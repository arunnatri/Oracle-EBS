--
-- XXDO_AR_B2B_OUTBOUND_PKG  (Package Body) 
--
/* Formatted on 4/26/2023 4:34:25 PM (QP5 v5.362) */
CREATE OR REPLACE PACKAGE BODY APPS."XXDO_AR_B2B_OUTBOUND_PKG"
/***************************************************************************************
* Program Name : XXDO_AR_B2B_OUTBOUND_PKG                                              *
* Language     : PL/SQL                                                                *
* Description  : Package to generate outbound files for B2B Portal integration         *
*                                                                                      *
* History      :                                                                       *
*                                                                                      *
* WHO          :       WHAT      Desc                                    WHEN          *
* -------------- ----------------------------------------------------------------------*
* Madhav Dhurjaty      1.0      Initial Version                         27-SEP-2017    *
* Kranthi Bollam       1.0      Added code for Open AR                  27-Oct-2017    *
* Madhav Dhurjaty      2.0      B2B Phase 2 EMEA Changes (CCR0007216 )  18-Apr-2018    *
* Srinath Siricilla    3.0      Macau Project Changes (CCR0007979)      12-JUL-2019    *
* Srinath Siricilla    3.1      UAT Defect# 513                         13-APR-2020    *
* Srinath Siricilla    3.2      CCR0008617                              27-MAY-2020    *
* Srinath Siricilla    3.3      CCR0008954                              22-SEP-2020    *
* Tejaswi Gangumalla   3.4      CCR0009132                              19-Jan-2020    *
* Srinath Siricilla    4.0      CCR0009103 - MTD P3                     08-MAR-2021    *
* Srinath Siricilla    4.1      CCR0009402                              07-JUN-2021    *
* Viswanathan Pandian  4.2      Performance fix for CCR0009748          02-Dec-2021    *
* Kishan Reddy         4.3      CCR0009859                              22-May-2022    *
* -------------------------------------------------------------------------------------*/
AS
    gv_package_name    CONSTANT VARCHAR (30) := 'XXDO_AR_B2B_OUTBOUND_PKG';
    gv_time_stamp               VARCHAR2 (40)
                                    := TO_CHAR (SYSDATE, 'YYYYMMDDHH24MISS');
    gv_file_time_stamp          VARCHAR2 (40)
                                    := TO_CHAR (SYSDATE, 'MMDDYY_HH24MISS');
    gn_user_id         CONSTANT NUMBER := fnd_global.user_id;
    gn_conc_request_id          NUMBER := fnd_global.conc_request_id;
    gv_default_email   CONSTANT VARCHAR2 (50)
        := fnd_profile.VALUE ('XXDO_B2B_DEFAULT_EMAIL_ID') ;
    gn_input_notif_req_id       NUMBER := NULL;

    -----
    -----
    --Write messages into LOG file
    --Parameters
    --PV_MSG        Message to be printed
    --PV_TIME       Print timestamp or not. Default is NO.
    PROCEDURE print_log (pv_msg IN VARCHAR2, pv_time IN VARCHAR2 DEFAULT 'N')
    IS
        lv_proc_name    VARCHAR2 (30) := 'PRINT_LOG';
        lv_msg          VARCHAR2 (4000);
        lv_time_stamp   VARCHAR2 (20)
                            := TO_CHAR (SYSDATE, 'DD-MON-RRRR HH24:MI:SS');
    BEGIN
        IF pv_time = 'Y'
        THEN
            lv_msg   := pv_msg || '. Timestamp: ' || lv_time_stamp;
        ELSE
            lv_msg   := pv_msg;
        END IF;

        IF gn_user_id = -1
        THEN
            DBMS_OUTPUT.put_line (lv_msg);
        ELSE
            fnd_file.put_line (fnd_file.LOG, lv_msg);
        END IF;
    --fnd_file.put_line (fnd_file.LOG, msg);
    EXCEPTION
        WHEN OTHERS
        THEN
            fnd_file.put_line (fnd_file.LOG,
                               'Unable to print log:' || SQLERRM);
    END print_log;

    ----
    ----
    --Write messages into output file
    --Parameters
    --PV_MSG        Message to be printed
    --PV_TIME       Print timestamp or not. Default is NO.
    PROCEDURE print_out (pv_msg IN VARCHAR2, pv_time IN VARCHAR2 DEFAULT 'N')
    IS
        lv_proc_name    VARCHAR2 (30) := 'PRINT_OUT';
        lv_msg          VARCHAR2 (4000);
        lv_time_stamp   VARCHAR2 (20)
                            := TO_CHAR (SYSDATE, 'DD-MON-RRRR HH24:MI:SS');
    BEGIN
        IF pv_time = 'Y'
        THEN
            lv_msg   := pv_msg || '. Timestamp: ' || lv_time_stamp;
        ELSE
            lv_msg   := pv_msg;
        END IF;

        IF gn_user_id = -1
        THEN
            DBMS_OUTPUT.put_line (lv_msg);
        ELSE
            fnd_file.put_line (fnd_file.output, lv_msg);
        END IF;
    --fnd_file.put_line (fnd_file.output, msg);
    EXCEPTION
        WHEN OTHERS
        THEN
            fnd_file.put_line (fnd_file.LOG,
                               'Unable to print output:' || SQLERRM);
    END print_out;

    ----
    ----
    --Function to check messages for Italy invoices
    --Parameters
    -- Start of Change for CCR0009859
    --
    FUNCTION validate_invoice (pn_org_id IN NUMBER, pn_customer_trx_id IN NUMBER, pv_invoice_type IN VARCHAR2)
        RETURN NUMBER
    IS
        ln_italy_org_count   NUMBER := 0;
        ln_italy_inv_count   NUMBER := 0;
    BEGIN
        BEGIN
            SELECT COUNT (1)
              INTO ln_italy_org_count
              FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values_vl ffvl
             WHERE     1 = 1
                   AND ffvs.flex_value_set_name =
                       'XXD_BILL_TRUST_ELE_INV_OUS_VS'
                   AND ffvs.flex_value_set_id = ffvl.flex_value_set_id
                   AND ffvl.enabled_flag = 'Y'
                   AND NVL (ffvl.start_date_active, SYSDATE) <= SYSDATE
                   AND NVL (ffvl.end_date_active, SYSDATE + 1) > SYSDATE
                   AND TO_NUMBER (ffvl.attribute1) = pn_org_id;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_italy_org_count   := 0;
        END;

        IF NVL (ln_italy_org_count, 0) = 0
        THEN
            RETURN (1);
        ELSE
            --
            IF pv_invoice_type IN ('INV', 'CM', 'DM')
            THEN
                BEGIN
                    SELECT COUNT (1)
                      INTO ln_italy_inv_count
                      FROM xxdo.xxd_pgr_response_msgs_t resp
                     WHERE     resp.invoice_id = pn_customer_trx_id
                           AND resp.invoice_type = 'AR_DI'
                           AND resp.document_subtype IN
                                   ('DELIVERY_SUCCESS', 'DELIVERY_FAILURE');
                -- AND org_id = pn_org_id;

                EXCEPTION
                    WHEN OTHERS
                    THEN
                        ln_italy_inv_count   := 0;
                END;

                IF NVL (ln_italy_inv_count, 0) = 0
                THEN
                    RETURN 0;
                ELSIF NVL (ln_italy_inv_count, 0) >= 1
                THEN                                     -- ln_italy_inv_count
                    RETURN 1;
                ELSE
                    RETURN 0;
                END IF;
            ELSE                                         -- IF pv_invoice_type
                RETURN (1);
            END IF;
        --
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            RETURN 0;
    END validate_invoice;

    ---- End of Change for CCR0009859

    ----
    -- Start of Change 3.0
    FUNCTION get_tax_codes (pv_org_id IN VARCHAR2, pv_tax_rate IN VARCHAR2, pv_ship_to IN VARCHAR2
                            , pv_ship_to_reg IN VARCHAR2, pv_ship_from IN VARCHAR2, x_tax_code OUT VARCHAR2)
        RETURN BOOLEAN
    IS
    BEGIN
        IF     pv_tax_rate IS NOT NULL
           AND pv_ship_to IS NOT NULL
           AND pv_ship_from IS NOT NULL
        THEN
            BEGIN
                SELECT tax_code
                  INTO x_tax_code
                  FROM (SELECT ffvs.flex_value_set_name, ffvl.attribute1 ou_id, ffvl.attribute2 tax_rate_equal,
                               ffvl.attribute3 tax_rate_unequal, ffvl.attribute4 ship_to_equal, ffvl.attribute5 ship_to_unequal,
                               ffvl.attribute6 ship_from_equal, ffvl.attribute7 ship_from_unequal, ffvl.attribute8 tax_code
                          FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values_vl ffvl
                         WHERE     1 = 1
                               AND ffvs.flex_value_set_name =
                                   'XXD_B2B_TAX_CODES_VS'
                               AND ffvs.flex_value_set_id =
                                   ffvl.flex_value_set_id
                               AND ffvl.enabled_flag = 'Y'
                               AND NVL (ffvl.start_date_active, SYSDATE) <=
                                   SYSDATE
                               AND NVL (ffvl.end_date_active, SYSDATE + 1) >
                                   SYSDATE) xx
                 WHERE     1 = 1
                       AND ou_id = pv_org_id
                       AND CASE
                               WHEN     NVL (pv_tax_rate, 'NA') <> 0
                                    AND tax_rate_unequal <> 'NA'
                               THEN
                                   tax_rate_unequal
                               WHEN     NVL (pv_tax_rate, 'NA') = '0'
                                    AND tax_rate_equal <> 'NA'
                               THEN
                                   tax_rate_equal
                           END =
                           CASE
                               WHEN     NVL (pv_tax_rate, 'NA') <> 0
                                    AND tax_rate_unequal <> 'NA'
                               THEN
                                   tax_rate_unequal
                               WHEN     NVL (pv_tax_rate, 'NA') = '0'
                                    AND tax_rate_equal <> 'NA'
                               THEN
                                   tax_rate_equal
                           END
                       AND (CASE
                                WHEN (NVL (pv_ship_to, '111') = NVL (ship_to_equal, '111') OR (NVL (pv_ship_to_reg, '111') = NVL (ship_to_equal, '111') AND ship_to_equal = 'EU'))
                                THEN
                                    NVL (ship_to_equal, '111')
                                WHEN ((NVL (pv_ship_to, '111') <> NVL (ship_to_unequal, '111') AND ship_to_unequal NOT IN ('NA', 'EU')) OR (DECODE (pv_ship_to, ship_to_unequal, ship_to_unequal, NVL (pv_ship_to_reg, '111')) <> ship_to_unequal AND ship_to_unequal <> 'NA'))
                                THEN
                                    NVL (ship_to_unequal, '111')
                            END =
                            CASE
                                WHEN (NVL (pv_ship_to, '111') = NVL (ship_to_equal, '111') OR (NVL (pv_ship_to_reg, '111') = NVL (ship_to_equal, '111') AND ship_to_equal = 'EU'))
                                THEN
                                    NVL (ship_to_equal, '111')
                                WHEN ((NVL (pv_ship_to, '111') <> NVL (ship_to_unequal, '111') AND ship_to_unequal NOT IN ('NA', 'EU')) OR (DECODE (pv_ship_to, ship_to_unequal, ship_to_unequal, NVL (pv_ship_to_reg, '111')) <> ship_to_unequal AND ship_to_unequal <> 'NA'))
                                THEN
                                    NVL (ship_to_unequal, '111')
                            END)
                       AND (   CASE
                                   WHEN NVL (pv_ship_from, '111') =
                                        NVL (ship_from_equal, '111')
                                   THEN
                                       NVL (ship_from_equal, '111')
                                   WHEN     NVL (pv_ship_from, '111') <>
                                            NVL (ship_from_unequal, '111')
                                        AND ship_from_unequal <> 'NA'
                                   THEN
                                       NVL (ship_from_unequal, '111')
                               END =
                               CASE
                                   WHEN NVL (pv_ship_from, '111') =
                                        NVL (ship_from_equal, '111')
                                   THEN
                                       NVL (ship_from_equal, '111')
                                   WHEN     NVL (pv_ship_from, '111') <>
                                            NVL (ship_from_unequal, '111')
                                        AND ship_from_unequal <> 'NA'
                                   THEN
                                       NVL (ship_from_unequal, '111')
                               END
                            OR CASE
                                   WHEN NVL (TRIM (ship_from_unequal), '111') =
                                        NVL (TRIM (ship_from_equal), '111')
                                   THEN
                                       1
                               END =
                               CASE
                                   WHEN NVL (TRIM (ship_from_unequal), '111') =
                                        NVL (TRIM (ship_from_equal), '111')
                                   THEN
                                       1
                               END);

                RETURN TRUE;
            EXCEPTION
                WHEN OTHERS
                THEN
                    x_tax_code   := NULL;
                    RETURN TRUE;
            END;
        ELSIF     pv_tax_rate IS NOT NULL
              AND pv_ship_to IS NOT NULL
              AND pv_ship_from IS NULL
        THEN
            BEGIN
                SELECT tax_code
                  INTO x_tax_code
                  FROM (SELECT ffvs.flex_value_set_name, ffvl.attribute1 ou_id, ffvl.attribute2 tax_rate_equal,
                               ffvl.attribute3 tax_rate_unequal, ffvl.attribute4 ship_to_equal, ffvl.attribute5 ship_to_unequal,
                               ffvl.attribute6 ship_from_equal, ffvl.attribute7 ship_from_unequal, ffvl.attribute8 tax_code
                          FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values_vl ffvl
                         WHERE     1 = 1
                               AND ffvs.flex_value_set_name =
                                   'XXD_B2B_TAX_CODES_VS'
                               AND ffvs.flex_value_set_id =
                                   ffvl.flex_value_set_id
                               AND ffvl.enabled_flag = 'Y'
                               AND NVL (ffvl.start_date_active, SYSDATE) <=
                                   SYSDATE
                               AND NVL (ffvl.end_date_active, SYSDATE + 1) >
                                   SYSDATE) xx
                 WHERE     1 = 1
                       AND ou_id = pv_org_id
                       AND CASE
                               WHEN     NVL (pv_tax_rate, 'NA') <> 0
                                    AND tax_rate_unequal <> 'NA'
                               THEN
                                   tax_rate_unequal
                               WHEN     NVL (pv_tax_rate, 'NA') = '0'
                                    AND tax_rate_equal <> 'NA'
                               THEN
                                   tax_rate_equal
                           END =
                           CASE
                               WHEN     NVL (pv_tax_rate, 'NA') <> 0
                                    AND tax_rate_unequal <> 'NA'
                               THEN
                                   tax_rate_unequal
                               WHEN     NVL (pv_tax_rate, 'NA') = '0'
                                    AND tax_rate_equal <> 'NA'
                               THEN
                                   tax_rate_equal
                           END
                       AND (CASE
                                WHEN (NVL (pv_ship_to, '111') = NVL (ship_to_equal, '111') OR (NVL (pv_ship_to_reg, '111') = NVL (ship_to_equal, '111') AND ship_to_equal = 'EU'))
                                THEN
                                    NVL (ship_to_equal, '111')
                                WHEN ((NVL (pv_ship_to, '111') <> NVL (ship_to_unequal, '111') AND ship_to_unequal NOT IN ('NA', 'EU')) OR (DECODE (pv_ship_to, ship_to_unequal, ship_to_unequal, NVL (pv_ship_to_reg, '111')) <> ship_to_unequal AND ship_to_unequal <> 'NA'))
                                THEN
                                    NVL (ship_to_unequal, '111')
                            END =
                            CASE
                                WHEN (NVL (pv_ship_to, '111') = NVL (ship_to_equal, '111') OR (NVL (pv_ship_to_reg, '111') = NVL (ship_to_equal, '111') AND ship_to_equal = 'EU'))
                                THEN
                                    NVL (ship_to_equal, '111')
                                WHEN ((NVL (pv_ship_to, '111') <> NVL (ship_to_unequal, '111') AND ship_to_unequal NOT IN ('NA', 'EU')) OR (DECODE (pv_ship_to, ship_to_unequal, ship_to_unequal, NVL (pv_ship_to_reg, '111')) <> ship_to_unequal AND ship_to_unequal <> 'NA'))
                                THEN
                                    NVL (ship_to_unequal, '111')
                            END);

                RETURN TRUE;
            EXCEPTION
                WHEN OTHERS
                THEN
                    x_tax_code   := NULL;
                    RETURN TRUE;
            END;
        ELSIF     pv_tax_rate IS NOT NULL
              AND pv_ship_from IS NOT NULL
              AND pv_ship_to IS NULL
        THEN
            BEGIN
                SELECT tax_code
                  INTO x_tax_code
                  FROM (SELECT ffvs.flex_value_set_name, ffvl.attribute1 ou_id, ffvl.attribute2 tax_rate_equal,
                               ffvl.attribute3 tax_rate_unequal, ffvl.attribute4 ship_to_equal, ffvl.attribute5 ship_to_unequal,
                               ffvl.attribute6 ship_from_equal, ffvl.attribute7 ship_from_unequal, ffvl.attribute8 tax_code
                          FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values_vl ffvl
                         WHERE     1 = 1
                               AND ffvs.flex_value_set_name =
                                   'XXD_B2B_TAX_CODES_VS'
                               AND ffvs.flex_value_set_id =
                                   ffvl.flex_value_set_id
                               AND ffvl.enabled_flag = 'Y'
                               AND NVL (ffvl.start_date_active, SYSDATE) <=
                                   SYSDATE
                               AND NVL (ffvl.end_date_active, SYSDATE + 1) >
                                   SYSDATE) xx
                 WHERE     1 = 1
                       AND ou_id = pv_org_id
                       AND CASE
                               WHEN     NVL (pv_tax_rate, 'NA') <> 0
                                    AND tax_rate_unequal <> 'NA'
                               THEN
                                   tax_rate_unequal
                               WHEN     NVL (pv_tax_rate, 'NA') = '0'
                                    AND tax_rate_equal <> 'NA'
                               THEN
                                   tax_rate_equal
                           END =
                           CASE
                               WHEN     NVL (pv_tax_rate, 'NA') <> 0
                                    AND tax_rate_unequal <> 'NA'
                               THEN
                                   tax_rate_unequal
                               WHEN     NVL (pv_tax_rate, 'NA') = '0'
                                    AND tax_rate_equal <> 'NA'
                               THEN
                                   tax_rate_equal
                           END
                       AND (   CASE
                                   WHEN NVL (pv_ship_from, '111') =
                                        NVL (ship_from_equal, '111')
                                   THEN
                                       NVL (ship_from_equal, '111')
                                   WHEN     NVL (pv_ship_from, '111') <>
                                            NVL (ship_from_unequal, '111')
                                        AND ship_from_unequal <> 'NA'
                                   THEN
                                       NVL (ship_from_unequal, '111')
                               END =
                               CASE
                                   WHEN NVL (pv_ship_from, '111') =
                                        NVL (ship_from_equal, '111')
                                   THEN
                                       NVL (ship_from_equal, '111')
                                   WHEN     NVL (pv_ship_from, '111') <>
                                            NVL (ship_from_unequal, '111')
                                        AND ship_from_unequal <> 'NA'
                                   THEN
                                       NVL (ship_from_unequal, '111')
                               END
                            OR CASE
                                   WHEN NVL (TRIM (ship_from_unequal), '111') =
                                        NVL (TRIM (ship_from_equal), '111')
                                   THEN
                                       1
                               END =
                               CASE
                                   WHEN NVL (TRIM (ship_from_unequal), '111') =
                                        NVL (TRIM (ship_from_equal), '111')
                                   THEN
                                       1
                               END);

                RETURN TRUE;
            EXCEPTION
                WHEN OTHERS
                THEN
                    x_tax_code   := NULL;
                    RETURN TRUE;
            END;
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_tax_code   := NULL;
            RETURN TRUE;
    END get_tax_codes;

    FUNCTION check_VS_active (pv_ff_name IN VARCHAR2, pv_flex_context_code IN VARCHAR2, x_count OUT NUMBER)
        RETURN BOOLEAN
    IS
        ln_count   NUMBER := 0;
    BEGIN
        SELECT COUNT (1)
          INTO ln_count
          FROM FND_DESCR_FLEX_CONTEXTS_VL
         WHERE     descriptive_flexfield_name = pv_ff_name
               AND descriptive_flex_context_code = pv_flex_context_code
               AND NVL (enabled_flag, 'N') = 'Y';

        IF ln_count = 1
        THEN
            x_count   := ln_count;
            RETURN TRUE;
        ELSIF ln_count = 0 OR ln_count > 1
        THEN
            x_count   := ln_count;
            RETURN FALSE;
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_count   := 0;
            RETURN FALSE;
    END check_VS_active;

    -- End of Change 3.0
    ----

    ---- Start of Change for CCR0009103

    FUNCTION get_org_territory_fnc (pv_terr_name IN VARCHAR2)
        RETURN VARCHAR2
    IS
        lv_org_name   VARCHAR2 (100);
    BEGIN
        lv_org_name   := NULL;

        BEGIN
            SELECT attribute2
              INTO lv_org_name
              FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values_vl ffvl
             WHERE     ffvs.flex_value_set_id = ffvl.flex_value_set_id
                   AND ffvs.flex_value_set_name = 'XXD_AR_MTD_CNTRY_WH_VS'
                   AND ffvl.enabled_flag = 'Y'
                   AND SYSDATE BETWEEN NVL (ffvl.start_date_active,
                                            SYSDATE - 1)
                                   AND NVL (ffvl.end_date_active,
                                            SYSDATE + 1)
                   AND ffvl.attribute1 = pv_terr_name;
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                lv_org_name   := 'ME2';
            WHEN OTHERS
            THEN
                lv_org_name   := NULL;
        END;

        RETURN lv_org_name;
    END get_org_territory_fnc;

    FUNCTION get_ship_from_brand_fnc (pv_brand    IN VARCHAR2,
                                      pn_org_id   IN NUMBER)
        RETURN VARCHAR2
    IS
        lv_territory   VARCHAR2 (100);
    BEGIN
        SELECT ffvl.attribute3
          INTO lv_territory
          FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values_vl ffvl
         WHERE     1 = 1
               AND ffvs.flex_value_set_id = ffvl.flex_value_set_id
               AND ffvl.enabled_flag = 'Y'
               AND SYSDATE BETWEEN NVL (ffvl.start_date_active, SYSDATE)
                               AND NVL (ffvl.end_date_active, SYSDATE)
               AND ffvs.flex_value_set_name = 'XXD_MTD_OU_TERR_BRANDS_VS'
               AND ffvl.attribute1 = pn_org_id
               AND ffvl.attribute2 = pv_brand;

        RETURN lv_territory;
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_territory   := NULL;

            RETURN lv_territory;
    END get_ship_from_brand_fnc;

    FUNCTION get_ship_from_fnc (pn_inv_org_id IN NUMBER)
        RETURN VARCHAR2
    IS
        lv_ship_country   VARCHAR2 (100);
    BEGIN
        lv_ship_country   := NULL;

        SELECT fvl.territory_code                   --fvl.territory_short_name
          INTO lv_ship_country
          FROM fnd_territories_vl fvl, hr_locations hrl, hr_all_organization_units hou
         WHERE     hrl.country = fvl.territory_code
               AND hrl.inventory_organization_id = hou.organization_id
               AND hrl.location_id = hou.location_id
               AND hrl.inventory_organization_id = pn_inv_org_id;

        RETURN lv_ship_country;
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_ship_country   := NULL;

            RETURN lv_ship_country;
    END get_ship_from_fnc;


    FUNCTION get_ref_num (p_trx_type            IN VARCHAR2,
                          p_batch_name          IN VARCHAR2,
                          pn_ship_site_use_id   IN NUMBER,
                          pn_bill_to_cust_id    IN NUMBER,
                          pn_bill_site_use_id   IN NUMBER,
                          pv_brand              IN VARCHAR2,
                          pn_org_id             IN NUMBER,
                          pn_warehouse_id       IN NUMBER,
                          pv_claim_number       IN VARCHAR2,
                          pv_line_context       IN VARCHAR2, -- Added for CCR0009402
                          pn_inv_item_id        IN NUMBER -- Added as per CCR0009859
                                                         )
        RETURN NUMBER
    IS
        lv_ref                  VARCHAR2 (100);
        lv_ship_from            VARCHAR2 (50);
        lv_tm_whname            VARCHAR2 (50);
        ln_tm_counter           NUMBER;
        ln_tm_counter1          NUMBER;
        lv_tm_trx_type          VARCHAR2 (50);
        lv_tm_int_context       VARCHAR2 (50);
        lv_tm_brand             VARCHAR2 (50);
        lv_ref_ship_from        VARCHAR2 (50);
        ln_ref_ship_from_id     NUMBER;
        lv_ref_ship_from_name   VARCHAR2 (50);
        ln_tm_org_id            NUMBER;
        lv_ret_msg              VARCHAR2 (1000);
        lv_reference_line       VARCHAR2 (100);
        ln_ref_trx_line_id      NUMBER;
        lv_tm_ship_from         VARCHAR2 (100);
        ln_tm_warehouse_id      NUMBER;
        lv_tm_ship_from_obj     VARCHAR2 (100);
        lv_tm_whname_obj        VARCHAR2 (100);
        lv_trx_number           VARCHAR2 (100);
        ln_ref_trx_count        NUMBER;                -- Added for CCR0009402
        ln_trx_amt_due          NUMBER;            --- Added as per CCR0009859
        ln_cust_trx_id          NUMBER;            --- Added as per CCR0009859
        ln_amount_due           NUMBER;            --- Added as per CCR0009859
    BEGIN
        lv_ref                  := NULL;
        lv_ship_from            := NULL;
        lv_tm_whname            := NULL;
        ln_tm_counter           := NULL;
        ln_tm_counter1          := NULL;
        lv_tm_trx_type          := NULL;
        lv_tm_int_context       := NULL;
        lv_tm_brand             := NULL;
        lv_ref_ship_from        := NULL;
        ln_ref_ship_from_id     := NULL;
        lv_ref_ship_from_name   := NULL;
        ln_tm_org_id            := NULL;
        lv_ret_msg              := NULL;
        lv_reference_line       := NULL;
        ln_ref_trx_line_id      := NULL;
        lv_tm_ship_from         := NULL;
        ln_tm_warehouse_id      := NULL;
        lv_tm_ship_from_obj     := NULL;
        lv_tm_whname_obj        := NULL;
        lv_trx_number           := NULL;
        ln_ref_trx_count        := NULL;               -- Added for CCR0009402
        ln_trx_amt_due          := NULL;           --- Added as per CCR0009859
        ln_cust_trx_id          := NULL;           --- Added as per CCR0009859
        ln_amount_due           := NULL;           --- Added as per CCR0009859

        --       IF p_trx_type IN ('CM', 'DM')
        --       THEN
        -- First get the Ship from based on the Brand and Org combination

        lv_ref_ship_from        := NULL;
        lv_ref_ship_from        :=
            get_ship_from_brand_fnc (pv_brand    => pv_brand,
                                     pn_org_id   => pn_org_id);
        lv_ref_ship_from_name   := NULL;

        IF lv_ref_ship_from IS NOT NULL
        THEN
            lv_ref_ship_from_name   :=
                get_org_territory_fnc (lv_ref_ship_from);
        END IF;

        ln_ref_ship_from_id     := NULL;


        IF lv_ref_ship_from_name IS NOT NULL
        THEN
            BEGIN
                SELECT organization_id
                  INTO ln_ref_ship_from_id
                  FROM org_organization_definitions
                 WHERE organization_code = lv_ref_ship_from_name;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_ref_ship_from_id   := NULL;
            END;
        END IF;

        print_log (
               ' The Fetched Ship from Org_id based on Brand is - '
            || ln_ref_ship_from_id);

        IF p_batch_name = 'Trade Management'
        THEN
            -- Get the Ship from country based on the Brand

            -- When batch source is TM, either populate the Ref line with Invoice Source object class value or make it as NULL
            --             lv_location := ' With TM Making Ref line as NULL';
            lv_reference_line     := NULL;
            ln_ref_trx_line_id    := NULL;
            lv_tm_ship_from       := NULL;
            lv_ret_msg            := NULL;
            lv_tm_whname          := NULL;
            lv_tm_trx_type        := NULL;
            lv_tm_int_context     := NULL;
            lv_tm_brand           := NULL;
            ln_tm_org_id          := NULL;
            ln_tm_warehouse_id    := NULL;
            lv_tm_ship_from_obj   := NULL;
            lv_tm_whname_obj      := NULL;
            ln_tm_counter         := 0;
            ln_tm_counter1        := 0;
            ln_trx_amt_due        := NULL;         --- Added as per CCR0009859
            ln_cust_trx_id        := NULL;         --- Added as per CCR0009859
            ln_amount_due         := NULL;         --- Added as per CCR0009859

            lv_tm_ship_from       :=
                get_ship_from_brand_fnc (pv_brand, pn_org_id);

            IF lv_tm_ship_from IS NOT NULL
            THEN
                lv_tm_whname   := get_org_territory_fnc (lv_tm_ship_from);
            END IF;

            -- Start of Changes as per CCR0009859

            BEGIN
                SELECT DISTINCT customer_trx_id
                  INTO ln_cust_trx_id
                  FROM apps.ra_customer_trx_lines_all
                 WHERE     1 = 1
                       AND interface_line_attribute1 = pv_claim_number
                       AND org_id = pn_org_id;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_cust_trx_id   := NULL;
            END;

            IF ln_cust_trx_id IS NOT NULL
            THEN
                BEGIN
                    SELECT SUM (amount_due_remaining) amount_due_remaining
                      INTO ln_trx_amt_due
                      FROM apps.ar_payment_schedules_all
                     WHERE     customer_trx_id = ln_cust_trx_id
                           AND org_id = pn_org_id
                           AND status = 'OP';
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        ln_trx_amt_due   := NULL;
                END;
            END IF;

            -- End of Changes as per CCR0009859


            -- Find whether it is CM or DM
            -- If Auto Invoice, go to warehouse
            -- If warehouse is not available then go to brand
            -- If it is not Auto Invoice, Directly go and get the Brand]

            -- Start of Change as per CCR0009859

            BEGIN
                  SELECT rcta.trx_number
                    INTO lv_reference_line
                    FROM apps.ozf_claim_lines_all ocla, apps.ozf_claims_all oca, apps.ra_customer_trx_all rcta
                   WHERE     1 = 1
                         --                         AND ocla.source_object_class = 'INVOICE'
                         AND oca.claim_number = pv_claim_number
                         AND ocla.claim_id = oca.claim_id
                         AND ocla.org_id = oca.org_id
                         AND ocla.org_id = pn_org_id
                         AND oca.attribute1 = rcta.trx_number -- for trademanagement
                         AND rcta.org_id = oca.org_id
                ORDER BY rcta.trx_date DESC;

                RETURN lv_reference_line;
            EXCEPTION
                WHEN OTHERS
                THEN
                    lv_reference_line   := NULL;
            END;

            -- End of Change as per CCR0009859

            FOR tm_value
                IN (  SELECT NVL (oca.source_object_id, ocla.source_object_id) source_object_id
                        FROM apps.ozf_claim_lines_all ocla, apps.ozf_claims_all oca, apps.ra_customer_trx_all rcta
                       WHERE     1 = 1
                             --                             AND     ocla.source_object_class = 'INVOICE'
                             AND oca.claim_number = pv_claim_number
                             AND ocla.claim_id = oca.claim_id
                             AND ocla.org_id = oca.org_id
                             AND ocla.org_id = pn_org_id
                             AND rcta.customer_trx_id =
                                 NVL (oca.source_object_id,
                                      ocla.source_object_id)
                             AND rcta.org_id = oca.org_id
                    ORDER BY rcta.trx_date DESC, NVL (oca.source_object_id, ocla.source_object_id) DESC)
            LOOP
                --- Check the Source Obj Ref Type

                ln_tm_counter       := 1;
                ln_tm_counter1      := 0;
                lv_tm_trx_type      := NULL;
                lv_tm_int_context   := NULL;
                lv_tm_brand         := NULL;
                ln_tm_org_id        := NULL;

                BEGIN
                    SELECT rctta.TYPE, rcta.interface_header_context, rcta.attribute5 brand,
                           rcta.org_id
                      INTO lv_tm_trx_type, lv_tm_int_context, lv_tm_brand, ln_tm_org_id
                      FROM ra_cust_trx_types_all rctta, ra_customer_trx_all rcta
                     WHERE     rctta.cust_trx_type_id = rcta.cust_trx_type_id
                           AND rcta.customer_trx_id =
                               tm_value.source_object_id;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        lv_tm_trx_type      := NULL;
                        lv_tm_int_context   := NULL;
                        lv_tm_brand         := NULL;
                        ln_tm_org_id        := NULL;
                END;

                -- Check if it Auto Invoice or Manual

                IF lv_tm_int_context = 'ORDER ENTRY'
                THEN
                    ln_tm_warehouse_id   := NULL;

                    -- Get warehouse ID and then fetch Country
                    BEGIN
                        SELECT DISTINCT warehouse_id
                          INTO ln_tm_warehouse_id
                          FROM ra_customer_trx_lines_all
                         WHERE Customer_trx_id = tm_value.source_object_id;
                    EXCEPTION
                        WHEN OTHERS
                        THEN
                            ln_tm_warehouse_id   := NULL;
                    END;

                    -- Warehouse_id NOT NULL then get the  Ship from Country

                    IF ln_tm_warehouse_id IS NOT NULL
                    THEN
                        lv_tm_ship_from_obj   := NULL;

                        lv_tm_ship_from_obj   :=
                            get_ship_from_fnc (ln_tm_warehouse_id);
                    END IF;
                END IF;

                -- If this is not Auto Invoice or derived warehouse id is NULL, then go with the Brand Logic
                IF    lv_tm_int_context <> 'ORDER ENTRY'
                   OR ln_tm_warehouse_id IS NULL
                THEN
                    lv_tm_ship_from_obj   := NULL;
                    lv_ret_msg            := NULL;
                    lv_tm_ship_from_obj   :=
                        get_ship_from_brand_fnc (lv_tm_brand, ln_tm_org_id);
                END IF;

                IF lv_tm_ship_from_obj IS NOT NULL
                THEN
                    lv_tm_whname_obj   := NULL;

                    lv_tm_whname_obj   :=
                        get_org_territory_fnc (lv_tm_ship_from_obj);
                END IF;

                IF lv_tm_whname = lv_tm_whname_obj
                THEN
                    ln_ref_trx_line_id   := tm_value.source_object_id;

                    ln_amount_due        := NULL;

                    BEGIN
                        SELECT SUM (amount_line_items_remaining) amount_due_remaining
                          INTO ln_amount_due
                          FROM ar_payment_schedules_all
                         WHERE     customer_trx_id = ln_ref_trx_line_id
                               AND org_id = pn_org_id
                               AND status = 'OP';

                        IF ln_amount_due >= ABS (ln_trx_amt_due)
                        THEN
                            ln_tm_counter1   := 1;
                            EXIT;
                        END IF;
                    EXCEPTION
                        WHEN OTHERS
                        THEN
                            ln_amount_due   := NULL;
                    END;
                END IF;
            END LOOP;


            IF ln_tm_counter = 1 AND ln_tm_counter1 = 0
            THEN
                ln_ref_trx_line_id   := NULL;

                BEGIN
                    SELECT source_object_id
                      INTO ln_ref_trx_line_id
                      FROM (  SELECT NVL (oca.source_object_id, ocla.source_object_id) source_object_id
                                FROM apps.ozf_claim_lines_all ocla, apps.ozf_claims_all oca, apps.ra_customer_trx_all rcta
                               WHERE     ocla.source_object_class = 'INVOICE'
                                     AND oca.claim_number = pv_claim_number
                                     AND ocla.claim_id = oca.claim_id
                                     AND ocla.org_id = oca.org_id
                                     AND ocla.org_id = pn_org_id
                                     AND rcta.customer_trx_id =
                                         NVL (oca.source_object_id,
                                              ocla.source_object_id)
                                     AND rcta.org_id = oca.org_id
                            ORDER BY rcta.trx_date DESC, NVL (oca.source_object_id, ocla.source_object_id) DESC)
                     WHERE ROWNUM = 1;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        ln_ref_trx_line_id   := NULL;
                        lv_ret_msg           := SUBSTR (SQLERRM, 1, 200);
                END;
            END IF;

            IF ln_ref_trx_line_id IS NOT NULL
            THEN
                lv_reference_line   := NULL;
                lv_ret_msg          := NULL;

                BEGIN
                    SELECT trx_number
                      INTO lv_reference_line
                      FROM apps.ra_customer_trx_all rcta
                     WHERE     rcta.customer_trx_id = ln_ref_trx_line_id
                           AND rcta.org_id = pn_org_id;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        lv_ret_msg          := SUBSTR (SQLERRM, 1, 200);
                        lv_reference_line   := NULL;   -- Added for CCR0009402
                END;
            -- Start of Change for CCR0009402

            ELSE
                BEGIN
                    lv_reference_line   := NULL;
                    lv_ret_msg          := NULL;

                    SELECT trx_number
                      INTO lv_reference_line
                      FROM (  SELECT rcta.trx_date, rcta.trx_number, SUM (aps.amount_due_remaining) amount -- Added as per CCR0009859
                                FROM ra_customer_trx_lines_all rctla, ra_customer_trx_all rcta, ra_cust_trx_types_all rctta,
                                     ar_payment_schedules_all aps -- Added as per CCR0009859
                               WHERE     rcta.customer_trx_id =
                                         rctla.customer_trx_id
                                     AND rcta.cust_trx_type_id =
                                         rctta.cust_trx_type_id
                                     AND rcta.org_id = rctta.org_id
                                     AND rctta.TYPE = 'INV'
                                     AND rcta.interface_header_context =
                                         'ORDER ENTRY'
                                     AND rctla.line_type = 'LINE'
                                     AND rctta.name NOT LIKE '%Manual%'
                                     AND rctla.warehouse_id =
                                         NVL (pn_warehouse_id,
                                              ln_ref_ship_from_id)
                                     AND rcta.bill_to_customer_id =
                                         pn_bill_to_cust_id
                                     AND rcta.bill_to_site_use_id =
                                         pn_bill_site_use_id
                                     -- Start of Change as per CCR0009859
                                     AND rcta.customer_trx_id =
                                         aps.customer_trx_id
                                     AND rcta.org_id = aps.org_id
                                     AND aps.status = 'OP'
                                     AND EXISTS
                                             (SELECT 1
                                                FROM ra_customer_trx_lines_all rctla1
                                               WHERE     rctla1.customer_trx_id =
                                                         rctla.customer_trx_id
                                                     AND rctla1.inventory_item_id =
                                                         pn_inv_item_id)
                            GROUP BY rcta.trx_date, rcta.trx_number
                              HAVING SUM (aps.amount_due_remaining) >=
                                     ABS (ln_trx_amt_due)
                            -- End of Change as per CCR0009859
                            ORDER BY rcta.trx_date DESC)
                     WHERE ROWNUM = 1;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        lv_reference_line   := NULL;

                        BEGIN
                            SELECT trx_number
                              INTO lv_reference_line
                              FROM (  SELECT rcta.trx_date, rcta.trx_number, SUM (aps.amount_due_remaining) amount -- Added as per CCR0009859
                                        FROM ra_customer_trx_lines_all rctla, ra_customer_trx_all rcta, ra_cust_trx_types_all rctta,
                                             ar_payment_schedules_all aps -- Added as per CCR0009859
                                       WHERE     rcta.customer_trx_id =
                                                 rctla.customer_trx_id
                                             AND rcta.cust_trx_type_id =
                                                 rctta.cust_trx_type_id
                                             AND rcta.org_id = rctta.org_id
                                             AND rctta.TYPE = 'INV'
                                             AND rcta.interface_header_context =
                                                 'ORDER ENTRY'
                                             AND rctla.line_type = 'LINE'
                                             AND rctta.name NOT LIKE '%Manual%'
                                             AND rctla.warehouse_id =
                                                 NVL (pn_warehouse_id,
                                                      ln_ref_ship_from_id)
                                             AND rcta.bill_to_customer_id =
                                                 pn_bill_to_cust_id
                                             AND rcta.bill_to_site_use_id =
                                                 pn_bill_site_use_id
                                             -- Start of Change as per CCR0009859
                                             AND rcta.customer_trx_id =
                                                 aps.customer_trx_id
                                             AND rcta.org_id = aps.org_id
                                             AND aps.status = 'OP'
                                    GROUP BY rcta.trx_date, rcta.trx_number
                                      HAVING SUM (aps.amount_due_remaining) >=
                                             ABS (ln_trx_amt_due)
                                    -- End of Change as per CCR0009859
                                    ORDER BY rcta.trx_date DESC)
                             WHERE ROWNUM = 1;
                        EXCEPTION
                            WHEN OTHERS
                            THEN
                                lv_reference_line   := NULL;
                        END;
                END;
            -- End of Change for CCR0009402

            END IF;

            --END IF;

            RETURN lv_reference_line;
        ELSIF p_batch_name <> 'Trade Management'
        THEN
            -- Start of Change for CCR0009402

            IF pv_line_context IS NULL AND pv_claim_number IS NOT NULL
            THEN
                ln_ref_trx_count   := 0;

                -- Check whether the lv_trx_number is VALID

                BEGIN
                    SELECT COUNT (1)
                      INTO ln_ref_trx_count
                      FROM apps.ra_customer_trx_all
                     WHERE     trx_number = pv_claim_number
                           AND org_id = pn_org_id;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        ln_ref_trx_count   := NULL;
                END;

                IF ln_ref_trx_count = 1
                THEN
                    lv_trx_number   := pv_claim_number;
                --RETURN lv_trx_number;
                ELSE
                    lv_trx_number   := NULL;
                END IF;
            END IF;

            IF lv_trx_number IS NOT NULL
            THEN
                RETURN lv_trx_number;
            ELSE
                BEGIN
                    SELECT trx_number
                      INTO lv_trx_number
                      FROM (  SELECT rcta.trx_date, rcta.trx_number, SUM (aps.amount_due_remaining) amount -- Added as per CCR0009859
                                FROM ra_customer_trx_lines_all rctla, ra_customer_trx_all rcta, ra_cust_trx_types_all rctta,
                                     ar_payment_schedules_all aps -- Added as per CCR0009859
                               WHERE     rcta.customer_trx_id =
                                         rctla.customer_trx_id
                                     AND rcta.cust_trx_type_id =
                                         rctta.cust_trx_type_id
                                     AND rcta.org_id = rctta.org_id
                                     AND rctta.TYPE = 'INV'
                                     AND rcta.interface_header_context =
                                         'ORDER ENTRY'
                                     AND rctla.line_type = 'LINE'
                                     AND rctta.name NOT LIKE '%Manual%'
                                     AND rctla.warehouse_id =
                                         NVL (pn_warehouse_id,
                                              ln_ref_ship_from_id)
                                     AND rcta.bill_to_customer_id =
                                         pn_bill_to_cust_id
                                     AND rcta.bill_to_site_use_id =
                                         pn_bill_site_use_id
                                     -- Start of Change as per CCR0009859
                                     AND rcta.customer_trx_id =
                                         aps.customer_trx_id
                                     AND rcta.org_id = aps.org_id
                                     AND aps.status = 'OP'
                                     AND EXISTS
                                             (SELECT 1
                                                FROM ra_customer_trx_lines_all rctla1
                                               WHERE     rctla1.customer_trx_id =
                                                         rctla.customer_trx_id
                                                     AND rctla1.inventory_item_id =
                                                         pn_inv_item_id)
                            GROUP BY rcta.trx_date, rcta.trx_number
                              HAVING SUM (aps.amount_due_remaining) >=
                                     ABS (ln_trx_amt_due)
                            -- End of Change as per CCR0009859
                            ORDER BY rcta.trx_date DESC)
                     WHERE ROWNUM = 1;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        lv_trx_number   := NULL;

                        ---- End of Change for CCR0009402

                        BEGIN
                            SELECT trx_number
                              INTO lv_trx_number
                              FROM (  SELECT rcta.trx_date, rcta.trx_number, SUM (aps.amount_due_remaining) amount -- Added as per CCR0009859
                                        FROM ra_customer_trx_lines_all rctla, ra_customer_trx_all rcta, ra_cust_trx_types_all rctta,
                                             ar_payment_schedules_all aps -- Added as per CCR0009859
                                       WHERE     rcta.customer_trx_id =
                                                 rctla.customer_trx_id
                                             AND rcta.cust_trx_type_id =
                                                 rctta.cust_trx_type_id
                                             AND rcta.org_id = rctta.org_id
                                             AND rctta.TYPE = 'INV'
                                             AND rcta.interface_header_context =
                                                 'ORDER ENTRY'
                                             AND rctla.line_type = 'LINE'
                                             AND rctta.name NOT LIKE '%Manual%'
                                             AND rctla.warehouse_id =
                                                 NVL (pn_warehouse_id,
                                                      ln_ref_ship_from_id)
                                             AND rcta.bill_to_customer_id =
                                                 pn_bill_to_cust_id
                                             AND rcta.bill_to_site_use_id =
                                                 pn_bill_site_use_id
                                             -- Start of Change as per CCR0009859
                                             AND rcta.customer_trx_id =
                                                 aps.customer_trx_id
                                             AND rcta.org_id = aps.org_id
                                             AND aps.status = 'OP'
                                    GROUP BY rcta.trx_date, rcta.trx_number
                                      HAVING SUM (aps.amount_due_remaining) >=
                                             ABS (ln_trx_amt_due)
                                    -- End of Change as per CCR0009859
                                    ORDER BY rcta.trx_date DESC)
                             WHERE ROWNUM = 1;
                        EXCEPTION
                            WHEN OTHERS
                            THEN
                                lv_trx_number   := NULL;
                        END;
                END;

                RETURN lv_trx_number;
            END IF;
        --          print_log('Entered 2');
        --          print_log('pn_bill_to_cust_id - '||pn_bill_to_cust_id);
        --          print_log('pn_bill_site_use_id - '||pn_bill_site_use_id);

        END IF;

        RETURN NVL (lv_reference_line, lv_trx_number);
    END get_ref_num;

    -- End of Change for CCR0009103

    ----
    FUNCTION ar_rec_num_validate (p_org_id IN NUMBER, p_cust_account_id IN NUMBER, p_receipt_number IN VARCHAR2)
        RETURN VARCHAR2
    IS
        l_ret_msg   VARCHAR2 (30);
        l_cnt       NUMBER;
    BEGIN
        IF (p_org_id IS NOT NULL AND p_cust_account_id IS NOT NULL AND p_receipt_number IS NOT NULL)
        THEN
            SELECT COUNT (*)
              INTO l_cnt
              FROM ar_cash_receipts_all cr, hz_cust_accounts hca, hr_operating_units hou,
                   ar_payment_schedules_all ps
             WHERE     1 = 1
                   AND cr.pay_from_customer = hca.cust_account_id
                   AND cr.org_id = hou.organization_id
                   AND cr.cash_receipt_id = ps.cash_receipt_id(+)
                   AND ps.class(+) = 'PMT'
                   AND ps.amount_due_remaining(+) <> 0
                   AND cr.org_id = p_org_id
                   AND cr.pay_from_customer = p_cust_account_id
                   AND cr.receipt_number = p_receipt_number--AND TRUNC(cr.creation_date) <> TRUNC(SYSDATE)
                                                           ;

            IF l_cnt > 0
            THEN
                l_ret_msg   := 'DUPLICATE_RECEIPT';
            ELSE
                l_ret_msg   := 'NOT_DUPLICATE_RECEIPT'; --UPPER(p_receipt_number);
            END IF;
        END IF;

        RETURN UPPER (l_ret_msg);
    EXCEPTION
        WHEN OTHERS
        THEN
            l_ret_msg   := 'NOT_DUPLICATE_RECEIPT';
            RETURN l_ret_msg;
    END ar_rec_num_validate;

    ----
    ----
    FUNCTION remove_junk (p_input IN VARCHAR2)
        RETURN VARCHAR2
    IS
        lv_output   VARCHAR2 (32767) := NULL;
    BEGIN
        IF p_input IS NOT NULL
        THEN
            SELECT REPLACE (REPLACE (REPLACE (REPLACE (p_input, CHR (9), ''), CHR (10), ''), '|', ' '), CHR (13), '')
              INTO lv_output
              FROM DUAL;
        ELSE
            RETURN NULL;
        END IF;

        RETURN lv_output;
    EXCEPTION
        WHEN OTHERS
        THEN
            RETURN NULL;
    END remove_junk;

    ----
    ----
    FUNCTION get_sales_order_num (pn_customer_trx_id IN NUMBER)
        RETURN VARCHAR2
    IS
        --Local Variables Declaration
        lv_proc_name   VARCHAR2 (30) := 'GET_SALES_ORDER_NUM';
        lv_so_num      VARCHAR2 (240) := NULL;
        lv_err_msg     VARCHAR2 (2000) := NULL;

        CURSOR so_cur IS
              SELECT rctl.interface_line_attribute1 so_num
                FROM apps.ra_customer_trx_all rct, apps.ra_customer_trx_lines_all rctl
               WHERE     1 = 1
                     AND rct.customer_trx_id = pn_customer_trx_id
                     AND rct.customer_trx_id = rctl.customer_trx_id
                     AND rctl.line_type = 'LINE'
            GROUP BY rctl.interface_line_attribute1;
    BEGIN
        FOR so_rec IN so_cur
        LOOP
            IF so_rec.so_num IS NOT NULL
            THEN
                lv_so_num   := ',' || so_rec.so_num;
            END IF;
        END LOOP;

        IF lv_so_num IS NOT NULL
        THEN
            lv_so_num   := SUBSTR (lv_so_num, 2);
        END IF;

        --If SO is null in lines, get it from header
        IF lv_so_num IS NULL
        THEN
            BEGIN
                SELECT rct.interface_header_attribute1 so_num
                  INTO lv_so_num
                  FROM apps.ra_customer_trx_all rct
                 WHERE 1 = 1 AND rct.customer_trx_id = pn_customer_trx_id --17306
                                                                         ;
            EXCEPTION
                WHEN OTHERS
                THEN
                    lv_so_num   := NULL;
                    lv_err_msg   :=
                        SUBSTR (
                               'When Others Exception While Getting Header SO Number in '
                            || lv_proc_name
                            || '. Error is: '
                            || SQLERRM,
                            1,
                            2000);
                    print_log (lv_err_msg);
            END;
        END IF;

        RETURN lv_so_num;
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_err_msg   :=
                SUBSTR (
                       'When Others Exception While Getting SO Number in '
                    || lv_proc_name
                    || '. Error is: '
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
            RETURN lv_so_num;
    END get_sales_order_num;

    ----
    ----
    PROCEDURE get_eu_non_eu (p_country_code   IN     VARCHAR2,
                             x_eu_non_eu         OUT VARCHAR2)
    IS
        lv_eu_non_eu   VARCHAR2 (10) := NULL;
        ln_count       NUMBER := 0;
    BEGIN
        print_log ('p_country_code=' || p_country_code);

        /*B2B Phase 2 EMEA Changes (CCR0007216 ) --Start*/
        /*
         SELECT COUNT(1)
           INTO ln_count
           FROM apps.fnd_lookup_values flv1
          WHERE 1=1
            AND flv1.lookup_type = 'XXDO_EU_COUNTIRES'
            AND flv1.language = 'US'
            AND flv1.enabled_flag = 'Y'
            AND NVL(flv1.start_date_active,SYSDATE) <= SYSDATE
            AND NVL(flv1.end_date_active,SYSDATE+1) > SYSDATE
            AND lookup_code = p_country_code;
         */

        SELECT COUNT (1)
          INTO ln_count
          FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv
         WHERE     ffvs.flex_value_set_name = 'XXDO_CFS_EU_COUNTRIES_VS'
               AND ffv.flex_value_set_id = ffvs.flex_value_set_id
               --- Added as per 3.0
               AND ffv.enabled_flag = 'Y'
               AND NVL (ffv.start_date_active, SYSDATE) <= SYSDATE
               AND NVL (ffv.end_date_active, SYSDATE + 1) > SYSDATE
               AND UPPER (ffv.flex_value) = UPPER (p_country_code);

        --- Added as per 3.0
        /*B2B Phase 2 EMEA Changes (CCR0007216 ) --End*/

        IF ln_count > 0
        THEN
            x_eu_non_eu   := 'EU';
        ELSE
            x_eu_non_eu   := 'Non-EU';
        END IF;

        print_log ('x_eu_non_eu=' || x_eu_non_eu);
    EXCEPTION
        WHEN OTHERS
        THEN
            x_eu_non_eu   := 'Non-EU';                                 --NULL;
    END get_eu_non_eu;

    ----
    ----
    PROCEDURE get_remit_address (p_org_id IN NUMBER, x_remit_address1 OUT VARCHAR2, x_remit_address2 OUT VARCHAR2, x_remit_address3 OUT VARCHAR2, x_remit_address4 OUT VARCHAR2, x_remit_city OUT VARCHAR2, x_remit_state OUT VARCHAR2, x_remit_province OUT VARCHAR2, x_remit_zip OUT VARCHAR2, x_remit_country OUT VARCHAR2, x_remit_addressee OUT VARCHAR2, x_remit_contact OUT VARCHAR2
                                 , x_remit_country_name OUT VARCHAR2)
    IS
    BEGIN
        SELECT loc.address1, loc.address2, loc.address3,
               loc.address4, loc.city, loc.state,
               loc.province, loc.postal_code, loc.country country,
               party_site.addressee, addr.attribute2, terr.territory_short_name
          INTO x_remit_address1, x_remit_address2, x_remit_address3, x_remit_address4,
                               x_remit_city, x_remit_state, x_remit_province,
                               x_remit_zip, x_remit_country, x_remit_addressee,
                               x_remit_contact, x_remit_country_name
          FROM fnd_territories_vl terr, hz_cust_acct_sites_all addr, hz_party_sites party_site,
               hz_locations loc, hr_operating_units hou
         WHERE     1 = 1
               AND addr.cust_account_id = -1
               AND addr.party_site_id = party_site.party_site_id
               AND loc.location_id = party_site.location_id
               AND loc.country = terr.territory_code(+)
               AND hou.organization_id = addr.org_id
               AND hou.organization_id = p_org_id
               AND addr.status = 'A'
               AND ROWNUM = 1;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_remit_address1       := NULL;
            x_remit_address2       := NULL;
            x_remit_address3       := NULL;
            x_remit_address4       := NULL;
            x_remit_city           := NULL;
            x_remit_state          := NULL;
            x_remit_province       := NULL;
            x_remit_zip            := NULL;
            x_remit_country        := NULL;
            x_remit_addressee      := NULL;
            x_remit_contact        := NULL;
            x_remit_country_name   := NULL;
            print_log ('Error in get_remit_address:' || SQLERRM);
    END get_remit_address;

    ----
    ----
    PROCEDURE get_bill_to_address (p_customer_id IN NUMBER, p_org_id IN NUMBER, x_bill_address1 OUT VARCHAR2, x_bill_address2 OUT VARCHAR2, x_bill_address3 OUT VARCHAR2, x_bill_address4 OUT VARCHAR2, x_bill_city OUT VARCHAR2, x_bill_state OUT VARCHAR2, x_bill_province OUT VARCHAR2, x_bill_zip OUT VARCHAR2, x_bill_country OUT VARCHAR2, x_bill_party OUT VARCHAR2
                                   , x_bill_country_name OUT VARCHAR2)
    IS
    BEGIN
        SELECT loc.address1, loc.address2, loc.address3,
               loc.address4, loc.city, loc.state,
               loc.province, loc.postal_code, loc.country,
               party.party_name, terr.territory_short_name
          INTO x_bill_address1, x_bill_address2, x_bill_address3, x_bill_address4,
                              x_bill_city, x_bill_state, x_bill_province,
                              x_bill_zip, x_bill_country, x_bill_party,
                              x_bill_country_name
          FROM apps.hz_party_sites psites, apps.hz_locations loc, apps.hz_cust_acct_sites_all sites,
               apps.hz_cust_site_uses_all uses, apps.hz_cust_accounts cust_acct, apps.hz_parties party,
               apps.fnd_territories_vl terr
         WHERE     1 = 1
               AND sites.party_site_id = psites.party_site_id
               AND loc.location_id = psites.location_id
               AND sites.cust_account_id = p_customer_id
               AND sites.cust_acct_site_id = uses.cust_acct_site_id
               AND sites.org_id = p_org_id
               AND loc.country = terr.territory_code(+)
               --AND terr.language (+) = USERENV ('LANG')
               AND uses.status = 'A'
               AND uses.PRIMARY_FLAG = 'Y'
               AND uses.SITE_USE_CODE = 'BILL_TO'
               AND sites.cust_account_id = cust_acct.cust_account_id
               AND cust_acct.party_id = party.party_id;
    EXCEPTION
        WHEN NO_DATA_FOUND
        THEN
            x_bill_address1       := NULL;
            x_bill_address2       := NULL;
            x_bill_address3       := NULL;
            x_bill_address4       := NULL;
            x_bill_city           := NULL;
            x_bill_state          := NULL;
            x_bill_zip            := NULL;
            x_bill_party          := NULL;
            x_bill_province       := NULL;
            x_bill_country        := NULL;
            x_bill_country_name   := NULL;
            print_log ('Error in get_bill_to_address:' || SQLERRM);
        WHEN OTHERS
        THEN
            x_bill_address1       := NULL;
            x_bill_address2       := NULL;
            x_bill_address3       := NULL;
            x_bill_address4       := NULL;
            x_bill_city           := NULL;
            x_bill_state          := NULL;
            x_bill_zip            := NULL;
            x_bill_party          := NULL;
            x_bill_province       := NULL;
            x_bill_country        := NULL;
            x_bill_country_name   := NULL;
            print_log ('Error in get_bill_to_address:' || SQLERRM);
    END get_bill_to_address;

    ----
    ----
    PROCEDURE get_collector_info (p_customer_id       IN     NUMBER,
                                  p_contact_id        IN     NUMBER,
                                  x_collector_name       OUT VARCHAR2,
                                  x_collector_phone      OUT VARCHAR2,
                                  x_collector_email      OUT VARCHAR2)
    IS
        lv_coll_name    VARCHAR2 (360);
        lv_coll_phone   VARCHAR2 (360);
        lv_coll_email   VARCHAR2 (360);
    BEGIN
        BEGIN
            SELECT ac.name, ac.telephone_number, ppf.email_address
              INTO lv_coll_name, lv_coll_phone, lv_coll_email
              FROM hz_customer_profiles hcp, ar_collectors ac, per_all_people_f ppf
             WHERE     1 = 1
                   AND hcp.collector_id = ac.collector_id(+)
                   AND ac.employee_id = ppf.person_id(+)
                   AND hcp.cust_account_id = p_customer_id
                   AND hcp.site_use_id = p_contact_id
                   AND hcp.status = 'A'
                   AND ROWNUM = 1;
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_coll_name    := NULL;
                lv_coll_phone   := NULL;
                lv_coll_email   := NULL;
        END;

        IF (lv_coll_name IS NULL OR UPPER (lv_coll_name) LIKE 'DEFAULT%')
        THEN
            BEGIN
                SELECT ac.name, ac.telephone_number, ppf.email_address
                  INTO lv_coll_name, lv_coll_phone, lv_coll_email
                  FROM hz_customer_profiles hcp, ar_collectors ac, per_all_people_f ppf
                 WHERE     1 = 1
                       AND hcp.collector_id = ac.collector_id(+)
                       AND ac.employee_id = ppf.person_id(+)
                       AND hcp.cust_account_id = p_customer_id
                       AND hcp.site_use_id IS NULL
                       AND hcp.status = 'A'
                       AND ROWNUM = 1;
            EXCEPTION
                WHEN OTHERS
                THEN
                    lv_coll_name    := NULL;
                    lv_coll_phone   := NULL;
                    lv_coll_email   := NULL;
            END;
        END IF;

        x_collector_name    := lv_coll_name;
        x_collector_phone   := lv_coll_phone;
        x_collector_email   := lv_coll_email;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_collector_name    := NULL;
            x_collector_phone   := NULL;
            x_collector_email   := NULL;
            print_log ('Error in get_collector_info:' || SQLERRM);
    END get_collector_info;

    ----
    ----
    PROCEDURE get_stmt_line_det (p_payment_schedule_id IN NUMBER, x_currency_code OUT VARCHAR2, x_amt_due_orig OUT NUMBER
                                 , x_reference OUT VARCHAR2)
    IS
        ln_amt_due_orig   NUMBER;
    BEGIN
        BEGIN
            SELECT ps.amount_due_original, invoice_currency_code
              INTO x_amt_due_orig, x_currency_code
              FROM ar_payment_schedules_all ps
             WHERE ps.payment_schedule_id = p_payment_schedule_id;
        EXCEPTION
            WHEN OTHERS
            THEN
                x_amt_due_orig    := NULL;
                x_currency_code   := NULL;
        END;

        BEGIN
            SELECT   --NVL (trx.purchase_order, NULL) Commented for CCR0007216
                   DECODE (trx.purchase_order, NULL, NULL, remove_junk (trx.purchase_order))
              INTO x_reference
              FROM ra_customer_trx_all trx, ar_payment_schedules_all ps
             WHERE     1 = 1
                   AND ps.payment_schedule_id = p_payment_schedule_id
                   AND trx.customer_trx_id = ps.customer_trx_id;
        EXCEPTION
            WHEN OTHERS
            THEN
                x_reference   := NULL;
        END;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_stmt_line_det:' || SQLERRM);
    END get_stmt_line_det;

    ----
    ----
    FUNCTION get_billing_phone (p_brand IN VARCHAR2)
        RETURN VARCHAR2
    IS
        lv_phone   VARCHAR2 (50);
    BEGIN
        SELECT flv.description
          INTO lv_phone
          FROM fnd_lookup_values flv
         WHERE     1 = 1
               AND flv.lookup_type = 'DO_AR_BILLING_PHONE'
               AND flv.language = 'US'
               AND UPPER (flv.lookup_code) = p_brand;

        RETURN lv_phone;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_billing_phone:' || SQLERRM);
            RETURN NULL;
    END get_billing_phone;

    ----
    ----
    FUNCTION get_brand_num (p_brand IN VARCHAR2)
        RETURN VARCHAR2
    IS
        lv_brand_phone   VARCHAR2 (50);
    BEGIN
        BEGIN
            SELECT al.description
              INTO lv_brand_phone
              FROM ar_lookups al
             WHERE     1 = 1
                   AND al.lookup_type = 'DO_AR_BRAND_PHONE'
                   AND UPPER (al.lookup_code) = UPPER (p_brand);
        EXCEPTION
            WHEN OTHERS
            THEN
                SELECT al.description
                  INTO lv_brand_phone
                  FROM ar_lookups al
                 WHERE     1 = 1
                       AND al.lookup_type = 'DO_AR_BRAND_PHONE'
                       AND al.lookup_code = 'DECKERS';
        END;

        RETURN lv_brand_phone;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_brand_num:' || SQLERRM);
            RETURN NULL;
    END get_brand_num;

    ----
    ----
    FUNCTION get_to_email_address (p_customer_id IN NUMBER, p_brand IN VARCHAR2, p_ship_country IN VARCHAR2
                                   , p_org_id IN NUMBER, p_trx_class IN VARCHAR2, p_bill_site_id IN NUMBER -- Added as per change 3.2
                                                                                                          )
        RETURN VARCHAR2
    IS
        -- Commented and added new code as per change 3.2
        -- Modified cursor to fetch Party Level, Account level, Party Site(bill_to),
        --account site (bill_to) emails.

        /*CURSOR c_email
        IS
            SELECT DISTINCT hcp.email_address
              FROM hz_cust_accounts_all    hca,
                   hz_contact_points       hcp,
                   hz_cust_account_roles   har,
                   hz_role_responsibility  hrr
             WHERE 1 = 1
               AND har.party_id = hcp.owner_table_id
               AND hcp.owner_table_name = 'HZ_PARTIES'
               AND hcp.contact_point_type = 'EMAIL'
               AND hca.cust_account_id = har.cust_account_id
               AND har.cust_account_role_id = hrr.cust_account_role_id
               AND hrr.responsibility_type = DECODE (p_trx_class, 'CM', 'CM', 'INV')
               AND hca.cust_account_id = p_customer_id
               AND har.current_role_state = 'A'
               AND hcp.status = 'A' --Added for CCR0007216
               AND hcp.email_address LIKE '%@%' --Added for CCR0007216
               ;*/

        CURSOR c_email IS
            SELECT DISTINCT hcp.email_address
              FROM hz_contact_points hcp, hz_cust_accounts hca
             WHERE     hcp.owner_table_name = 'HZ_PARTIES'
                   AND hcp.contact_point_type = 'EMAIL'
                   AND hcp.owner_table_id = hca.party_id
                   AND hca.cust_account_id = p_customer_id
                   AND hcp.status = 'A'                 --Added for CCR0007216
                   AND hcp.email_address LIKE '%@%'
            UNION
            -- Account Site at Bill to
            SELECT DISTINCT hcp.email_address
              FROM hz_contact_points hcp, hz_cust_acct_sites_all hcasa
             WHERE     hcp.owner_table_name = 'HZ_PARTY_SITES'
                   AND hcp.contact_point_type = 'EMAIL'
                   AND hcp.owner_table_id = hcasa.party_site_id
                   AND hcasa.cust_account_id = p_customer_id
                   AND hcp.status = 'A'                 --Added for CCR0007216
                   AND hcp.email_address LIKE '%@%'
                   AND EXISTS
                           (SELECT 1
                              FROM apps.hz_cust_site_uses_all uses
                             WHERE     uses.cust_acct_site_id =
                                       hcasa.cust_acct_site_id
                                   AND uses.site_use_id = p_bill_site_id)
            UNION
            -- Account level details email
            SELECT DISTINCT hcp.email_address
              FROM hz_cust_accounts_all hca, hz_contact_points hcp, hz_cust_account_roles har,
                   hz_role_responsibility hrr
             WHERE     1 = 1
                   AND har.party_id = hcp.owner_table_id
                   AND hcp.owner_table_name = 'HZ_PARTIES'
                   AND hcp.contact_point_type = 'EMAIL'
                   AND hca.cust_account_id = har.cust_account_id
                   AND har.cust_account_role_id = hrr.cust_account_role_id
                   AND hrr.responsibility_type =
                       DECODE (p_trx_class, 'CM', 'CM', 'INV')
                   AND hca.cust_account_id = p_customer_id
                   AND har.current_role_state = 'A'
                   --AND hrr.primary_flag = 'Y'   -- Commented for CCR0008954
                   AND har.cust_acct_site_id IS NULL
                   AND har.role_type = 'CONTACT'
                   AND hcp.status = 'A'                 --Added for CCR0007216
                   AND hcp.email_address LIKE '%@%'
            --
            UNION
            -- Account Site level Bill to (inside)
            SELECT DISTINCT hcp.email_address
              FROM hz_cust_accounts_all hca, hz_contact_points hcp, hz_cust_account_roles har,
                   hz_role_responsibility hrr
             --,hz_party_sites hps
             --,hz_cust_acct_sites_all hcasa
             WHERE     1 = 1
                   AND har.party_id = hcp.owner_table_id
                   AND hcp.owner_table_name = 'HZ_PARTIES'
                   AND hcp.contact_point_type = 'EMAIL'
                   AND hca.cust_account_id = har.cust_account_id
                   AND har.cust_account_role_id = hrr.cust_account_role_id
                   AND hrr.responsibility_type =
                       DECODE (p_trx_class, 'CM', 'CM', 'INV')
                   AND hca.cust_account_id = p_customer_id
                   AND har.current_role_state = 'A'
                   --AND hrr.primary_flag = 'Y'-- Commented for CCR0008954
                   -- AND     hcasa.party_site_id = hps.party_site_id
                   -- AND     HCASA.cust_acct_site_id = har.cust_acct_site_id
                   AND har.cust_acct_site_id IS NOT NULL
                   AND har.role_type = 'CONTACT'
                   AND hcp.status = 'A'                 --Added for CCR0007216
                   AND hcp.email_address LIKE '%@%'
                   AND EXISTS
                           (SELECT 1
                              FROM apps.hz_cust_site_uses_all uses
                             WHERE     uses.cust_acct_site_id =
                                       har.cust_acct_site_id
                                   AND uses.site_use_id = p_bill_site_id);

        -- End of Change 3.2

        lv_email_address    VARCHAR2 (360);
        lv_ou_country       VARCHAR2 (100);
        lv_helpdesk_email   VARCHAR2 (100);
    BEGIN
        FOR i IN c_email
        LOOP
            lv_email_address   := i.email_address || ',' || lv_email_address;
        END LOOP;

        lv_email_address   :=
            SUBSTR (lv_email_address, 0, LENGTH (lv_email_address) - 1);

        IF lv_email_address IS NULL
        THEN
            BEGIN
                SELECT country
                  INTO lv_ou_country
                  FROM hr_organization_units_v
                 WHERE organization_id = p_org_id;
            EXCEPTION
                WHEN OTHERS
                THEN
                    lv_ou_country   := NULL;
            END;

            BEGIN
                SELECT attribute6
                  INTO lv_helpdesk_email
                  FROM fnd_lookup_values
                 WHERE     1 = 1
                       AND lookup_type = 'XXDO_CUST_FAC_DOC_LKP'
                       AND attribute4 = 'Invoice'
                       AND language = USERENV ('LANG')
                       AND enabled_flag = 'Y'
                       AND attribute5 = p_brand
                       AND attribute3 = p_org_id
                       AND attribute1 = lv_ou_country
                       AND attribute2 = p_ship_country;
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    lv_helpdesk_email   := NULL;

                    BEGIN
                        SELECT attribute6
                          INTO lv_helpdesk_email
                          FROM fnd_lookup_values
                         WHERE     1 = 1
                               AND lookup_type = 'XXDO_CUST_FAC_DOC_LKP'
                               AND attribute4 = 'Invoice'
                               AND language = USERENV ('LANG')
                               AND enabled_flag = 'Y'
                               AND attribute5 = 'ALL BRAND'
                               AND attribute3 = p_org_id
                               AND attribute1 = lv_ou_country
                               AND attribute2 = lv_ou_country;
                    EXCEPTION
                        WHEN OTHERS
                        THEN
                            lv_helpdesk_email   := NULL;
                    END;
            END;

            lv_email_address   := lv_helpdesk_email;
        END IF;

        RETURN lv_email_address;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_to_email_address:' || SQLERRM);
            RETURN NULL;
    END get_to_email_address;

    ----
    ----
    FUNCTION get_print_or_email (p_trx_class_code IN VARCHAR2, p_trx_source_type IN VARCHAR2, p_bill_to_site_use_id IN NUMBER)
        RETURN VARCHAR2
    IS
        lv_trans_method   VARCHAR2 (30);
    BEGIN
        SELECT flt.meaning                                    --hps.attribute1
          INTO lv_trans_method
          FROM hz_party_sites hps, hz_cust_acct_sites_all cas, hz_cust_site_uses_all csu,
               fnd_lookup_values flt
         WHERE     1 = 1
               AND hps.party_site_id = cas.party_site_id
               AND cas.cust_acct_site_id = csu.cust_acct_site_id
               AND (CASE
                        WHEN (p_trx_class_code = 'CM' AND UPPER (p_trx_source_type) LIKE '%MANUAL%')
                        THEN
                            SUBSTR (hps.attribute2, 1, 1)
                        WHEN (p_trx_class_code = 'CM' AND UPPER (p_trx_source_type) NOT LIKE '%MANUAL%')
                        THEN
                            SUBSTR (hps.attribute2, 2, 1)
                        WHEN (p_trx_class_code = 'DM' AND UPPER (p_trx_source_type) LIKE '%MANUAL%')
                        THEN
                            SUBSTR (hps.attribute3, 1, 1)
                        WHEN (p_trx_class_code = 'DM' AND UPPER (p_trx_source_type) NOT LIKE '%MANUAL%')
                        THEN
                            SUBSTR (hps.attribute3, 2, 1)
                        WHEN (p_trx_class_code = 'INV' AND UPPER (p_trx_source_type) LIKE '%MANUAL%')
                        THEN
                            SUBSTR (hps.attribute1, 1, 1)
                        WHEN (p_trx_class_code = 'INV' AND UPPER (p_trx_source_type) NOT LIKE '%MANUAL%')
                        THEN
                            SUBSTR (hps.attribute1, 2, 1)
                        ELSE
                            '0'
                    END) =
                   flt.lookup_code
               AND lookup_type = 'DO_AR_TRX_TRANS_METHODS'
               AND flt.language = 'US'
               AND csu.site_use_id = p_bill_to_site_use_id;

        RETURN lv_trans_method;
    EXCEPTION
        WHEN OTHERS
        THEN
            RETURN 'NONE';
    END get_print_or_email;

    ----
    ----
    FUNCTION get_original_trx_num (p_rel_cust_trx_id IN NUMBER)
        RETURN VARCHAR2
    IS
        lv_trx_num   VARCHAR2 (30);
    BEGIN
        SELECT trx_number
          INTO lv_trx_num
          FROM ra_customer_trx_all
         WHERE customer_trx_id = p_rel_cust_trx_id;

        RETURN lv_trx_num;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_original_trx_num:' || SQLERRM);
            RETURN NULL;
    END get_original_trx_num;

    ----
    ----
    PROCEDURE get_country_le (p_org_id       IN     NUMBER,
                              x_le_name         OUT VARCHAR2,
                              x_ou_country      OUT VARCHAR2)
    IS
    BEGIN
        SELECT xep.name, hou.country
          INTO x_le_name, x_ou_country
          FROM hr_organization_units_v hou, hr_operating_units hou1, xle_entity_profiles xep
         WHERE     1 = 1
               AND hou.organization_id = hou1.organization_id
               AND hou1.default_legal_context_id = xep.legal_entity_id
               AND hou.organization_id = p_org_id;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_country_le:' || SQLERRM);
            x_le_name      := NULL;
            x_ou_country   := NULL;
    END get_country_le;

    ----
    ----
    PROCEDURE get_lang_email_data (p_org_id IN NUMBER, p_ship_country IN VARCHAR2, p_brand IN VARCHAR2, x_from_email OUT VARCHAR2, x_email_body OUT VARCHAR2, x_email_subject OUT VARCHAR2
                                   , x_language OUT VARCHAR2)
    IS
        lv_ou_country      VARCHAR2 (30);
        lv_from_email      VARCHAR2 (100);
        lv_email_subject   VARCHAR2 (200);
        lv_email_body      VARCHAR2 (2000);
        lv_language        VARCHAR2 (100);
        lv_message         VARCHAR2 (2000);
        ln_orgid           NUMBER;
    BEGIN
        --Get OU Country
        BEGIN
            SELECT country
              INTO lv_ou_country
              FROM hr_organization_units_v
             WHERE organization_id = p_org_id;
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_ou_country   := NULL;
        END;

        BEGIN
            SELECT DISTINCT attribute9, attribute10, attribute14,
                            attribute3, attribute8
              INTO lv_email_subject, lv_message, lv_language, ln_orgid,
                                   lv_from_email
              FROM fnd_lookup_values
             WHERE     LOOKUP_TYPE = 'XXDO_CUST_FAC_DOC_LKP'
                   AND attribute4 = 'Invoice'
                   AND language = USERENV ('LANG')
                   AND enabled_flag = 'Y'
                   AND attribute5 = p_brand
                   AND attribute3 = p_org_id
                   AND attribute1 = lv_ou_country
                   AND attribute2 = p_ship_country
                   AND NVL (attribute7, 'N') = 'N';
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                BEGIN
                    SELECT DISTINCT attribute9, attribute10, attribute14,
                                    attribute3, attribute8
                      INTO lv_email_subject, lv_message, lv_language, ln_orgid,
                                           lv_from_email
                      FROM fnd_lookup_values
                     WHERE     1 = 1
                           AND lookup_type = 'XXDO_CUST_FAC_DOC_LKP'
                           AND attribute4 = 'Invoice'
                           AND language = USERENV ('LANG')
                           AND enabled_flag = 'Y'
                           AND attribute5 = p_brand
                           AND attribute3 = p_org_id
                           AND attribute1 = lv_ou_country
                           AND attribute2 = lv_ou_country
                           AND NVL (attribute7, 'N') = 'Y';
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        BEGIN
                            SELECT DISTINCT attribute9, attribute10, attribute14,
                                            attribute3, attribute8
                              INTO lv_email_subject, lv_message, lv_language, ln_orgid,
                                                   lv_from_email
                              FROM fnd_lookup_values
                             WHERE     1 = 1
                                   AND LOOKUP_TYPE = 'XXDO_CUST_FAC_DOC_LKP'
                                   AND attribute4 = 'Invoice'
                                   AND language = USERENV ('LANG')
                                   AND enabled_flag = 'Y'
                                   AND attribute5 = 'ALL BRAND'
                                   AND attribute3 = p_org_id
                                   AND attribute1 = lv_ou_country
                                   AND attribute2 = p_ship_country
                                   AND NVL (attribute7, 'N') = 'N';
                        EXCEPTION
                            WHEN NO_DATA_FOUND
                            THEN
                                BEGIN
                                    SELECT DISTINCT attribute9, attribute10, attribute14,
                                                    attribute3, attribute8
                                      INTO lv_email_subject, lv_message, lv_language, ln_orgid,
                                                           lv_from_email
                                      FROM fnd_lookup_values
                                     WHERE     1 = 1
                                           AND lookup_type =
                                               'XXDO_CUST_FAC_DOC_LKP'
                                           AND attribute4 = 'Invoice'
                                           AND language = USERENV ('LANG')
                                           AND enabled_flag = 'Y'
                                           AND attribute5 = 'ALL BRAND'
                                           AND attribute3 = p_org_id
                                           AND attribute1 = lv_ou_country
                                           AND attribute2 = lv_ou_country
                                           AND NVL (attribute7, 'N') = 'Y';
                                EXCEPTION
                                    WHEN OTHERS
                                    THEN
                                        NULL;
                                END;
                        END;
                END;
        END;

        BEGIN
            SELECT message_name
              INTO lv_email_body
              FROM fnd_new_messages
             WHERE 1 = 1 AND message_name = lv_message;
        EXCEPTION
            WHEN OTHERS
            THEN
                NULL;
        END;

        x_from_email      := lv_from_email;
        x_email_body      := lv_email_body;
        x_email_subject   := lv_email_subject;
        x_language        := lv_language;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_lang_email_data:' || SQLERRM);
            NULL;
    END get_lang_email_data;

    ----
    ----
    PROCEDURE get_disc_date (p_term_id     IN     NUMBER,
                             p_trx_date    IN     DATE,
                             p_due_date    IN     DATE,
                             p_ou_region   IN     VARCHAR2,
                             x_disc_date      OUT DATE,
                             x_due_date       OUT DATE)
    IS
        ld_disc_date   DATE;
        ld_due_date    DATE;
    BEGIN
        BEGIN
            SELECT p_trx_date + NVL (discount_days, 0), p_trx_date + NVL (discount_days, 0) + 1
              INTO ld_disc_date, ld_due_date
              FROM apps.ra_terms_lines_discounts
             WHERE term_id = p_term_id;
        EXCEPTION
            WHEN OTHERS
            THEN
                ld_disc_date   := NULL;
                ld_due_date    := NULL;
        END;

        IF p_ou_region <> 'NA'
        THEN
            ld_due_date   := p_due_date;
        END IF;

        IF ld_disc_date IS NULL
        THEN
            x_disc_date   := p_due_date;
        ELSE
            x_disc_date   := ld_disc_date;
        END IF;

        IF ld_due_date IS NULL
        THEN
            x_due_date   := p_due_date + 1;
        ELSE
            x_due_date   := ld_due_date;
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_disc_date:' || SQLERRM);
            x_disc_date   := NULL;
            x_due_date    := NULL;
    END get_disc_date;

    ----
    ----
    PROCEDURE get_emea_hdr_data (p_bill_to_customer_id   IN     NUMBER,
                                 p_bill_to_site_use_id   IN     NUMBER,
                                 p_ship_to_customer_id   IN     NUMBER,
                                 p_ship_to_site_use_id   IN     NUMBER,
                                 x_cpo_acc                  OUT VARCHAR2,
                                 x_cpo_member               OUT VARCHAR2,
                                 x_tax_relate               OUT VARCHAR2,
                                 x_tax_ref                  OUT VARCHAR2)
    IS
        ln_pur_grp_term_id   NUMBER;
        ln_relate_cust_id    NUMBER;
        lv_brand_name        VARCHAR2 (30);
    BEGIN
        /*--Commented for CCR0007216 --Start
         SELECT term_id
           INTO ln_pur_grp_term_id
           FROM ra_terms t
          WHERE name = 'PURCH GRP';
          */
        /* --Commented for CCR0007216 --Start
        IF NVL (p_term_id, ln_pur_grp_term_id) = ln_pur_grp_term_id
        THEN
            BEGIN
                SELECT hzp.party_name related_customer,
                       relate.comments,
                       relate.related_cust_account_id,
                       relate_cust.attribute1
                  INTO x_cpo_acc,
                       x_cpo_member,
                       ln_relate_cust_id,
                       lv_brand_name
                  FROM hz_cust_accounts_all     trx_bill_cust,
                       hz_cust_acct_relate_all  relate,
                       hz_cust_accounts_all     relate_cust,
                       hz_parties               hzp
                 WHERE 1 = 1
                   AND trx_bill_cust.cust_account_id = p_bill_to_customer_id
                   AND relate.cust_account_id = trx_bill_cust.cust_account_id
                   AND relate.related_cust_account_id = relate_cust.cust_account_id
                   AND hzp.party_id = relate_cust.party_id
                   AND relate_cust.attribute1 = trx_bill_cust.attribute1
                   AND hzp.party_id NOT IN (
                                            SELECT party_id
                                              FROM hz_cust_accounts_all
                                             WHERE cust_account_id = trx_bill_cust.cust_account_id
                                           )
                ;
            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    BEGIN
                        SELECT hzp.party_name related_customer,
                               relate.comments,
                               relate.related_cust_account_id,
                               relate_cust.attribute1
                          INTO x_cpo_acc,
                               x_cpo_member,
                               ln_relate_cust_id,
                               lv_brand_name
                          FROM hz_cust_accounts_all     trx_bill_cust,
                               hz_cust_acct_relate_all  relate,
                               hz_cust_accounts_all     relate_cust,
                               hz_parties               hzp
                         WHERE 1 = 1
                           AND trx_bill_cust.cust_account_id = p_bill_to_customer_id
                           AND relate.cust_account_id = trx_bill_cust.cust_account_id
                           AND relate.related_cust_account_id = relate_cust.cust_account_id
                           AND hzp.party_id = relate_cust.party_id
                           AND UPPER (relate_cust.attribute1) = 'ALL BRAND'
                           AND hzp.party_id NOT IN (
                                                    SELECT party_id
                                                      FROM hz_cust_accounts_all
                                                      WHERE cust_account_id = trx_bill_cust.cust_account_id
                                                   )
                        ;
                    EXCEPTION
                        WHEN NO_DATA_FOUND THEN
                            x_cpo_acc := NULL;
                            x_cpo_member := NULL;
                            ln_relate_cust_id := NULL;
                        WHEN TOO_MANY_ROWS THEN
                            x_cpo_acc := NULL;
                            x_cpo_member := NULL;
                            ln_relate_cust_id := NULL;
                        WHEN OTHERS THEN
                            x_cpo_acc := 'Unidentified';
                            x_cpo_member := NULL;
                            ln_relate_cust_id := NULL;
                    END;
                WHEN TOO_MANY_ROWS THEN
                    x_cpo_acc := NULL;
                    x_cpo_member := NULL;
                    ln_relate_cust_id := NULL;
                WHEN OTHERS THEN
                    x_cpo_acc := 'Unidentified';
                    x_cpo_member := NULL;
                    ln_relate_cust_id := NULL;
            END;

            BEGIN
                SELECT tax_reference
                  INTO x_tax_relate
                  FROM zx_party_tax_profile    pro,
                       hz_cust_acct_sites_all  sites,
                       hz_cust_site_uses_all   uses
                 WHERE 1 = 1
                   AND pro.party_type_code = 'THIRD_PARTY_SITE'
                   AND pro.party_id = sites.party_site_id
                   AND sites.cust_acct_site_id = uses.cust_acct_site_id
                   AND uses.site_use_code = 'BILL_TO'
                   AND sites.cust_account_id = ln_relate_cust_id;
            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    x_tax_relate := NULL;
                WHEN OTHERS THEN
                    x_tax_relate := NULL;
            END;
        ELSE
            x_cpo_acc := NULL;
            x_cpo_member := NULL;
            ln_relate_cust_id := NULL;
        END IF;
        */
        --Commented for CCR0007216 --End

        BEGIN
            --Party Level derivation of Buying Group and Buying Group Vat No
            SELECT hp.attribute16, hp.attribute18
              INTO x_CPO_ACC, x_TAX_RELATE
              FROM hz_parties hp, hz_cust_accounts_all trx_bill_cust
             WHERE     hp.party_id = trx_bill_cust.party_id
                   AND trx_bill_cust.cust_account_id = p_bill_to_customer_id;
        EXCEPTION
            WHEN OTHERS
            THEN
                x_CPO_ACC      := NULL;
                x_TAX_RELATE   := NULL;
        END;

        --Derivation of Customer Membership
        BEGIN
            --Derive value using Ship-To
            BEGIN
                SELECT sites.attribute11
                  INTO x_CPO_MEMBER
                  FROM hz_cust_acct_sites_all sites, hz_cust_site_uses_all uses
                 WHERE     sites.CUST_ACCT_SITE_ID = uses.CUST_ACCT_SITE_ID
                       AND uses.SITE_USE_CODE = 'SHIP_TO'
                       AND uses.site_use_id = p_ship_to_site_use_id
                       AND sites.CUST_ACCOUNT_ID = p_ship_to_customer_id;
            EXCEPTION
                WHEN OTHERS
                THEN
                    x_CPO_MEMBER   := NULL;
            END;


            IF x_CPO_MEMBER IS NULL
            THEN
                BEGIN
                    --Derive value using Bill-To
                    SELECT sites.attribute11
                      INTO x_CPO_MEMBER
                      FROM hz_cust_acct_sites_all sites, hz_cust_site_uses_all uses
                     WHERE     sites.CUST_ACCT_SITE_ID =
                               uses.CUST_ACCT_SITE_ID
                           AND uses.SITE_USE_CODE = 'BILL_TO'
                           AND uses.site_use_id = p_bill_to_site_use_id
                           AND sites.CUST_ACCOUNT_ID = p_bill_to_customer_id;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        x_CPO_MEMBER   := NULL;
                END;
            END IF;

            IF x_CPO_MEMBER IS NULL
            THEN
                BEGIN
                    --Derive value from party level
                    SELECT hp.attribute17
                      INTO x_CPO_MEMBER
                      FROM hz_parties hp, hz_cust_accounts_all trx_bill_cust
                     WHERE     hp.party_id = trx_bill_cust.party_id
                           AND trx_bill_cust.cust_account_id =
                               p_bill_to_customer_id;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        x_CPO_MEMBER   := NULL;
                END;
            END IF;
        EXCEPTION
            WHEN OTHERS
            THEN
                x_CPO_MEMBER   := NULL;
        END;

        /*End modification to CFS Phase2 - 13-Mar-2018*/


        -- Tax Number --
        BEGIN
            -- START : Modified for CFS Project.
            -----------------
            -- Customer VAT #
            -----------------
            SELECT TAX_REFERENCE
              INTO x_TAX_REF
              FROM zx_party_tax_profile pro, hz_cust_acct_sites_all sites, hz_cust_site_uses_all uses
             WHERE     pro.PARTY_TYPE_CODE = 'THIRD_PARTY_SITE'
                   AND pro.party_id = sites.PARTY_SITE_ID
                   AND sites.CUST_ACCT_SITE_ID = uses.CUST_ACCT_SITE_ID
                   AND uses.SITE_USE_CODE = 'SHIP_TO'
                   AND uses.site_use_id = p_ship_to_site_use_id
                   AND sites.CUST_ACCOUNT_ID = p_ship_to_customer_id;

            -- END : Modified for CFS Project.

            -- BEGIN : Added for CFS Project.
            IF x_TAX_REF IS NULL
            THEN
                -- END : Added for CFS Project.
                SELECT TAX_REFERENCE
                  INTO x_TAX_REF
                  FROM zx_party_tax_profile pro, hz_cust_acct_sites_all sites, hz_cust_site_uses_all uses
                 WHERE     pro.PARTY_TYPE_CODE = 'THIRD_PARTY_SITE'
                       AND pro.party_id = sites.PARTY_SITE_ID
                       AND sites.CUST_ACCT_SITE_ID = uses.CUST_ACCT_SITE_ID
                       AND uses.SITE_USE_CODE = 'BILL_TO'
                       AND uses.site_use_id = p_bill_to_site_use_id
                       AND sites.CUST_ACCOUNT_ID = p_bill_to_customer_id;
            END IF;                                  -- Added for CFS Project.
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                x_TAX_REF   := NULL;
            WHEN OTHERS
            THEN
                x_TAX_REF   := NULL;
        END;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_emea_hdr_data:' || SQLERRM);
            NULL;
    END get_emea_hdr_data;

    ----
    ----
    PROCEDURE get_canada_tax (p_trx_id IN NUMBER, p_inv_item_id IN NUMBER, p_int_lin_att6 IN VARCHAR2, p_tax_type IN VARCHAR2, p_desc IN VARCHAR2, x_tax_amt OUT NUMBER
                              , x_tax_rate OUT NUMBER)
    IS
        ln_tax_amt    NUMBER;
        ln_tax_rate   NUMBER;
    BEGIN
        IF p_inv_item_id IS NOT NULL
        THEN
            SELECT NVL (SUM (T1.hst_amt), 0) cp_hst, NVL (MAX (T1.tax_rt), 0) cp_tax
              INTO ln_tax_amt, ln_tax_rate
              FROM (  SELECT rctl.inventory_item_id, SUM (NVL (rctl.quantity_invoiced, rctl.QUANTITY_CREDITED)) qty, SUM (NVL (rctl.extended_amount, 0)) Amount,
                             SUM (NVL (zl.tax_amt, 0)) hst_amt, MAX (NVL (zl.tax_rate, 0)) tax_rt
                        FROM apps.ra_customer_trx_lines_all rctl, apps.zx_lines zl
                       WHERE     1 = 1
                             AND rctl.customer_trx_id = P_trx_id
                             AND rctl.inventory_item_id = p_inv_item_id
                             AND rctl.interface_line_attribute6 =
                                 p_int_lin_att6
                             AND rctl.line_type IN ('LINE', 'CB')
                             AND zl.internal_organization_id = rctl.org_id
                             AND zl.trx_id = rctl.customer_trx_id
                             AND zl.trx_line_id = rctl.customer_trx_line_id
                             AND zl.legal_justification_text1 = p_tax_type
                    GROUP BY rctl.inventory_item_id) T1,
                   (  SELECT rctl.inventory_item_id, SUM (NVL (rctl.quantity_invoiced, rctl.QUANTITY_CREDITED)) qty, SUM (NVL (rctl.extended_amount, 0)) Amount,
                             SUM (NVL (zl.tax_amt, 0)) hst_amt, MAX (NVL (zl.tax_rate, 0)) tax_rt
                        FROM apps.ra_customer_trx_lines_all rctl, apps.zx_lines zl
                       WHERE     rctl.customer_trx_id = P_trx_id
                             AND rctl.inventory_item_id = p_inv_item_id
                             AND rctl.interface_line_attribute6 =
                                 p_int_lin_att6
                             AND zl.internal_organization_id = rctl.org_id
                             AND zl.trx_id = rctl.customer_trx_id
                             AND zl.trx_line_id = rctl.customer_trx_line_id
                             AND zl.legal_justification_text1 = p_tax_type
                             AND rctl.line_type IN ('LINE', 'CB')
                             AND rctl.interface_line_attribute11 <> '0'
                             AND rctl.interface_line_context = 'ORDER ENTRY'
                    GROUP BY rctl.inventory_item_id, rctl.interface_line_context)
                   T2
             WHERE     T1.inventory_item_id = T2.inventory_item_id(+)
                   AND NVL (T1.Amount, 0) + NVL (T2.Amount, 0) <> 0;
        ELSE
            SELECT NVL (SUM (T1.hst_amt), 0) cp_hst, NVL (MAX (T1.tax_rt), 0) cp_tax
              INTO ln_tax_amt, ln_tax_rate
              FROM (SELECT NULL sze, SUM (NVL (rctl.quantity_invoiced, rctl.QUANTITY_CREDITED)) qty, SUM (NVL (rctl.extended_amount, 0)) Amount,
                           SUM (NVL (zl.tax_amt, 0)) hst_amt, MAX (NVL (zl.tax_rate, 0)) tax_rt
                      FROM apps.ra_customer_trx_lines_all rctl, apps.zx_lines zl
                     WHERE     rctl.customer_trx_id = p_trx_id
                           AND rctl.line_type IN ('LINE', 'CB')
                           AND zl.internal_organization_id = rctl.org_id
                           AND zl.trx_id = rctl.customer_trx_id
                           AND zl.trx_line_id = rctl.customer_trx_line_id
                           AND zl.legal_justification_text1 = p_tax_type
                           AND rctl.inventory_item_id IS NULL
                           AND rctl.description = p_desc) T1,
                   (SELECT NULL sze, SUM (NVL (rctl.quantity_invoiced, rctl.QUANTITY_CREDITED)) qty, SUM (NVL (rctl.extended_amount, 0)) Amount,
                           SUM (NVL (zl.tax_amt, 0)) hst_amt, MAX (NVL (zl.tax_rate, 0)) tax_rt
                      FROM apps.ra_customer_trx_lines_all rctl, apps.zx_lines zl
                     WHERE     rctl.customer_trx_id = p_trx_id
                           AND zl.internal_organization_id = rctl.org_id
                           AND zl.trx_id = rctl.customer_trx_id
                           AND zl.trx_line_id = rctl.customer_trx_line_id
                           AND zl.legal_justification_text1 = p_tax_type
                           AND rctl.line_type IN ('LINE', 'CB')
                           AND rctl.interface_line_attribute11 <> '0'
                           AND rctl.interface_line_context = 'ORDER ENTRY'
                           AND rctl.inventory_item_id IS NULL
                           AND rctl.description = p_desc) T2
             WHERE NVL (T1.Amount, 0) + NVL (T2.Amount, 0) <> 0;
        END IF;

        x_tax_amt    := ln_tax_amt;
        x_tax_rate   := ln_tax_rate;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_canada_tax:' || SQLERRM);
            x_tax_amt    := 0;
            x_tax_rate   := NULL;
    END get_canada_tax;

    ----
    ----
    PROCEDURE get_line_data (p_style IN VARCHAR2, p_color IN VARCHAR2, p_size IN VARCHAR2, p_cust_trx_id IN NUMBER, p_tax_rec IN VARCHAR2, --p_cust_trx_line_id  IN     NUMBER,
                                                                                                                                           p_inventory_item_id IN NUMBER, p_int_line_att6 IN VARCHAR2, x_qty_sum OUT NUMBER, x_line_amt OUT NUMBER, x_unit_price OUT NUMBER, x_unit_price_list OUT NUMBER, x_disc_percent OUT NUMBER
                             , x_tax_yn OUT VARCHAR2)
    IS
    BEGIN
        --print_log('Style:'||p_style||' Color:'||p_color||' Size:'||p_size);
        IF p_style IS NOT NULL AND p_color IS NOT NULL
        THEN
            SELECT SUM (DECODE (T1.QTY - NVL (T2.QTY, 0), 0, T1.QTY, T1.QTY - NVL (T2.QTY, 0))) qty, SUM (T1.Amount) line_amt, ROUND (SUM (T1.Amount) / SUM (DECODE (T1.QTY - NVL (T2.QTY, 0), 0, T1.QTY, T1.QTY - NVL (T2.QTY, 0))), 2) unit_price,
                   ROUND (SUM (T1.Amount - NVL (T2.Amount, 0)) / SUM (DECODE (T1.QTY - NVL (T2.QTY, 0), 0, T1.QTY, T1.QTY - NVL (T2.QTY, 0))), 2) unit_price_list, ROUND (DECODE (SUM (t1.amount) - SUM (t2.amount), 0, 0, SUM (t2.amount) / (SUM (t1.amount) - SUM (t2.amount)) * -1) * 100, 2) disc_pct, DECODE (p_tax_rec, NULL, 'T0', 'T1') Tax_YN
              INTO x_qty_sum, x_line_amt, x_unit_price, x_unit_price_list,
                            x_disc_percent, x_tax_yn
              FROM (  SELECT msib.item_size SZE, SUM (NVL (rctl.quantity_invoiced, rctl.quantity_credited)) qty, SUM (NVL (rctl.extended_amount, 0)) Amount,
                             NVL (SUM (rctl.tax_recoverable), 0) tamt
                        FROM apps.ra_customer_trx_lines_all rctl,
                             apps.xxd_common_items_v msib,
                             (  SELECT customer_trx_id, --tax_rate, --Commented on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id
                                  FROM apps.ra_customer_trx_lines_all rctl_tax
                                 WHERE     rctl_tax.line_type = 'TAX'
                                       AND NVL (rctl_tax.tax_rate, 0) <> 0
                              GROUP BY customer_trx_id, --Added on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id --Added on 16Jan2018 by Kranthi Bollam
                                                                                )
                             trx_tax_rate
                       WHERE     1 = 1
                             AND rctl.customer_trx_id =
                                 trx_tax_rate.customer_trx_id(+) --Added outer join on 23Jan2018 by Kranthi Bollam
                             AND rctl.customer_trx_line_id =
                                 trx_tax_rate.link_to_cust_trx_line_id(+) --Added outer join on 23Jan2018 by Kranthi Bollam
                             AND msib.inventory_item_id =
                                 rctl.inventory_item_id
                             --AND msib.style_number = p_style--Commented for CCR0007216
                             --AND msib.color_desc              = p_color
                             --AND msib.color_code = p_color--Commented for CCR0007216
                             --AND msib.item_size = p_size--Commented for CCR0007216
                             --AND rctl.customer_trx_line_id = p_cust_trx_line_id --Added for
                             AND rctl.inventory_item_id = p_inventory_item_id
                             AND rctl.interface_line_attribute6 =
                                 p_int_line_att6
                             AND rctl.line_type = 'LINE'
                             AND msib.organization_id =
                                 NVL (rctl.warehouse_id, 7)
                             --AND NVL (rctl.tax_recoverable, 0) <> 0 --Commented on 23Jan2018 by Kranthi Bollam
                             AND rctl.customer_trx_id = p_cust_trx_id
                    GROUP BY msib.style_number, --msib.color_desc ,
                                                msib.color_code, msib.item_size,
                             msib.item_description, rctl.interface_line_context)
                   T1,
                   (  SELECT msib.item_size SZE, SUM (NVL (rctl.quantity_invoiced, rctl.quantity_credited)) qty, SUM (NVL (rctl.extended_amount, 0)) Amount,
                             NVL (SUM (rctl.tax_recoverable), 0) tamt
                        FROM apps.ra_customer_trx_lines_all rctl,
                             apps.xxd_common_items_v msib,
                             (  SELECT customer_trx_id, --tax_rate,  --Commented on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id
                                  FROM apps.ra_customer_trx_lines_all rctl_tax
                                 WHERE     rctl_tax.line_type = 'TAX'
                                       AND NVL (rctl_tax.tax_rate, 0) <> 0
                              GROUP BY customer_trx_id, --Added on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id --Added on 16Jan2018 by Kranthi Bollam
                                                                                )
                             trx_tax_rate
                       WHERE     1 = 1
                             AND rctl.customer_trx_id =
                                 trx_tax_rate.customer_trx_id(+) --Added outer join on 23Jan2018 by Kranthi Bollam
                             AND rctl.customer_trx_line_id =
                                 trx_tax_rate.link_to_cust_trx_line_id(+) --Added outer join on 23Jan2018 by Kranthi Bollam
                             AND msib.inventory_item_id =
                                 rctl.inventory_item_id
                             --AND msib.style_number = p_style --Commented for CCR0007216
                             --AND msib.color_desc              = p_color
                             --AND msib.color_code = p_color--Commented for CCR0007216
                             --AND msib.item_size = p_size--Commented for CCR0007216
                             --AND rctl.customer_trx_line_id = p_cust_trx_line_id --Added for CCR0007216
                             AND rctl.inventory_item_id = p_inventory_item_id
                             AND rctl.interface_line_attribute6 =
                                 p_int_line_att6
                             AND rctl.line_type = 'LINE'
                             AND msib.organization_id =
                                 NVL (rctl.warehouse_id, 7)
                             --AND NVL (rctl.tax_recoverable, 0) <> 0  --Commented on 23Jan2018 by Kranthi Bollam
                             AND rctl.interface_line_attribute11 <> '0'
                             AND rctl.interface_line_context = 'ORDER ENTRY'
                             AND rctl.customer_trx_id = p_cust_trx_id
                    GROUP BY msib.style_number, --msib.color_desc ,
                                                msib.color_code, msib.item_size,
                             msib.item_description, rctl.interface_line_context)
                   T2
             WHERE T1.SZE = T2.SZE(+);
        ELSIF p_style IS NULL AND p_color IS NULL
        THEN
            SELECT SUM (DECODE (T1.QTY - NVL (T2.QTY, 0), 0, T1.QTY, T1.QTY - NVL (T2.QTY, 0))) qty, SUM (T1.Amount) line_amt, ROUND (SUM (T1.Amount) / SUM (DECODE (T1.QTY - NVL (T2.QTY, 0), 0, T1.QTY, T1.QTY - NVL (T2.QTY, 0))), 2) unit_price,
                   ROUND (SUM (T1.Amount - NVL (T2.Amount, 0)) / SUM (DECODE (T1.QTY - NVL (T2.QTY, 0), 0, T1.QTY, T1.QTY - NVL (T2.QTY, 0))), 2) unit_price_list, ROUND (DECODE (SUM (t1.amount) - SUM (t2.amount), 0, 0, SUM (t2.amount) / (SUM (t1.amount) - SUM (t2.amount)) * -1) * 100, 2) disc_pct, DECODE (p_tax_rec, NULL, 'T0', 'T1') Tax_YN
              INTO x_qty_sum, x_line_amt, x_unit_price, x_unit_price_list,
                            x_disc_percent, x_tax_yn
              FROM (  SELECT NULL sze, SUM (NVL (rctl.quantity_invoiced, rctl.quantity_credited)) qty, SUM (NVL (rctl.extended_amount, 0)) amount,
                             NVL (SUM (rctl.tax_recoverable), 0) tamt
                        FROM apps.ra_customer_trx_lines_all rctl,
                             (  SELECT customer_trx_id, --tax_rate, -- --Commented on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id
                                  FROM apps.ra_customer_trx_lines_all rctl_tax
                                 WHERE     rctl_tax.line_type = 'TAX'
                                       AND NVL (rctl_tax.tax_rate, 0) <> 0
                              GROUP BY customer_trx_id, --Added on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id --Added on 16Jan2018 by Kranthi Bollam
                                                                                )
                             trx_tax_rate
                       WHERE     1 = 1
                             AND rctl.customer_trx_id =
                                 trx_tax_rate.customer_trx_id(+) --Added outer join on 23Jan2018 by Kranthi Bollam
                             AND rctl.customer_trx_line_id =
                                 trx_tax_rate.link_to_cust_trx_line_id(+) --Added outer join on 23Jan2018 by Kranthi Bollam
                             AND rctl.line_type = 'LINE'
                             --AND NVL (rctl.tax_recoverable, 0) <> 0 --Commented on 23Jan2018 by Kranthi Bollam
                             AND rctl.customer_trx_id = p_cust_trx_id
                    GROUP BY rctl.interface_line_context) T1,
                   (  SELECT NULL sze, SUM (NVL (rctl.quantity_invoiced, rctl.quantity_credited)) qty, SUM (NVL (rctl.extended_amount, 0)) amount,
                             NVL (SUM (rctl.tax_recoverable), 0) tamt
                        FROM apps.ra_customer_trx_lines_all rctl,
                             (  SELECT customer_trx_id, --tax_rate,  --Commented on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id
                                  FROM apps.ra_customer_trx_lines_all rctl_tax
                                 WHERE     rctl_tax.line_type = 'TAX'
                                       AND NVL (rctl_tax.tax_rate, 0) <> 0
                              GROUP BY customer_trx_id, --Added on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id --Added on 16Jan2018 by Kranthi Bollam
                                                                                )
                             trx_tax_rate
                       WHERE     1 = 1
                             AND rctl.customer_trx_id =
                                 trx_tax_rate.customer_trx_id(+) --Added outer join on 23Jan2018 by Kranthi Bollam
                             AND rctl.customer_trx_line_id =
                                 trx_tax_rate.link_to_cust_trx_line_id(+) --Added outer join on 23Jan2018 by Kranthi Bollam
                             AND rctl.line_type = 'LINE'
                             --AND NVL (rctl.tax_recoverable, 0) <> 0 --Commented on 23Jan2018 by Kranthi Bollam
                             AND rctl.interface_line_attribute11 <> '0'
                             AND rctl.interface_line_context = 'ORDER ENTRY'
                             AND rctl.customer_trx_id = p_cust_trx_id
                    GROUP BY rctl.interface_line_context) T2
             WHERE NVL (T1.Amount, 0) + NVL (T2.Amount, 0) <> 0;
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log (
                   'Error in get_line_data for customer_trx_id:'
                || p_cust_trx_id
                || ' . Rrror is: '
                || SQLERRM);
            x_qty_sum           := 0;
            x_line_amt          := 0;
            x_unit_price        := 0;
            x_unit_price_list   := 0;
            x_disc_percent      := NULL;
            x_tax_yn            := 'T0';
    END get_line_data;

    ----
    ----
    PROCEDURE get_hcode (p_style IN VARCHAR2, p_language IN VARCHAR2, x_hcode OUT VARCHAR2
                         , x_origin OUT VARCHAR2)
    IS
        lv_hcode    VARCHAR2 (60);
        lv_origin   VARCHAR2 (60);
    BEGIN
        BEGIN
            SELECT harmonized_tariff_code
              INTO lv_hcode
              FROM do_custom.do_harmonized_tariff_codes
             WHERE style_number = p_style AND country = 'EU';
        EXCEPTION
            WHEN OTHERS
            THEN
                x_hcode   := NULL;
        END;

        IF LENGTH (lv_hcode) > 1
        THEN
            x_hcode   := lv_hcode;

            IF p_language = 'FR'
            THEN
                x_origin   := 'Origine: Chine';
            ELSIF p_language = 'DU'
            THEN
                x_origin   := 'Herkomst: China';
            ELSE
                x_origin   := 'Origin: China';
            END IF;
        ELSE
            x_hcode    := NULL;
            x_origin   := NULL;
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_hcode:' || SQLERRM);
            x_hcode    := NULL;
            x_origin   := NULL;
    END get_hcode;

    ----
    ----
    PROCEDURE emea_lang_code (p_org_id                IN     NUMBER,
                              p_bill_to_customer_id   IN     NUMBER,
                              p_bill_to_site_use_id   IN     NUMBER,
                              p_language              IN     VARCHAR2,
                              x_lang_code                OUT VARCHAR2)
    IS
        lv_lang_code   VARCHAR2 (10);
    BEGIN
        BEGIN
            SELECT sites.attribute9
              INTO lv_lang_code
              FROM hz_cust_accounts_all acct, hz_cust_acct_sites_all sites, hz_cust_site_uses_all uses
             WHERE     acct.cust_account_id = sites.cust_account_id
                   AND sites.cust_acct_site_id = uses.cust_acct_site_id
                   AND sites.org_id = p_org_id
                   AND sites.cust_account_id = p_bill_to_customer_id
                   AND sites.status = 'A'
                   AND uses.SITE_USE_CODE = 'BILL_TO'
                   AND uses.site_use_id = p_bill_to_site_use_id
                   AND uses.status = 'A';
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_lang_code   := NULL;
        END;

        IF lv_lang_code IS NULL
        THEN
            SELECT NVL (NVL (attribute17, p_language), 'US') country_code
              INTO lv_lang_code
              FROM hz_cust_accounts cust
             WHERE cust_account_id = p_bill_to_customer_id;
        END IF;

        IF    lv_lang_code = 'FR'
           OR lv_lang_code = 'F'
           OR lv_lang_code = 'fr_FR'
        THEN
            x_lang_code   := 'FR';
        ELSIF    lv_lang_code = 'BE'
              OR lv_lang_code = 'NL'
              OR lv_lang_code = 'DU'
        THEN
            x_lang_code   := 'DU';
        ELSIF lv_lang_code = 'DE' OR lv_lang_code = 'de_DE'
        THEN
            x_lang_code   := 'DE';
        ELSIF lv_lang_code = 'CH' OR lv_lang_code = 'it_IT'
        THEN
            x_lang_code   := 'CH';
        ELSE
            x_lang_code   := 'EN';
        END IF;
    EXCEPTION
        WHEN NO_DATA_FOUND
        THEN
            print_log ('Error in emea_lang_code:' || SQLERRM);
            x_lang_code   := NULL;
        WHEN OTHERS
        THEN
            print_log ('Error in emea_lang_code:' || SQLERRM);
            x_lang_code   := NULL;
    END emea_lang_code;

    ----
    ----
    PROCEDURE emea_line_type_amt (p_customer_trx_id IN NUMBER, p_org_id IN NUMBER, p_invoice_currency IN VARCHAR2, p_lang_code IN VARCHAR2, x_line_amt OUT VARCHAR2, x_nt_tqty OUT VARCHAR2, x_non_tax_amt OUT VARCHAR2, x_non_tax_text OUT VARCHAR2, x_c1 OUT VARCHAR2, x_t_tqty OUT VARCHAR2, x_tax_amt OUT VARCHAR2, x_tax_text OUT VARCHAR2, x_c2 OUT VARCHAR2, x_other_amt OUT VARCHAR2, x_tot_tax OUT VARCHAR2
                                  , x_trate OUT VARCHAR2, x_no_vat OUT VARCHAR2, x_tax_on_taxable_amt OUT VARCHAR2)
    IS
        lv_return        VARCHAR2 (50);
        lv_text1         VARCHAR2 (360);
        lv_text2         VARCHAR2 (360);
        ln_org           NUMBER;
        ln_round         NUMBER := 0;
        lv_ou_name       VARCHAR2 (240);
        ln_taxable_amt   NUMBER;
    BEGIN
        SELECT LTRIM (TO_CHAR (SUM (NVL (rctl.EXTENDED_AMOUNT, 0)), '999G999G990D00')) line_amt
          INTO x_line_amt
          FROM apps.ra_customer_trx_lines_all rctl
         WHERE rctl.customer_trx_id = p_customer_trx_id AND org_id = p_org_id;

        --Language
        IF p_lang_code = 'FR'
        THEN
            lv_text1   := 'Total - Non-Imposable (T0)';
            lv_text2   := 'Total H.T. (T1)';
        ELSIF p_lang_code = 'DU'
        THEN
            lv_text1   := 'Totaal - Niet-belastbare (T0)';
            lv_text2   := 'Totaal - Belastbare (T1)';
        ELSIF p_lang_code = 'DE'
        THEN
            lv_text1   := 'Bruttobetrag';
            lv_text2   := 'Nettobetrag';
        ELSIF p_lang_code = 'CH'
        THEN
            lv_text1   := 'Importo lordo';
            lv_text2   := 'Importo netto';
        ELSE
            lv_text1   := 'Total - Non Taxable Items (T0)';
            lv_text2   := 'Total - Taxable Items (T1)';
        END IF;

        -- Non Taxable Qty
        BEGIN
            SELECT NVL (t2_qty, 0) - NVL (t1_qty, 0)
              INTO x_nt_tqty
              FROM (  SELECT rctl.customer_trx_id, SUM (NVL (rctl.quantity_invoiced, quantity_credited)) t1_qty
                        FROM apps.ra_customer_trx_lines_all rctl,
                             (  SELECT customer_trx_id--,tax_rate --Commented on 16Jan2018 by Kranthi Bollam
                                                      , link_to_cust_trx_line_id
                                  FROM apps.ra_customer_trx_lines_all rctl_tax
                                 WHERE     rctl_tax.line_type = 'TAX'
                                       AND NVL (rctl_tax.tax_rate, 0) = 0 --Added on 16Jan2018 by Kranthi Bollam
                              GROUP BY customer_trx_id, --Added on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id --Added on 16Jan2018 by Kranthi Bollam
                                                                                )
                             trx_tax_rate
                       WHERE     rctl.customer_trx_id = p_customer_trx_id
                             AND rctl.line_type = 'LINE'
                             AND rctl.customer_trx_id =
                                 trx_tax_rate.customer_trx_id --(+) --Removed the Outer Join on 17Jan2018 by Kranthi Bollam
                             AND rctl.customer_trx_line_id =
                                 trx_tax_rate.link_to_cust_trx_line_id --(+) --Removed the Outer Join on 17Jan2018 by Kranthi Bollam
                             AND rctl.interface_line_attribute11 <> '0'
                    --AND NVL(trx_tax_rate.tax_rate, 0) = 0 --Commented on 16Jan2018 by Kranthi Bollam
                    GROUP BY rctl.customer_trx_id) T1,
                   (  SELECT rctl.customer_trx_id, SUM (NVL (rctl.quantity_invoiced, quantity_credited)) t2_qty
                        FROM apps.ra_customer_trx_lines_all rctl,
                             (  SELECT customer_trx_id--,tax_rate --Commented on 16Jan2018 by Kranthi Bollam
                                                      , link_to_cust_trx_line_id
                                  FROM apps.ra_customer_trx_lines_all rctl_tax
                                 WHERE     rctl_tax.line_type = 'TAX'
                                       AND NVL (rctl_tax.tax_rate, 0) = 0 --Added on 16Jan2018 by Kranthi Bollam
                              GROUP BY customer_trx_id, --Added on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id --Added on 16Jan2018 by Kranthi Bollam
                                                                                )
                             trx_tax_rate
                       WHERE     rctl.customer_trx_id = p_customer_trx_id
                             AND rctl.line_type = 'LINE'
                             AND rctl.customer_trx_id =
                                 trx_tax_rate.customer_trx_id --(+) --Removed the Outer Join on 17Jan2018 by Kranthi Bollam
                             AND rctl.customer_trx_line_id =
                                 trx_tax_rate.link_to_cust_trx_line_id --(+) --Removed the Outer Join on 17Jan2018 by Kranthi Bollam
                    --AND NVL(trx_tax_rate.tax_rate,0) = 0 --Commented on 16Jan2018 by Kranthi Bollam
                    GROUP BY rctl.customer_trx_id) T2
             WHERE t1.customer_trx_id(+) = t2.customer_trx_id;
        --            SELECT NVL (T2_QTY, 0) - NVL (T1_QTY, 0)
        --              INTO x_nt_tqty
        --              FROM (  SELECT rctl.customer_trx_id,
        --                             SUM (
        --                                 NVL (rctl.QUANTITY_INVOICED,
        --                                      QUANTITY_CREDITED))
        --                                 T1_QTY
        --                        FROM apps.ra_customer_trx_lines_all rctl,
        --                             (  SELECT customer_trx_id,
        --                                       tax_rate,
        --                                       link_to_cust_trx_line_id
        --                                  FROM apps.ra_customer_trx_lines_all rctl_tax
        --                                 WHERE     rctl_tax.line_type = 'TAX'
        --                                       AND NVL (rctl_tax.tax_rate, 0) = 0
        --                              GROUP BY customer_trx_id,
        --                                       tax_rate,
        --                                       link_to_cust_trx_line_id) trx_tax_rate
        --                       WHERE     rctl.customer_trx_id = p_customer_trx_id
        --                             AND rctl.line_type = 'LINE'
        --                             AND rctl.customer_trx_id =
        --                                 trx_tax_rate.customer_trx_id(+)
        --                             AND rctl.customer_trx_line_id =
        --                                 trx_tax_rate.link_to_cust_trx_line_id(+)
        --                             AND rctl.interface_line_attribute11 <> '0'
        --                             AND NVL (trx_tax_rate.tax_rate, 0) = 0
        --                    GROUP BY rctl.customer_trx_id) T1,
        --                   (  SELECT rctl.customer_trx_id,
        --                             SUM (
        --                                 NVL (rctl.QUANTITY_INVOICED,
        --                                      QUANTITY_CREDITED))
        --                                 T2_QTY
        --                        FROM apps.ra_customer_trx_lines_all rctl,
        --                             (  SELECT customer_trx_id,
        --                                       tax_rate,
        --                                       link_to_cust_trx_line_id
        --                                  FROM apps.ra_customer_trx_lines_all rctl_tax
        --                                 WHERE     rctl_tax.line_type = 'TAX'
        --                                       AND NVL (rctl_tax.tax_rate, 0) = 0
        --                              GROUP BY customer_trx_id,
        --                                       tax_rate,
        --                                       link_to_cust_trx_line_id) trx_tax_rate
        --                       WHERE     rctl.customer_trx_id = p_customer_trx_id
        --                             AND rctl.line_type = 'LINE'
        --                             AND rctl.customer_trx_id =
        --                                 trx_tax_rate.customer_trx_id(+)
        --                             AND rctl.customer_trx_line_id =
        --                                 trx_tax_rate.link_to_cust_trx_line_id(+)
        --                             AND NVL (trx_tax_rate.tax_rate, 0) = 0
        --                    GROUP BY rctl.customer_trx_id) T2
        --             WHERE t1.customer_trx_id(+) = t2.customer_trx_id;
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                x_nt_tqty   := NULL;
            WHEN OTHERS
            THEN
                x_nt_tqty   := NULL;
        END;

        -- Non taxable Items
        BEGIN
            SELECT LTRIM (TO_CHAR (NVL (SUM (NVL (rctl.EXTENDED_AMOUNT, 0)), 0), '999G999G990D00')) line_amt, lv_text1 Non_Tax_Text, p_invoice_currency curr1
              INTO x_non_tax_amt, x_non_tax_text, x_c1
              FROM apps.ra_customer_trx_lines_all rctl,
                   (  SELECT customer_trx_id--,tax_rate --Commented on 16Jan2018 by Kranthi Bollam
                                            , link_to_cust_trx_line_id
                        FROM apps.ra_customer_trx_lines_all rctl_tax
                       WHERE     rctl_tax.line_type = 'TAX'
                             AND NVL (rctl_tax.tax_rate, 0) = 0
                    GROUP BY customer_trx_id, --Added on 16Jan2018 by Kranthi Bollam
                                              link_to_cust_trx_line_id --Added on 16Jan2018 by Kranthi Bollam
                                                                      )
                   trx_tax_rate
             WHERE     rctl.customer_trx_id = p_customer_trx_id
                   AND rctl.line_type = 'LINE'
                   AND rctl.customer_trx_id = trx_tax_rate.customer_trx_id --(+) --Removed the Outer Join on 17Jan2018 by Kranthi Bollam
                   AND rctl.customer_trx_line_id =
                       trx_tax_rate.link_to_cust_trx_line_id --(+) --Removed the Outer Join on 17Jan2018 by Kranthi Bollam
                                                            --AND NVL(trx_tax_rate.tax_rate, 0) = 0 --Commented on 16Jan2018 by Kranthi Bollam
                                                            ;

            --            SELECT LTRIM (
            --                       TO_CHAR (NVL (SUM (NVL (rctl.EXTENDED_AMOUNT, 0)), 0),
            --                                '999G999G990D00'))
            --                       line_amt,
            --                   lv_text1
            --                       Non_Tax_Text,
            --                   p_invoice_currency
            --                       curr1
            --              INTO x_non_tax_amt, x_non_tax_text, x_c1
            --              FROM apps.ra_customer_trx_lines_all  rctl,
            --                   (  SELECT customer_trx_id,
            --                             tax_rate,
            --                             link_to_cust_trx_line_id
            --                        FROM apps.ra_customer_trx_lines_all rctl_tax
            --                       WHERE     rctl_tax.line_type = 'TAX'
            --                             AND NVL (rctl_tax.tax_rate, 0) = 0
            --                    GROUP BY customer_trx_id,
            --                             tax_rate,
            --                             link_to_cust_trx_line_id) trx_tax_rate
            --             WHERE     rctl.customer_trx_id = p_customer_trx_id
            --                   AND rctl.line_type = 'LINE'
            --                   AND rctl.customer_trx_id = trx_tax_rate.customer_trx_id(+)
            --                   AND rctl.customer_trx_line_id =
            --                       trx_tax_rate.link_to_cust_trx_line_id(+)
            --                   AND NVL (trx_tax_rate.tax_rate, 0) = 0;

            IF x_non_tax_amt = '0,00' OR x_non_tax_amt = '0.00'
            THEN
                x_non_tax_amt    := NULL;
                x_non_tax_text   := NULL;
                x_c1             := NULL;
                x_nt_tqty        := NULL;
            END IF;
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                x_non_tax_amt    := NULL;
                x_non_tax_text   := NULL;
                x_c1             := NULL;
                x_nt_tqty        := NULL;
            WHEN OTHERS
            THEN
                x_non_tax_amt    := NULL;
                x_non_tax_text   := NULL;
                x_c1             := NULL;
                x_nt_tqty        := NULL;
        END;

        -- Taxable Qty
        BEGIN
            SELECT NVL (T2_QTY, 0) - NVL (T1_QTY, 0)
              INTO x_t_tqty
              FROM (  SELECT rctl.customer_trx_id, SUM (NVL (rctl.quantity_invoiced, quantity_credited)) T1_QTY
                        FROM apps.ra_customer_trx_lines_all rctl,
                             (  SELECT customer_trx_id, --tax_rate, --Commented on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id
                                  FROM apps.ra_customer_trx_lines_all rctl_tax
                                 WHERE     rctl_tax.line_type = 'TAX'
                                       AND NVL (rctl_tax.tax_rate, 0) <> 0
                              GROUP BY customer_trx_id, --Added on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id --Added on 16Jan2018 by Kranthi Bollam
                                                                                )
                             trx_tax_rate
                       WHERE     rctl.customer_trx_id = p_customer_trx_id
                             AND rctl.line_type = 'LINE'
                             AND rctl.customer_trx_id =
                                 trx_tax_rate.customer_trx_id --(+)  --Removed the Outer Join on 17Jan2018 by Kranthi Bollam
                             AND rctl.customer_trx_line_id =
                                 trx_tax_rate.link_to_cust_trx_line_id --(+)  --Removed the Outer Join on 17Jan2018 by Kranthi Bollam
                             AND rctl.interface_line_attribute11 <> '0'
                    GROUP BY rctl.customer_trx_id) T1,
                   (  SELECT rctl.customer_trx_id, SUM (NVL (rctl.quantity_invoiced, quantity_credited)) T2_QTY
                        FROM apps.ra_customer_trx_lines_all rctl,
                             (  SELECT customer_trx_id, --tax_rate, --Commented on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id
                                  FROM apps.ra_customer_trx_lines_all rctl_tax
                                 WHERE     rctl_tax.line_type = 'TAX'
                                       AND NVL (rctl_tax.tax_rate, 0) <> 0
                              GROUP BY customer_trx_id, --Added on 16Jan2018 by Kranthi Bollam
                                                        link_to_cust_trx_line_id --Added on 16Jan2018 by Kranthi Bollam
                                                                                )
                             trx_tax_rate
                       WHERE     rctl.customer_trx_id = p_customer_trx_id
                             AND rctl.line_type = 'LINE'
                             AND rctl.customer_trx_id =
                                 trx_tax_rate.customer_trx_id --(+)  --Removed the Outer Join on 17Jan2018 by Kranthi Bollam
                             AND rctl.customer_trx_line_id =
                                 trx_tax_rate.link_to_cust_trx_line_id --(+) --Removed the Outer Join on 17Jan2018 by Kranthi Bollam
                    GROUP BY rctl.customer_trx_id) T2
             WHERE t1.customer_trx_id(+) = t2.customer_trx_id;
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                x_t_tqty   := NULL;
            WHEN OTHERS
            THEN
                x_t_tqty   := NULL;
        END;

        --  Taxable Items
        BEGIN
            SELECT LTRIM (TO_CHAR (NVL (SUM (NVL (rctl.extended_amount, 0)), 0), '999G999G990D00')) line_amt, NVL (SUM (rctl.extended_amount), 0) Taxable_Amt, NVL (SUM (trx_tax_rate.extended_amount), 0) tax_on_Taxable_Amt --Added by Kranthi
              INTO x_tax_amt, ln_taxable_amt, x_tax_on_taxable_amt
              FROM apps.ra_customer_trx_lines_all rctl,
                   (  SELECT customer_trx_id, --tax_rate, --Commented on 16Jan2018 by Kranthi Bollam
                                              link_to_cust_trx_line_id, SUM (extended_amount) extended_amount -- Added by Kranthi
                        FROM apps.ra_customer_trx_lines_all rctl_tax
                       WHERE     rctl_tax.line_type = 'TAX'
                             AND NVL (rctl_tax.tax_rate, 0) <> 0
                    GROUP BY customer_trx_id, --Added on 16Jan2018 by Kranthi Bollam
                                              link_to_cust_trx_line_id --Added on 16Jan2018 by Kranthi Bollam
                                                                      )
                   trx_tax_rate
             WHERE     rctl.customer_trx_id = p_customer_trx_id
                   AND rctl.line_type = 'LINE'
                   AND rctl.customer_trx_id = trx_tax_rate.customer_trx_id
                   AND rctl.customer_trx_line_id =
                       trx_tax_rate.link_to_cust_trx_line_id;

            --and nvl(RCTL.TAX_RECOVERABLE,0) <> 0;
            IF ln_taxable_amt = 0
            THEN
                x_tax_amt              := NULL;
                x_tax_text             := NULL;
                x_c2                   := NULL;
                x_t_tqty               := NULL;
                x_tax_on_taxable_amt   := NULL;
            ELSIF ln_taxable_amt <> 0
            THEN
                x_tax_text   := lv_text2;
                x_c2         := p_invoice_currency;
            END IF;
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                x_tax_amt    := NULL;
                x_tax_text   := NULL;
                x_c2         := NULL;
                x_t_tqty     := NULL;
            WHEN OTHERS
            THEN
                x_tax_amt    := NULL;
                x_tax_text   := NULL;
                x_c2         := NULL;
                x_t_tqty     := NULL;
        END;

        BEGIN
            SELECT LTRIM (TO_CHAR (NVL (SUM (NVL (rctl.extended_amount, 0)), 0), '999G999G990D00')) line_amt, NVL (SUM (rctl.extended_amount), 0) Total_Tax, NVL (APPS.FND_PROFILE.VALUE ('XXDOAR005_UK_TAX_RATE_ROUNDING'), 0)
              INTO x_other_amt, x_tot_tax, ln_round
              FROM apps.ra_customer_trx_lines_all rctl
             WHERE     rctl.customer_trx_id = p_customer_trx_id
                   AND rctl.line_type = 'TAX';
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                x_other_amt   := 0;
                x_tot_tax     := 0;
                ln_round      := 2;
            WHEN OTHERS
            THEN
                x_other_amt   := 0;
                x_tot_tax     := 0;
                ln_round      := 2;
        END;

        SELECT name
          INTO lv_ou_name
          FROM hr_operating_units
         WHERE organization_id = p_org_id;

        IF x_tot_tax <> 0
        THEN
            x_trate   :=
                   ROUND ((x_tot_tax / NVL (ln_taxable_amt, 1)) * 100,
                          NVL (ln_round, 0))
                || '%';

            IF NVL (ln_round, 0) = 2
            THEN
                x_trate   :=
                    REPLACE (
                        TRIM (
                            TO_CHAR (
                                ROUND (
                                      (x_tot_tax / NVL (ln_taxable_amt, 1))
                                    * 100,
                                    2),
                                '99D00')),
                        '.00',
                        '');
                x_trate   := REPLACE (x_trate, ',00', '') || '%';
            END IF;
        ELSE
            x_trate   := NULL;

            IF lv_ou_name = 'Deckers France SAS OU'
            THEN
                x_no_vat   := 'TVA non applicable article 262 TER du CGI';
            ELSE
                x_no_vat   := NULL;
            END IF;
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in emea_line_type_amt:' || SQLERRM);
            NULL;
    END emea_line_type_amt;

    ----
    ----
    PROCEDURE get_stmt_buckets (p_bucket_name IN VARCHAR2, x_bucket_line_type_0 OUT VARCHAR2, x_bucket_line_type_1 OUT VARCHAR2, x_bucket_line_type_2 OUT VARCHAR2, x_bucket_line_type_3 OUT VARCHAR2, x_bucket_line_type_4 OUT VARCHAR2, x_bucket_line_type_5 OUT VARCHAR2, x_bucket_line_type_6 OUT VARCHAR2, x_bucket_days_from_0 OUT NUMBER, x_bucket_days_from_1 OUT NUMBER, x_bucket_days_from_2 OUT NUMBER, x_bucket_days_from_3 OUT NUMBER, x_bucket_days_from_4 OUT NUMBER, x_bucket_days_from_5 OUT NUMBER, x_bucket_days_from_6 OUT NUMBER, x_bucket_days_to_0 OUT NUMBER, x_bucket_days_to_1 OUT NUMBER, x_bucket_days_to_2 OUT NUMBER, x_bucket_days_to_3 OUT NUMBER, x_bucket_days_to_4 OUT NUMBER, x_bucket_days_to_5 OUT NUMBER, x_bucket_days_to_6 OUT NUMBER, x_bucket_category OUT VARCHAR2, x_bucket_heading_0 OUT VARCHAR2, x_bucket_heading_1 OUT VARCHAR2, x_bucket_heading_2 OUT VARCHAR2, x_bucket_heading_3 OUT VARCHAR2
                                , x_bucket_heading_4 OUT VARCHAR2, x_bucket_heading_5 OUT VARCHAR2, x_bucket_heading_6 OUT VARCHAR2)
    IS
        CURSOR buck_cur IS
              SELECT days_start, days_to, report_heading1,
                     report_heading2, TYPE
                FROM ar_aging_bucket_lines lines, ar_aging_buckets buckets
               WHERE     1 = 1
                     AND lines.aging_bucket_id = buckets.aging_bucket_id
                     AND UPPER (buckets.bucket_name) = UPPER (p_bucket_name)
                     AND NVL (buckets.status, 'A') = 'A'
            ORDER BY lines.bucket_sequence_num;

        i   NUMBER (1) := 0;
    BEGIN
        FOR buck_rec IN buck_cur
        LOOP
            IF i = 0
            THEN
                x_bucket_line_type_0   := buck_rec.TYPE;
                x_bucket_days_from_0   := buck_rec.days_start;
                x_bucket_days_to_0     := buck_rec.days_to;
                x_bucket_heading_0     :=
                       buck_rec.report_heading1
                    || ' '
                    || buck_rec.report_heading2;
            END IF;

            IF i = 1
            THEN
                x_bucket_line_type_1   := buck_rec.TYPE;
                x_bucket_days_from_1   := buck_rec.days_start;
                x_bucket_days_to_1     := buck_rec.days_to;
                x_bucket_heading_1     :=
                       buck_rec.report_heading1
                    || ' '
                    || buck_rec.report_heading2;
            END IF;

            IF i = 2
            THEN
                x_bucket_line_type_2   := buck_rec.TYPE;
                x_bucket_days_from_2   := buck_rec.days_start;
                x_bucket_days_to_2     := buck_rec.days_to;
                x_bucket_heading_2     :=
                       buck_rec.report_heading1
                    || ' '
                    || buck_rec.report_heading2;
            END IF;

            IF i = 3
            THEN
                x_bucket_line_type_3   := buck_rec.TYPE;
                x_bucket_days_from_3   := buck_rec.days_start;
                x_bucket_days_to_3     := buck_rec.days_to;
                x_bucket_heading_3     :=
                       buck_rec.report_heading1
                    || ' '
                    || buck_rec.report_heading2;
            END IF;

            IF i = 4
            THEN
                x_bucket_line_type_4   := buck_rec.TYPE;
                x_bucket_days_from_4   := buck_rec.days_start;
                x_bucket_days_to_4     := buck_rec.days_to;
                x_bucket_heading_4     :=
                       buck_rec.report_heading1
                    || ' '
                    || buck_rec.report_heading2;
            END IF;

            IF i = 5
            THEN
                x_bucket_line_type_5   := buck_rec.TYPE;
                x_bucket_days_from_5   := buck_rec.days_start;
                x_bucket_days_to_5     := buck_rec.days_to;
                x_bucket_heading_5     :=
                       buck_rec.report_heading1
                    || ' '
                    || buck_rec.report_heading2;
            END IF;

            IF i = 6
            THEN
                x_bucket_line_type_6   := buck_rec.TYPE;
                x_bucket_days_from_6   := buck_rec.days_start;
                x_bucket_days_to_6     := buck_rec.days_to;
                x_bucket_heading_6     :=
                       buck_rec.report_heading1
                    || ' '
                    || buck_rec.report_heading2;
            END IF;

            IF    (buck_rec.TYPE = 'DISPUTE_ONLY')
               OR (buck_rec.TYPE = 'PENDADJ_ONLY')
               OR (buck_rec.TYPE = 'DISPUTE_PENDADJ')
            THEN
                x_bucket_category   := buck_rec.TYPE;
            END IF;

            i   := i + 1;
        END LOOP;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_stmt_buckets:' || SQLERRM);
    END get_stmt_buckets;

    ----
    ----
    PROCEDURE get_soa_hdr_details (p_org_id IN NUMBER, p_customer_id IN NUMBER, p_customer_name IN VARCHAR2, x_ou_name OUT VARCHAR2, x_brand_name OUT VARCHAR2, x_lang_code OUT VARCHAR2, x_email_to OUT VARCHAR2, x_email_from OUT VARCHAR2, x_print_flag OUT VARCHAR2
                                   , x_email_flag OUT VARCHAR2)
    IS
        CURSOR c_email_address (p_cust_account_id NUMBER)
        IS
            SELECT DISTINCT hcp.email_address --hps.PARTY_ID,hcas.CUST_ACCOUNT_ID,hcas.CUST_ACCT_SITE_ID,hcas.party_site_id, hcp.email_address
              --Added "DISTINCT" in the SELECT for CCR0007216
              FROM hz_cust_accounts_all hca, hz_contact_points hcp, HZ_CUST_ACCOUNT_ROLES har,
                   HZ_ROLE_RESPONSIBILITY hrr
             WHERE     1 = 1
                   AND har.party_id = hcp.owner_table_id
                   AND hcp.owner_table_name = 'HZ_PARTIES'
                   AND hcp.contact_point_type = 'EMAIL'
                   AND hcp.status = 'A'
                   AND hca.CUST_ACCOUNT_ID = har.CUST_ACCOUNT_ID
                   AND har.CUST_ACCOUNT_ROLE_ID = hrr.CUST_ACCOUNT_ROLE_ID
                   AND hrr.RESPONSIBILITY_TYPE = 'STMTS'
                   AND hca.CUST_ACCOUNT_ID = p_cust_account_id
                   AND har.current_role_state = 'A'
                   AND hcp.status = 'A'                 --Added for CCR0007216
                   AND hcp.email_address LIKE '%@%'     --Added for CCR0007216
                                                   ;

        lv_email_to        VARCHAR2 (360);
        lv_attribute6      VARCHAR2 (30);
        lv_brand           VARCHAR2 (30);
        lv_country         VARCHAR2 (30);
        lv_name            VARCHAR2 (120);
        lv_ship_country    VARCHAR2 (30);
        lv_brand1          VARCHAR2 (30);
        lv_support_email   VARCHAR2 (150);
        lv_language        VARCHAR2 (30);
        lv_email_from      VARCHAR2 (150);
    BEGIN
        --Get Country, OU Name
        BEGIN
            SELECT country, name
              INTO lv_country, lv_name
              FROM hr_organization_units_v
             WHERE organization_id = p_org_id;
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_country   := NULL;
                lv_name      := NULL;
        END;


        --Get Brand
        BEGIN
            SELECT NVL (hzc.attribute1, NULL)
              INTO lv_brand
              -- Start changes for CCR0009748
              -- FROM hz_cust_accounts hzc, hz_parties hzp
              -- WHERE     hzc.party_id = hzp.party_id
              --      AND hzp.party_name = p_customer_name
              FROM hz_cust_accounts hzc
             WHERE     1 = 1
                   -- End changes for CCR0009748
                   AND hzc.cust_account_id = p_customer_id
                   AND ROWNUM = 1;
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_brand   := NULL;
        END;

        --GET SHIP COUNTRY
        BEGIN
            -- Start changes for CCR0009748
            /*SELECT NVL (loc.country, NULL)
              INTO lv_ship_country
              FROM apps.hz_party_sites          psites,
                   apps.hz_locations            loc,
                   apps.hz_cust_acct_sites_all  sites,
                   apps.hz_cust_site_uses_all   uses,
                   apps.hz_cust_accounts        cust_acct,
                   apps.hz_parties              party
             WHERE     sites.party_site_id = psites.party_site_id
                   AND loc.location_id = psites.location_id
                   AND sites.cust_account_id = p_customer_id
                   AND sites.cust_acct_site_id = uses.cust_acct_site_id
                   AND sites.org_id = p_org_id
                   AND sites.cust_account_id = cust_acct.cust_account_id
                   AND cust_acct.party_id = party.party_id
                   AND uses.status = 'A'
                   AND uses.PRIMARY_FLAG = 'Y'
                   AND uses.SITE_USE_CODE = 'BILL_TO';*/

            SELECT NVL (loc.country, NULL)
              INTO lv_ship_country
              FROM apps.hz_party_sites psites, apps.hz_locations loc, apps.hz_cust_acct_sites_all sites,
                   apps.hz_cust_accounts cust_acct
             WHERE     sites.party_site_id = psites.party_site_id
                   AND loc.location_id = psites.location_id
                   AND sites.cust_account_id = cust_acct.cust_account_id
                   AND sites.status = 'A'
                   AND sites.bill_to_flag = 'P'
                   AND sites.org_id = p_org_id
                   AND sites.cust_account_id = p_customer_id;
        -- End changes for CCR0009748
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_ship_country   := NULL;
        END;

        --Get To email Addresses
        FOR i IN c_email_address (p_customer_id)
        LOOP
            lv_email_to   := i.email_address || ',' || lv_email_to;
        END LOOP;

        lv_email_to    := SUBSTR (lv_email_to, 0, LENGTH (lv_email_to) - 1);

        BEGIN
            -- Start changes for CCR0009748
            /*SELECT psites.attribute6
              INTO lv_attribute6
              FROM apps.hz_party_sites          psites,
                   apps.hz_locations            loc,
                   apps.hz_cust_acct_sites_all  sites,
                   apps.hz_cust_site_uses_all   uses,
                   apps.hz_cust_accounts        cust_acct,
                   apps.hz_parties              party
             WHERE     sites.party_site_id = psites.party_site_id
                   AND loc.location_id = psites.location_id
                   AND sites.cust_account_id = p_customer_id
                   AND sites.cust_acct_site_id = uses.cust_acct_site_id
                   AND sites.org_id = p_org_id
                   AND sites.cust_account_id = cust_acct.cust_account_id
                   AND cust_acct.party_id = party.party_id
                   AND uses.status = 'A'
                   AND uses.PRIMARY_FLAG = 'Y'
                   AND uses.SITE_USE_CODE = 'BILL_TO';*/

            SELECT psites.attribute6
              INTO lv_attribute6
              FROM apps.hz_party_sites psites, apps.hz_cust_acct_sites_all sites, apps.hz_cust_accounts cust_acct
             WHERE     sites.party_site_id = psites.party_site_id
                   AND sites.cust_account_id = cust_acct.cust_account_id
                   AND sites.status = 'A'
                   AND sites.bill_to_flag = 'P'
                   AND sites.org_id = p_org_id
                   AND sites.cust_account_id = p_customer_id;
        -- End changes for CCR0009748
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_attribute6   := NULL;
        END;

        IF NVL (lv_attribute6, '0') IN ('1')                          -- Print
        THEN
            x_print_flag   := 'Y';
        ELSIF NVL (lv_attribute6, '0') IN ('2')
        THEN                                                          -- Email
            x_email_flag   := 'Y';
        ELSIF NVL (lv_attribute6, '0') IN ('3')
        THEN                                                            --Both
            x_print_flag   := 'Y';
            x_email_flag   := 'Y';
        ELSE
            lv_email_to    := NULL;
            x_print_flag   := 'N';
            x_email_flag   := 'N';
        END IF;

        BEGIN
            SELECT                                               --attribute1,
                                                                 --attribute2,
                                                                 --attribute3,
                                                                 --attribute4,
                  attribute5, attribute6, --attribute7,
                                          attribute8,
                  --attribute9,
                  --attribute10,
                  --attribute11,
                  --attribute12,
                  --attribute13,
                  attribute14
             INTO                                          --l_seling_entinty,
                  --l_ship_to_country,
                  --l_ou,
                  --l_cfd_type,
                   lv_brand1, lv_support_email, --l_terms,
                                                lv_email_from, --l_email_subject,
                                                               --l_email_body,
                                                               --l_company_chop,
                                                               --l_company_logo,
                                                               --l_footer_image,
                                                               lv_language
             FROM fnd_lookup_values
            WHERE     LOOKUP_TYPE = 'XXDO_CUST_FAC_DOC_LKP'
                  AND language = USERENV ('LANG')
                  AND enabled_flag = 'Y'
                  AND attribute5 = lv_brand
                  AND attribute3 = p_org_id
                  AND attribute1 = lv_country
                  AND attribute2 = lv_country
                  AND attribute4 = 'SOA'
                  AND NVL (attribute7, 'N') = 'Y';
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                BEGIN
                    SELECT                                       --attribute1,
                                                                 --attribute2,
                                                                 --attribute3,
                                                                 --attribute4,
                          attribute5, attribute6, --attribute7,
                                                  attribute8,
                          --attribute9,
                          --attribute10,
                          --attribute11,
                          --attribute12,
                          --attribute13,
                          attribute14
                     INTO                                  --l_seling_entinty,
                          --l_ship_to_country,
                          --l_ou,
                          --l_cfd_type,
                           lv_brand1, lv_support_email, --l_terms,
                                                        lv_email_from, --l_email_subject,
                                                                       --l_email_body,
                                                                       --l_company_chop,
                                                                       --l_company_logo,
                                                                       --l_footer_image,
                                                                       lv_language
                     FROM fnd_lookup_values
                    WHERE     LOOKUP_TYPE = 'XXDO_CUST_FAC_DOC_LKP'
                          AND language = USERENV ('LANG')
                          AND enabled_flag = 'Y'
                          AND attribute5 = 'ALL BRAND'
                          AND attribute3 = p_org_id
                          AND attribute1 = lv_country
                          AND attribute2 = NVL (lv_ship_country, lV_country)
                          AND attribute4 = 'SOA'
                          AND NVL (attribute7, 'N') = 'N';
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        BEGIN
                            SELECT                               --attribute1,
                                   --attribute2,
                                   --attribute3,
                                   --attribute4,
                                   attribute5, attribute6, --attribute7,
                                                           attribute8,
                                   --attribute9,
                                   --attribute10,
                                   --attribute11,
                                   --attribute12,
                                   --attribute13,
                                   attribute14
                              INTO                         --l_seling_entinty,
                                   --l_ship_to_country,
                                   --l_ou,
                                   --l_cfd_type,
                                    lv_brand1, lv_support_email, --l_terms,
                                                                 lv_email_from, --l_email_subject,
                                                                                --l_email_body,
                                                                                --l_company_chop,
                                                                                --l_company_logo,
                                                                                --l_footer_image,
                                                                                lv_language
                              FROM fnd_lookup_values
                             WHERE     LOOKUP_TYPE = 'XXDO_CUST_FAC_DOC_LKP'
                                   AND language = USERENV ('LANG')
                                   AND enabled_flag = 'Y'
                                   AND attribute5 = 'ALL BRAND'
                                   AND attribute3 = p_org_id
                                   AND attribute1 = lv_country
                                   AND attribute2 = lv_country
                                   AND attribute4 = 'SOA'
                                   AND NVL (attribute7, 'N') = 'Y';
                        EXCEPTION
                            WHEN OTHERS
                            THEN
                                NULL;
                        END;
                END;
            WHEN OTHERS
            THEN
                NULL;
        END;

        x_ou_name      := lv_name;
        x_brand_name   := NVL (lv_brand, lv_brand1);
        x_lang_code    := lv_language;
        x_email_to     := NVL (lv_email_to, lv_support_email);
        x_email_from   := lv_email_from;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_ou_name      := NULL;
            x_brand_name   := NULL;
            x_lang_code    := NULL;
            x_email_to     := NULL;
            x_email_from   := NULL;
            x_print_flag   := NULL;
            x_email_flag   := NULL;
            print_log ('Error in get_soa_hdr_details:' || SQLERRM);
    END get_soa_hdr_details;

    ----
    ----
    FUNCTION get_consolidation_flag (p_customer_id IN NUMBER)
        RETURN VARCHAR2
    AS
        ln_bill_to_count   NUMBER := 0;
        lv_cons_flag       VARCHAR2 (1) := 'N';
    BEGIN
        BEGIN
            SELECT COUNT (DISTINCT contact_site_id)
              INTO ln_bill_to_count
              FROM xxdo.xxdoar_statements_stg
             WHERE     1 = 1
                   AND customer_id = p_customer_id
                   AND concurrent_request_id = gn_conc_request_id;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_bill_to_count   := 0;
        END;

        IF NVL (ln_bill_to_count, 0) = 1
        THEN
            lv_cons_flag   := 'Y';
        ELSE
            lv_cons_flag   := 'N';
        END IF;

        IF lv_cons_flag = 'Y'
        THEN
            BEGIN
                SELECT NVL (attribute15, 'Y')
                  INTO lv_cons_flag
                  FROM apps.hz_cust_accounts hca
                 WHERE 1 = 1 AND cust_account_id = p_customer_id;
            EXCEPTION
                WHEN OTHERS
                THEN
                    lv_cons_flag   := 'Y';
            END;
        END IF;

        RETURN lv_cons_flag;
    EXCEPTION
        WHEN OTHERS
        THEN
            print_log ('Error in get_consolidation_flag:' || SQLERRM);
            RETURN 'N';
    END get_consolidation_flag;

    ----
    ----
    FUNCTION get_inco_term (p_operating_unit IN VARCHAR2)
        RETURN VARCHAR2
    IS
        lv_inco_term   VARCHAR2 (100) := NULL;
    BEGIN
        BEGIN
            SELECT ffv.description
              INTO lv_inco_term
              FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values_vl ffv
             WHERE     1 = 1
                   AND ffvs.flex_value_set_id = ffv.flex_value_set_id
                   AND ffvs.flex_value_set_name = 'XXDO_CFS_INCO_TERMS_VS'
                   AND ffv.enabled_flag = 'Y'
                   AND NVL (ffv.start_date_active, SYSDATE) <= SYSDATE
                   AND NVL (ffv.end_date_active, SYSDATE + 1) > SYSDATE
                   AND UPPER (RTRIM (LTRIM (ffv.flex_value))) =
                       UPPER (p_operating_unit)--AND ffv.attribute1 = 'EMEA'
                                               ;
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_inco_term   := NULL;
        --                print_log('When others exception while getting Inco Term from value set.'||SQLERRM);
        END;

        RETURN lv_inco_term;
    EXCEPTION
        WHEN OTHERS
        THEN
            --            print_log ('Error in get_inco_term:' || SQLERRM);
            lv_inco_term   := NULL;
            RETURN lv_inco_term;
    END get_inco_term;

    PROCEDURE get_emea_vat_details (p_customer_trx_id IN NUMBER, p_org_id IN NUMBER, x_vat_rate_name OUT VARCHAR2--                                  ,x_vat_rate           OUT VARCHAR2
                                                                                                                 )
    IS
        lv_vat_rate_name   VARCHAR2 (50) := NULL;
    --        lv_vat_rate         VARCHAR2(50)    :=  NULL;
    BEGIN
        BEGIN
            SELECT DISTINCT rctl.tax_classification_code
              INTO lv_vat_rate_name
              FROM ra_customer_trx_lines_all rctl
             WHERE     1 = 1
                   AND rctl.org_id = p_org_id
                   AND rctl.customer_trx_id = p_customer_trx_id
                   AND rctl.line_type = 'LINE'
                   AND rctl.tax_classification_code IS NOT NULL
                   AND EXISTS
                           (SELECT 1
                              FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values ffv
                             WHERE     1 = 1
                                   AND ffvs.flex_value_set_id =
                                       ffv.flex_value_set_id
                                   AND ffvs.flex_value_set_name =
                                       'XXDOAR_B2B_OPERATING_UNITS'
                                   AND ffv.enabled_flag = 'Y'
                                   AND NVL (ffv.start_date_active, SYSDATE) <=
                                       SYSDATE
                                   AND NVL (ffv.end_date_active, SYSDATE + 1) >
                                       SYSDATE
                                   AND TO_CHAR (rctl.org_id) =
                                       RTRIM (LTRIM (ffv.flex_value))
                                   AND ffv.attribute1 = 'EMEA');
        EXCEPTION
            WHEN TOO_MANY_ROWS
            THEN
                lv_vat_rate_name   := 'Multiple VAT Rates.';
            --                BEGIN
            --                    SELECT DISTINCT rctl.tax_classification_code
            --                      INTO lv_vat_rate_name
            --                      FROM ra_customer_trx_lines_all rctl
            --                     WHERE 1 = 1
            --                       AND rctl.org_id = p_org_id
            --                       AND rctl.customer_trx_id = p_customer_trx_id
            --                       AND EXISTS (
            --                                 SELECT 1
            --                                   FROM apps.fnd_flex_value_sets ffvs
            --                                       , apps.fnd_flex_values ffv
            --                                   WHERE 1=1
            --                                     AND ffvs.flex_value_set_id = ffv.flex_value_set_id
            --                                     AND ffvs.flex_value_set_name = 'XXDOAR_B2B_OPERATING_UNITS'
            --                                     AND ffv.enabled_flag = 'Y'
            --                                     AND NVL(ffv.start_date_active,SYSDATE) <= SYSDATE
            --                                     AND NVL(ffv.end_date_active,SYSDATE+1) > SYSDATE
            --                                     AND TO_CHAR(rctl.org_id) = RTRIM(LTRIM(ffv.flex_value))
            --                                     AND ffv.attribute1 = 'EMEA'
            --                                     )
            --                       AND rownum = 1
            --                       ;
            --                EXCEPTION
            --                    WHEN OTHERS THEN
            --                        lv_vat_rate_name := NULL;
            ----                        lv_vat_rate := NULL;
            --                END;
            WHEN OTHERS
            THEN
                lv_vat_rate_name   := NULL;
        --                lv_vat_rate := NULL;
        END;

        x_vat_rate_name   := lv_vat_rate_name;
    --        x_vat_rate := lv_vat_rate;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_vat_rate_name   := NULL;
    --            x_vat_rate := NULL;
    --            print_log ('Error in get_emea_vat_details:' || SQLERRM);
    END get_emea_vat_details;

    ----
    ----
    PROCEDURE get_freight_amt (p_customer_trx_id IN NUMBER, p_org_id IN NUMBER, x_freight_amt OUT NUMBER
                               , x_freight_amt_dsp OUT VARCHAR2)
    IS
        ln_freight_amt       NUMBER (15) := NULL;
        lv_freight_amt_dsp   VARCHAR2 (15) := NULL;
    BEGIN
        BEGIN
            SELECT SUM (NVL (rctl.extended_amount, 0)) freight_amt, TO_CHAR (SUM (NVL (rctl.extended_amount, 0)), '999G999G990D00') freight_amt_dsp
              INTO ln_freight_amt, lv_freight_amt_dsp
              FROM ra_customer_trx_lines_all rctl
             WHERE     1 = 1
                   AND rctl.org_id = p_org_id
                   AND rctl.customer_trx_id = p_customer_trx_id
                   AND rctl.line_type = 'FREIGHT'
                   AND EXISTS
                           (SELECT 1
                              FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values ffv
                             WHERE     1 = 1
                                   AND ffvs.flex_value_set_id =
                                       ffv.flex_value_set_id
                                   AND ffvs.flex_value_set_name =
                                       'XXDOAR_B2B_OPERATING_UNITS'
                                   AND ffv.enabled_flag = 'Y'
                                   AND NVL (ffv.start_date_active, SYSDATE) <=
                                       SYSDATE
                                   AND NVL (ffv.end_date_active, SYSDATE + 1) >
                                       SYSDATE
                                   AND TO_CHAR (rctl.org_id) =
                                       RTRIM (LTRIM (ffv.flex_value))
                                   AND ffv.attribute1 = 'EMEA');
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_freight_amt       := NULL;
                lv_freight_amt_dsp   := NULL;
        END;

        x_freight_amt       := ln_freight_amt;
        x_freight_amt_dsp   := lv_freight_amt_dsp;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_freight_amt       := NULL;
            x_freight_amt_dsp   := NULL;
    --            print_log ('Error in get_freight_amt:' || SQLERRM);
    END get_freight_amt;

    ----
    ---- B2B Phase 2 Changes -- CCR0007216 -- Start
    ----
    PROCEDURE get_buying_group_data (p_customer_id IN NUMBER, x_buy_grp_number OUT VARCHAR2, x_buy_grp_vat_num OUT VARCHAR2
                                     , x_customer_member OUT VARCHAR2, x_ret_code OUT VARCHAR2, x_ret_message OUT VARCHAR2)
    IS
    BEGIN
        NULL;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_buy_grp_number    := NULL;
            x_buy_grp_vat_num   := NULL;
            x_customer_member   := NULL;
            x_ret_code          := gn_error;
            x_ret_message       :=
                SUBSTR ('Error in get_buying_group_data:' || SQLERRM, 1, 250);
    END get_buying_group_data;

    ----
    ----
    PROCEDURE get_emea_stmt_lang (p_customer_id   IN     NUMBER,
                                  p_org_id        IN     NUMBER,
                                  x_lang_code        OUT VARCHAR2,
                                  x_ret_code         OUT VARCHAR2,
                                  x_ret_message      OUT VARCHAR2)
    IS
        ln_org_id            NUMBER;
        lv_lang_code         VARCHAR2 (30);
        lv_lang_at_account   VARCHAR2 (30);
        lv_lang_at_site      VARCHAR2 (30);
    BEGIN
        --print_log('Customer ID:'||p_customer_id||' Org ID:'||p_org_id);
        BEGIN
            SELECT hca.attribute17 lang_at_account, hcas.ATTRIBUTE9 lang_at_site
              INTO lv_lang_at_account, lv_lang_at_site
              FROM apps.hz_cust_accounts hca, apps.hz_cust_acct_sites_all hcas
             --apps.hz_cust_site_uses_all uses -- Commented for CCR0009748
             WHERE     1 = 1
                   AND hca.cust_account_id = hcas.cust_account_id
                   AND hca.status = 'A'
                   AND hcas.status = 'A'
                   AND hcas.org_id = p_org_id
                   -- Start changes for CCR0009748
                   -- AND   hcas.cust_acct_site_id = uses.cust_acct_site_id
                   -- AND   uses.status = 'A'
                   -- AND   uses.primary_flag = 'Y'
                   -- AND   uses.site_use_code = 'BILL_TO'
                   AND hcas.bill_to_flag = 'P'
                   -- End changes for CCR0009748
                   AND hca.cust_account_id = p_customer_id;
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_lang_at_account   := NULL;
                lv_lang_at_site      := NULL;
        END;

        lv_lang_code   := NVL (lv_lang_at_site, lv_lang_at_account);

        --print_log('lv_lang_code1:'||lv_lang_code);

        IF lv_lang_code IS NULL
        THEN
            BEGIN
                SELECT ffv.attribute3
                  INTO lv_lang_code
                  FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values ffv
                 WHERE     1 = 1
                       AND ffvs.flex_value_set_id = ffv.flex_value_set_id
                       AND ffvs.flex_value_set_name =
                           'XXDOAR_B2B_OPERATING_UNITS'
                       --- Added as per 3.0
                       AND ffv.enabled_flag = 'Y'
                       AND NVL (ffv.start_date_active, SYSDATE) <= SYSDATE
                       AND NVL (ffv.end_date_active, SYSDATE + 1) > SYSDATE
                       --- Added as per 3.0
                       AND ffv.flex_value = TO_CHAR (p_org_id);

                x_lang_code     := lv_lang_code;
                x_ret_code      := gn_success;
                x_ret_message   := NULL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    x_lang_code   := NULL;
                    x_ret_code    := gn_error;
                    x_ret_message   :=
                        SUBSTR ('Unable to get alt lang:' || SQLERRM, 1, 250);
            END;
        --print_log('lv_lang_code2:'||lv_lang_code);
        ELSE
            --print_log('lv_lang_code3:'||lv_lang_code);
            x_lang_code     := lv_lang_code;
            x_ret_code      := gn_success;
            x_ret_message   := NULL;
        END IF;

        IF    UPPER (x_lang_code) = 'CH'
           OR UPPER (x_lang_code) = UPPER ('it_IT')
        THEN
            x_lang_code   := 'IT';
        ELSIF UPPER (x_lang_code) = 'DU'
        THEN
            x_lang_code   := 'NL';
        ELSIF UPPER (x_lang_code) = UPPER ('en')
        THEN
            x_lang_code   := 'EN';
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_lang_code   := NULL;
            x_ret_code    := gn_error;
            x_ret_message   :=
                SUBSTR ('Error in get_emea_stmt_lang:' || SQLERRM, 1, 250);
    --print_log('x_ret_message:'||x_ret_message);
    END get_emea_stmt_lang;

    ----
    ----
    PROCEDURE get_emea_billing_lang (p_customer_id IN NUMBER, p_bill_to_site_use_id IN NUMBER, p_org_id IN NUMBER
                                     , x_lang_code OUT VARCHAR2)
    IS
        ln_org_id            NUMBER;
        lv_lang_code         VARCHAR2 (30);
        lv_lang_at_account   VARCHAR2 (30);
        lv_lang_at_site      VARCHAR2 (30);
    BEGIN
        --print_log('Customer ID:'||p_customer_id||' Org ID:'||p_org_id);
        BEGIN
            SELECT hca.attribute17 lang_at_account, hcas.ATTRIBUTE9 lang_at_site
              INTO lv_lang_at_account, lv_lang_at_site
              FROM apps.hz_cust_accounts hca, apps.hz_cust_acct_sites_all hcas, apps.hz_cust_site_uses_all uses
             WHERE     1 = 1
                   AND hca.cust_account_id = hcas.cust_account_id
                   AND hca.status = 'A'
                   AND hcas.status = 'A'
                   AND hcas.org_id = p_org_id
                   AND hcas.cust_acct_site_id = uses.cust_acct_site_id
                   AND uses.status = 'A'
                   --AND   uses.primary_flag = 'Y'
                   --AND   uses.site_use_code = 'BILL_TO'
                   AND uses.site_use_id = p_bill_to_site_use_id
                   AND hca.cust_account_id = p_customer_id;
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_lang_at_account   := NULL;
                lv_lang_at_site      := NULL;
        END;

        lv_lang_code   := NVL (lv_lang_at_site, lv_lang_at_account);

        --print_log('lv_lang_code1:'||lv_lang_code);

        IF lv_lang_code IS NULL
        THEN
            BEGIN
                SELECT ffv.attribute3
                  INTO lv_lang_code
                  FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values ffv
                 WHERE     1 = 1
                       AND ffvs.flex_value_set_id = ffv.flex_value_set_id
                       AND ffvs.flex_value_set_name =
                           'XXDOAR_B2B_OPERATING_UNITS'
                       --- Added as per 3.0
                       AND ffv.enabled_flag = 'Y'
                       AND NVL (ffv.start_date_active, SYSDATE) <= SYSDATE
                       AND NVL (ffv.end_date_active, SYSDATE + 1) > SYSDATE
                       --- Added as per 3.0
                       AND ffv.flex_value = TO_CHAR (p_org_id);

                x_lang_code   := lv_lang_code;
            --x_ret_code := gn_success;
            --x_ret_message := NULL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    x_lang_code   := NULL;
            --x_ret_code := gn_error;
            --x_ret_message := SUBSTR('Unable to get alt lang:'||SQLERRM,1,250);
            END;
        --print_log('lv_lang_code2:'||lv_lang_code);
        ELSE
            --print_log('lv_lang_code3:'||lv_lang_code);
            x_lang_code   := lv_lang_code;
        --x_ret_code := gn_success;
        --x_ret_message := NULL;
        END IF;

        IF    UPPER (x_lang_code) = 'CH'
           OR UPPER (x_lang_code) = UPPER ('it_IT')
        THEN
            x_lang_code   := 'IT';
        ELSIF UPPER (x_lang_code) = 'DU'
        THEN
            x_lang_code   := 'NL';
        ELSIF UPPER (x_lang_code) = UPPER ('en')
        THEN
            x_lang_code   := 'EN';
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_lang_code   := NULL;
    --x_ret_code := gn_error;
    --x_ret_message := SUBSTR('Error in get_emea_billing_lang:'||SQLERRM,1,250);
    --print_log(SUBSTR('Error in get_emea_billing_lang:'||SQLERRM,1,250));
    END get_emea_billing_lang;

    ----
    ----
    FUNCTION get_ou_region (p_org_id IN NUMBER)
        RETURN VARCHAR2
    IS
        lv_ou_region   VARCHAR2 (30);
    BEGIN
        SELECT ffv.attribute1
          INTO lv_ou_region
          FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values ffv
         WHERE     1 = 1
               AND ffvs.flex_value_set_id = ffv.flex_value_set_id
               AND ffvs.flex_value_set_name = 'XXDOAR_B2B_OPERATING_UNITS'
               --- Added as per 3.0
               AND ffv.enabled_flag = 'Y'
               AND NVL (ffv.start_date_active, SYSDATE) <= SYSDATE
               AND NVL (ffv.end_date_active, SYSDATE + 1) > SYSDATE
               --- Added as per 3.0
               AND ffv.flex_value = TO_CHAR (p_org_id);

        RETURN lv_ou_region;
    EXCEPTION
        WHEN OTHERS
        THEN
            RETURN 'NA';
    END get_ou_region;

    ----
    ----
    PROCEDURE get_billing_ship_from (p_customer_trx_id       IN     NUMBER,
                                     p_trx_type              IN     VARCHAR2,
                                     x_ship_from_country        OUT VARCHAR2,
                                     x_ship_from_ctry_name      OUT VARCHAR2,
                                     x_tax_statement            OUT VARCHAR2)
    IS
        lv_is_manual_trx         VARCHAR2 (10);
        ln_orig_order_ref        NUMBER;
        ln_cm_manual_ship_from   NUMBER;
    BEGIN
        ------------------------------
        -- Fetch Ship-From Country. --
        ------------------------------
        BEGIN
            SELECT DISTINCT ft.territory_code, ft.territory_short_name
              INTO x_ship_from_country, x_ship_from_ctry_name
              FROM ra_customer_trx_lines_all, hr_locations_all hloc, fnd_territories_tl ft
             WHERE     customer_trx_id = p_customer_trx_id
                   AND warehouse_id IS NOT NULL
                   AND hloc.inventory_organization_id = warehouse_id
                   AND ft.territory_code = hloc.country
                   AND ft.language = 'US';
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                x_ship_from_country     := NULL;
                x_ship_from_ctry_name   := NULL;
            WHEN OTHERS
            THEN
                x_ship_from_country     := NULL;
                x_ship_from_ctry_name   := NULL;
        END;

        -- SHIP FROM/Tax Statement derivation :: Handling Credit Memos and Manual transactions.
        IF p_trx_type != 'INV'
        THEN
            BEGIN
                SELECT 'Y'
                  INTO lv_is_manual_trx
                  FROM ra_customer_trx_all rct
                 WHERE     rct.batch_source_id IN
                               (SELECT rbs.batch_source_id
                                  FROM ra_batch_sources_all rbs
                                 WHERE     rbs.batch_source_type = 'INV' -- 'INV' for Manual Transactions and 'FOREIGN' for Non-Manual.
                                       AND rbs.org_id = rct.org_id)
                       AND customer_trx_id = p_customer_trx_id;
            EXCEPTION
                WHEN OTHERS
                THEN
                    lv_is_manual_trx   := 'N';
            END;

            IF lv_is_manual_trx = 'Y'
            THEN
                BEGIN
                    SELECT attribute8
                      INTO x_tax_statement
                      FROM ra_customer_trx_all
                     WHERE customer_trx_id = p_customer_trx_id;

                    IF x_tax_statement IS NULL
                    THEN
                        x_tax_statement   := NULL;
                    END IF;
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        x_tax_statement   := NULL;
                    WHEN OTHERS
                    THEN
                        x_tax_statement   := NULL;
                END;
            END IF;                                  -- lv_is_manual_trx = 'Y'

            IF lv_is_manual_trx = 'N'
            THEN
                BEGIN
                    SELECT COUNT (DISTINCT (reference_line_id))
                      INTO ln_orig_order_ref
                      FROM oe_order_lines_all
                     WHERE     line_id IN
                                   (SELECT rctl.interface_line_attribute6
                                      FROM ra_customer_trx_all rct, ra_customer_trx_lines_all rctl
                                     WHERE     rct.customer_trx_id =
                                               p_customer_trx_id
                                           AND rct.customer_trx_id =
                                               rctl.customer_trx_id
                                           AND interface_line_context =
                                               'ORDER ENTRY')
                           AND reference_line_id IS NOT NULL;
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_orig_order_ref   := 0;
                    WHEN OTHERS
                    THEN
                        ln_orig_order_ref   := 0;
                END;

                IF ln_orig_order_ref = 0
                THEN
                    BEGIN
                        SELECT DISTINCT ship_from_org_id
                          INTO ln_cm_manual_ship_from
                          FROM oe_order_lines_all
                         WHERE     line_id IN
                                       (SELECT rctl.interface_line_attribute6
                                          FROM ra_customer_trx_all rct, ra_customer_trx_lines_all rctl
                                         WHERE     rct.customer_trx_id =
                                                   p_customer_trx_id
                                               AND rct.customer_trx_id =
                                                   rctl.customer_trx_id
                                               AND interface_line_context =
                                                   'ORDER ENTRY')
                               AND reference_line_id IS NULL;
                    EXCEPTION
                        WHEN NO_DATA_FOUND
                        THEN
                            ln_cm_manual_ship_from   := NULL;
                        WHEN OTHERS
                        THEN
                            ln_cm_manual_ship_from   := NULL;
                    END;
                END IF;                               -- ln_orig_order_ref = 0

                IF ln_orig_order_ref > 0
                THEN
                    BEGIN
                        SELECT DISTINCT oh.ship_from_org_id
                          INTO ln_cm_manual_ship_from
                          FROM oe_order_lines_all ol, oe_order_headers_all oh
                         WHERE     oh.header_id = ol.header_id
                               AND ol.line_id IN
                                       (SELECT reference_line_id
                                          FROM oe_order_lines_all
                                         WHERE line_id IN
                                                   (SELECT rctl.interface_line_attribute6
                                                      FROM ra_customer_trx_all rct, ra_customer_trx_lines_all rctl
                                                     WHERE     rct.customer_trx_id =
                                                               p_customer_trx_id
                                                           AND rct.customer_trx_id =
                                                               rctl.customer_trx_id
                                                           AND interface_line_context =
                                                               'ORDER ENTRY'));
                    EXCEPTION
                        WHEN NO_DATA_FOUND
                        THEN
                            ln_cm_manual_ship_from   := NULL;
                        WHEN OTHERS
                        THEN
                            ln_cm_manual_ship_from   := NULL;
                    END;
                END IF;                                -- l_orig_order_ref > 0

                BEGIN
                    SELECT DISTINCT ft.territory_code, ft.territory_short_name
                      INTO x_ship_from_country, x_ship_from_ctry_name
                      FROM hr_locations_all hloc, fnd_territories_tl ft
                     WHERE     hloc.inventory_organization_id =
                               ln_cm_manual_ship_from
                           AND ft.territory_code = hloc.country
                           AND ft.language = 'US';
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        x_ship_from_country     := NULL;
                        x_ship_from_ctry_name   := NULL;
                    WHEN OTHERS
                    THEN
                        x_ship_from_country     := NULL;
                        x_ship_from_ctry_name   := NULL;
                END;
            END IF;                                   -- l_is_manual_trx = 'N'
        END IF;                                  --IF p_trx_type != 'INV' THEN
    EXCEPTION
        WHEN OTHERS
        THEN
            x_ship_from_country     := NULL;
            x_ship_from_ctry_name   := NULL;
            x_tax_statement         := NULL;
    --x_ret_message := SUBSTR('Error in get_billing_ship_from_ctry:'||SQLERRM,1,250);
    END get_billing_ship_from;

    ----
    ----
    /*--Commented temporarily - Redundant code CCR0007216 --Remove -- Start
    FUNCTION is_eu_region (p_ship_from_country  IN  VARCHAR2)
    RETURN BOOLEAN
    IS
        lv_ship_from_region VARCHAR2 (30);
    BEGIN
        SELECT 'EU'
          INTO lv_ship_from_region
            FROM fnd_flex_value_sets ffvs,
                   fnd_flex_values_vl ffv
         WHERE ffvs.flex_value_set_name = 'XXDO_CFS_EU_COUNTRIES_VS'
             AND ffv.flex_value_set_id      = ffvs.flex_value_set_id
             AND UPPER(ffv.flex_value)      = UPPER(p_ship_from_country);
        IF lv_ship_from_region = 'EU'
        THEN
            RETURN TRUE;
        ELSE
            RETURN FALSE;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN FALSE;
    END is_eu_region;
    */
    --Commented temporarily - Redundant code CCR0007216 --Remove -- End
    ----
    ----
    FUNCTION is_manual_trx (p_customer_trx_id IN NUMBER)
        RETURN BOOLEAN
    IS
        lv_is_manual_trx   VARCHAR2 (30);
    BEGIN
        SELECT 'Y'
          INTO lv_is_manual_trx
          FROM ra_customer_trx_all rct
         WHERE     rct.batch_source_id IN
                       (SELECT rbs.batch_source_id
                          FROM ra_batch_sources_all rbs
                         WHERE     rbs.batch_source_type = 'INV' -- 'INV' for Manual Transactions and 'FOREIGN' for Non-Manual.
                               AND rbs.org_id = rct.org_id)
               AND rct.customer_trx_id = p_customer_trx_id;

        IF lv_is_manual_trx = 'Y'
        THEN
            RETURN TRUE;
        ELSE
            RETURN FALSE;
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            RETURN FALSE;
    END is_manual_trx;

    ----
    ----
    FUNCTION get_nontax_goods_amt (p_customer_trx_line_id IN NUMBER)
        RETURN NUMBER
    IS
        ln_nontax_good_amt   NUMBER := 0;
    BEGIN
        SELECT NVL (SUM (NVL (rctl.EXTENDED_AMOUNT, 0)), 0)
          INTO ln_nontax_good_amt
          FROM apps.ra_customer_trx_lines_all rctl,
               (SELECT CUSTOMER_TRX_ID, tax_rate, link_to_cust_trx_line_id
                  FROM apps.ra_customer_trx_lines_all rctl_tax
                 WHERE rctl_tax.line_type = 'TAX') trx_tax_rate
         WHERE     1 = 1
               --AND rctl.customer_trx_id    = :CUSTOMER_TRX_ID
               AND rctl.customer_trx_line_id = p_customer_trx_line_id
               AND rctl.line_type = 'LINE'
               /*Begin Modification for CFS Phase2, 27-Mar-2018*/
               --        AND UPPER(rctl.description) NOT LIKE '%FREIGHT%'     --Commented for CFS Phase2
               AND NOT (    UPPER (description) LIKE '%FREIGHT%' --Added this And block for CFS Phase2
                        AND (   inventory_item_id IS NULL
                             OR inventory_item_id IN
                                    (SELECT msib.inventory_item_id
                                       FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                            mtl_system_items_b msib
                                      WHERE     ffvs.flex_value_set_name =
                                                'XXDO_CFS_FREIGHT_LIST_VS'
                                            AND ffv.flex_value_set_id =
                                                ffvs.flex_value_set_id
                                            --- Added as per 3.0
                                            AND ffv.enabled_flag = 'Y'
                                            AND NVL (ffv.start_date_active,
                                                     SYSDATE) <=
                                                SYSDATE
                                            AND NVL (ffv.end_date_active,
                                                     SYSDATE + 1) >
                                                SYSDATE
                                            --- Added as per 3.0
                                            AND ffv.flex_value = hou.name
                                            AND hou.organization_id =
                                                rctl.org_id
                                            AND UPPER (msib.segment1) =
                                                UPPER (ffv.description))))
               /*End Modification for CFS2, 27-Mar-2018*/
               AND rctl.customer_trx_id = trx_tax_rate.CUSTOMER_TRX_ID(+)
               AND rctl.customer_trx_line_id =
                   trx_tax_rate.link_to_cust_trx_line_id(+);

        RETURN ln_nontax_good_amt;
    EXCEPTION
        WHEN OTHERS
        THEN
            RETURN 0;
    END get_nontax_goods_amt;

    ----
    ----
    FUNCTION get_stdtax_rate (p_org_id IN NUMBER, p_trx_date IN DATE)
        RETURN NUMBER
    IS
        ln_tax_rate   NUMBER;
    BEGIN
        SELECT zxr.percentage_rate
          INTO ln_tax_rate
          FROM zx_rates_b zxr, zx_regimes_usages zru, zx_party_tax_profile ptp,
               hr_operating_units hou
         WHERE     zxr.tax_regime_code = zru.tax_regime_code
               AND zxr.content_owner_id = zru.first_pty_org_id
               AND zru.first_pty_org_id = ptp.party_tax_profile_id
               AND hou.organization_id = p_org_id
               AND ptp.party_id = hou.organization_id
               AND percentage_rate <> 0
               AND default_rate_flag = 'Y'
               AND rate_type_code = 'PERCENTAGE'
               AND p_trx_date BETWEEN zxr.effective_from
                                  AND NVL (zxr.effective_to, SYSDATE);

        RETURN ln_tax_rate;
    EXCEPTION
        WHEN OTHERS
        THEN
            RETURN 0;
    END get_stdtax_rate;

    ----
    ----
    FUNCTION get_line_tax_rate (p_org_id IN NUMBER, p_customer_trx_id IN NUMBER, p_customer_trx_line_id IN NUMBER)
        RETURN NUMBER
    IS
        ln_tax_rate   NUMBER;
    BEGIN
        SELECT tax_rate
          INTO ln_tax_rate
          FROM zx_lines
         WHERE     application_id = 222
               AND trx_line_id = p_customer_trx_line_id
               AND trx_id = p_customer_trx_id
               AND internal_organization_id = p_org_id;

        RETURN ln_tax_rate;
    EXCEPTION
        WHEN OTHERS
        THEN
            RETURN 0;
    END get_line_tax_rate;

    -- Start of Change for CCR0009103

    PROCEDURE get_line_tax_rate_det (p_org_id IN NUMBER, p_customer_trx_id IN NUMBER, p_customer_trx_line_id IN NUMBER
                                     , x_tax_rate_name OUT VARCHAR2, x_tax_rate_des OUT VARCHAR2, x_tax_rate_code OUT VARCHAR2)
    IS
        ln_tax_rate_id     NUMBER;
        lv_tax_rate_name   VARCHAR2 (240);
        lv_tax_rate_desc   VARCHAR2 (240);
        lv_tax_rate_code   VARCHAR2 (240);
    BEGIN
        ln_tax_rate_id     := NULL;
        lv_tax_rate_name   := NULL;
        lv_tax_rate_desc   := NULL;
        lv_tax_rate_code   := NULL;
        x_tax_rate_name    := NULL;
        x_tax_rate_des     := NULL;
        x_tax_rate_code    := NULL;

        BEGIN
            SELECT tax_rate_id
              INTO ln_tax_rate_id
              FROM zx_lines
             WHERE     application_id = 222
                   AND trx_line_id = p_customer_trx_line_id
                   AND trx_id = p_customer_trx_id
                   AND internal_organization_id = p_org_id;
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_tax_rate_name   := NULL;
                lv_tax_rate_desc   := NULL;
                lv_tax_rate_code   := NULL;
        END;

        --       print_log('Derived Tax Rate ID is - '||ln_tax_rate_id);

        IF ln_tax_rate_id IS NOT NULL
        THEN
            BEGIN
                SELECT ztl.tax_rate_name,
                       ztl.description,
                       SUBSTR (zb.tax_rate_code,
                               1,
                                 INSTR (zb.tax_rate_code, '_', -1,
                                        1)
                               - 1)               --tax_rate_code, description
                  INTO lv_tax_rate_name, lv_tax_rate_desc, lv_tax_rate_code
                  FROM zx_rates_tl ztl, zx_rates_b zb             --zx_rates_b
                 WHERE     ztl.tax_rate_id = ln_tax_rate_id
                       AND ztl.tax_rate_id = zb.tax_rate_id
                       AND LANGUAGE = USERENV ('Lang');
            EXCEPTION
                WHEN OTHERS
                THEN
                    lv_tax_rate_name   := NULL;
                    lv_tax_rate_desc   := NULL;
                    lv_tax_rate_code   := NULL;
            --          print_log('Derived tax_rate_code is - '||lv_tax_rate_name||' - Ex1 is - '|| SQLERRM);
            END;
        END IF;

        -- print_log('Finally Derived tax_rate_code function is - '||lv_tax_rate_name||' - Ex is - '|| SQLERRM);

        x_tax_rate_name    := lv_tax_rate_name;
        x_tax_rate_des     := lv_tax_rate_desc;
        x_tax_rate_code    := lv_tax_rate_code;
    --   print_log('Finally Derived tax_rate_code function is - '||lv_tax_rate_code||' - One Ex is - '|| SQLERRM);
    --   print_log('Finally Derived tax_rate_code function is - '||lv_tax_rate_desc);
    EXCEPTION
        WHEN OTHERS
        THEN
            x_tax_rate_name   := NULL;
            x_tax_rate_des    := NULL;
            x_tax_rate_code   := NULL;
    --   print_log('Finally Ex Error is  - '|| SQLERRM);
    END get_line_tax_rate_det;

    -- End of Change for CCR0009103

    ----
    ---- B2B Phase 2 Changes -- CCR0007216 -- End
    ----
    PROCEDURE update_print_options (p_conc_request_id IN NUMBER, x_ret_code OUT VARCHAR2, x_ret_message OUT VARCHAR2)
    IS
        --Local Variables
        lv_proc_name   VARCHAR2 (30) := 'UPDATE_PRINT_OPTIONS';
        lv_err_msg     VARCHAR2 (2000) := NULL;
    BEGIN
        print_log ('Inside Update Printing Options Procedure - START', 'Y');

        print_log (
            'Updating the Printing Options for First Time Print Scenario - START',
            'Y');

        --First Time Printing
        BEGIN
            UPDATE apps.ra_customer_trx_all rct
               SET rct.printing_option = NVL (rct.printing_option, 'PRI'), rct.printing_last_printed = SYSDATE, rct.printing_original_date = SYSDATE,
                   rct.printing_count = NVL (rct.printing_count, 0) + 1, rct.printing_pending = 'N', last_update_date = SYSDATE,
                   last_updated_by = gn_user_id
             WHERE     1 = 1
                   AND rct.printing_last_printed IS NULL --For First Time Print, Printing_last_printed will be NULL
                   AND rct.printing_pending = 'Y' --Printing should be Pending
                   AND NVL (rct.printing_option, 'PRI') = 'PRI' --Print option should be Blank Or PRINT
                   AND EXISTS
                           (SELECT '1'
                              FROM xxdo.xxdoar_b2b_billing_hdr_stg stg
                             WHERE     1 = 1
                                   AND stg.concurrent_request_id =
                                       p_conc_request_id
                                   AND stg.process_flag = 'Y'
                                   AND stg.printing_pending = 'Y' --First time print
                                   AND stg.customer_trx_id =
                                       rct.customer_trx_id);
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_err_msg      :=
                       'Exception while updating First time printing options in '
                    || lv_proc_name
                    || ' Procedure';
                lv_err_msg      :=
                    SUBSTR (lv_err_msg || 'Error is: ' || SQLERRM, 1, 2000);
                x_ret_message   := lv_err_msg;
                x_ret_code      := gn_error;
        END;

        print_log (
               'Number of Records updated for First time print scenario:'
            || SQL%ROWCOUNT);
        COMMIT;
        print_log (
            'Updating the Printing Options for First Time Print Scenario - END',
            'Y');

        --This case is not valid as we do not bring transactions which
        --        print_log('Updating the Printing Options for Re-Print and Print Pending is ''No'' Scenario - START', 'Y');
        --        --For Reprints
        --        BEGIN
        --            UPDATE apps.ra_customer_trx_all rct
        --               SET rct.printing_option = NVL(rct.printing_option, 'PRI')
        --                  ,rct.printing_last_printed = SYSDATE
        --                  --,rct.printing_original_date = SYSDATE
        --                  ,rct.printing_count = NVL(rct.printing_count, 0) + 1
        --                  ,rct.printing_pending = 'N'
        --                  ,last_update_date = SYSDATE
        --                  ,last_updated_by = gn_user_id
        --             WHERE 1 = 1
        --               AND rct.printing_last_printed IS NOT NULL --For RePrints, Printing_last_printed will not be NULL
        --               AND rct.printing_pending = 'N'  --For RePrints where printing pending is 'No'
        --               AND EXISTS(
        --                         SELECT '1'
        --                          FROM xxdo.xxdoar_b2b_billing_hdr_stg stg
        --                         WHERE 1 = 1
        --                           AND stg.concurrent_request_id = p_conc_request_id
        --                           AND stg.process_flag = 'Y'
        --                           AND stg.printing_pending = 'N'  --For RePrints where printing pending is 'No'
        --                           AND stg.customer_trx_id = rct.customer_trx_id
        --                         );
        --        EXCEPTION
        --            WHEN OTHERS THEN
        --                lv_err_msg := 'Exception while updating Reprint and Print Pending is ''No'' printing options in '||lv_proc_name||' Procedure';
        --                lv_err_msg := SUBSTR(lv_err_msg || 'Error is: '||SQLERRM, 1, 2000);
        --                x_ret_message := lv_err_msg;
        --                x_ret_code := gn_error;
        --        END;
        --
        --        print_log('Number of Records updated for Re-Print and Print Pending is ''No'' print scenario:'||SQL%ROWCOUNT);
        --        COMMIT;
        --        print_log('Updating the Printing Options for Re-Print and Print Pending is ''No'' Scenario - END', 'Y');

        print_log (
            'Updating the Printing Options for Re-Print and Print Pending is ''Yes'' Scenario - START',
            'Y');

        --For Reprints where print pending is 'Yes'
        BEGIN
            UPDATE apps.ra_customer_trx_all rct
               SET rct.printing_option = NVL (rct.printing_option, 'PRI'), rct.printing_last_printed = SYSDATE--,rct.printing_original_date = SYSDATE
                                                                                                              , rct.printing_count = NVL (rct.printing_count, 0) + 1,
                   rct.printing_pending = 'N', last_update_date = SYSDATE, last_updated_by = gn_user_id
             WHERE     1 = 1
                   AND rct.printing_last_printed IS NOT NULL --For RePrints, Printing_last_printed will not be NULL
                   AND rct.printing_pending = 'Y' --For RePrints where priting pending is 'Yes'
                   AND NVL (rct.printing_option, 'PRI') = 'PRI' --Print option should be Blank Or PRINT
                   AND EXISTS
                           (SELECT '1'
                              FROM xxdo.xxdoar_b2b_billing_hdr_stg stg
                             WHERE     1 = 1
                                   AND stg.concurrent_request_id =
                                       p_conc_request_id
                                   AND stg.process_flag = 'Y'
                                   AND stg.printing_pending = 'Y' --For RePrints where printing pending is 'Yes'
                                   AND stg.customer_trx_id =
                                       rct.customer_trx_id);
        EXCEPTION
            WHEN OTHERS
            THEN
                lv_err_msg      :=
                       'Exception while updating Reprint and Print Pending is ''Yes'' printing options in '
                    || lv_proc_name
                    || ' Procedure';
                lv_err_msg      :=
                    SUBSTR (lv_err_msg || 'Error is: ' || SQLERRM, 1, 2000);
                x_ret_message   := lv_err_msg;
                x_ret_code      := gn_error;
        END;

        print_log (
               'Number of Records updated for Re-Print and Print Pending is ''Yes'' print scenario:'
            || SQL%ROWCOUNT);
        COMMIT;
        print_log (
            'Updating the Printing Options for Re-Print and Print Pending is ''Yes'' Scenario - END',
            'Y');

        print_log ('Inside Update Printing Options Procedure - END', 'Y');
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_err_msg      :=
                   'Exception while updating printing options in '
                || lv_proc_name
                || ' Procedure';
            lv_err_msg      :=
                SUBSTR (lv_err_msg || 'Error is: ' || SQLERRM, 1, 2000);
            x_ret_message   := lv_err_msg;
            x_ret_code      := gn_error;
    END update_print_options;

    ----
    ----
    FUNCTION get_country_name (p_country_code IN VARCHAR2)
        RETURN VARCHAR2
    IS
        lv_country_name   apps.fnd_territories_tl.territory_short_name%TYPE
                              := NULL;
    BEGIN
        SELECT ftt.territory_short_name
          INTO lv_country_name
          FROM apps.fnd_territories_tl ftt
         WHERE ftt.language = 'US' AND ftt.territory_code = p_country_code;

        RETURN lv_country_name;
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_country_name   := NULL;
            RETURN lv_country_name;
    END get_country_name;

    ----
    ----
    PROCEDURE get_emea_footer2 (p_org_id IN NUMBER, p_customer_trx_id IN NUMBER, p_ship_to_country_reg IN VARCHAR2, p_ship_to_country IN VARCHAR2, p_ship_from_country IN VARCHAR2, p_is_manual_trx IN VARCHAR2
                                , x_stmt_english OUT VARCHAR2--                            ,x_ret_code             OUT NUMBER
                                                             --                            ,x_ret_message          OUT VARCHAR2
                                                             )
    IS
        --Local Variables
        lv_proc_name      VARCHAR2 (30) := 'GET_EMEA_FOOTER2';
        lv_err_msg        VARCHAR2 (2000) := NULL;
        lv_stmt_english   VARCHAR2 (150) := NULL;
    BEGIN
        IF NVL (p_is_manual_trx, 'N') = 'N'
        THEN
            BEGIN
                SELECT                                       --flv.lookup_type
                       --,flv.attribute1 operating_unit
                       --,flv.attribute2 ship_to_country
                       --,flv.attribute3 ship_to_country_exclusion
                       --,flv.attribute4 ship_from_country
                       flv.attribute6 cfs_statement_english
                  INTO lv_stmt_english
                  FROM apps.fnd_lookup_values flv
                 WHERE     1 = 1
                       AND flv.lookup_type LIKE 'XXDO_CFS_SPECIAL_RULES_LKP'
                       AND flv.language = 'US'
                       AND flv.enabled_flag = 'Y'
                       AND NVL (flv.start_date_active, SYSDATE) <= SYSDATE
                       AND NVL (flv.end_date_active, SYSDATE + 1) > SYSDATE
                       AND flv.attribute1 = TO_CHAR (p_org_id)
                       AND UPPER (flv.attribute2) = UPPER (p_ship_to_country)
                       AND UPPER (flv.attribute4) =
                           UPPER (p_ship_from_country);
            EXCEPTION
                WHEN OTHERS
                THEN
                    lv_stmt_english   := NULL;
            END;

            IF lv_stmt_english IS NULL
            THEN
                BEGIN
                    SELECT                                   --flv.lookup_type
                           --,flv.attribute1 operating_unit
                           --,flv.attribute2 ship_to_country
                           --,flv.attribute3 ship_to_country_exclusion
                           --,flv.attribute4 ship_from_country
                           flv.attribute6 cfs_statement_english
                      INTO lv_stmt_english
                      FROM apps.fnd_lookup_values flv
                     WHERE     1 = 1
                           AND flv.lookup_type LIKE
                                   'XXDO_CFS_SPECIAL_RULES_LKP'
                           AND flv.language = 'US'
                           AND flv.enabled_flag = 'Y'
                           AND NVL (flv.start_date_active, SYSDATE) <=
                               SYSDATE
                           AND NVL (flv.end_date_active, SYSDATE + 1) >
                               SYSDATE
                           AND flv.attribute1 = TO_CHAR (p_org_id)
                           AND UPPER (flv.attribute2) =
                               UPPER (p_ship_to_country_reg)
                           AND UPPER (NVL (flv.attribute3, 'x')) NOT LIKE
                                   '%' || UPPER (p_ship_to_country) || '%'
                           AND UPPER (flv.attribute4) =
                               UPPER (p_ship_from_country)--AND UPPER(NVL(flv.attribute5, 'x')) NOT LIKE '%'||UPPER(p_ship_from_country)||'%'-- SHIP_FROM Exclusion(for future use).
                                                          ;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        lv_stmt_english   := NULL;
                END;
            END IF;
        ELSE
            SELECT attribute8
              INTO lv_stmt_english
              FROM ra_customer_trx_all
             WHERE customer_trx_id = p_CUSTOMER_TRX_ID;
        END IF;

        x_stmt_english   := lv_stmt_english;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_stmt_english   := NULL;
    --            lv_err_msg := 'Exception while getting EMEA Footer in '||lv_proc_name||' Procedure';
    --            lv_err_msg := SUBSTR(lv_err_msg || 'Error is: '||SQLERRM, 1, 2000);
    --            x_ret_message := lv_err_msg;
    --            x_ret_code := gn_error;
    END get_emea_footer2;

    ----
    ----
    PROCEDURE get_emea_footer (p_org_id                IN     NUMBER,
                               p_ship_to_country_reg   IN     VARCHAR2,
                               p_ship_to_country       IN     VARCHAR2,
                               p_ship_from_country     IN     VARCHAR2,
                               x_stmt_english             OUT VARCHAR2,
                               x_stmt_dutch               OUT VARCHAR2,
                               x_stmt_french              OUT VARCHAR2,
                               x_stmt_german              OUT VARCHAR2--                            ,x_ret_code             OUT NUMBER
                                                                      --                            ,x_ret_message          OUT VARCHAR2
                                                                      )
    IS
        --Local Variables
        lv_proc_name      VARCHAR2 (30) := 'GET_EMEA_FOOTER';
        lv_err_msg        VARCHAR2 (2000) := NULL;
        lv_stmt_english   VARCHAR2 (150) := NULL;
        lv_stmt_dutch     VARCHAR2 (150) := NULL;
        lv_stmt_french    VARCHAR2 (150) := NULL;
        lv_stmt_german    VARCHAR2 (150) := NULL;
    BEGIN
        SELECT                                               --flv.lookup_type
               --,flv.attribute1 operating_unit
               --,flv.attribute2 ship_to_country
               --,flv.attribute3 ship_to_country_exclusion
               --,flv.attribute4 ship_from_country
               flv.attribute6 cfs_statement_english, flv.attribute7 cfs_statement_dutch, flv.attribute8 cfs_statement_french,
               flv.attribute9 cfs_statement_german
          INTO lv_stmt_english, lv_stmt_dutch, lv_stmt_french, lv_stmt_german
          FROM apps.fnd_lookup_values flv
         WHERE     1 = 1
               AND flv.lookup_type LIKE 'XXDO_CFS_SPECIAL_RULES_LKP'
               AND flv.language = 'US'
               AND flv.enabled_flag = 'Y'
               AND NVL (flv.start_date_active, SYSDATE) <= SYSDATE
               AND NVL (flv.end_date_active, SYSDATE + 1) > SYSDATE
               AND flv.attribute1 = TO_CHAR (p_org_id)
               AND UPPER (flv.attribute2) = UPPER (p_ship_to_country_reg)
               AND UPPER (NVL (flv.attribute3, 'x')) NOT LIKE
                       '%' || UPPER (p_ship_to_country) || '%'
               AND UPPER (flv.attribute4) = UPPER (p_ship_from_country)--AND UPPER(NVL(flv.attribute5, 'x')) NOT LIKE '%'||UPPER(p_ship_from_country)||'%'-- SHIP_FROM Exclusion(for future use).
                                                                       ;

        --        SELECT DECODE(:CP_LANG_CODE_CFS, 'FR', flv.attribute8, 'DE', flv.attribute9, 'DU', flv.attribute7, flv.attribute6 )
        --            INTO :CP_TAX_STATEMENT
        --            FROM fnd_lookup_values_vl flv
        --           WHERE lookup_type         ='XXDO_CFS_SPECIAL_RULES_LKP'
        --             AND flv.attribute1        = l_orgid
        --             AND UPPER(flv.attribute4) = UPPER(:CP_SHIP_FROM_CTRY)
        --             AND UPPER(flv.attribute2) = UPPER(l_ship_to_region)
        --             AND UPPER(NVL(flv.attribute3,'x')) NOT LIKE '%' ||UPPER(:CP_SHIP_TO_CTRY) ||'%'; -- SHIP_TO Exclusion
        --          -- AND UPPER(NVL(flv.attribute5,'x')) NOT LIKE '%' ||UPPER(:CP_SHIP_FROM_CTRY) ||'%'; -- SHIP_FROM Exclusion(for future use).

        x_stmt_english   := lv_stmt_english;
        x_stmt_dutch     := lv_stmt_dutch;
        x_stmt_french    := lv_stmt_french;
        x_stmt_german    := lv_stmt_german;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_stmt_english   := NULL;
            x_stmt_dutch     := NULL;
            x_stmt_french    := NULL;
            x_stmt_german    := NULL;
    --            lv_err_msg := 'Exception while getting EMEA Footer in '||lv_proc_name||' Procedure';
    --            lv_err_msg := SUBSTR(lv_err_msg || 'Error is: '||SQLERRM, 1, 2000);
    --            x_ret_message := lv_err_msg;
    --            x_ret_code := gn_error;
    END get_emea_footer;


    -- Start of Change for CCR009103

    PROCEDURE get_sub_totals_prc (p_customer_trx_id IN NUMBER, p_eu_non_eu IN VARCHAR2, p_is_manual_trx IN VARCHAR2, x_st_g_t0 OUT NUMBER, x_st_g_t1 OUT NUMBER, x_st_g_t2 OUT NUMBER, x_st_g_tot OUT NUMBER, x_st_s_t0 OUT NUMBER, x_st_s_t1 OUT NUMBER, x_st_s_t2 OUT NUMBER, x_st_s_tot OUT NUMBER, x_gt_st_t0 OUT NUMBER, x_gt_st_t1 OUT NUMBER, x_gt_st_t2 OUT NUMBER, x_gt_st_tot OUT NUMBER, x_vat_g_t0 OUT NUMBER, x_vat_g_t1 OUT NUMBER, x_vat_g_t2 OUT NUMBER, x_vat_g_tot OUT NUMBER, x_vat_s_t0 OUT NUMBER, x_vat_s_t1 OUT NUMBER, x_vat_s_t2 OUT NUMBER, x_vat_s_tot OUT NUMBER, x_gt_vat_t0 OUT NUMBER, x_gt_vat_t1 OUT NUMBER, x_gt_vat_t2 OUT NUMBER, x_gt_vat_tot OUT NUMBER, x_gt_tot OUT NUMBER, x_tax_rate_T0 OUT VARCHAR2, x_tax_rate_T1 OUT VARCHAR2, x_tax_rate_T2 OUT VARCHAR2, x_tax_desc_T0 OUT VARCHAR2, x_tax_desc_T1 OUT VARCHAR2, x_tax_desc_T2 OUT VARCHAR2, x_tax_rate_val_T0 OUT VARCHAR2, x_tax_rate_val_T1 OUT VARCHAR2
                                  , x_tax_rate_val_T2 OUT VARCHAR2)
    IS
        --Local Variables
        lv_proc_name    VARCHAR2 (30) := 'GET_SUB_TOTALS_PRC';
        --Sub Total Goods
        ln_st_g_t0      NUMBER;
        ln_st_g_t1      NUMBER;
        ln_st_g_t2      NUMBER;
        ln_st_g_tot     NUMBER;
        --Sub Total Services
        ln_st_s_t0      NUMBER;
        ln_st_s_t1      NUMBER;
        ln_st_s_t2      NUMBER;
        ln_st_s_tot     NUMBER;
        --
        ln_gt_st_t0     NUMBER;
        ln_gt_st_t1     NUMBER;
        ln_gt_st_t2     NUMBER;
        ln_gt_st_tot    NUMBER;

        ln_vat_g_t0     NUMBER;
        ln_vat_g_t1     NUMBER;
        ln_vat_g_t2     NUMBER;
        ln_vat_g_tot    NUMBER;

        ln_vat_s_t0     NUMBER;
        ln_vat_s_t1     NUMBER;
        ln_vat_s_t2     NUMBER;
        ln_vat_s_tot    NUMBER;

        ln_gt_vat_t0    NUMBER;
        ln_gt_vat_t1    NUMBER;
        ln_gt_vat_t2    NUMBER;
        ln_gt_vat_tot   NUMBER;
        ln_gt_tot       NUMBER;

        ln_count        NUMBER := 0;


        CURSOR tax_cur (p_customer_trx_id NUMBER)
        IS
              SELECT zl.tax_rate_name, zl.description, rctla.tax_rate
                FROM ra_customer_trx_lines_all rctla, zx_rates_tl zl
               WHERE     line_type = 'TAX'
                     AND zl.language = 'US'
                     AND zl.tax_rate_id = rctla.vat_tax_id
                     AND rctla.customer_trx_id = p_customer_trx_id
            GROUP BY zl.tax_rate_name, zl.description, rctla.tax_rate;
    BEGIN
        /*
                print_log('p_customer_trx_id := ' || p_customer_trx_id);
                print_log('p_is_manual_trx := ' || p_is_manual_trx);
                print_log('p_eu_non_eu := ' || p_eu_non_eu);
        */

        ln_count            := 0;

        x_tax_rate_T0       := NULL;
        x_tax_rate_T1       := NULL;
        x_tax_rate_T2       := NULL;
        x_tax_desc_T0       := NULL;
        x_tax_desc_T1       := NULL;
        x_tax_desc_T2       := NULL;
        x_tax_rate_val_T0   := NULL;
        x_tax_rate_val_T1   := NULL;
        x_tax_rate_val_T2   := NULL;

        FOR i IN tax_cur (p_customer_trx_id)
        LOOP
            ln_count   := ln_count + 1;

            IF ln_count = 1
            THEN
                x_tax_rate_T0       := i.tax_rate_name;
                x_tax_desc_T0       := i.description;
                x_tax_rate_val_T0   := i.tax_rate;

                ln_st_g_t0          := 0;

                BEGIN
                    SELECT NVL (SUM (NVL (rctl.extended_amount, 0)), 0)
                      INTO ln_st_g_t0
                      FROM apps.ra_customer_trx_lines_all rctl,
                           apps.zx_lines zl,
                           (SELECT customer_trx_id, tax_rate, link_to_cust_trx_line_id
                              FROM apps.ra_customer_trx_lines_all rctl_tax
                             WHERE rctl_tax.line_type = 'TAX') trx_tax_rate
                     WHERE     rctl.customer_trx_id = p_customer_trx_id
                           AND rctl.line_type = 'LINE'
                           /*Begin Modification for CFS Phase2, 27-Mar-2018*/
                           --        AND UPPER(rctl.description) NOT LIKE '%FREIGHT%'     --Commented for CFS Phase2
                           AND NOT (    UPPER (description) LIKE '%FREIGHT%'
                                    --Added this And block for CFS Phase2
                                    AND (   inventory_item_id IS NULL
                                         OR inventory_item_id IN
                                                (SELECT msib.inventory_item_id
                                                   FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                        mtl_system_items_b msib
                                                  WHERE     ffvs.flex_value_set_name =
                                                            'XXDO_CFS_FREIGHT_LIST_VS'
                                                        AND ffv.flex_value_set_id =
                                                            ffvs.flex_value_set_id
                                                        --- Added as per 3.0
                                                        AND ffv.enabled_flag =
                                                            'Y'
                                                        AND NVL (
                                                                ffv.start_date_active,
                                                                SYSDATE) <=
                                                            SYSDATE
                                                        AND NVL (
                                                                ffv.end_date_active,
                                                                SYSDATE + 1) >
                                                            SYSDATE
                                                        --- Added as per 3.0
                                                        AND ffv.flex_value =
                                                            hou.NAME
                                                        AND hou.organization_id =
                                                            rctl.org_id
                                                        AND UPPER (
                                                                msib.segment1) =
                                                            UPPER (
                                                                ffv.description))))
                           /*End Modification for CFS Phase2, 27-Mar-2018*/
                           AND rctl.customer_trx_id =
                               trx_tax_rate.customer_trx_id(+)
                           AND rctl.customer_trx_line_id =
                               trx_tax_rate.link_to_cust_trx_line_id(+)
                           AND zl.trx_id = rctl.customer_trx_id
                           AND zl.trx_line_id = rctl.customer_trx_line_id
                           AND zl.internal_organization_id = rctl.org_id
                           AND EXISTS
                                   (SELECT 1
                                      FROM zx_rates_tl ztl
                                     WHERE     language = USERENV ('Lang')
                                           AND ztl.tax_rate_id =
                                               zl.tax_rate_id
                                           AND ztl.tax_rate_name =
                                               i.tax_rate_name);
                --print_log('ST_G_T0 := ' || ln_st_g_t0);
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_st_g_t0   := 0;
                    WHEN OTHERS
                    THEN
                        ln_st_g_t0   := 0;
                END;

                ln_st_s_t0          := 0;

                BEGIN
                    -- Subtotal - Services: Taxable (T0)
                    SELECT NVL (SUM (NVL (rctl.extended_amount, 0)), 0)
                      INTO ln_st_s_t0
                      FROM apps.ra_customer_trx_lines_all rctl,
                           apps.zx_lines zl,
                           (SELECT customer_trx_id, tax_rate, link_to_cust_trx_line_id
                              FROM apps.ra_customer_trx_lines_all rctl_tax
                             WHERE rctl_tax.line_type = 'TAX') trx_tax_rate
                     WHERE     rctl.customer_trx_id = p_customer_trx_id
                           /*Begin Modification for CFS Phase2, 27-Mar-2018*/
                           AND (   line_type = 'FREIGHT'
                                OR (    line_type = 'LINE'
                                    AND UPPER (description) LIKE '%FREIGHT%'
                                    --Added this And block for CFS Phase2
                                    AND (   inventory_item_id IS NULL
                                         OR inventory_item_id IN
                                                (SELECT msib.inventory_item_id
                                                   FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                        mtl_system_items_b msib
                                                  WHERE     ffvs.flex_value_set_name =
                                                            'XXDO_CFS_FREIGHT_LIST_VS'
                                                        AND ffv.flex_value_set_id =
                                                            ffvs.flex_value_set_id
                                                        --- Added as per 3.0
                                                        AND ffv.enabled_flag =
                                                            'Y'
                                                        AND NVL (
                                                                ffv.start_date_active,
                                                                SYSDATE) <=
                                                            SYSDATE
                                                        AND NVL (
                                                                ffv.end_date_active,
                                                                SYSDATE + 1) >
                                                            SYSDATE
                                                        --- Added as per 3.0
                                                        AND ffv.flex_value =
                                                            hou.NAME
                                                        AND hou.organization_id =
                                                            rctl.org_id
                                                        AND UPPER (
                                                                msib.segment1) =
                                                            UPPER (
                                                                ffv.description)))))
                           /*End Modification for CFS Phase2, 27-Mar-2018*/
                           AND rctl.customer_trx_id =
                               trx_tax_rate.customer_trx_id(+)
                           AND rctl.customer_trx_line_id =
                               trx_tax_rate.link_to_cust_trx_line_id(+)
                           AND zl.trx_id(+) = rctl.customer_trx_id
                           AND zl.trx_line_id(+) = rctl.customer_trx_line_id
                           AND zl.internal_organization_id(+) = rctl.org_id
                           AND EXISTS
                                   (SELECT 1
                                      FROM zx_rates_tl ztl
                                     WHERE     language = USERENV ('Lang')
                                           AND ztl.tax_rate_id =
                                               zl.tax_rate_id
                                           AND ztl.tax_rate_name =
                                               i.tax_rate_name);
                --                      AND EXISTS
                --                             (SELECT 1
                --                                FROM zx_rates_tl ztl
                --                               WHERE     language = USERENV ('Lang')
                --                                     AND ztl.tax_rate_id = zl.tax_rate_id
                --                                     AND ztl.tax_rate_name = i.tax_rate_name);
                --                   AND NVL (trx_tax_rate.tax_rate, 0) = 0;
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_st_s_t0   := 0;
                    WHEN OTHERS
                    THEN
                        ln_st_s_t0   := 0;
                END;

                ln_vat_g_t0         := 0;

                BEGIN
                    -- VAT - Goods : Taxable (T0)
                    SELECT NVL (SUM (NVL (rctl_tax.extended_amount, 0)), 0)
                      INTO ln_vat_g_t0
                      FROM apps.ra_customer_trx_lines_all rctl_tax,
                           apps.zx_lines zl,
                           (SELECT customer_trx_id, customer_trx_line_id, org_id
                              FROM apps.ra_customer_trx_lines_all rctl
                             WHERE     rctl.line_type = 'LINE'
                                   AND NOT (    UPPER (description) LIKE
                                                    '%FREIGHT%'
                                            AND (   inventory_item_id IS NULL
                                                 OR inventory_item_id IN
                                                        (SELECT msib.inventory_item_id
                                                           FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                                mtl_system_items_b msib
                                                          WHERE     ffvs.flex_value_set_name =
                                                                    'XXDO_CFS_FREIGHT_LIST_VS'
                                                                AND ffv.flex_value_set_id =
                                                                    ffvs.flex_value_set_id
                                                                --- Added as per 3.0
                                                                AND ffv.enabled_flag =
                                                                    'Y'
                                                                AND NVL (
                                                                        ffv.start_date_active,
                                                                        SYSDATE) <=
                                                                    SYSDATE
                                                                AND NVL (
                                                                        ffv.end_date_active,
                                                                          SYSDATE
                                                                        + 1) >
                                                                    SYSDATE
                                                                --- Added as per 3.0
                                                                AND ffv.flex_value =
                                                                    hou.NAME
                                                                AND hou.organization_id =
                                                                    rctl.org_id
                                                                AND UPPER (
                                                                        msib.segment1) =
                                                                    UPPER (
                                                                        ffv.description))))
                                   AND rctl.customer_trx_id =
                                       p_customer_trx_id) trx_line
                     WHERE     rctl_tax.customer_trx_id = p_customer_trx_id
                           AND rctl_tax.line_type = 'TAX'
                           --AND NVL (tax_rate, 0) = 0
                           AND rctl_tax.customer_trx_id =
                               trx_line.customer_trx_id
                           AND rctl_tax.link_to_cust_trx_line_id =
                               trx_line.customer_trx_line_id
                           AND zl.trx_id = trx_line.customer_trx_id
                           AND zl.trx_line_id = trx_line.customer_trx_line_id
                           AND zl.internal_organization_id = trx_line.org_id
                           AND EXISTS
                                   (SELECT 1
                                      FROM zx_rates_tl ztl
                                     WHERE     language = USERENV ('Lang')
                                           AND ztl.tax_rate_id =
                                               zl.tax_rate_id
                                           AND ztl.tax_rate_name =
                                               i.tax_rate_name);
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_vat_g_t0   := 0;
                    WHEN OTHERS
                    THEN
                        ln_vat_g_t0   := 0;
                END;

                ln_vat_s_t0         := 0;

                BEGIN
                    -- VAT - Services : Taxable (T0)
                    SELECT NVL (SUM (NVL (rctl_tax.extended_amount, 0)), 0)
                      INTO ln_vat_s_t0
                      FROM apps.ra_customer_trx_lines_all rctl_tax,
                           apps.zx_lines zl,
                           (SELECT customer_trx_id, customer_trx_line_id, org_id
                              FROM apps.ra_customer_trx_lines_all rctl
                             WHERE     1 = 1
                                   AND (   line_type = 'FREIGHT'
                                        OR (    line_type = 'LINE'
                                            AND UPPER (description) LIKE
                                                    '%FREIGHT%'
                                            AND (   inventory_item_id IS NULL
                                                 OR inventory_item_id IN
                                                        (SELECT msib.inventory_item_id
                                                           FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                                mtl_system_items_b msib
                                                          WHERE     ffvs.flex_value_set_name =
                                                                    'XXDO_CFS_FREIGHT_LIST_VS'
                                                                AND ffv.flex_value_set_id =
                                                                    ffvs.flex_value_set_id
                                                                --- Added as per 3.0
                                                                AND ffv.enabled_flag =
                                                                    'Y'
                                                                AND NVL (
                                                                        ffv.start_date_active,
                                                                        SYSDATE) <=
                                                                    SYSDATE
                                                                AND NVL (
                                                                        ffv.end_date_active,
                                                                          SYSDATE
                                                                        + 1) >
                                                                    SYSDATE
                                                                --- Added as per 3.0
                                                                AND ffv.flex_value =
                                                                    hou.NAME
                                                                AND hou.organization_id =
                                                                    rctl.org_id
                                                                AND UPPER (
                                                                        msib.segment1) =
                                                                    UPPER (
                                                                        ffv.description)))))
                                   AND rctl.customer_trx_id =
                                       p_customer_trx_id) trx_line
                     WHERE     rctl_tax.customer_trx_id = p_customer_trx_id
                           AND rctl_tax.line_type = 'TAX'
                           --AND NVL (tax_rate, 0) = 0
                           AND rctl_tax.customer_trx_id =
                               trx_line.customer_trx_id
                           AND rctl_tax.link_to_cust_trx_line_id =
                               trx_line.customer_trx_line_id
                           AND zl.trx_id = trx_line.customer_trx_id
                           AND zl.trx_line_id = trx_line.customer_trx_line_id
                           AND zl.internal_organization_id = trx_line.org_id
                           AND EXISTS
                                   (SELECT 1
                                      FROM zx_rates_tl ztl
                                     WHERE     language = USERENV ('Lang')
                                           AND ztl.tax_rate_id =
                                               zl.tax_rate_id
                                           AND ztl.tax_rate_name =
                                               i.tax_rate_name);
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_vat_s_t0   := 0;
                    WHEN OTHERS
                    THEN
                        ln_vat_s_t0   := 0;
                END;
            ELSIF ln_count = 2
            THEN
                ln_st_g_t1          := 0;

                x_tax_rate_T1       := i.tax_rate_name;
                x_tax_desc_T1       := i.description;
                x_tax_rate_val_T1   := i.tax_rate;

                BEGIN
                    --Subtotal - Goods: Taxable (T1)
                    SELECT NVL (SUM (NVL (rctl.extended_amount, 0)), 0)
                      INTO ln_st_g_t1
                      FROM apps.ra_customer_trx_lines_all rctl,
                           apps.zx_lines zl,
                           (SELECT customer_trx_id, tax_rate, link_to_cust_trx_line_id
                              FROM apps.ra_customer_trx_lines_all rctl_tax
                             WHERE rctl_tax.line_type = 'TAX' --AND NVL (tax_rate, 0) <> 0
                                                             ) trx_tax_rate
                     WHERE     rctl.customer_trx_id = p_customer_trx_id
                           AND rctl.line_type = 'LINE'
                           /*Begin Modification for CFS Phase2, 27-Mar-2018*/
                           --        AND UPPER(rctl.description) NOT LIKE '%FREIGHT%'     --Commented for CFS Phase2
                           AND NOT (    UPPER (description) LIKE '%FREIGHT%'
                                    --Added this And block for CFS Phase2
                                    AND (   inventory_item_id IS NULL
                                         OR inventory_item_id IN
                                                (SELECT msib.inventory_item_id
                                                   FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                        mtl_system_items_b msib
                                                  WHERE     ffvs.flex_value_set_name =
                                                            'XXDO_CFS_FREIGHT_LIST_VS'
                                                        AND ffv.flex_value_set_id =
                                                            ffvs.flex_value_set_id
                                                        --- Added as per 3.0
                                                        AND ffv.enabled_flag =
                                                            'Y'
                                                        AND NVL (
                                                                ffv.start_date_active,
                                                                SYSDATE) <=
                                                            SYSDATE
                                                        AND NVL (
                                                                ffv.end_date_active,
                                                                SYSDATE + 1) >
                                                            SYSDATE
                                                        --- Added as per 3.0
                                                        AND ffv.flex_value =
                                                            hou.NAME
                                                        AND hou.organization_id =
                                                            rctl.org_id
                                                        AND UPPER (
                                                                msib.segment1) =
                                                            UPPER (
                                                                ffv.description))))
                           /*End Modification for CFS Phase2, 27-Mar-2018*/
                           AND rctl.customer_trx_id =
                               trx_tax_rate.customer_trx_id
                           AND rctl.customer_trx_line_id =
                               trx_tax_rate.link_to_cust_trx_line_id
                           AND zl.trx_id = rctl.customer_trx_id
                           AND zl.trx_line_id = rctl.customer_trx_line_id
                           AND zl.internal_organization_id = rctl.org_id
                           AND EXISTS
                                   (SELECT 1
                                      FROM zx_rates_tl ztl
                                     WHERE     language = USERENV ('Lang')
                                           AND ztl.tax_rate_id =
                                               zl.tax_rate_id
                                           AND ztl.tax_rate_name =
                                               i.tax_rate_name);
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_st_g_t1   := 0;
                    WHEN OTHERS
                    THEN
                        ln_st_g_t1   := 0;
                END;

                ln_st_s_t1          := 0;

                BEGIN
                    -- Subtotal - Services: Taxable (T1)
                    SELECT NVL (SUM (NVL (rctl.extended_amount, 0)), 0)
                      INTO ln_st_s_t1
                      FROM apps.ra_customer_trx_lines_all rctl,
                           apps.zx_lines zl,
                           (SELECT customer_trx_id, tax_rate, link_to_cust_trx_line_id
                              FROM apps.ra_customer_trx_lines_all rctl_tax
                             WHERE rctl_tax.line_type = 'TAX'--AND NVL (tax_rate, 0) <> 0
                                                             ) trx_tax_rate
                     WHERE     rctl.customer_trx_id = p_customer_trx_id
                           /*Begin Modification for CFS Phase2, 27-Mar-2018*/
                           AND (   line_type = 'FREIGHT'
                                OR (    line_type = 'LINE'
                                    AND UPPER (description) LIKE '%FREIGHT%'
                                    --Added this And block for CFS Phase2
                                    AND (   inventory_item_id IS NULL
                                         OR inventory_item_id IN
                                                (SELECT msib.inventory_item_id
                                                   FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                        mtl_system_items_b msib
                                                  WHERE     ffvs.flex_value_set_name =
                                                            'XXDO_CFS_FREIGHT_LIST_VS'
                                                        AND ffv.flex_value_set_id =
                                                            ffvs.flex_value_set_id
                                                        --- Added as per 3.0
                                                        AND ffv.enabled_flag =
                                                            'Y'
                                                        AND NVL (
                                                                ffv.start_date_active,
                                                                SYSDATE) <=
                                                            SYSDATE
                                                        AND NVL (
                                                                ffv.end_date_active,
                                                                SYSDATE + 1) >
                                                            SYSDATE
                                                        --- Added as per 3.0
                                                        AND ffv.flex_value =
                                                            hou.NAME
                                                        AND hou.organization_id =
                                                            rctl.org_id
                                                        AND UPPER (
                                                                msib.segment1) =
                                                            UPPER (
                                                                ffv.description)))))
                           /*End Modification for CFS Phase2, 27-Mar-2018*/
                           AND rctl.customer_trx_id =
                               trx_tax_rate.customer_trx_id
                           AND rctl.customer_trx_line_id =
                               trx_tax_rate.link_to_cust_trx_line_id
                           AND zl.trx_id(+) = rctl.customer_trx_id
                           AND zl.trx_line_id(+) = rctl.customer_trx_line_id
                           AND zl.internal_organization_id(+) = rctl.org_id
                           AND EXISTS
                                   (SELECT 1
                                      FROM zx_rates_tl ztl
                                     WHERE     language = USERENV ('Lang')
                                           AND ztl.tax_rate_id =
                                               zl.tax_rate_id
                                           AND ztl.tax_rate_name =
                                               i.tax_rate_name);
                --                      AND EXISTS
                --                             (SELECT 1
                --                                FROM zx_rates_tl ztl
                --                               WHERE     language = USERENV ('Lang')
                --                                     AND ztl.tax_rate_id = zl.tax_rate_id
                --                                     AND ztl.tax_rate_name = i.tax_rate_name);
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_st_s_t1   := 0;
                    WHEN OTHERS
                    THEN
                        ln_st_s_t1   := 0;
                END;

                ln_vat_g_t1         := 0;

                BEGIN
                    -- VAT - Goods : Taxable (T1)
                    SELECT NVL (SUM (NVL (rctl_tax.extended_amount, 0)), 0)
                      INTO ln_vat_g_t1
                      FROM apps.ra_customer_trx_lines_all rctl_tax,
                           apps.zx_lines zl,
                           (SELECT customer_trx_id, customer_trx_line_id, org_id
                              FROM apps.ra_customer_trx_lines_all rctl
                             WHERE     rctl.line_type = 'LINE'
                                   AND NOT (    UPPER (description) LIKE
                                                    '%FREIGHT%'
                                            AND (   inventory_item_id IS NULL
                                                 OR inventory_item_id IN
                                                        (SELECT msib.inventory_item_id
                                                           FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                                mtl_system_items_b msib
                                                          WHERE     ffvs.flex_value_set_name =
                                                                    'XXDO_CFS_FREIGHT_LIST_VS'
                                                                AND ffv.flex_value_set_id =
                                                                    ffvs.flex_value_set_id
                                                                --- Added as per 3.0
                                                                AND ffv.enabled_flag =
                                                                    'Y'
                                                                AND NVL (
                                                                        ffv.start_date_active,
                                                                        SYSDATE) <=
                                                                    SYSDATE
                                                                AND NVL (
                                                                        ffv.end_date_active,
                                                                          SYSDATE
                                                                        + 1) >
                                                                    SYSDATE
                                                                --- Added as per 3.0
                                                                AND ffv.flex_value =
                                                                    hou.NAME
                                                                AND hou.organization_id =
                                                                    rctl.org_id
                                                                AND UPPER (
                                                                        msib.segment1) =
                                                                    UPPER (
                                                                        ffv.description))))
                                   AND rctl.customer_trx_id =
                                       p_customer_trx_id) trx_line
                     WHERE     rctl_tax.customer_trx_id = p_customer_trx_id
                           AND rctl_tax.line_type = 'TAX'
                           --AND NVL (tax_rate, 0) <> 0
                           AND rctl_tax.customer_trx_id =
                               trx_line.customer_trx_id
                           AND rctl_tax.link_to_cust_trx_line_id =
                               trx_line.customer_trx_line_id
                           AND zl.trx_id = trx_line.customer_trx_id
                           AND zl.trx_line_id = trx_line.customer_trx_line_id
                           AND zl.internal_organization_id = trx_line.org_id
                           AND EXISTS
                                   (SELECT 1
                                      FROM zx_rates_tl ztl
                                     WHERE     language = USERENV ('Lang')
                                           AND ztl.tax_rate_id =
                                               zl.tax_rate_id
                                           AND ztl.tax_rate_name =
                                               i.tax_rate_name);
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_vat_g_t1   := 0;
                    WHEN OTHERS
                    THEN
                        ln_vat_g_t1   := 0;
                END;

                ln_vat_s_t1         := 0;

                BEGIN
                    -- VAT - Services : Taxable (T1)
                    SELECT NVL (SUM (NVL (rctl_tax.extended_amount, 0)), 0)
                      INTO ln_vat_s_t1
                      FROM apps.ra_customer_trx_lines_all rctl_tax,
                           apps.zx_lines zl,
                           (SELECT customer_trx_id, customer_trx_line_id, org_id
                              FROM apps.ra_customer_trx_lines_all rctl
                             WHERE     1 = 1
                                   AND (   line_type = 'FREIGHT'
                                        OR (    line_type = 'LINE'
                                            AND UPPER (description) LIKE
                                                    '%FREIGHT%'
                                            AND (   inventory_item_id IS NULL
                                                 OR inventory_item_id IN
                                                        (SELECT msib.inventory_item_id
                                                           FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                                mtl_system_items_b msib
                                                          WHERE     ffvs.flex_value_set_name =
                                                                    'XXDO_CFS_FREIGHT_LIST_VS'
                                                                AND ffv.flex_value_set_id =
                                                                    ffvs.flex_value_set_id
                                                                --- Added as per 3.0
                                                                AND ffv.enabled_flag =
                                                                    'Y'
                                                                AND NVL (
                                                                        ffv.start_date_active,
                                                                        SYSDATE) <=
                                                                    SYSDATE
                                                                AND NVL (
                                                                        ffv.end_date_active,
                                                                          SYSDATE
                                                                        + 1) >
                                                                    SYSDATE
                                                                --- Added as per 3.0
                                                                AND ffv.flex_value =
                                                                    hou.NAME
                                                                AND hou.organization_id =
                                                                    rctl.org_id
                                                                AND UPPER (
                                                                        msib.segment1) =
                                                                    UPPER (
                                                                        ffv.description)))))
                                   AND rctl.customer_trx_id =
                                       p_customer_trx_id) trx_line
                     WHERE     rctl_tax.customer_trx_id = p_customer_trx_id
                           AND rctl_tax.line_type = 'TAX'
                           --AND NVL (tax_rate, 0) <> 0
                           AND rctl_tax.customer_trx_id =
                               trx_line.customer_trx_id
                           AND rctl_tax.link_to_cust_trx_line_id =
                               trx_line.customer_trx_line_id
                           AND zl.trx_id = trx_line.customer_trx_id
                           AND zl.trx_line_id = trx_line.customer_trx_line_id
                           AND zl.internal_organization_id = trx_line.org_id
                           AND EXISTS
                                   (SELECT 1
                                      FROM zx_rates_tl ztl
                                     WHERE     language = USERENV ('Lang')
                                           AND ztl.tax_rate_id =
                                               zl.tax_rate_id
                                           AND ztl.tax_rate_name =
                                               i.tax_rate_name);
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_vat_s_t1   := 0;
                    WHEN OTHERS
                    THEN
                        ln_vat_s_t1   := 0;
                END;
            ELSIF ln_count = 3
            THEN
                x_tax_rate_T2       := i.tax_rate_name;
                x_tax_desc_T2       := i.description;
                x_tax_rate_val_T2   := i.tax_rate;

                ln_st_g_t2          := 0;


                BEGIN
                    -- Subtotal - Goods :: Non-Taxable (T2)
                    SELECT NVL (SUM (NVL (rctl.extended_amount, 0)), 0)
                      INTO ln_st_g_t2
                      FROM apps.ra_customer_trx_lines_all rctl,
                           apps.zx_lines zl,
                           (SELECT customer_trx_id, tax_rate, link_to_cust_trx_line_id
                              FROM apps.ra_customer_trx_lines_all rctl_tax
                             WHERE rctl_tax.line_type = 'TAX') trx_tax_rate
                     WHERE     rctl.customer_trx_id = p_customer_trx_id
                           --:CUSTOMER_TRX_ID
                           AND rctl.line_type = 'LINE'
                           /*Begin Modification for CFS Phase2, 27-Mar-2018*/
                           --        AND UPPER(rctl.description) NOT LIKE '%FREIGHT%'     --Commented for CFS Phase2
                           AND NOT (    UPPER (description) LIKE '%FREIGHT%'
                                    --Added this And block for CFS Phase2
                                    AND (   inventory_item_id IS NULL
                                         OR inventory_item_id IN
                                                (SELECT msib.inventory_item_id
                                                   FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                        mtl_system_items_b msib
                                                  WHERE     ffvs.flex_value_set_name =
                                                            'XXDO_CFS_FREIGHT_LIST_VS'
                                                        AND ffv.flex_value_set_id =
                                                            ffvs.flex_value_set_id
                                                        --- Added as per 3.0
                                                        AND ffv.enabled_flag =
                                                            'Y'
                                                        AND NVL (
                                                                ffv.start_date_active,
                                                                SYSDATE) <=
                                                            SYSDATE
                                                        AND NVL (
                                                                ffv.end_date_active,
                                                                SYSDATE + 1) >
                                                            SYSDATE
                                                        --- Added as per 3.0
                                                        AND ffv.flex_value =
                                                            hou.NAME
                                                        AND hou.organization_id =
                                                            rctl.org_id
                                                        AND UPPER (
                                                                msib.segment1) =
                                                            UPPER (
                                                                ffv.description))))
                           /*End Modification for CFS2, 27-Mar-2018*/
                           AND rctl.customer_trx_id =
                               trx_tax_rate.customer_trx_id(+)
                           AND rctl.customer_trx_line_id =
                               trx_tax_rate.link_to_cust_trx_line_id(+)
                           AND zl.trx_id = rctl.customer_trx_id
                           AND zl.trx_line_id = rctl.customer_trx_line_id
                           AND zl.internal_organization_id = rctl.org_id
                           AND EXISTS
                                   (SELECT 1
                                      FROM zx_rates_tl ztl
                                     WHERE     language = USERENV ('Lang')
                                           AND ztl.tax_rate_id =
                                               zl.tax_rate_id
                                           AND ztl.tax_rate_name =
                                               i.tax_rate_name);
                --print_log('ST_G_T2 := ' || ln_st_g_t2);
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_st_g_t2   := 0;
                    WHEN OTHERS
                    THEN
                        ln_st_g_t2   := 0;
                END;

                ln_st_s_t2          := 0;

                BEGIN
                    -- Subtotal - Services :: Non-Taxable (T2)
                    SELECT NVL (SUM (NVL (rctl.extended_amount, 0)), 0)
                      INTO ln_st_s_t2
                      FROM apps.ra_customer_trx_lines_all rctl,
                           apps.zx_lines zl,
                           (SELECT customer_trx_id, tax_rate, link_to_cust_trx_line_id
                              FROM apps.ra_customer_trx_lines_all rctl_tax
                             WHERE rctl_tax.line_type = 'TAX') trx_tax_rate
                     WHERE     rctl.customer_trx_id = p_customer_trx_id
                           /*Begin Modification for CFS Phase2, 27-Mar-2018*/
                           AND (   line_type = 'FREIGHT'
                                OR (    line_type = 'LINE'
                                    AND UPPER (description) LIKE '%FREIGHT%'
                                    --Added this And block for CFS Phase2
                                    AND (   inventory_item_id IS NULL
                                         OR inventory_item_id IN
                                                (SELECT msib.inventory_item_id
                                                   FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                        mtl_system_items_b msib
                                                  WHERE     ffvs.flex_value_set_name =
                                                            'XXDO_CFS_FREIGHT_LIST_VS'
                                                        AND ffv.flex_value_set_id =
                                                            ffvs.flex_value_set_id
                                                        --- Added as per 3.0
                                                        AND ffv.enabled_flag =
                                                            'Y'
                                                        AND NVL (
                                                                ffv.start_date_active,
                                                                SYSDATE) <=
                                                            SYSDATE
                                                        AND NVL (
                                                                ffv.end_date_active,
                                                                SYSDATE + 1) >
                                                            SYSDATE
                                                        --- Added as per 3.0
                                                        AND ffv.flex_value =
                                                            hou.NAME
                                                        AND hou.organization_id =
                                                            rctl.org_id
                                                        AND UPPER (
                                                                msib.segment1) =
                                                            UPPER (
                                                                ffv.description)))))
                           /*End Modification for CFS Phase2, 27-Mar-2018*/
                           AND rctl.customer_trx_id =
                               trx_tax_rate.customer_trx_id(+)
                           AND rctl.customer_trx_line_id =
                               trx_tax_rate.link_to_cust_trx_line_id(+)
                           AND zl.trx_id(+) = rctl.customer_trx_id
                           AND zl.trx_line_id(+) = rctl.customer_trx_line_id
                           AND zl.internal_organization_id(+) = rctl.org_id
                           AND EXISTS
                                   (SELECT 1
                                      FROM zx_rates_tl ztl
                                     WHERE     language = USERENV ('Lang')
                                           AND ztl.tax_rate_id =
                                               zl.tax_rate_id
                                           AND ztl.tax_rate_name =
                                               i.tax_rate_name);
                --                      AND EXISTS
                --                             (SELECT 1
                --                                FROM zx_rates_tl ztl
                --                               WHERE     language = USERENV ('Lang')
                --                                     AND ztl.tax_rate_id = zl.tax_rate_id
                --                                     AND ztl.tax_rate_name = i.tax_rate_name);
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_st_s_t2   := 0;
                    WHEN OTHERS
                    THEN
                        ln_st_s_t2   := 0;
                END;

                ln_vat_g_t2         := 0;

                BEGIN
                    -- VAT - Goods  :: Non-Taxable (T2)
                    SELECT NVL (SUM (NVL (rctl_tax.extended_amount, 0)), 0)
                      INTO ln_vat_g_t2
                      FROM apps.ra_customer_trx_lines_all rctl_tax,
                           apps.zx_lines zl,
                           (SELECT customer_trx_id, customer_trx_line_id, org_id
                              FROM apps.ra_customer_trx_lines_all rctl
                             WHERE     rctl.line_type = 'LINE'
                                   AND NOT (    UPPER (description) LIKE
                                                    '%FREIGHT%'
                                            AND (   inventory_item_id IS NULL
                                                 OR inventory_item_id IN
                                                        (SELECT msib.inventory_item_id
                                                           FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                                mtl_system_items_b msib
                                                          WHERE     ffvs.flex_value_set_name =
                                                                    'XXDO_CFS_FREIGHT_LIST_VS'
                                                                AND ffv.flex_value_set_id =
                                                                    ffvs.flex_value_set_id
                                                                --- Added as per 3.0
                                                                AND ffv.enabled_flag =
                                                                    'Y'
                                                                AND NVL (
                                                                        ffv.start_date_active,
                                                                        SYSDATE) <=
                                                                    SYSDATE
                                                                AND NVL (
                                                                        ffv.end_date_active,
                                                                          SYSDATE
                                                                        + 1) >
                                                                    SYSDATE
                                                                --- Added as per 3.0
                                                                AND ffv.flex_value =
                                                                    hou.NAME
                                                                AND hou.organization_id =
                                                                    rctl.org_id
                                                                AND UPPER (
                                                                        msib.segment1) =
                                                                    UPPER (
                                                                        ffv.description))))
                                   AND rctl.customer_trx_id =
                                       p_customer_trx_id) trx_line
                     WHERE     rctl_tax.customer_trx_id = p_customer_trx_id
                           AND rctl_tax.line_type = 'TAX'
                           AND rctl_tax.customer_trx_id =
                               trx_line.customer_trx_id
                           AND rctl_tax.link_to_cust_trx_line_id =
                               trx_line.customer_trx_line_id
                           AND zl.trx_id = trx_line.customer_trx_id
                           AND zl.trx_line_id = trx_line.customer_trx_line_id
                           AND zl.internal_organization_id = trx_line.org_id
                           AND EXISTS
                                   (SELECT 1
                                      FROM zx_rates_tl ztl
                                     WHERE     language = USERENV ('Lang')
                                           AND ztl.tax_rate_id =
                                               zl.tax_rate_id
                                           AND ztl.tax_rate_name =
                                               i.tax_rate_name);
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_vat_g_t2   := 0;
                    WHEN OTHERS
                    THEN
                        ln_vat_g_t2   := 0;
                END;

                ln_vat_s_t2         := 0;

                BEGIN
                    -- VAT - Services  :: Non-Taxable (T2)
                    SELECT NVL (SUM (NVL (rctl_tax.extended_amount, 0)), 0)
                      INTO ln_vat_s_t2
                      FROM apps.ra_customer_trx_lines_all rctl_tax,
                           apps.zx_lines zl,
                           (SELECT customer_trx_id, customer_trx_line_id, org_id
                              FROM apps.ra_customer_trx_lines_all rctl
                             WHERE     1 = 1
                                   AND (   line_type = 'FREIGHT'
                                        OR (    line_type = 'LINE'
                                            AND UPPER (description) LIKE
                                                    '%FREIGHT%'
                                            AND (   inventory_item_id IS NULL
                                                 OR inventory_item_id IN
                                                        (SELECT msib.inventory_item_id
                                                           FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                                mtl_system_items_b msib
                                                          WHERE     ffvs.flex_value_set_name =
                                                                    'XXDO_CFS_FREIGHT_LIST_VS'
                                                                AND ffv.flex_value_set_id =
                                                                    ffvs.flex_value_set_id
                                                                --- Added as per 3.0
                                                                AND ffv.enabled_flag =
                                                                    'Y'
                                                                AND NVL (
                                                                        ffv.start_date_active,
                                                                        SYSDATE) <=
                                                                    SYSDATE
                                                                AND NVL (
                                                                        ffv.end_date_active,
                                                                          SYSDATE
                                                                        + 1) >
                                                                    SYSDATE
                                                                --- Added as per 3.0
                                                                AND ffv.flex_value =
                                                                    hou.NAME
                                                                AND hou.organization_id =
                                                                    rctl.org_id
                                                                AND UPPER (
                                                                        msib.segment1) =
                                                                    UPPER (
                                                                        ffv.description)))))
                                   AND rctl.customer_trx_id =
                                       p_customer_trx_id) trx_line
                     WHERE     rctl_tax.customer_trx_id = p_customer_trx_id
                           AND rctl_tax.line_type = 'TAX'
                           AND rctl_tax.customer_trx_id =
                               trx_line.customer_trx_id
                           AND rctl_tax.link_to_cust_trx_line_id =
                               trx_line.customer_trx_line_id
                           AND zl.trx_id = trx_line.customer_trx_id
                           AND zl.trx_line_id = trx_line.customer_trx_line_id
                           AND zl.internal_organization_id = trx_line.org_id
                           AND EXISTS
                                   (SELECT 1
                                      FROM zx_rates_tl ztl
                                     WHERE     language = USERENV ('Lang')
                                           AND ztl.tax_rate_id =
                                               zl.tax_rate_id
                                           AND ztl.tax_rate_name =
                                               i.tax_rate_name);
                EXCEPTION
                    WHEN NO_DATA_FOUND
                    THEN
                        ln_vat_s_t2   := 0;
                    WHEN OTHERS
                    THEN
                        ln_vat_s_t2   := 0;
                END;
            END IF;
        END LOOP;


        BEGIN
            -- Subtotal - Goods: Taxable (T0)



            -- Subtotal - Goods :: Total Invoice.
            BEGIN
                SELECT NVL (ln_st_g_t0, 0) + NVL (ln_st_g_t1, 0) + NVL (ln_st_g_t2, 0)
                  INTO ln_st_g_tot
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_st_g_tot   := 0;
            END;

            -- Subtotal - Services :: Total Invoice.
            BEGIN
                SELECT NVL (ln_st_s_t0, 0) + NVL (ln_st_s_t1, 0) + NVL (ln_st_s_t2, 0)
                  INTO ln_st_s_tot
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_st_s_tot   := 0;
            END;

            -- Grand Total :: Taxable (T0).
            BEGIN
                SELECT NVL (ln_st_g_t0, 0) + NVL (ln_st_s_t0, 0)
                  INTO ln_gt_st_t0
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_gt_st_t0   := 0;
            END;

            -- Grand Total :: Taxable (T1).
            BEGIN
                SELECT NVL (ln_st_g_t1, 0) + NVL (ln_st_s_t1, 0)
                  INTO ln_gt_st_t1
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_gt_st_t1   := 0;
            END;

            -- Grand Total :: Non-Taxable (T2).
            BEGIN
                SELECT NVL (ln_st_g_t2, 0) + NVL (ln_st_s_t2, 0)
                  INTO ln_gt_st_t2
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_gt_st_t2   := 0;
            END;

            -- Grand Total :: Total Invoice.
            BEGIN
                SELECT NVL (ln_st_g_tot, 0) + NVL (ln_st_s_tot, 0)
                  INTO ln_gt_st_tot
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_gt_st_tot   := 0;
            END;

            -- Grand Total (VAT) :: Taxable (T0).
            BEGIN
                SELECT NVL (ln_vat_g_t0, 0) + NVL (ln_vat_s_t0, 0)
                  INTO ln_gt_vat_t0
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_gt_vat_t0   := 0;
            END;

            -- Grand Total (VAT) :: Taxable (T1).
            BEGIN
                SELECT NVL (ln_vat_g_t1, 0) + NVL (ln_vat_s_t1, 0)
                  INTO ln_gt_vat_t1
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_gt_vat_t1   := 0;
            END;

            -- Grand Total (VAT) :: Non-Taxable (T2).
            BEGIN
                SELECT NVL (ln_vat_g_t2, 0) + NVL (ln_vat_s_t2, 0)
                  INTO ln_gt_vat_t2
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_gt_vat_t2   := 0;
            END;

            -- Grand Total (VAT) :: Total Invoice.
            BEGIN
                SELECT NVL (ln_vat_g_tot, 0) + NVL (ln_vat_s_tot, 0)
                  INTO ln_gt_vat_tot
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_gt_vat_tot   := 0;
            END;

            -- Grand Total :: Total Invoice Amount.
            BEGIN
                SELECT NVL (ln_gt_st_tot, 0) + NVL (ln_gt_vat_tot, 0)
                  INTO ln_gt_tot
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    ln_gt_tot   := 0;
            END;

            x_st_g_t0      := ln_st_g_t0;
            x_st_g_t1      := ln_st_g_t1;
            x_st_g_t2      := ln_st_g_t2;
            x_st_g_tot     := ln_st_g_tot;

            x_st_s_t0      := ln_st_s_t0;
            x_st_s_t1      := ln_st_s_t1;
            x_st_s_t2      := ln_st_s_t2;
            x_st_s_tot     := ln_st_s_tot;

            x_gt_st_t0     := ln_gt_st_t0;
            x_gt_st_t1     := ln_gt_st_t1;
            x_gt_st_t2     := ln_gt_st_t2;
            x_gt_st_tot    := ln_gt_st_tot;

            x_vat_g_t0     := ln_vat_g_t0;
            x_vat_g_t1     := ln_vat_g_t1;
            x_vat_g_t2     := ln_vat_g_t2;
            x_vat_g_tot    := ln_vat_g_tot;

            x_vat_s_t0     := ln_vat_s_t0;
            x_vat_s_t1     := ln_vat_s_t1;
            x_vat_s_t2     := ln_vat_s_t2;
            x_vat_s_tot    := ln_vat_s_tot;

            x_gt_vat_t0    := ln_gt_vat_t0;
            x_gt_vat_t1    := ln_gt_vat_t1;
            x_gt_vat_t2    := ln_gt_vat_t2;
            x_gt_vat_tot   := ln_gt_vat_tot;
            x_gt_tot       := ln_gt_tot;
        /*
                print_log('x_st_g_t0 := ' || x_st_g_t0);
                print_log('x_st_g_t1 := ' || x_st_g_t1);
                print_log('x_st_g_t2 := ' || x_st_g_t2);

                print_log('x_st_s_t0 := ' || x_st_s_t0);
                print_log('x_st_s_t1 := ' || x_st_s_t1);
                print_log('x_st_s_t2 := ' || x_st_s_t2);

                print_log('x_vat_g_t0 := ' || x_vat_g_t0);
                print_log('x_vat_g_t1 := ' || x_vat_g_t1);
                print_log('x_vat_g_t2 := ' || x_vat_g_t2);

                print_log('x_vat_s_t0 := ' || x_vat_s_t0);
                print_log('x_vat_s_t1 := ' || x_vat_s_t1);
                print_log('x_vat_s_t2 := ' || x_vat_s_t2);
        */
        EXCEPTION
            WHEN OTHERS
            THEN
                NULL;
        END;
    END get_sub_totals_prc;


    -- End of Change for CCR0009103

    ----
    ----
    -----------------------------------------
    -- Subtotal Derivations :: T0, T1 and T2.
    -----------------------------------------
    PROCEDURE get_sub_totals (p_customer_trx_id IN NUMBER, p_eu_non_eu IN VARCHAR2, p_is_manual_trx IN VARCHAR2, x_st_g_t0 OUT NUMBER, x_st_g_t1 OUT NUMBER, x_st_g_t2 OUT NUMBER, x_st_g_tot OUT NUMBER, x_st_s_t0 OUT NUMBER, x_st_s_t1 OUT NUMBER, x_st_s_t2 OUT NUMBER, x_st_s_tot OUT NUMBER, x_gt_st_t0 OUT NUMBER, x_gt_st_t1 OUT NUMBER, x_gt_st_t2 OUT NUMBER, x_gt_st_tot OUT NUMBER, x_vat_g_t0 OUT NUMBER, x_vat_g_t1 OUT NUMBER, x_vat_g_t2 OUT NUMBER, x_vat_g_tot OUT NUMBER, x_vat_s_t0 OUT NUMBER, x_vat_s_t1 OUT NUMBER, x_vat_s_t2 OUT NUMBER, x_vat_s_tot OUT NUMBER, x_gt_vat_t0 OUT NUMBER, x_gt_vat_t1 OUT NUMBER, x_gt_vat_t2 OUT NUMBER, x_gt_vat_tot OUT NUMBER
                              , x_gt_tot OUT NUMBER)
    IS
        --Local Variables
        lv_proc_name    VARCHAR2 (30) := 'GET_SUB_TOTALS';
        --Sub Total Goods
        ln_st_g_t0      NUMBER;
        ln_st_g_t1      NUMBER;
        ln_st_g_t2      NUMBER;
        ln_st_g_tot     NUMBER;
        --Sub Total Services
        ln_st_s_t0      NUMBER;
        ln_st_s_t1      NUMBER;
        ln_st_s_t2      NUMBER;
        ln_st_s_tot     NUMBER;
        --
        ln_gt_st_t0     NUMBER;
        ln_gt_st_t1     NUMBER;
        ln_gt_st_t2     NUMBER;
        ln_gt_st_tot    NUMBER;

        ln_vat_g_t0     NUMBER;
        ln_vat_g_t1     NUMBER;
        ln_vat_g_t2     NUMBER;
        ln_vat_g_tot    NUMBER;

        ln_vat_s_t0     NUMBER;
        ln_vat_s_t1     NUMBER;
        ln_vat_s_t2     NUMBER;
        ln_vat_s_tot    NUMBER;

        ln_gt_vat_t0    NUMBER;
        ln_gt_vat_t1    NUMBER;
        ln_gt_vat_t2    NUMBER;
        ln_gt_vat_tot   NUMBER;

        ln_gt_tot       NUMBER;
    BEGIN
        /*
                print_log('p_customer_trx_id := ' || p_customer_trx_id);
                print_log('p_is_manual_trx := ' || p_is_manual_trx);
                print_log('p_eu_non_eu := ' || p_eu_non_eu);
        */

        ln_st_g_t2     := 0;

        IF p_eu_non_eu = 'Non-EU'
        THEN
            BEGIN
                IF p_eu_non_eu = 'Non-EU'
                THEN
                    -- Subtotal - Goods :: Non-Taxable (T2)
                    /*
                    SELECT NVL(SUM(NVL(rctl.EXTENDED_AMOUNT,0)),0)
                    INTO ln_st_g_t2
                    FROM apps.ra_customer_trx_lines_all rctl,
                      (SELECT customer_trx_id,
                        --tax_rate, --Commented on 16Jan2018 by Kranthi Bollam
                        link_to_cust_trx_line_id
                      FROM apps.ra_customer_trx_lines_all rctl_tax
                      WHERE rctl_tax.line_type = 'TAX'
                   GROUP BY customer_trx_id, --Added on 16Jan2018 by Kranthi Bollam
                            link_to_cust_trx_line_id --Added on 16Jan2018 by Kranthi Bollam
                      ) trx_tax_rate
                    WHERE rctl.customer_trx_id    = p_customer_trx_id
                    AND rctl.line_type            ='LINE'
                    AND UPPER(rctl.description) NOT LIKE '%FREIGHT%'
                    AND rctl.customer_trx_id      = trx_tax_rate.customer_trx_id(+)
                    AND rctl.customer_trx_line_id = trx_tax_rate.link_to_cust_trx_line_id(+);
                    */

                    -- Subtotal - Goods :: Non-Taxable (T2)
                    SELECT NVL (SUM (NVL (rctl.EXTENDED_AMOUNT, 0)), 0)
                      --INTO :ST_G_T2
                      INTO ln_st_g_t2
                      FROM apps.ra_customer_trx_lines_all rctl,
                           (SELECT CUSTOMER_TRX_ID, tax_rate, link_to_cust_trx_line_id
                              FROM apps.ra_customer_trx_lines_all rctl_tax
                             WHERE rctl_tax.line_type = 'TAX') trx_tax_rate
                     WHERE     rctl.customer_trx_id = p_customer_trx_id --:CUSTOMER_TRX_ID
                           AND rctl.line_type = 'LINE'
                           /*Begin Modification for CFS Phase2, 27-Mar-2018*/
                           --        AND UPPER(rctl.description) NOT LIKE '%FREIGHT%'     --Commented for CFS Phase2
                           AND NOT (    UPPER (description) LIKE '%FREIGHT%' --Added this And block for CFS Phase2
                                    AND (   inventory_item_id IS NULL
                                         OR inventory_item_id IN
                                                (SELECT msib.inventory_item_id
                                                   FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                        mtl_system_items_b msib
                                                  WHERE     ffvs.flex_value_set_name =
                                                            'XXDO_CFS_FREIGHT_LIST_VS'
                                                        AND ffv.flex_value_set_id =
                                                            ffvs.flex_value_set_id
                                                        --- Added as per 3.0
                                                        AND ffv.enabled_flag =
                                                            'Y'
                                                        AND NVL (
                                                                ffv.start_date_active,
                                                                SYSDATE) <=
                                                            SYSDATE
                                                        AND NVL (
                                                                ffv.end_date_active,
                                                                SYSDATE + 1) >
                                                            SYSDATE
                                                        --- Added as per 3.0
                                                        AND ffv.flex_value =
                                                            hou.name
                                                        AND hou.organization_id =
                                                            rctl.org_id
                                                        AND UPPER (
                                                                msib.segment1) =
                                                            UPPER (
                                                                ffv.description))))
                           /*End Modification for CFS2, 27-Mar-2018*/
                           AND rctl.customer_trx_id =
                               trx_tax_rate.CUSTOMER_TRX_ID(+)
                           AND rctl.customer_trx_line_id =
                               trx_tax_rate.link_to_cust_trx_line_id(+);
                END IF;
            --print_log('ST_G_T2 := ' || ln_st_g_t2);



            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    ln_st_g_t2   := 0;
                WHEN OTHERS
                THEN
                    ln_st_g_t2   := 0;
            END;
        END IF;

        ln_st_g_t0     := 0;
        ln_st_g_t1     := 0;

        IF p_eu_non_eu = 'EU' OR p_is_manual_trx = 'Y'
        THEN
            BEGIN
                -- Subtotal - Goods: Taxable (T0)
                SELECT NVL (SUM (NVL (rctl.EXTENDED_AMOUNT, 0)), 0)
                  INTO ln_ST_G_T0
                  FROM apps.ra_customer_trx_lines_all rctl,
                       (SELECT CUSTOMER_TRX_ID, tax_rate, link_to_cust_trx_line_id
                          FROM apps.ra_customer_trx_lines_all rctl_tax
                         WHERE rctl_tax.line_type = 'TAX') trx_tax_rate
                 WHERE     rctl.customer_trx_id = P_CUSTOMER_TRX_ID
                       AND rctl.line_type = 'LINE'
                       /*Begin Modification for CFS Phase2, 27-Mar-2018*/
                       --        AND UPPER(rctl.description) NOT LIKE '%FREIGHT%'     --Commented for CFS Phase2
                       AND NOT (    UPPER (description) LIKE '%FREIGHT%' --Added this And block for CFS Phase2
                                AND (   inventory_item_id IS NULL
                                     OR inventory_item_id IN
                                            (SELECT msib.inventory_item_id
                                               FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                    mtl_system_items_b msib
                                              WHERE     ffvs.flex_value_set_name =
                                                        'XXDO_CFS_FREIGHT_LIST_VS'
                                                    AND ffv.flex_value_set_id =
                                                        ffvs.flex_value_set_id
                                                    --- Added as per 3.0
                                                    AND ffv.enabled_flag =
                                                        'Y'
                                                    AND NVL (
                                                            ffv.start_date_active,
                                                            SYSDATE) <=
                                                        SYSDATE
                                                    AND NVL (
                                                            ffv.end_date_active,
                                                            SYSDATE + 1) >
                                                        SYSDATE
                                                    --- Added as per 3.0
                                                    AND ffv.flex_value =
                                                        hou.name
                                                    AND hou.organization_id =
                                                        rctl.org_id
                                                    AND UPPER (msib.segment1) =
                                                        UPPER (
                                                            ffv.description))))
                       /*End Modification for CFS Phase2, 27-Mar-2018*/
                       AND rctl.customer_trx_id =
                           trx_tax_rate.CUSTOMER_TRX_ID(+)
                       AND rctl.customer_trx_line_id =
                           trx_tax_rate.link_to_cust_trx_line_id(+)
                       AND NVL (trx_tax_rate.tax_rate, 0) = 0;
            --print_log('ST_G_T0 := ' || ln_st_g_t0);
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    ln_st_g_t0   := 0;
                WHEN OTHERS
                THEN
                    ln_st_g_t0   := 0;
            END;

            BEGIN
                --Subtotal - Goods: Taxable (T1)
                SELECT NVL (SUM (NVL (rctl.EXTENDED_AMOUNT, 0)), 0)
                  INTO ln_ST_G_T1
                  FROM apps.ra_customer_trx_lines_all rctl,
                       (SELECT CUSTOMER_TRX_ID, tax_rate, link_to_cust_trx_line_id
                          FROM apps.ra_customer_trx_lines_all rctl_tax
                         WHERE     rctl_tax.line_type = 'TAX'
                               AND NVL (tax_rate, 0) <> 0) trx_tax_rate
                 WHERE     rctl.customer_trx_id = P_CUSTOMER_TRX_ID
                       AND rctl.line_type = 'LINE'
                       /*Begin Modification for CFS Phase2, 27-Mar-2018*/
                       --        AND UPPER(rctl.description) NOT LIKE '%FREIGHT%'     --Commented for CFS Phase2
                       AND NOT (    UPPER (description) LIKE '%FREIGHT%' --Added this And block for CFS Phase2
                                AND (   inventory_item_id IS NULL
                                     OR inventory_item_id IN
                                            (SELECT msib.inventory_item_id
                                               FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                    mtl_system_items_b msib
                                              WHERE     ffvs.flex_value_set_name =
                                                        'XXDO_CFS_FREIGHT_LIST_VS'
                                                    AND ffv.flex_value_set_id =
                                                        ffvs.flex_value_set_id
                                                    --- Added as per 3.0
                                                    AND ffv.enabled_flag =
                                                        'Y'
                                                    AND NVL (
                                                            ffv.start_date_active,
                                                            SYSDATE) <=
                                                        SYSDATE
                                                    AND NVL (
                                                            ffv.end_date_active,
                                                            SYSDATE + 1) >
                                                        SYSDATE
                                                    --- Added as per 3.0
                                                    AND ffv.flex_value =
                                                        hou.name
                                                    AND hou.organization_id =
                                                        rctl.org_id
                                                    AND UPPER (msib.segment1) =
                                                        UPPER (
                                                            ffv.description))))
                       /*End Modification for CFS Phase2, 27-Mar-2018*/
                       AND rctl.customer_trx_id =
                           trx_tax_rate.CUSTOMER_TRX_ID
                       AND rctl.customer_trx_line_id =
                           trx_tax_rate.link_to_cust_trx_line_id;
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    ln_st_g_t1   := 0;
                WHEN OTHERS
                THEN
                    ln_st_g_t1   := 0;
            END;
        END IF;

        -- Subtotal - Goods :: Total Invoice.
        BEGIN
            SELECT NVL (ln_st_g_t0, 0) + NVL (ln_st_g_t1, 0) + NVL (ln_st_g_t2, 0)
              INTO ln_st_g_tot
              FROM DUAL;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_st_g_tot   := 0;
        END;

        ln_st_s_t0     := 0;
        ln_st_s_t1     := 0;
        ln_st_s_t2     := 0;


        -- Subtotal - Services :: Taxable (T1).
        /*
            BEGIN
                    -- FREIGHT amount :: Line Type = FREIGHT.
                    SELECT NVL(SUM(NVL(extended_amount,0)),0)
                      INTO ln_ST_S_T1
                      FROM ra_customer_trx_lines_all
                     WHERE customer_trx_id = p_customer_trx_id
                       AND line_type       = 'FREIGHT';
            EXCEPTION
                    WHEN OTHERS THEN
                        ln_ST_S_T1 := 0;
            END;

            IF ln_ST_S_T1 = 0
            THEN
                BEGIN
                    -- FREIGHT amount :: Line Type = LINE, Description containing 'FREIGHT' and Item is NULL.
                    SELECT NVL(SUM(NVL(extended_amount,0)),0)
                        INTO ln_ST_S_T1
                        FROM ra_customer_trx_lines_all
                     WHERE customer_trx_id = p_customer_trx_id
                         AND line_type         = 'LINE'
                         AND UPPER(description) LIKE '%FREIGHT%'
                         AND inventory_item_id IS NULL;
                EXCEPTION
                    WHEN OTHERS THEN
                        ln_st_s_t1 := 0;
                END;
            END IF;

            IF ln_st_s_t1 = 0
            THEN
                BEGIN
                    -- FREIGHT amount :: Line Type = LINE, Description containing 'FREIGHT' and Item is FRT-NA-NA.
                    SELECT NVL(SUM(NVL(extended_amount,0)),0)
                        INTO ln_st_s_t1
                        FROM ra_customer_trx_lines_all
                     WHERE customer_trx_id = p_customer_trx_id
                         AND line_type       = 'LINE'
                         AND UPPER(description) LIKE '%FREIGHT%'
                         AND inventory_item_id IN
                                              (SELECT DISTINCT inventory_item_id
                                              FROM mtl_system_items_b
                                              WHERE segment1 = 'FRT-NA-NA'
                                              );
                EXCEPTION
                    WHEN OTHERS THEN
                        ln_st_s_t1 := 0;
                END;
            END IF;
        */
        IF p_eu_non_eu = 'Non-EU'
        THEN
            BEGIN
                IF p_eu_non_eu = 'Non-EU'
                THEN
                    -- Subtotal - Services :: Non-Taxable (T2)
                    SELECT NVL (SUM (NVL (rctl.EXTENDED_AMOUNT, 0)), 0)
                      INTO ln_st_s_t2
                      FROM apps.ra_customer_trx_lines_all rctl,
                           (SELECT CUSTOMER_TRX_ID, tax_rate, link_to_cust_trx_line_id
                              FROM apps.ra_customer_trx_lines_all rctl_tax
                             WHERE rctl_tax.line_type = 'TAX') trx_tax_rate
                     WHERE     rctl.customer_trx_id = p_customer_trx_id
                           /*Begin Modification for CFS Phase2, 27-Mar-2018*/
                           AND (   line_type = 'FREIGHT'
                                OR (    line_type = 'LINE'
                                    AND UPPER (description) LIKE '%FREIGHT%' --Added this And block for CFS Phase2
                                    AND (   inventory_item_id IS NULL
                                         OR inventory_item_id IN
                                                (SELECT msib.inventory_item_id
                                                   FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                        mtl_system_items_b msib
                                                  WHERE     ffvs.flex_value_set_name =
                                                            'XXDO_CFS_FREIGHT_LIST_VS'
                                                        AND ffv.flex_value_set_id =
                                                            ffvs.flex_value_set_id
                                                        --- Added as per 3.0
                                                        AND ffv.enabled_flag =
                                                            'Y'
                                                        AND NVL (
                                                                ffv.start_date_active,
                                                                SYSDATE) <=
                                                            SYSDATE
                                                        AND NVL (
                                                                ffv.end_date_active,
                                                                SYSDATE + 1) >
                                                            SYSDATE
                                                        --- Added as per 3.0
                                                        AND ffv.flex_value =
                                                            hou.name
                                                        AND hou.organization_id =
                                                            rctl.org_id
                                                        AND UPPER (
                                                                msib.segment1) =
                                                            UPPER (
                                                                ffv.description)))))
                           /*End Modification for CFS Phase2, 27-Mar-2018*/
                           AND rctl.customer_trx_id =
                               trx_tax_rate.CUSTOMER_TRX_ID(+)
                           AND rctl.customer_trx_line_id =
                               trx_tax_rate.link_to_cust_trx_line_id(+);
                END IF;
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    ln_st_s_t2   := 0;
                WHEN OTHERS
                THEN
                    ln_st_s_t2   := 0;
            END;
        END IF;

        ln_st_s_t0     := 0;
        ln_st_s_t1     := 0;

        IF p_eu_non_eu = 'EU' OR p_is_manual_trx = 'Y'
        THEN
            BEGIN
                -- Subtotal - Services: Taxable (T0)
                SELECT NVL (SUM (NVL (rctl.EXTENDED_AMOUNT, 0)), 0)
                  INTO ln_st_s_t0
                  FROM apps.ra_customer_trx_lines_all rctl,
                       (SELECT CUSTOMER_TRX_ID, tax_rate, link_to_cust_trx_line_id
                          FROM apps.ra_customer_trx_lines_all rctl_tax
                         WHERE rctl_tax.line_type = 'TAX') trx_tax_rate
                 WHERE     rctl.customer_trx_id = p_customer_trx_id
                       /*Begin Modification for CFS Phase2, 27-Mar-2018*/
                       AND (   line_type = 'FREIGHT'
                            OR (    line_type = 'LINE'
                                AND UPPER (description) LIKE '%FREIGHT%' --Added this And block for CFS Phase2
                                AND (   inventory_item_id IS NULL
                                     OR inventory_item_id IN
                                            (SELECT msib.inventory_item_id
                                               FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                    mtl_system_items_b msib
                                              WHERE     ffvs.flex_value_set_name =
                                                        'XXDO_CFS_FREIGHT_LIST_VS'
                                                    AND ffv.flex_value_set_id =
                                                        ffvs.flex_value_set_id
                                                    --- Added as per 3.0
                                                    AND ffv.enabled_flag =
                                                        'Y'
                                                    AND NVL (
                                                            ffv.start_date_active,
                                                            SYSDATE) <=
                                                        SYSDATE
                                                    AND NVL (
                                                            ffv.end_date_active,
                                                            SYSDATE + 1) >
                                                        SYSDATE
                                                    --- Added as per 3.0
                                                    AND ffv.flex_value =
                                                        hou.name
                                                    AND hou.organization_id =
                                                        rctl.org_id
                                                    AND UPPER (msib.segment1) =
                                                        UPPER (
                                                            ffv.description)))))
                       /*End Modification for CFS Phase2, 27-Mar-2018*/
                       AND rctl.customer_trx_id =
                           trx_tax_rate.CUSTOMER_TRX_ID(+)
                       AND rctl.customer_trx_line_id =
                           trx_tax_rate.link_to_cust_trx_line_id(+)
                       AND NVL (trx_tax_rate.tax_rate, 0) = 0;
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    ln_st_s_t0   := 0;
                WHEN OTHERS
                THEN
                    ln_st_s_t0   := 0;
            END;

            BEGIN
                -- Subtotal - Services: Taxable (T1)
                SELECT NVL (SUM (NVL (rctl.EXTENDED_AMOUNT, 0)), 0)
                  INTO ln_st_s_t1
                  FROM apps.ra_customer_trx_lines_all rctl,
                       (SELECT CUSTOMER_TRX_ID, tax_rate, link_to_cust_trx_line_id
                          FROM apps.ra_customer_trx_lines_all rctl_tax
                         WHERE     rctl_tax.line_type = 'TAX'
                               AND NVL (tax_rate, 0) <> 0) trx_tax_rate
                 WHERE     rctl.customer_trx_id = p_customer_trx_id
                       /*Begin Modification for CFS Phase2, 27-Mar-2018*/
                       AND (   line_type = 'FREIGHT'
                            OR (    line_type = 'LINE'
                                AND UPPER (description) LIKE '%FREIGHT%' --Added this And block for CFS Phase2
                                AND (   inventory_item_id IS NULL
                                     OR inventory_item_id IN
                                            (SELECT msib.inventory_item_id
                                               FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                    mtl_system_items_b msib
                                              WHERE     ffvs.flex_value_set_name =
                                                        'XXDO_CFS_FREIGHT_LIST_VS'
                                                    AND ffv.flex_value_set_id =
                                                        ffvs.flex_value_set_id
                                                    --- Added as per 3.0
                                                    AND ffv.enabled_flag =
                                                        'Y'
                                                    AND NVL (
                                                            ffv.start_date_active,
                                                            SYSDATE) <=
                                                        SYSDATE
                                                    AND NVL (
                                                            ffv.end_date_active,
                                                            SYSDATE + 1) >
                                                        SYSDATE
                                                    --- Added as per 3.0
                                                    AND ffv.flex_value =
                                                        hou.name
                                                    AND hou.organization_id =
                                                        rctl.org_id
                                                    AND UPPER (msib.segment1) =
                                                        UPPER (
                                                            ffv.description)))))
                       /*End Modification for CFS Phase2, 27-Mar-2018*/
                       AND rctl.customer_trx_id =
                           trx_tax_rate.CUSTOMER_TRX_ID
                       AND rctl.customer_trx_line_id =
                           trx_tax_rate.link_to_cust_trx_line_id;
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    ln_st_s_t1   := 0;
                WHEN OTHERS
                THEN
                    ln_st_s_t1   := 0;
            END;
        END IF;

        -- Subtotal - Services :: Total Invoice.
        BEGIN
            SELECT NVL (ln_st_s_t0, 0) + NVL (ln_st_s_t1, 0) + NVL (ln_st_s_t2, 0)
              INTO ln_st_s_tot
              FROM DUAL;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_st_s_tot   := 0;
        END;

        -- Grand Total :: Taxable (T0).
        BEGIN
            SELECT NVL (ln_st_g_t0, 0) + NVL (ln_st_s_t0, 0)
              INTO ln_gt_st_t0
              FROM DUAL;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_gt_st_t0   := 0;
        END;

        -- Grand Total :: Taxable (T1).
        BEGIN
            SELECT NVL (ln_st_g_t1, 0) + NVL (ln_st_s_t1, 0)
              INTO ln_gt_st_t1
              FROM DUAL;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_gt_st_t1   := 0;
        END;

        -- Grand Total :: Non-Taxable (T2).
        BEGIN
            SELECT NVL (ln_st_g_t2, 0) + NVL (ln_st_s_t2, 0)
              INTO ln_gt_st_t2
              FROM DUAL;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_gt_st_t2   := 0;
        END;

        -- Grand Total :: Total Invoice.
        BEGIN
            SELECT NVL (ln_st_g_tot, 0) + NVL (ln_st_s_tot, 0)
              INTO ln_gt_st_tot
              FROM DUAL;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_gt_st_tot   := 0;
        END;

        ln_vat_g_t0    := 0;
        ln_vat_g_t1    := 0;
        ln_vat_g_t2    := 0;
        ln_vat_s_t0    := 0;
        ln_vat_s_t1    := 0;
        ln_vat_s_t2    := 0;

        /*
        -- VAT - Goods :: Taxable (T1)
            BEGIN
                SELECT NVL(SUM(NVL(rctl.extended_amount,0)),0)
                  INTO ln_vat_g_t1
                  FROM apps.ra_customer_trx_lines_all rctl
                 WHERE rctl.customer_trx_id = p_customer_trx_id
                   AND rctl.line_type       = 'TAX';
            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                  ln_VAT_G_T1 := 0;
                WHEN OTHERS THEN
                    ln_VAT_G_T1 := 0;
            END;

                -- VAT - Goods :: Total Invoice.
                BEGIN
                  SELECT NVL(ln_vat_g_t0, 0) + NVL(ln_vat_g_t1,0) + NVL(ln_vat_g_t2,0)
                  INTO ln_vat_g_tot
                  FROM dual;
                EXCEPTION
                WHEN OTHERS THEN
                  ln_vat_g_tot := 0;
                END;

                    -- VAT - Services :: Total Invoice.
                    BEGIN
                      SELECT NVL(ln_vat_s_t0, 0) + NVL(ln_vat_s_t1,0) + NVL(ln_vat_s_t2,0)
                      INTO  ln_vat_s_tot
                      FROM dual;
                    EXCEPTION
                    WHEN OTHERS THEN
                      ln_vat_s_tot := 0;
                    END;
        */
        IF p_eu_non_eu = 'Non-EU'
        THEN
            BEGIN
                IF p_eu_non_eu = 'Non-EU'
                THEN
                    -- VAT - Goods  :: Non-Taxable (T2)
                    SELECT NVL (SUM (NVL (rctl_tax.EXTENDED_AMOUNT, 0)), 0)
                      INTO ln_vat_G_T2
                      FROM apps.ra_customer_trx_lines_all rctl_tax,
                           (SELECT customer_trx_id, customer_trx_line_id
                              FROM apps.ra_customer_trx_lines_all rctl
                             WHERE     rctl.line_type = 'LINE'
                                   AND NOT (    UPPER (description) LIKE
                                                    '%FREIGHT%'
                                            AND (   inventory_item_id IS NULL
                                                 OR inventory_item_id IN
                                                        (SELECT msib.inventory_item_id
                                                           FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                                mtl_system_items_b msib
                                                          WHERE     ffvs.flex_value_set_name =
                                                                    'XXDO_CFS_FREIGHT_LIST_VS'
                                                                AND ffv.flex_value_set_id =
                                                                    ffvs.flex_value_set_id
                                                                --- Added as per 3.0
                                                                AND ffv.enabled_flag =
                                                                    'Y'
                                                                AND NVL (
                                                                        ffv.start_date_active,
                                                                        SYSDATE) <=
                                                                    SYSDATE
                                                                AND NVL (
                                                                        ffv.end_date_active,
                                                                          SYSDATE
                                                                        + 1) >
                                                                    SYSDATE
                                                                --- Added as per 3.0
                                                                AND ffv.flex_value =
                                                                    hou.name
                                                                AND hou.organization_id =
                                                                    rctl.org_id
                                                                AND UPPER (
                                                                        msib.segment1) =
                                                                    UPPER (
                                                                        ffv.description))))
                                   AND rctl.customer_trx_id =
                                       p_customer_trx_id) trx_line
                     WHERE     rctl_tax.customer_trx_id = p_customer_trx_id
                           AND rctl_tax.line_type = 'TAX'
                           AND rctl_tax.customer_trx_id =
                               trx_line.CUSTOMER_TRX_ID
                           AND rctl_tax.link_to_cust_trx_line_id =
                               trx_line.customer_trx_line_id;
                END IF;
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    ln_vat_G_T2   := 0;
                WHEN OTHERS
                THEN
                    ln_vat_G_T2   := 0;
            END;
        END IF;

        ln_vat_G_T0    := 0;
        ln_vat_G_T1    := 0;

        IF p_eu_non_eu = 'EU' OR p_is_manual_trx = 'Y'
        THEN
            BEGIN
                -- VAT - Goods : Taxable (T0)
                SELECT NVL (SUM (NVL (rctl_tax.EXTENDED_AMOUNT, 0)), 0)
                  INTO ln_vat_G_T0
                  FROM apps.ra_customer_trx_lines_all rctl_tax,
                       (SELECT customer_trx_id, customer_trx_line_id
                          FROM apps.ra_customer_trx_lines_all rctl
                         WHERE     rctl.line_type = 'LINE'
                               AND NOT (    UPPER (description) LIKE
                                                '%FREIGHT%'
                                        AND (   inventory_item_id IS NULL
                                             OR inventory_item_id IN
                                                    (SELECT msib.inventory_item_id
                                                       FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                            mtl_system_items_b msib
                                                      WHERE     ffvs.flex_value_set_name =
                                                                'XXDO_CFS_FREIGHT_LIST_VS'
                                                            AND ffv.flex_value_set_id =
                                                                ffvs.flex_value_set_id
                                                            --- Added as per 3.0
                                                            AND ffv.enabled_flag =
                                                                'Y'
                                                            AND NVL (
                                                                    ffv.start_date_active,
                                                                    SYSDATE) <=
                                                                SYSDATE
                                                            AND NVL (
                                                                    ffv.end_date_active,
                                                                      SYSDATE
                                                                    + 1) >
                                                                SYSDATE
                                                            --- Added as per 3.0
                                                            AND ffv.flex_value =
                                                                hou.name
                                                            AND hou.organization_id =
                                                                rctl.org_id
                                                            AND UPPER (
                                                                    msib.segment1) =
                                                                UPPER (
                                                                    ffv.description))))
                               AND rctl.customer_trx_id = p_customer_trx_id)
                       trx_line
                 WHERE     rctl_tax.customer_trx_id = p_customer_trx_id
                       AND rctl_tax.line_type = 'TAX'
                       AND NVL (tax_rate, 0) = 0
                       AND rctl_tax.customer_trx_id =
                           trx_line.CUSTOMER_TRX_ID
                       AND rctl_tax.link_to_cust_trx_line_id =
                           trx_line.customer_trx_line_id;
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    ln_vat_G_T0   := 0;
                WHEN OTHERS
                THEN
                    ln_vat_G_T0   := 0;
            END;

            BEGIN
                -- VAT - Goods : Taxable (T1)
                SELECT NVL (SUM (NVL (rctl_tax.EXTENDED_AMOUNT, 0)), 0)
                  INTO ln_vat_G_T1
                  FROM apps.ra_customer_trx_lines_all rctl_tax,
                       (SELECT customer_trx_id, customer_trx_line_id
                          FROM apps.ra_customer_trx_lines_all rctl
                         WHERE     rctl.line_type = 'LINE'
                               AND NOT (    UPPER (description) LIKE
                                                '%FREIGHT%'
                                        AND (   inventory_item_id IS NULL
                                             OR inventory_item_id IN
                                                    (SELECT msib.inventory_item_id
                                                       FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                            mtl_system_items_b msib
                                                      WHERE     ffvs.flex_value_set_name =
                                                                'XXDO_CFS_FREIGHT_LIST_VS'
                                                            AND ffv.flex_value_set_id =
                                                                ffvs.flex_value_set_id
                                                            --- Added as per 3.0
                                                            AND ffv.enabled_flag =
                                                                'Y'
                                                            AND NVL (
                                                                    ffv.start_date_active,
                                                                    SYSDATE) <=
                                                                SYSDATE
                                                            AND NVL (
                                                                    ffv.end_date_active,
                                                                      SYSDATE
                                                                    + 1) >
                                                                SYSDATE
                                                            --- Added as per 3.0
                                                            AND ffv.flex_value =
                                                                hou.name
                                                            AND hou.organization_id =
                                                                rctl.org_id
                                                            AND UPPER (
                                                                    msib.segment1) =
                                                                UPPER (
                                                                    ffv.description))))
                               AND rctl.customer_trx_id = p_customer_trx_id)
                       trx_line
                 WHERE     rctl_tax.customer_trx_id = p_customer_trx_id
                       AND rctl_tax.line_type = 'TAX'
                       AND NVL (tax_rate, 0) <> 0
                       AND rctl_tax.customer_trx_id =
                           trx_line.CUSTOMER_TRX_ID
                       AND rctl_tax.link_to_cust_trx_line_id =
                           trx_line.customer_trx_line_id;
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    ln_vat_G_T1   := 0;
                WHEN OTHERS
                THEN
                    ln_vat_G_T1   := 0;
            END;
        END IF;


        -- VAT Services :: Calculation
        IF p_eu_non_eu = 'Non-EU'
        THEN
            BEGIN
                IF p_eu_non_eu = 'Non-EU'
                THEN
                    -- VAT - Services  :: Non-Taxable (T2)
                    SELECT NVL (SUM (NVL (rctl_tax.EXTENDED_AMOUNT, 0)), 0)
                      INTO ln_vat_S_T2
                      FROM apps.ra_customer_trx_lines_all rctl_tax,
                           (SELECT customer_trx_id, customer_trx_line_id
                              FROM apps.ra_customer_trx_lines_all rctl
                             WHERE     1 = 1
                                   AND (   line_type = 'FREIGHT'
                                        OR (    line_type = 'LINE'
                                            AND UPPER (description) LIKE
                                                    '%FREIGHT%'
                                            AND (   inventory_item_id IS NULL
                                                 OR inventory_item_id IN
                                                        (SELECT msib.inventory_item_id
                                                           FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                                mtl_system_items_b msib
                                                          WHERE     ffvs.flex_value_set_name =
                                                                    'XXDO_CFS_FREIGHT_LIST_VS'
                                                                AND ffv.flex_value_set_id =
                                                                    ffvs.flex_value_set_id
                                                                --- Added as per 3.0
                                                                AND ffv.enabled_flag =
                                                                    'Y'
                                                                AND NVL (
                                                                        ffv.start_date_active,
                                                                        SYSDATE) <=
                                                                    SYSDATE
                                                                AND NVL (
                                                                        ffv.end_date_active,
                                                                          SYSDATE
                                                                        + 1) >
                                                                    SYSDATE
                                                                --- Added as per 3.0
                                                                AND ffv.flex_value =
                                                                    hou.name
                                                                AND hou.organization_id =
                                                                    rctl.org_id
                                                                AND UPPER (
                                                                        msib.segment1) =
                                                                    UPPER (
                                                                        ffv.description)))))
                                   AND rctl.customer_trx_id =
                                       p_customer_trx_id) trx_line
                     WHERE     rctl_tax.customer_trx_id = p_customer_trx_id
                           AND rctl_tax.line_type = 'TAX'
                           AND rctl_tax.customer_trx_id =
                               trx_line.CUSTOMER_TRX_ID
                           AND rctl_tax.link_to_cust_trx_line_id =
                               trx_line.customer_trx_line_id;
                END IF;
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    ln_vat_S_T2   := 0;
                WHEN OTHERS
                THEN
                    ln_vat_S_T2   := 0;
            END;
        END IF;

        ln_vat_S_T0    := 0;
        ln_vat_S_T1    := 0;

        IF p_eu_non_eu = 'EU' OR p_is_manual_trx = 'Y'
        THEN
            BEGIN
                -- VAT - Services : Taxable (T0)
                SELECT NVL (SUM (NVL (rctl_tax.EXTENDED_AMOUNT, 0)), 0)
                  INTO ln_vat_S_T0
                  FROM apps.ra_customer_trx_lines_all rctl_tax,
                       (SELECT customer_trx_id, customer_trx_line_id
                          FROM apps.ra_customer_trx_lines_all rctl
                         WHERE     1 = 1
                               AND (   line_type = 'FREIGHT'
                                    OR (    line_type = 'LINE'
                                        AND UPPER (description) LIKE
                                                '%FREIGHT%'
                                        AND (   inventory_item_id IS NULL
                                             OR inventory_item_id IN
                                                    (SELECT msib.inventory_item_id
                                                       FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                            mtl_system_items_b msib
                                                      WHERE     ffvs.flex_value_set_name =
                                                                'XXDO_CFS_FREIGHT_LIST_VS'
                                                            AND ffv.flex_value_set_id =
                                                                ffvs.flex_value_set_id
                                                            --- Added as per 3.0
                                                            AND ffv.enabled_flag =
                                                                'Y'
                                                            AND NVL (
                                                                    ffv.start_date_active,
                                                                    SYSDATE) <=
                                                                SYSDATE
                                                            AND NVL (
                                                                    ffv.end_date_active,
                                                                      SYSDATE
                                                                    + 1) >
                                                                SYSDATE
                                                            --- Added as per 3.0
                                                            AND ffv.flex_value =
                                                                hou.name
                                                            AND hou.organization_id =
                                                                rctl.org_id
                                                            AND UPPER (
                                                                    msib.segment1) =
                                                                UPPER (
                                                                    ffv.description)))))
                               AND rctl.customer_trx_id = p_customer_trx_id)
                       trx_line
                 WHERE     rctl_tax.customer_trx_id = p_customer_trx_id
                       AND rctl_tax.line_type = 'TAX'
                       AND NVL (tax_rate, 0) = 0
                       AND rctl_tax.customer_trx_id =
                           trx_line.CUSTOMER_TRX_ID
                       AND rctl_tax.link_to_cust_trx_line_id =
                           trx_line.customer_trx_line_id;
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    ln_vat_S_T0   := 0;
                WHEN OTHERS
                THEN
                    ln_vat_S_T0   := 0;
            END;

            BEGIN
                -- VAT - Services : Taxable (T1)
                SELECT NVL (SUM (NVL (rctl_tax.EXTENDED_AMOUNT, 0)), 0)
                  INTO ln_vat_S_T1
                  FROM apps.ra_customer_trx_lines_all rctl_tax,
                       (SELECT customer_trx_id, customer_trx_line_id
                          FROM apps.ra_customer_trx_lines_all rctl
                         WHERE     1 = 1
                               AND (   line_type = 'FREIGHT'
                                    OR (    line_type = 'LINE'
                                        AND UPPER (description) LIKE
                                                '%FREIGHT%'
                                        AND (   inventory_item_id IS NULL
                                             OR inventory_item_id IN
                                                    (SELECT msib.inventory_item_id
                                                       FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv, hr_operating_units hou,
                                                            mtl_system_items_b msib
                                                      WHERE     ffvs.flex_value_set_name =
                                                                'XXDO_CFS_FREIGHT_LIST_VS'
                                                            AND ffv.flex_value_set_id =
                                                                ffvs.flex_value_set_id
                                                            --- Added as per 3.0
                                                            AND ffv.enabled_flag =
                                                                'Y'
                                                            AND NVL (
                                                                    ffv.start_date_active,
                                                                    SYSDATE) <=
                                                                SYSDATE
                                                            AND NVL (
                                                                    ffv.end_date_active,
                                                                      SYSDATE
                                                                    + 1) >
                                                                SYSDATE
                                                            --- Added as per 3.0
                                                            AND ffv.flex_value =
                                                                hou.name
                                                            AND hou.organization_id =
                                                                rctl.org_id
                                                            AND UPPER (
                                                                    msib.segment1) =
                                                                UPPER (
                                                                    ffv.description)))))
                               AND rctl.customer_trx_id = p_customer_trx_id)
                       trx_line
                 WHERE     rctl_tax.customer_trx_id = p_customer_trx_id
                       AND rctl_tax.line_type = 'TAX'
                       AND NVL (tax_rate, 0) <> 0
                       AND rctl_tax.customer_trx_id =
                           trx_line.CUSTOMER_TRX_ID
                       AND rctl_tax.link_to_cust_trx_line_id =
                           trx_line.customer_trx_line_id;
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    ln_vat_S_T1   := 0;
                WHEN OTHERS
                THEN
                    ln_vat_S_T1   := 0;
            END;
        END IF;

        -- Grand Total (VAT) :: Taxable (T0).
        BEGIN
            SELECT NVL (ln_vat_g_t0, 0) + NVL (ln_vat_s_t0, 0)
              INTO ln_gt_vat_t0
              FROM DUAL;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_gt_vat_t0   := 0;
        END;

        -- Grand Total (VAT) :: Taxable (T1).
        BEGIN
            SELECT NVL (ln_vat_g_t1, 0) + NVL (ln_vat_s_t1, 0)
              INTO ln_gt_vat_t1
              FROM DUAL;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_gt_vat_t1   := 0;
        END;

        -- Grand Total (VAT) :: Non-Taxable (T2).
        BEGIN
            SELECT NVL (ln_vat_g_t2, 0) + NVL (ln_vat_s_t2, 0)
              INTO ln_gt_vat_t2
              FROM DUAL;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_gt_vat_t2   := 0;
        END;

        -- Grand Total (VAT) :: Total Invoice.
        BEGIN
            SELECT NVL (ln_vat_g_tot, 0) + NVL (ln_vat_s_tot, 0)
              INTO ln_gt_vat_tot
              FROM DUAL;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_gt_vat_tot   := 0;
        END;

        -- Grand Total :: Total Invoice Amount.
        BEGIN
            SELECT NVL (ln_gt_st_tot, 0) + NVL (ln_gt_vat_tot, 0)
              INTO ln_gt_tot
              FROM DUAL;
        EXCEPTION
            WHEN OTHERS
            THEN
                ln_gt_tot   := 0;
        END;

        x_st_g_t0      := ln_st_g_t0;
        x_st_g_t1      := ln_st_g_t1;
        x_st_g_t2      := ln_st_g_t2;
        x_st_g_tot     := ln_st_g_tot;
        x_st_s_t0      := ln_st_s_t0;
        x_st_s_t1      := ln_st_s_t1;
        x_st_s_t2      := ln_st_s_t2;
        x_st_s_tot     := ln_st_s_tot;
        x_gt_st_t0     := ln_gt_st_t0;
        x_gt_st_t1     := ln_gt_st_t1;
        x_gt_st_t2     := ln_gt_st_t2;
        x_gt_st_tot    := ln_gt_st_tot;
        x_vat_g_t0     := ln_vat_g_t0;
        x_vat_g_t1     := ln_vat_g_t1;
        x_vat_g_t2     := ln_vat_g_t2;
        x_vat_g_tot    := ln_vat_g_tot;
        x_vat_s_t0     := ln_vat_s_t0;
        x_vat_s_t1     := ln_vat_s_t1;
        x_vat_s_t2     := ln_vat_s_t2;
        x_vat_s_tot    := ln_vat_s_tot;
        x_gt_vat_t0    := ln_gt_vat_t0;
        x_gt_vat_t1    := ln_gt_vat_t1;
        x_gt_vat_t2    := ln_gt_vat_t2;
        x_gt_vat_tot   := ln_gt_vat_tot;
        x_gt_tot       := ln_gt_tot;
    /*
            print_log('x_st_g_t0 := ' || x_st_g_t0);
            print_log('x_st_g_t1 := ' || x_st_g_t1);
            print_log('x_st_g_t2 := ' || x_st_g_t2);

            print_log('x_st_s_t0 := ' || x_st_s_t0);
            print_log('x_st_s_t1 := ' || x_st_s_t1);
            print_log('x_st_s_t2 := ' || x_st_s_t2);

            print_log('x_vat_g_t0 := ' || x_vat_g_t0);
            print_log('x_vat_g_t1 := ' || x_vat_g_t1);
            print_log('x_vat_g_t2 := ' || x_vat_g_t2);

            print_log('x_vat_s_t0 := ' || x_vat_s_t0);
            print_log('x_vat_s_t1 := ' || x_vat_s_t1);
            print_log('x_vat_s_t2 := ' || x_vat_s_t2);
    */


    EXCEPTION
        WHEN OTHERS
        THEN
            NULL;
    END get_sub_totals;

    ----
    ----
    PROCEDURE get_ship_from_details (p_customer_trx_id IN NUMBER, p_ship_from_country OUT VARCHAR2, p_ship_from_address OUT VARCHAR2)
    IS
        lv_ship_from_country   VARCHAR2 (50) := NULL;
        lv_ship_from_addr      VARCHAR2 (2000) := NULL;
    BEGIN
        BEGIN
            SELECT DISTINCT DECODE (hloc.country, 'NL', SUBSTR (hloc.description, 1, INSTR (hloc.description, ',') - 1) || ', ' || CHR (10), NULL) ship_from_country, DECODE (hloc.country, 'NL', SUBSTR (hloc.description, 1, INSTR (hloc.description, ',') - 1) || ', ' || CHR (10), NULL) || DECODE (hloc.address_line_1, NULL, NULL, hloc.address_line_1 || ', ' || CHR (10)) || DECODE (hloc.address_line_2, NULL, NULL, hloc.address_line_2 || ', ' || CHR (10)) || DECODE (hloc.address_line_3, NULL, NULL, hloc.address_line_3 || ', ' || CHR (10)) || hloc.town_or_city || ', ' || CHR (10) || postal_code || ', ' || CHR (10) || ft.territory_short_name || '.' Ship_from_address
              INTO lv_ship_from_country, lv_ship_from_addr
              FROM ra_customer_trx_lines_all rctl, hr_locations_all hloc, fnd_territories_tl ft
             WHERE     rctl.customer_trx_id = p_customer_trx_id
                   AND rctl.warehouse_id IS NOT NULL
                   AND hloc.inventory_organization_id = rctl.warehouse_id
                   AND ft.territory_code = hloc.country
                   AND ft.language = 'US';
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
                lv_ship_from_addr   := NULL;
            WHEN OTHERS
            THEN
                lv_ship_from_addr   := NULL;
        END;
    EXCEPTION
        WHEN OTHERS
        THEN
            NULL;
    END get_ship_from_details;

    ----
    ----
    PROCEDURE program_output (p_program_name IN VARCHAR2, p_conc_request_id IN NUMBER, x_ret_code OUT VARCHAR2
                              , x_ret_message OUT VARCHAR2)
    IS
        lv_proc_name   VARCHAR2 (30) := 'PROGRAM_OUTPUT';
        lv_err_msg     VARCHAR2 (4000) := NULL;

        TYPE open_ar_rec_type IS RECORD
        (
            org_id               NUMBER,
            operating_unit       VARCHAR2 (240),
            customer_number      VARCHAR2 (30),
            transaction_class    VARCHAR2 (30),
            open_ar_count        NUMBER
        );

        open_ar_rec    open_ar_rec_type;

        CURSOR open_ar_cur IS
              SELECT NVL (stg.org_id, 999) org_id, NVL (hou.name, 'Dummy Records') operating_unit, stg.bill_to_customer_number customer_number,
                     stg.document_type transaction_class, COUNT (*) open_ar_count
                FROM xxdo.xxdoar_b2b_open_ar_stg stg, hr_operating_units hou
               WHERE     1 = 1
                     AND stg.request_id = p_conc_request_id
                     AND stg.process_flag = 'S'
                     AND stg.org_id = hou.organization_id(+)
            GROUP BY NVL (stg.org_id, 999), NVL (hou.name, 'Dummy Records'), stg.bill_to_customer_number,
                     stg.document_type
            ORDER BY operating_unit, stg.bill_to_customer_number, stg.document_type;

        TYPE stmts_rec_type IS RECORD
        (
            org_id             NUMBER,
            operating_unit     VARCHAR2 (240),
            customer_number    VARCHAR2 (30),
            stmts_count        NUMBER
        );

        stmts_rec      stmts_rec_type;

        CURSOR stmts_cur IS
              SELECT stg.org_id, stg.operating_unit, stg.customer_number,
                     COUNT (*) stmts_count
                FROM xxdo.xxdoar_statements_stg stg
               WHERE 1 = 1 AND stg.concurrent_request_id = p_conc_request_id --46290332
            GROUP BY stg.org_id, stg.operating_unit, stg.customer_number
            ORDER BY stg.operating_unit, stg.customer_number;

        TYPE billing_rec_type IS RECORD
        (
            operating_unit       VARCHAR2 (240),
            customer_number      VARCHAR2 (30),
            transaction_class    VARCHAR2 (30),
            transaction_type     VARCHAR2 (80),
            new_trx_count        NUMBER,
            reprint_trx_count    NUMBER
        );

        billing_rec    billing_rec_type;

        CURSOR billing_cur IS
              SELECT stg.operating_unit,
                     stg.bill_to_customer_num customer_number,
                     stg.transaction_class,
                     stg.transaction_type_name transaction_type,
                     --COUNT(DECODE(NVL(stg.printing_pending, 'Y'), 'Y', 'New Transactions')) new_trx_count, --Commented on 17Jan2018 by Kranthi Bollam
                     --COUNT(DECODE(NVL(stg.printing_pending, 'Y'), 'N', 'Re-Print')) reprint_trx_count --Commented on 17Jan2018 by Kranthi Bollam
                     COUNT (
                         CASE
                             WHEN     NVL (stg.printing_pending, 'Y') = 'Y'
                                  AND rct.printing_last_printed IS NULL
                             THEN
                                 'New Transactions'
                         END) new_trx_count, --Added on 17Jan2018 by Kranthi Bollam
                     COUNT (
                         CASE
                             WHEN     NVL (stg.printing_pending, 'Y') = 'Y'
                                  AND rct.printing_last_printed IS NOT NULL
                             THEN
                                 'Re-Print'
                         --WHEN NVL(stg.printing_pending, 'Y') = 'N' AND rct.printing_last_printed IS NOT NULL
                         --THEN 'Re-Print'
                         END) reprint_trx_count --Added on 17Jan2018 by Kranthi Bollam
                FROM xxdo.xxdoar_b2b_billing_hdr_stg stg, apps.ra_customer_trx_all rct
               WHERE     stg.concurrent_request_id = p_conc_request_id
                     AND stg.customer_trx_id = rct.customer_trx_id
            GROUP BY stg.operating_unit, stg.bill_to_customer_num, stg.transaction_class,
                     stg.transaction_type_name
            ORDER BY stg.operating_unit, stg.bill_to_customer_num, stg.transaction_class,
                     stg.transaction_type_name;
    BEGIN
        IF p_program_name = 'OPEN_AR_FILE'
        THEN
            print_out (
                'Operating Unit|Customer Number|Transaction class|Open AR Count');

            OPEN open_ar_cur;

            LOOP
                FETCH open_ar_cur INTO open_ar_rec;

                EXIT WHEN open_ar_cur%NOTFOUND;
                print_out (
                       open_ar_rec.operating_unit
                    || '|'
                    || open_ar_rec.customer_number
                    || '|'
                    || open_ar_rec.transaction_class
                    || '|'
                    || open_ar_rec.open_ar_count);
            END LOOP;

            CLOSE open_ar_cur;
        ELSIF p_program_name = 'STATEMENTS_FILE'
        THEN
            print_out ('Operating Unit|Customer Number|Statement Count');

            OPEN stmts_cur;

            LOOP
                FETCH stmts_cur INTO stmts_rec;

                EXIT WHEN stmts_cur%NOTFOUND;
                print_out (
                       stmts_rec.operating_unit
                    || '|'
                    || stmts_rec.customer_number
                    || '|'
                    || stmts_rec.stmts_count);
            END LOOP;

            CLOSE stmts_cur;
        ELSIF p_program_name = 'BILLING_FILE'
        THEN
            print_out (
                'Operating Unit|Customer Number|Transaction Class|Transaction Type|New Transactions Count|Re-Print Count');

            OPEN billing_cur;

            LOOP
                FETCH billing_cur INTO billing_rec;

                EXIT WHEN billing_cur%NOTFOUND;
                print_out (
                       billing_rec.operating_unit
                    || '|'
                    || billing_rec.customer_number
                    || '|'
                    || billing_rec.transaction_class
                    || '|'
                    || billing_rec.transaction_type
                    || '|'
                    || billing_rec.new_trx_count
                    || '|'
                    || billing_rec.reprint_trx_count);
            END LOOP;

            CLOSE billing_cur;
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_err_msg      :=
                SUBSTR (
                       'Exception while writing the output into output file. Error is: '
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
    END program_output;

    ----
    ----
    PROCEDURE insert_stmt_staging (p_org_id IN NUMBER, p_customer_id IN NUMBER, p_as_of_date IN DATE, p_bucket_name IN VARCHAR2, p_fuctional_currency IN VARCHAR2, x_ret_code OUT NUMBER
                                   , x_ret_message OUT VARCHAR2)
    IS
        CURSOR stmt_cur (p_org_id IN NUMBER, p_as_of_date IN DATE, p_fuctional_currency IN VARCHAR2, p_bucket_line_type_0 IN VARCHAR2, p_bucket_line_type_1 IN VARCHAR2, p_bucket_line_type_2 IN VARCHAR2, p_bucket_line_type_3 IN VARCHAR2, p_bucket_line_type_4 IN VARCHAR2, p_bucket_line_type_5 IN VARCHAR2, p_bucket_line_type_6 IN VARCHAR2, p_bucket_days_from_0 IN NUMBER, p_bucket_days_from_1 IN NUMBER, p_bucket_days_from_2 IN NUMBER, p_bucket_days_from_3 IN NUMBER, p_bucket_days_from_4 IN NUMBER, p_bucket_days_from_5 IN NUMBER, p_bucket_days_from_6 IN NUMBER, p_bucket_days_to_0 IN NUMBER, p_bucket_days_to_1 IN NUMBER, p_bucket_days_to_2 IN NUMBER, p_bucket_days_to_3 IN NUMBER, p_bucket_days_to_4 IN NUMBER, p_bucket_days_to_5 IN NUMBER, p_bucket_days_to_6 IN NUMBER
                         , p_bucket_category IN VARCHAR2)
        IS
            SELECT xxdo.cust_name_inv, xxdo.cust_no_inv, xxdo.sort_field1_inv,
                   xxdo.class_inv sort_field2_inv, 2000 inv_tid_inv, NVL (stmts.site_use_id, xxdo.contact_site_id_inv) contact_site_id_inv,
                   xxdo.cust_state_inv, xxdo.cust_city_inv, 3000 addr_id_inv,
                   xxdo.cust_id_inv, xxdo.payment_sched_id_inv, xxdo.class_inv,
                   xxdo.due_date_inv, xxdo.amt_due_remaining_inv, xxdo.invnum,
                   xxdo.days_past_due, xxdo.amount_adjusted_inv, xxdo.amount_applied_inv,
                   xxdo.amount_credited_inv, xxdo.gl_date_inv, xxdo.data_converted_inv,
                   xxdo.ps_exchange_rate_inv, xxdo.b0_inv, xxdo.b1_inv,
                   xxdo.b2_inv, xxdo.b3_inv, xxdo.b4_inv,
                   xxdo.b5_inv, xxdo.b6_inv, xxdo.company_inv,
                   xxdo.cons_billing_number, xxdo.invoice_type_inv, xxdo.org_id,
                   xxdo.buying_agent_group_num
              FROM hz_customer_profiles hz_profile,
                   (SELECT site.site_use_id, site.cust_acct_site_id, acct_site.cust_account_id,
                           site_use_code
                      FROM hz_cust_site_uses_all site, hz_cust_acct_sites_all acct_site
                     WHERE     site.cust_acct_site_id =
                               acct_site.cust_acct_site_id
                           AND site.status = 'A'
                           AND site.site_use_code = 'STMTS') stmts,
                   (SELECT SUBSTRB (party.party_name, 1, 50)
                               cust_name_inv,
                           cust_acct.account_number
                               cust_no_inv,
                              c.SEGMENT1
                           || ' '
                           || c.SEGMENT2
                           || ' '
                           || c.SEGMENT3
                           || ' '
                           || c.SEGMENT4
                           || ' '
                           || c.SEGMENT5
                           || ' '
                           || c.SEGMENT6
                           || ' '
                           || c.SEGMENT7
                           || ' '
                           || c.SEGMENT8
                               sort_field1_inv,
                           arpt_sql_func_util.get_org_trx_type_details (
                               ps.cust_trx_type_id,
                               ps.org_id)
                               sort_field2_inv,
                           2000
                               inv_tid_inv,
                           site.site_use_id
                               contact_site_id_inv,
                           loc.state
                               cust_state_inv,
                           loc.city
                               cust_city_inv,
                           3000
                               addr_id_inv,
                           NVL (cust_acct.cust_account_id, -999)
                               cust_id_inv,
                           ps.payment_schedule_id
                               payment_sched_id_inv,
                           ps.class
                               class_inv,
                           ps.due_date
                               due_date_inv,
                           amt_due_remaining_inv,
                           ps.trx_number
                               invnum,
                           ps.customer_trx_id,                           --4.3
                           CEIL (p_as_of_date - ps.due_date)
                               days_past_due,
                           ps.amount_adjusted
                               amount_adjusted_inv,
                           ps.amount_applied
                               amount_applied_inv,
                           ps.amount_credited
                               amount_credited_inv,
                           ps.gl_date
                               gl_date_inv,
                           DECODE (
                               ps.invoice_currency_code,
                               p_fuctional_currency, NULL,
                               DECODE (ps.exchange_rate, NULL, '*', NULL))
                               data_converted_inv,
                           NVL (ps.exchange_rate, 1)
                               ps_exchange_rate_inv,
                           DECODE (p_bucket_line_type_0,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_0,
                                       dh.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_0,
                                       p_bucket_days_to_0,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b0_inv,
                           DECODE (p_bucket_line_type_1,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_1,
                                       dh.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_1,
                                       p_bucket_days_to_1,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b1_inv,
                           DECODE (p_bucket_line_type_2,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_2,
                                       dh.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_2,
                                       p_bucket_days_to_2,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b2_inv,
                           DECODE (p_bucket_line_type_3,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_3,
                                       dh.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_3,
                                       p_bucket_days_to_3,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b3_inv,
                           DECODE (p_bucket_line_type_4,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_4,
                                       dh.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_4,
                                       p_bucket_days_to_4,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b4_inv,
                           DECODE (p_bucket_line_type_5,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_5,
                                       dh.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_5,
                                       p_bucket_days_to_5,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b5_inv,
                           DECODE (p_bucket_line_type_6,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_6,
                                       dh.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_6,
                                       p_bucket_days_to_6,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b6_inv,
                           c.SEGMENT1
                               company_inv,
                           TO_CHAR (NULL)
                               cons_billing_number,
                           arpt_sql_func_util.get_org_trx_type_details (
                               ps.cust_trx_type_id,
                               ps.org_id)
                               invoice_type_inv,
                           ps.org_id,
                           party.attribute16
                               buying_agent_group_num --Added by Madhav for CCR0007216
                      FROM hz_cust_accounts cust_acct,
                           hz_parties party,
                           (  SELECT a.customer_id, a.customer_site_use_id, a.customer_trx_id,
                                     a.payment_schedule_id, a.class, SUM (a.primary_salesrep_id) primary_salesrep_id,
                                     a.due_date, SUM (a.amount_due_remaining) amt_due_remaining_inv, a.trx_number,
                                     a.amount_adjusted, a.amount_applied, a.amount_credited,
                                     a.amount_adjusted_pending, a.gl_date, a.cust_trx_type_id,
                                     a.org_id, a.invoice_currency_code, a.exchange_rate,
                                     SUM (a.cons_inv_id) cons_inv_id
                                FROM (  SELECT ps.customer_id, ps.customer_site_use_id, ps.customer_trx_id,
                                               ps.payment_schedule_id, ps.class, 0 primary_salesrep_id,
                                               ps.due_date, -- Commented and added as part of change 3.2
                                                            /*  NVL (
                                                                  SUM (
                                                                      DECODE (
                                                                          'Y',
                                                                          'Y', NVL (
                                                                                   adj.acctd_amount,
                                                                                   0),
                                                                          adj.amount)),
                                                                  0)
                                                            * (-1)
                                                                amount_due_remaining,*/
                                                            NVL (SUM (DECODE ('Y', 'Y', NVL (adj.amount, 0), adj.acctd_amount)), 0) * (-1) amount_due_remaining, -- End of Change 3.2
                                                                                                                                                                 ps.trx_number,
                                               ps.amount_adjusted, ps.amount_applied, ps.amount_credited,
                                               ps.amount_adjusted_pending, ps.gl_date, ps.cust_trx_type_id,
                                               ps.org_id, ps.invoice_currency_code, NVL (ps.exchange_rate, 1) exchange_rate,
                                               0 cons_inv_id
                                          FROM ar_payment_schedules_all ps, ar_adjustments_all adj
                                         WHERE     ps.gl_date <= p_as_of_date
                                               AND ps.customer_id > 0
                                               AND ps.gl_date_closed >
                                                   p_as_of_date
                                               AND DECODE (
                                                       UPPER (NULL),
                                                       NULL, ps.invoice_currency_code,
                                                       UPPER (NULL)) =
                                                   ps.invoice_currency_code
                                               AND adj.payment_schedule_id =
                                                   ps.payment_schedule_id
                                               AND adj.status = 'A'
                                               AND adj.gl_date > p_as_of_date
                                               AND ps.ORG_ID = p_org_id
                                               AND adj.ORG_ID = p_org_id
                                      GROUP BY ps.customer_id, ps.customer_site_use_id, ps.customer_trx_id,
                                               ps.class, ps.due_date, ps.trx_number,
                                               ps.amount_adjusted, ps.amount_applied, ps.amount_credited,
                                               ps.amount_adjusted_pending, ps.gl_date, ps.cust_trx_type_id,
                                               ps.org_id, ps.invoice_currency_code, NVL (ps.exchange_rate, 1),
                                               ps.payment_schedule_id
                                      UNION ALL
                                        SELECT ps.customer_id, ps.customer_site_use_id, ps.customer_trx_id,
                                               ps.payment_schedule_id, ps.class, 0 primary_salesrep_id,
                                               ps.due_date, -- Commented and added as part of change 3.2
                                                            /*
                                                            NVL (
                                                                SUM (
                                                                      DECODE (
                                                                          'Y',
                                                                          'Y', (  DECODE (
                                                                                      ps.class,
                                                                                      'CM', DECODE (
                                                                                                app.application_type,
                                                                                                'CM', app.acctd_amount_applied_from,
                                                                                                app.acctd_amount_applied_to),
                                                                                      app.acctd_amount_applied_to)
                                                                                + NVL (
                                                                                      app.acctd_earned_discount_taken,
                                                                                      0)
                                                                                + NVL (
                                                                                      app.acctd_unearned_discount_taken,
                                                                                      0)),
                                                                          (  app.amount_applied
                                                                           + NVL (
                                                                                 app.earned_discount_taken,
                                                                                 0)
                                                                           + NVL (
                                                                                 app.unearned_discount_taken,
                                                                                 0)))
                                                                    * DECODE (
                                                                          ps.class,
                                                                          'CM', DECODE (
                                                                                    app.application_type,
                                                                                    'CM', -1,
                                                                                    1),
                                                                          1)),
                                                                0)
                                                                amount_due_remaining_inv,*/
                                                            NVL (SUM (DECODE ('Y', 'Y', (app.amount_applied + NVL (app.earned_discount_taken, 0) + NVL (app.unearned_discount_taken, 0)), (DECODE (ps.class, 'CM', DECODE (app.application_type, 'CM', app.acctd_amount_applied_from, app.acctd_amount_applied_to), app.acctd_amount_applied_to) + NVL (app.acctd_earned_discount_taken, 0) + NVL (app.acctd_unearned_discount_taken, 0))) * DECODE (ps.class, 'CM', DECODE (app.application_type, 'CM', -1, 1), 1)), 0) amount_due_remaining_inv, -- End of Change 3.2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ps.trx_number,
                                               ps.amount_adjusted, ps.amount_applied, ps.amount_credited,
                                               ps.amount_adjusted_pending, ps.gl_date gl_date_inv, ps.cust_trx_type_id,
                                               ps.org_id, ps.invoice_currency_code, NVL (ps.exchange_rate, 1) exchange_rate,
                                               0 cons_inv_id
                                          FROM ar_payment_schedules_all ps, ar_receivable_applications_all app
                                         WHERE     ps.gl_date <= p_as_of_date
                                               AND ps.customer_id > 0
                                               AND ps.gl_date_closed >
                                                   p_as_of_date
                                               AND DECODE (
                                                       UPPER (NULL),
                                                       NULL, ps.invoice_currency_code,
                                                       UPPER (NULL)) =
                                                   ps.invoice_currency_code
                                               AND (app.applied_payment_schedule_id = ps.payment_schedule_id OR app.payment_schedule_id = ps.payment_schedule_id)
                                               AND app.status = 'APP'
                                               AND NVL (app.confirmed_flag, 'Y') =
                                                   'Y'
                                               AND app.gl_date > p_as_of_date
                                               AND ps.ORG_ID = p_org_id
                                               AND app.ORG_ID = p_org_id
                                      GROUP BY ps.customer_id, ps.customer_site_use_id, ps.customer_trx_id,
                                               ps.class, ps.due_date, ps.trx_number,
                                               ps.amount_adjusted, ps.amount_applied, ps.amount_credited,
                                               ps.amount_adjusted_pending, ps.gl_date, ps.cust_trx_type_id,
                                               ps.org_id, ps.invoice_currency_code, NVL (ps.exchange_rate, 1),
                                               ps.payment_schedule_id
                                      UNION ALL
                                      SELECT ps.customer_id, ps.customer_site_use_id, ps.customer_trx_id,
                                             ps.payment_schedule_id, ps.class class_inv, NVL (ct.primary_salesrep_id, -3) primary_salesrep_id,
                                             ps.due_date due_date_inv, -- Commented and added as part of change 3.2
                                                                       /*DECODE (
                                                                           'Y',
                                                                           'Y', ps.acctd_amount_due_remaining,
                                                                           ps.amount_due_remaining)
                                                                           amt_due_remaining_inv,*/
                                                                       DECODE ('Y', 'Y', ps.amount_due_remaining, ps.acctd_amount_due_remaining) amt_due_remaining_inv, -- End of Change 3.2
                                                                                                                                                                        ps.trx_number,
                                             ps.amount_adjusted, ps.amount_applied, ps.amount_credited,
                                             ps.amount_adjusted_pending, ps.gl_date, ps.cust_trx_type_id,
                                             ps.org_id, ps.invoice_currency_code, NVL (ps.exchange_rate, 1) exchange_rate,
                                             ps.cons_inv_id
                                        FROM ar_payment_schedules_all ps, ra_customer_trx_all ct
                                       WHERE     ps.gl_date <= p_as_of_date
                                             AND ps.gl_date_closed >
                                                 p_as_of_date
                                             AND DECODE (
                                                     UPPER (NULL),
                                                     NULL, ps.invoice_currency_code,
                                                     UPPER (NULL)) =
                                                 ps.invoice_currency_code
                                             AND ps.customer_trx_id =
                                                 ct.customer_trx_id
                                             AND ps.ORG_ID = p_org_id
                                             AND ct.ORG_ID = p_org_id) a
                            GROUP BY a.customer_id, a.customer_site_use_id, a.customer_trx_id,
                                     a.payment_schedule_id, a.class, a.due_date,
                                     a.trx_number, a.amount_adjusted, a.amount_applied,
                                     a.amount_credited, a.amount_adjusted_pending, a.gl_date,
                                     a.cust_trx_type_id, a.org_id, a.invoice_currency_code,
                                     a.exchange_rate) ps,
                           hz_cust_site_uses_all site,
                           hz_cust_acct_sites_all acct_site,
                           hz_party_sites party_site,
                           hz_locations loc,
                           ra_cust_trx_line_gl_dist_all gld,
                           xla_distribution_links lk,
                           xla_ae_lines ae,
                           ar_dispute_history dh,
                           gl_code_combinations c
                     WHERE     UPPER (RTRIM (RPAD ('I', 1))) = 'I'
                           AND ps.customer_site_use_id = site.site_use_id
                           AND site.cust_acct_site_id =
                               acct_site.cust_acct_site_id
                           AND acct_site.party_site_id =
                               party_site.party_site_id
                           AND loc.location_id = party_site.location_id
                           AND gld.account_class = 'REC'
                           AND gld.latest_rec_flag = 'Y'
                           AND gld.cust_trx_line_gl_dist_id =
                               lk.source_distribution_id_num_1(+)
                           AND lk.source_distribution_type(+) =
                               'RA_CUST_TRX_LINE_GL_DIST_ALL'
                           AND lk.application_id(+) = 222
                           AND ae.application_id(+) = 222
                           AND lk.ae_header_id = ae.ae_header_id(+)
                           AND lk.ae_line_num = ae.ae_line_num(+)
                           AND DECODE (lk.accounting_line_code,
                                       '', 'Y',
                                       'CM_EXCH_GAIN_LOSS', 'N',
                                       'AUTO_GEN_GAIN_LOSS', 'N',
                                       'Y') =
                               'Y'
                           AND DECODE (
                                   ae.ledger_id,
                                   '', DECODE (gld.posting_control_id,
                                               -3, -999999,
                                               gld.code_combination_id),
                                   gld.set_of_books_id, ae.code_combination_id,
                                   -999999) =
                               c.code_combination_id
                           AND ps.payment_schedule_id =
                               dh.payment_schedule_id(+)
                           AND ps.org_id = p_org_id
                           AND p_as_of_date >=
                               NVL (dh.start_date(+), p_as_of_date)
                           AND p_as_of_date <
                               NVL (dh.end_date(+), p_as_of_date + 1)
                           AND cust_acct.party_id = party.party_id
                           AND ps.customer_id = cust_acct.cust_account_id
                           AND ps.customer_trx_id = gld.customer_trx_id
                           AND gld.ORG_ID = p_org_id
                           AND NVL (acct_site.ORG_ID, p_org_id) = p_org_id
                    UNION ALL
                      SELECT /*+ LEADING(ps) */
                             SUBSTRB (
                                 NVL (
                                     party.party_name,
                                     RTRIM (
                                         RPAD (
                                             ARPT_SQL_FUNC_UTIL.get_lookup_meaning (
                                                 'MISC_PHRASES',
                                                 'UNIDENTIFIED_PAYMENT'),
                                             18))),
                                 1,
                                 50)
                                 cust_name_inv,
                             cust_acct.account_number
                                 cust_no_inv,
                                c.SEGMENT1
                             || ' '
                             || c.SEGMENT2
                             || ' '
                             || c.SEGMENT3
                             || ' '
                             || c.SEGMENT4
                             || ' '
                             || c.SEGMENT5
                             || ' '
                             || c.SEGMENT6
                             || ' '
                             || c.SEGMENT7
                             || ' '
                             || c.SEGMENT8,
                             INITCAP (
                                 RTRIM (
                                     RPAD (
                                         ARPT_SQL_FUNC_UTIL.get_lookup_meaning (
                                             'INV/CM/ADJ',
                                             'PMT'),
                                         20))),
                             c.code_combination_id,
                             site.site_use_id,
                             loc.state
                                 cust_state_inv,
                             loc.city
                                 cust_state_inv,
                             3000
                                 addr_id_inv,
                             NVL (cust_acct.cust_account_id, -999)
                                 cust_id_inv,
                             ps.payment_schedule_id,
                             DECODE (app.applied_payment_schedule_id,
                                     -4, 'CLAIM',
                                     ps.class),
                             ps.due_date,
                             -- Commented and added as part of change 3.2
                             /*DECODE (
                                 'Y',
                                 'Y', NVL (
                                          -SUM (app.acctd_amount_applied_from),
                                          0),
                                 NVL (-SUM (app.amount_applied), 0)),*/
                             DECODE (
                                 'Y',
                                 'Y', NVL (-SUM (app.amount_applied), 0),
                                 NVL (-SUM (app.acctd_amount_applied_from), 0)),
                             -- End of Change 3.2
                             ps.trx_number,
                             ps.customer_trx_id,                        -- 4.3
                             CEIL (p_as_of_date - ps.due_date),
                             ps.amount_adjusted,
                             ps.amount_applied,
                             ps.amount_credited,
                             ps.gl_date,
                             DECODE (
                                 ps.invoice_currency_code,
                                 p_fuctional_currency, NULL,
                                 DECODE (ps.exchange_rate, NULL, '*', NULL)),
                             NVL (ps.exchange_rate, 1),
                             DECODE (p_bucket_line_type_0,
                                     NULL, 0,
                                     arpt_sql_func_util.bucket_function (
                                         p_bucket_line_type_0,
                                         ps.amount_in_dispute,
                                         ps.amount_adjusted_pending,
                                         p_bucket_days_from_0,
                                         p_bucket_days_to_0,
                                         ps.due_date,
                                         p_bucket_category,
                                         p_as_of_date))
                                 b0_inv,
                             DECODE (p_bucket_line_type_1,
                                     NULL, 0,
                                     arpt_sql_func_util.bucket_function (
                                         p_bucket_line_type_1,
                                         ps.amount_in_dispute,
                                         ps.amount_adjusted_pending,
                                         p_bucket_days_from_1,
                                         p_bucket_days_to_1,
                                         ps.due_date,
                                         p_bucket_category,
                                         p_as_of_date))
                                 b1_inv,
                             DECODE (p_bucket_line_type_2,
                                     NULL, 0,
                                     arpt_sql_func_util.bucket_function (
                                         p_bucket_line_type_2,
                                         ps.amount_in_dispute,
                                         ps.amount_adjusted_pending,
                                         p_bucket_days_from_2,
                                         p_bucket_days_to_2,
                                         ps.due_date,
                                         p_bucket_category,
                                         p_as_of_date))
                                 b2_inv,
                             DECODE (p_bucket_line_type_3,
                                     NULL, 0,
                                     arpt_sql_func_util.bucket_function (
                                         p_bucket_line_type_3,
                                         ps.amount_in_dispute,
                                         ps.amount_adjusted_pending,
                                         p_bucket_days_from_3,
                                         p_bucket_days_to_3,
                                         ps.due_date,
                                         p_bucket_category,
                                         p_as_of_date))
                                 b3_inv,
                             DECODE (p_bucket_line_type_4,
                                     NULL, 0,
                                     arpt_sql_func_util.bucket_function (
                                         p_bucket_line_type_4,
                                         ps.amount_in_dispute,
                                         ps.amount_adjusted_pending,
                                         p_bucket_days_from_4,
                                         p_bucket_days_to_4,
                                         ps.due_date,
                                         p_bucket_category,
                                         p_as_of_date))
                                 b4_inv,
                             DECODE (p_bucket_line_type_5,
                                     NULL, 0,
                                     arpt_sql_func_util.bucket_function (
                                         p_bucket_line_type_5,
                                         ps.amount_in_dispute,
                                         ps.amount_adjusted_pending,
                                         p_bucket_days_from_5,
                                         p_bucket_days_to_5,
                                         ps.due_date,
                                         p_bucket_category,
                                         p_as_of_date))
                                 b5_inv,
                             DECODE (p_bucket_line_type_6,
                                     NULL, 0,
                                     arpt_sql_func_util.bucket_function (
                                         p_bucket_line_type_6,
                                         ps.amount_in_dispute,
                                         ps.amount_adjusted_pending,
                                         p_bucket_days_from_6,
                                         p_bucket_days_to_6,
                                         ps.due_date,
                                         p_bucket_category,
                                         p_as_of_date))
                                 b6_inv,
                             c.SEGMENT1
                                 company_inv,
                             TO_CHAR (NULL)
                                 cons_billing_number,
                             INITCAP (
                                 RTRIM (
                                     RPAD (
                                         ARPT_SQL_FUNC_UTIL.get_lookup_meaning (
                                             'INV/CM/ADJ',
                                             'PMT'),
                                         20))),
                             ps.org_id,
                             party.attribute16
                                 buying_agent_group_num --Added by Madhav for CCR0007216
                        FROM hz_cust_accounts cust_acct, hz_parties party, ar_payment_schedules_all ps,
                             hz_cust_site_uses_all site, hz_cust_acct_sites_all acct_site, hz_party_sites party_site,
                             hz_locations loc, ar_receivable_applications_all app, gl_code_combinations c
                       WHERE     app.gl_date <= p_as_of_date
                             AND UPPER (RTRIM (RPAD ('I', 1))) = 'I'
                             AND ps.trx_number IS NOT NULL
                             AND ps.customer_id = cust_acct.cust_account_id(+)
                             AND ps.org_id = p_org_id
                             AND cust_acct.party_id = party.party_id(+)
                             AND ps.cash_receipt_id = app.cash_receipt_id
                             AND app.code_combination_id =
                                 c.code_combination_id
                             AND app.status IN ('ACC', 'UNAPP', 'UNID',
                                                'OTHER ACC')
                             AND NVL (app.confirmed_flag, 'Y') = 'Y'
                             AND ps.customer_site_use_id = site.site_use_id(+)
                             AND site.cust_acct_site_id =
                                 acct_site.cust_acct_site_id(+)
                             AND acct_site.party_site_id =
                                 party_site.party_site_id(+)
                             AND loc.location_id(+) = party_site.location_id
                             AND ps.gl_date_closed > p_as_of_date
                             AND ((app.reversal_gl_date IS NOT NULL AND ps.gl_date <= p_as_of_date) OR app.reversal_gl_date IS NULL)
                             AND DECODE (UPPER (NULL),
                                         NULL, ps.invoice_currency_code,
                                         UPPER (NULL)) =
                                 ps.invoice_currency_code
                             AND NVL (ps.receipt_confirmed_flag, 'Y') = 'Y'
                             AND ps.ORG_ID = p_org_id
                             AND app.ORG_ID = p_org_id
                             AND NVL (acct_site.ORG_ID, p_org_id) = p_org_id
                    GROUP BY party.party_name, cust_acct.account_number, site.site_use_id,
                             c.SEGMENT1 || ' ' || c.SEGMENT2 || ' ' || c.SEGMENT3 || ' ' || c.SEGMENT4 || ' ' || c.SEGMENT5 || ' ' || c.SEGMENT6 || ' ' || c.SEGMENT7 || ' ' || c.SEGMENT8, c.code_combination_id, loc.state,
                             loc.city, acct_site.cust_acct_site_id, cust_acct.cust_account_id,
                             ps.payment_schedule_id, ps.due_date, ps.trx_number,
                             ps.customer_trx_id,                        -- 4.3
                                                 ps.amount_adjusted, ps.amount_applied,
                             ps.amount_credited, ps.gl_date, ps.amount_in_dispute,
                             ps.amount_adjusted_pending, ps.invoice_currency_code, ps.exchange_rate,
                             DECODE (app.applied_payment_schedule_id, -4, 'CLAIM', ps.class), c.SEGMENT1, DECODE (app.status,  'UNID', 'UNID',  'OTHER ACC', 'OTHER ACC',  'UNAPP'),
                             TO_CHAR (NULL), INITCAP (RTRIM (RPAD (ARPT_SQL_FUNC_UTIL.get_lookup_meaning ('INV/CM/ADJ', 'PMT'), 20))), ps.org_id,
                             party.attribute16 --Added by Madhav for CCR0007216
                    UNION ALL
                    SELECT SUBSTRB (
                               NVL (
                                   party.party_name,
                                   RTRIM (
                                       RPAD (
                                           ARPT_SQL_FUNC_UTIL.get_lookup_meaning (
                                               'MISC_PHRASES',
                                               'UNIDENTIFIED_PAYMENT'),
                                           18))),
                               1,
                               50)
                               cust_name_inv,
                           cust_acct.account_number
                               cust_no_inv,
                              c.SEGMENT1
                           || ' '
                           || c.SEGMENT2
                           || ' '
                           || c.SEGMENT3
                           || ' '
                           || c.SEGMENT4
                           || ' '
                           || c.SEGMENT5
                           || ' '
                           || c.SEGMENT6
                           || ' '
                           || c.SEGMENT7
                           || ' '
                           || c.SEGMENT8,
                           INITCAP (
                               RTRIM (
                                   RPAD (
                                       ARPT_SQL_FUNC_UTIL.get_lookup_meaning (
                                           'MISC_PHRASES',
                                           'RISK'),
                                       20))),
                           c.code_combination_id,
                           site.site_use_id,
                           loc.state
                               cust_state_inv,
                           loc.city
                               cust_city_inv,
                           3000
                               addr_id_inv,
                           NVL (cust_acct.cust_account_id, -999)
                               cust_id_inv,
                           ps.payment_schedule_id,
                           INITCAP (
                               RTRIM (
                                   RPAD (
                                       ARPT_SQL_FUNC_UTIL.get_lookup_meaning (
                                           'MISC_PHRASES',
                                           'RISK'),
                                       20))),
                           ps.due_date,
                           -- DECODE ('Y', 'Y', crh.acctd_amount, crh.amount),  -- Commented as per change 3.2
                           DECODE ('Y', 'Y', crh.amount, crh.acctd_amount), -- Added as per change 3.2
                           ps.trx_number,
                           ps.customer_trx_id,                          -- 4.3
                           CEIL (p_as_of_date - ps.due_date),
                           ps.amount_adjusted,
                           ps.amount_applied,
                           ps.amount_credited,
                           crh.gl_date,
                           DECODE (
                               ps.invoice_currency_code,
                               p_fuctional_currency, NULL,
                               DECODE (crh.exchange_rate, NULL, '*', NULL)),
                           NVL (crh.exchange_rate, 1),
                           DECODE (p_bucket_line_type_0,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_0,
                                       0,
                                       0,
                                       p_bucket_days_from_0,
                                       p_bucket_days_to_0,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b0_inv,
                           DECODE (p_bucket_line_type_1,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_1,
                                       0,
                                       0,
                                       p_bucket_days_from_1,
                                       p_bucket_days_to_1,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b1_inv,
                           DECODE (p_bucket_line_type_2,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_2,
                                       0,
                                       0,
                                       p_bucket_days_from_2,
                                       p_bucket_days_to_2,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b2_inv,
                           DECODE (p_bucket_line_type_3,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_3,
                                       0,
                                       0,
                                       p_bucket_days_from_3,
                                       p_bucket_days_to_3,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b3_inv,
                           DECODE (p_bucket_line_type_4,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_4,
                                       0,
                                       0,
                                       p_bucket_days_from_4,
                                       p_bucket_days_to_4,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b4_inv,
                           DECODE (p_bucket_line_type_5,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_5,
                                       0,
                                       0,
                                       p_bucket_days_from_5,
                                       p_bucket_days_to_5,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b5_inv,
                           DECODE (p_bucket_line_type_6,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_6,
                                       0,
                                       0,
                                       p_bucket_days_from_6,
                                       p_bucket_days_to_6,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b6_inv,
                           c.SEGMENT1
                               company_inv,
                           TO_CHAR (NULL)
                               cons_billing_number,
                           INITCAP (
                               RTRIM (
                                   RPAD (
                                       ARPT_SQL_FUNC_UTIL.get_lookup_meaning (
                                           'MISC_PHRASES',
                                           'RISK'),
                                       20))),
                           ps.org_id,
                           party.attribute16
                               buying_agent_group_num --Added by Madhav for CCR0007216
                      FROM hz_cust_accounts cust_acct, hz_parties party, ar_payment_schedules_all ps,
                           hz_cust_site_uses_all site, hz_cust_acct_sites_all acct_site, hz_party_sites party_site,
                           hz_locations loc, ar_cash_receipts_all cr, ar_cash_receipt_history_all crh,
                           gl_code_combinations c
                     WHERE     crh.gl_date <= p_as_of_date
                           AND ps.trx_number IS NOT NULL
                           AND NVL (ps.amount_due_remaining, 0) <> 0 --Open Transactions --Added on 09Jan2018
                           AND ps.status = 'OP' --Open Transactions --Added on 09Jan2018
                           AND UPPER (RTRIM (RPAD ('I', 1))) = 'I'
                           --AND UPPER ('Do Not Show') != 'NONE' --Commented on 23Jan2018 by Kranthi Bollam
                           AND 'NONE' != 'NONE' --Added on 23Jan2018 by Kranthi Bollam
                           AND ps.customer_id = cust_acct.cust_account_id(+)
                           AND cust_acct.party_id = party.party_id(+)
                           AND ps.cash_receipt_id = cr.cash_receipt_id
                           AND ps.org_id = p_org_id
                           AND cr.cash_receipt_id = crh.cash_receipt_id
                           AND crh.account_code_combination_id =
                               c.code_combination_id
                           AND ps.customer_site_use_id = site.site_use_id(+)
                           AND site.cust_acct_site_id =
                               acct_site.cust_acct_site_id(+)
                           AND acct_site.party_site_id =
                               party_site.party_site_id(+)
                           AND loc.location_id(+) = party_site.location_id
                           AND DECODE (UPPER (NULL),
                                       NULL, ps.invoice_currency_code,
                                       UPPER (NULL)) =
                               ps.invoice_currency_code
                           AND (crh.current_record_flag = 'Y' OR crh.reversal_gl_date > p_as_of_date)
                           AND crh.status NOT IN
                                   (DECODE (crh.factor_flag,  'Y', 'RISK_ELIMINATED',  'N', 'CLEARED'), 'REVERSED')
                           AND NOT EXISTS
                                   (SELECT 'x'
                                      FROM ar_receivable_applications_all ra
                                     WHERE     ra.cash_receipt_id =
                                               cr.cash_receipt_id
                                           AND ra.status = 'ACTIVITY'
                                           AND applied_payment_schedule_id =
                                               -2)
                           AND ps.ORG_ID = p_org_id
                           AND crh.ORG_ID = p_org_id
                           AND cr.ORG_ID = p_org_id
                           AND NVL (acct_site.ORG_ID, p_org_id) = p_org_id
                    UNION ALL
                    SELECT SUBSTRB (party.party_name, 1, 50)
                               cust_name_inv,
                           cust_acct.account_number
                               cust_no_inv,
                              c.SEGMENT1
                           || ' '
                           || c.SEGMENT2
                           || ' '
                           || c.SEGMENT3
                           || ' '
                           || c.SEGMENT4
                           || ' '
                           || c.SEGMENT5
                           || ' '
                           || c.SEGMENT6
                           || ' '
                           || c.SEGMENT7
                           || ' '
                           || c.SEGMENT8
                               sort_field1_inv,
                           arpt_sql_func_util.get_org_trx_type_details (
                               ps.cust_trx_type_id,
                               ps.org_id)
                               sort_field2_inv,
                           2000
                               inv_tid_inv,
                           site.site_use_id
                               contact_site_id_inv,
                           loc.state
                               cust_state_inv,
                           loc.city
                               cust_city_inv,
                           3000
                               addr_id_inv,
                           NVL (cust_acct.cust_account_id, -999)
                               cust_id_inv,
                           ps.payment_schedule_id
                               payment_sched_id_inv,
                           ps.class
                               class_inv,
                           ps.due_date
                               due_date_inv,
                           -- Commented and added as per change 3.2
                           /*DECODE ('Y',
                                   'Y', ps.acctd_amount_due_remaining,
                                   ps.amount_due_remaining)
                               amt_due_remaining_inv,*/
                           DECODE ('Y',
                                   'Y', ps.amount_due_remaining,
                                   ps.acctd_amount_due_remaining)
                               amt_due_remaining_inv,
                           -- End of change 3.2
                           ps.trx_number
                               invnum,
                           ps.customer_trx_id,                          -- 4.3
                           CEIL (p_as_of_date - ps.due_date)
                               days_past_due,
                           ps.amount_adjusted
                               amount_adjusted_inv,
                           ps.amount_applied
                               amount_applied_inv,
                           ps.amount_credited
                               amount_credited_inv,
                           ps.gl_date
                               gl_date_inv,
                           DECODE (
                               ps.invoice_currency_code,
                               p_fuctional_currency, NULL,
                               DECODE (ps.exchange_rate, NULL, '*', NULL))
                               data_converted_inv,
                           NVL (ps.exchange_rate, 1)
                               ps_exchange_rate_inv,
                           DECODE (p_bucket_line_type_0,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_0,
                                       ps.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_0,
                                       p_bucket_days_to_0,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b0_inv,
                           DECODE (p_bucket_line_type_1,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_1,
                                       ps.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_1,
                                       p_bucket_days_to_1,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b1_inv,
                           DECODE (p_bucket_line_type_2,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_2,
                                       ps.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_2,
                                       p_bucket_days_to_2,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b2_inv,
                           DECODE (p_bucket_line_type_3,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_3,
                                       ps.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_3,
                                       p_bucket_days_to_3,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b3_inv,
                           DECODE (p_bucket_line_type_4,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_4,
                                       ps.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_4,
                                       p_bucket_days_to_4,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b4_inv,
                           DECODE (p_bucket_line_type_5,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_5,
                                       ps.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_5,
                                       p_bucket_days_to_5,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b5_inv,
                           DECODE (p_bucket_line_type_6,
                                   NULL, 0,
                                   arpt_sql_func_util.bucket_function (
                                       p_bucket_line_type_6,
                                       ps.amount_in_dispute,
                                       ps.amount_adjusted_pending,
                                       p_bucket_days_from_6,
                                       p_bucket_days_to_6,
                                       ps.due_date,
                                       p_bucket_category,
                                       p_as_of_date))
                               b6_inv,
                           c.SEGMENT1
                               company_inv,
                           TO_CHAR (NULL)
                               cons_billing_number,
                           arpt_sql_func_util.get_org_trx_type_details (
                               ps.cust_trx_type_id,
                               ps.org_id)
                               invoice_type_inv,
                           ps.org_id,
                           party.attribute16
                               buying_agent_group_num --Added by Madhav for CCR0007216
                      FROM hz_cust_accounts cust_acct, hz_parties party, ar_payment_schedules_all ps,
                           hz_cust_site_uses_all site, hz_cust_acct_sites_all acct_site, hz_party_sites party_site,
                           hz_locations loc, ar_transaction_history_all th, ar_xla_ard_lines_v dist,
                           gl_code_combinations c
                     WHERE     ps.gl_date <=
                               TO_DATE (p_as_of_date, 'DD-MON-YYYY')
                           AND UPPER (RTRIM (RPAD ('I', 1))) = 'I'
                           AND ps.customer_site_use_id = site.site_use_id
                           AND ps.org_id = p_org_id
                           AND site.cust_acct_site_id =
                               acct_site.cust_acct_site_id
                           AND acct_site.party_site_id =
                               party_site.party_site_id
                           AND loc.location_id = party_site.location_id
                           AND ps.gl_date_closed >
                               TO_DATE (p_as_of_date, 'DD-MON-YYYY')
                           AND ps.class = 'BR'
                           AND DECODE (UPPER (NULL),
                                       NULL, ps.invoice_currency_code,
                                       UPPER (NULL)) =
                               ps.invoice_currency_code
                           AND th.transaction_history_id =
                               (SELECT MAX (transaction_history_id)
                                  FROM ar_transaction_history th2, ar_xla_ard_lines_v dist2
                                 WHERE     th2.transaction_history_id =
                                           dist2.source_id
                                       AND dist2.source_table = 'TH'
                                       AND th2.gl_date <=
                                           TO_DATE (p_as_of_date,
                                                    'DD-MON-YYYY')
                                       AND dist2.amount_dr IS NOT NULL
                                       AND th2.customer_trx_id =
                                           ps.customer_trx_id)
                           AND th.transaction_history_id = dist.source_id
                           AND dist.source_table = 'TH'
                           AND dist.amount_dr IS NOT NULL
                           AND dist.source_table_secondary IS NULL
                           AND dist.code_combination_id =
                               c.code_combination_id
                           AND cust_acct.party_id = party.party_id
                           AND ps.customer_id = cust_acct.cust_account_id
                           AND ps.customer_trx_id = th.customer_trx_id
                           AND ps.org_id = p_org_id
                           AND NVL (acct_site.org_id, p_org_id) = p_org_id
                    ORDER BY
                        30, 1, 2,
                        13 DESC) xxdo
             WHERE     1 = 1
                   AND hz_profile.cust_account_id = xxdo.cust_id_inv
                   AND hz_profile.site_use_id IS NULL
                   AND xxdo.cust_id_inv = stmts.cust_account_id(+)
                   AND xxdo.amt_due_remaining_inv <> 0
                   AND validate_invoice (xxdo.org_id,
                                         xxdo.customer_trx_id,
                                         xxdo.class_inv) =
                       1                            -- Added as per CCR0009859
                   --AND xxdo.cust_no_inv = '10250524-UGG'
                   AND DECODE (p_customer_id,
                               NULL, 1,
                               hz_profile.cust_account_id) IN
                           (SELECT c1.cust_account_id    --, c1.account_number
                              FROM hz_cust_accounts c1
                             WHERE SUBSTR (
                                       c1.account_number,
                                       1,
                                       INSTR (c1.account_number, '-', 1) - 1) =
                                   (SELECT c2.account_number
                                      FROM hz_cust_accounts c2
                                     WHERE c2.cust_account_id = p_customer_id)
                            UNION
                            SELECT hca.cust_account_id  --, hca.account_number
                              FROM hz_cust_accounts hca, hz_cust_acct_sites_all hcasa
                             WHERE     hca.cust_account_id = p_customer_id
                                   AND hca.cust_account_id =
                                       hcasa.cust_account_id
                                   AND hcasa.org_id =
                                       NVL (p_org_id, hcasa.org_id)
                                   AND hca.status = 'A'
                                   AND hcasa.status = 'A'
                            UNION
                            SELECT 1
                              FROM DUAL
                             WHERE p_customer_id IS NULL);

        lv_parent_cust_no       VARCHAR2 (30);
        --Aging Bucket Variables--
        lv_bucket_line_type_0   VARCHAR2 (60);
        lv_bucket_line_type_1   VARCHAR2 (60);
        lv_bucket_line_type_2   VARCHAR2 (60);
        lv_bucket_line_type_3   VARCHAR2 (60);
        lv_bucket_line_type_4   VARCHAR2 (60);
        lv_bucket_line_type_5   VARCHAR2 (60);
        lv_bucket_line_type_6   VARCHAR2 (60);
        ln_bucket_days_from_0   NUMBER;
        ln_bucket_days_from_1   NUMBER;
        ln_bucket_days_from_2   NUMBER;
        ln_bucket_days_from_3   NUMBER;
        ln_bucket_days_from_4   NUMBER;
        ln_bucket_days_from_5   NUMBER;
        ln_bucket_days_from_6   NUMBER;
        ln_bucket_days_to_0     NUMBER;
        ln_bucket_days_to_1     NUMBER;
        ln_bucket_days_to_2     NUMBER;
        ln_bucket_days_to_3     NUMBER;
        ln_bucket_days_to_4     NUMBER;
        ln_bucket_days_to_5     NUMBER;
        ln_bucket_days_to_6     NUMBER;
        lv_bucket_heading_0     VARCHAR2 (60);
        lv_bucket_heading_1     VARCHAR2 (60);
        lv_bucket_heading_2     VARCHAR2 (60);
        lv_bucket_heading_3     VARCHAR2 (60);
        lv_bucket_heading_4     VARCHAR2 (60);
        lv_bucket_heading_5     VARCHAR2 (60);
        lv_bucket_heading_6     VARCHAR2 (60);
        lv_bucket_category      VARCHAR2 (60);
        --Remit to Variables--
        lv_remit_address1       VARCHAR2 (240);
        lv_remit_address2       VARCHAR2 (240);
        lv_remit_address3       VARCHAR2 (240);
        lv_remit_address4       VARCHAR2 (240);
        lv_remit_city           VARCHAR2 (60);
        lv_remit_state          VARCHAR2 (60);
        lv_remit_province       VARCHAR2 (60);
        lv_remit_zip            VARCHAR2 (60);
        lv_remit_country        VARCHAR2 (60);
        lv_remit_addressee      VARCHAR2 (240);
        lv_remit_contact        VARCHAR2 (150);
        lv_remit_country_name   VARCHAR2 (150);

        --Bill to Variables--
        lv_bill_address1        VARCHAR2 (240);
        lv_bill_address2        VARCHAR2 (240);
        lv_bill_address3        VARCHAR2 (240);
        lv_bill_address4        VARCHAR2 (240);
        lv_bill_city            VARCHAR2 (60);
        lv_bill_state           VARCHAR2 (60);
        lv_bill_province        VARCHAR2 (60);
        lv_bill_zip             VARCHAR2 (60);
        lv_bill_country         VARCHAR2 (60);
        lv_bill_party           VARCHAR2 (360);
        lv_bill_country_name    VARCHAR2 (150);

        --Collector Info--
        lv_collector_name       VARCHAR2 (150);
        lv_collector_phone      VARCHAR2 (150);
        lv_collector_email      VARCHAR2 (240);
        --Statement details --
        lv_ou_name              VARCHAR2 (120);
        lv_brand_name           VARCHAR2 (30);
        lv_lang_code            VARCHAR2 (30);
        lv_lang_code1           VARCHAR2 (30);          --Added for CCR0007216
        lv_email_to             VARCHAR2 (360);
        lv_email_from           VARCHAR2 (150);
        lv_print_flag           VARCHAR2 (1);
        lv_email_flag           VARCHAR2 (1);

        --Other Variables--
        lv_err_msg              VARCHAR2 (2000);
        lv_currency_code        VARCHAR2 (30);
        ln_amt_due_original     NUMBER;
        lv_reference            VARCHAR2 (60);
        lv_ou_country           VARCHAR2 (60) := NULL;
        lv_legal_entity         VARCHAR2 (120) := NULL;

        lv_billing_phone        VARCHAR2 (60) := NULL;
        lv_brand_phone          VARCHAR2 (60) := NULL;

        lv_ret_code             VARCHAR2 (30) := NULL;
        lv_ret_message          VARCHAR2 (2000) := NULL;
    BEGIN
        --Get Sold by Legal Entity, Ship from country
        get_country_le (p_org_id       => p_org_id,
                        x_le_name      => lv_legal_entity,
                        x_ou_country   => lv_ou_country);

        --Get Bucket Information
        get_stmt_buckets (p_bucket_name          => p_bucket_name,
                          x_bucket_line_type_0   => lv_bucket_line_type_0,
                          x_bucket_line_type_1   => lv_bucket_line_type_1,
                          x_bucket_line_type_2   => lv_bucket_line_type_2,
                          x_bucket_line_type_3   => lv_bucket_line_type_3,
                          x_bucket_line_type_4   => lv_bucket_line_type_4,
                          x_bucket_line_type_5   => lv_bucket_line_type_5,
                          x_bucket_line_type_6   => lv_bucket_line_type_6,
                          x_bucket_days_from_0   => ln_bucket_days_from_0,
                          x_bucket_days_from_1   => ln_bucket_days_from_1,
                          x_bucket_days_from_2   => ln_bucket_days_from_2,
                          x_bucket_days_from_3   => ln_bucket_days_from_3,
                          x_bucket_days_from_4   => ln_bucket_days_from_4,
                          x_bucket_days_from_5   => ln_bucket_days_from_5,
                          x_bucket_days_from_6   => ln_bucket_days_from_6,
                          x_bucket_days_to_0     => ln_bucket_days_to_0,
                          x_bucket_days_to_1     => ln_bucket_days_to_1,
                          x_bucket_days_to_2     => ln_bucket_days_to_2,
                          x_bucket_days_to_3     => ln_bucket_days_to_3,
                          x_bucket_days_to_4     => ln_bucket_days_to_4,
                          x_bucket_days_to_5     => ln_bucket_days_to_5,
                          x_bucket_days_to_6     => ln_bucket_days_to_6,
                          x_bucket_category      => lv_bucket_category,
                          x_bucket_heading_0     => lv_bucket_heading_0,
                          x_bucket_heading_1     => lv_bucket_heading_1,
                          x_bucket_heading_2     => lv_bucket_heading_2,
                          x_bucket_heading_3     => lv_bucket_heading_3,
                          x_bucket_heading_4     => lv_bucket_heading_4,
                          x_bucket_heading_5     => lv_bucket_heading_5,
                          x_bucket_heading_6     => lv_bucket_heading_6);

        --Get Remit Information
        get_remit_address (p_org_id => p_org_id, x_remit_address1 => lv_remit_address1, x_remit_address2 => lv_remit_address2, x_remit_address3 => lv_remit_address3, x_remit_address4 => lv_remit_address4, x_remit_city => lv_remit_city, x_remit_state => lv_remit_state, x_remit_province => lv_remit_province, x_remit_zip => lv_remit_zip, x_remit_country => lv_remit_country, x_remit_addressee => lv_remit_addressee, x_remit_contact => lv_remit_contact
                           , x_remit_country_name => lv_remit_country_name);

        FOR stmt_rec IN stmt_cur (p_org_id => p_org_id, p_as_of_date => p_as_of_date, p_fuctional_currency => p_fuctional_currency, p_bucket_line_type_0 => lv_bucket_line_type_0, p_bucket_line_type_1 => lv_bucket_line_type_1, p_bucket_line_type_2 => lv_bucket_line_type_2, p_bucket_line_type_3 => lv_bucket_line_type_3, p_bucket_line_type_4 => lv_bucket_line_type_4, p_bucket_line_type_5 => lv_bucket_line_type_5, p_bucket_line_type_6 => lv_bucket_line_type_6, p_bucket_days_from_0 => ln_bucket_days_from_0, p_bucket_days_from_1 => ln_bucket_days_from_1, p_bucket_days_from_2 => ln_bucket_days_from_2, p_bucket_days_from_3 => ln_bucket_days_from_3, p_bucket_days_from_4 => ln_bucket_days_from_4, p_bucket_days_from_5 => ln_bucket_days_from_5, p_bucket_days_from_6 => ln_bucket_days_from_6, p_bucket_days_to_0 => ln_bucket_days_to_0, p_bucket_days_to_1 => ln_bucket_days_to_1, p_bucket_days_to_2 => ln_bucket_days_to_2, p_bucket_days_to_3 => ln_bucket_days_to_3, p_bucket_days_to_4 => ln_bucket_days_to_4, p_bucket_days_to_5 => ln_bucket_days_to_5, p_bucket_days_to_6 => ln_bucket_days_to_6
                                  , p_bucket_category => lv_bucket_category)
        LOOP
            --Resetting variables to NULL
            lv_bill_address1       := NULL;
            lv_bill_address2       := NULL;
            lv_bill_address3       := NULL;
            lv_bill_address4       := NULL;
            lv_bill_city           := NULL;
            lv_bill_state          := NULL;
            lv_bill_province       := NULL;
            lv_bill_zip            := NULL;
            lv_bill_country        := NULL;
            lv_bill_country_name   := NULL;
            lv_bill_party          := NULL;
            lv_collector_name      := NULL;
            lv_collector_phone     := NULL;
            lv_collector_email     := NULL;
            lv_parent_cust_no      := NULL;
            lv_ou_name             := NULL;
            lv_brand_name          := NULL;
            lv_lang_code           := NULL;
            lv_email_to            := NULL;
            lv_email_from          := NULL;
            lv_print_flag          := NULL;
            lv_email_flag          := NULL;
            lv_currency_code       := NULL;
            ln_amt_due_original    := NULL;
            lv_reference           := NULL;
            lv_billing_phone       := NULL;
            lv_brand_phone         := NULL;
            lv_lang_code1          := NULL;


            -- Start changes for CCR0009748
            -- Rather deriving data for each row, this can be done after the insert
            /*
            --Get Customer Bill to details

            get_bill_to_address (p_customer_id     => stmt_rec.cust_id_inv,
                                 p_org_id          => stmt_rec.org_id,
                                 x_bill_address1   => lv_bill_address1,
                                 x_bill_address2   => lv_bill_address2,
                                 x_bill_address3   => lv_bill_address3,
                                 x_bill_address4   => lv_bill_address4,
                                 x_bill_city       => lv_bill_city,
                                 x_bill_state      => lv_bill_state,
                                 x_bill_province   => lv_bill_province,
                                 x_bill_zip        => lv_bill_zip,
                                 x_bill_country    => lv_bill_country,
                                 x_bill_party      => lv_bill_party,
                                 x_bill_country_name => lv_bill_country_name);

            -- B2B Phase 2 EMEA Changes (CCR0007216 ) --Start
            --Get EMEA Alternate language code
            get_emea_stmt_lang (p_customer_id       => stmt_rec.cust_id_inv
                               ,p_org_id            => stmt_rec.org_id
                               ,x_lang_code         => lv_lang_code1
                               ,x_ret_code          => lv_ret_code
                               ,x_ret_message       => lv_ret_message);
            --print_log('x_lang_code:'||lv_lang_code1);
            -- B2B Phase 2 EMEA Changes (CCR0007216 ) --End

            --Get Collector Details

            get_collector_info (
                p_customer_id       => stmt_rec.cust_id_inv,
                p_contact_id        => stmt_rec.contact_site_id_inv,
                x_collector_name    => lv_collector_name,
                x_collector_phone   => lv_collector_phone,
                x_collector_email   => lv_collector_email);

            */
            -- End changes for CCR0009748
            --Get Parent Customer Number
            BEGIN
                SELECT CASE
                           WHEN INSTR (stmt_rec.cust_no_inv, '-') > 0
                           THEN
                               SUBSTR (stmt_rec.cust_no_inv,
                                       1,
                                       INSTR (stmt_rec.cust_no_inv, '-') - 1)
                           ELSE
                               stmt_rec.cust_no_inv
                       END parent_cust_no
                  INTO lv_parent_cust_no
                  FROM DUAL;
            EXCEPTION
                WHEN OTHERS
                THEN
                    lv_parent_cust_no   := NULL;
            END;

            -- Start changes for CCR0009748
            -- Rather deriving data for each row, this can be done after the insert
            /*
            --Get From Email, TO Email, OU Name and details
            get_soa_hdr_details (p_org_id          => stmt_rec.org_id,
                                 p_customer_id     => stmt_rec.cust_id_inv,
                                 p_customer_name   => stmt_rec.cust_name_inv,
                                 x_ou_name         => lv_ou_name,
                                 x_brand_name      => lv_brand_name,
                                 x_lang_code       => lv_lang_code,
                                 x_email_to        => lv_email_to,
                                 x_email_from      => lv_email_from,
                                 x_print_flag      => lv_print_flag,
                                 x_email_flag      => lv_email_flag);

            --Get Statement Line Info
            get_stmt_line_det (
                p_payment_schedule_id   => stmt_rec.payment_sched_id_inv,
                x_currency_code         => lv_currency_code,
                x_amt_due_orig          => ln_amt_due_original,
                x_reference             => lv_reference);

            --Get Billing Phone
            lv_billing_phone :=
                NVL (lv_remit_contact, get_billing_phone (lv_brand_name));

            --Get Brand Phone
            lv_brand_phone := get_brand_num (lv_brand_name);
            */
            -- End changes for CCR0009748

            BEGIN
                INSERT INTO xxdo.xxdoar_statements_stg (
                                concurrent_request_id,
                                file_date_time,
                                org_id,
                                operating_unit,
                                brand_name,
                                customer_name,
                                customer_number,
                                class,
                                contact_site_id,
                                customer_state,
                                customer_city,
                                customer_id,
                                payment_sched_id,
                                due_date,
                                amt_due_remaining,
                                trx_number,
                                days_past_due,
                                amount_adjusted,
                                amount_applied,
                                amount_credited,
                                gl_date,
                                b0_inv,
                                b1_inv,
                                b2_inv,
                                b3_inv,
                                b4_inv,
                                b5_inv,
                                b6_inv,
                                company,
                                invoice_type,
                                cons_billing_number,
                                process_flag,
                                remit_address1,
                                remit_address2,
                                remit_address3,
                                remit_address4,
                                remit_city,
                                remit_state,
                                remit_province,
                                remit_zip,
                                remit_country,
                                remit_to_country_name,
                                bill_to_address1,
                                bill_to_address2,
                                bill_to_address3,
                                bill_to_address4,
                                bill_to_city,
                                bill_to_state,
                                bill_to_province,
                                bill_to_zip,
                                bill_to_country,
                                bill_to_country_name,
                                bill_to_party,
                                remit_contact_number,
                                remit_addressee,
                                collector_name,
                                collector_phone,
                                collector_email,
                                parent_customer_number,
                                buying_group_number,
                                sold_by_legal_entity,
                                reprocess_flag,
                                consolidated_flag,
                                header_comments1,
                                header_comments2,
                                header_comments3,
                                header_comments4,
                                header_comments5,
                                header_comments6,
                                header_comments7,
                                header_comments8,
                                header_comments9,
                                header_comments10,
                                line_placeholder1,
                                line_placeholder2,
                                line_placeholder3,
                                line_placeholder4,
                                line_placeholder5,
                                line_placeholder6,
                                line_placeholder7,
                                line_placeholder8,
                                line_placeholder9,
                                line_placeholder10,
                                bucket0_name,
                                bucket1_name,
                                bucket2_name,
                                bucket3_name,
                                bucket4_name,
                                bucket5_name,
                                bucket6_name,
                                bucket0_value,
                                bucket1_value,
                                bucket2_value,
                                bucket3_value,
                                bucket4_value,
                                bucket5_value,
                                bucket6_value,
                                total_amount,
                                brand_phone_number,
                                billing_phone,
                                footer_notes1,
                                footer_notes2,
                                footer_notes3,
                                footer_notes4,
                                footer_notes5,
                                footer_comments1,
                                footer_comments2,
                                footer_comments3,
                                footer_comments4,
                                doc_language,
                                to_email_address,
                                from_email_address,
                                print_flag,
                                email_flag,
                                statement_number,
                                statement_date,
                                currency_code,
                                reference,
                                amount_due_original)
                     VALUES (gn_conc_request_id, gv_time_stamp, stmt_rec.org_id, lv_ou_name, lv_brand_name, stmt_rec.cust_name_inv, --customer_name     ,
                                                                                                                                    stmt_rec.cust_no_inv, --customer_number    ,
                                                                                                                                                          stmt_rec.class_inv, --class              ,
                                                                                                                                                                              stmt_rec.contact_site_id_inv, --contact_site_id    ,
                                                                                                                                                                                                            stmt_rec.cust_state_inv, --customer_state     ,
                                                                                                                                                                                                                                     stmt_rec.cust_city_inv, --customer_city      ,
                                                                                                                                                                                                                                                             stmt_rec.cust_id_inv, --customer_id        ,
                                                                                                                                                                                                                                                                                   stmt_rec.payment_sched_id_inv, --payment_sched_id   ,
                                                                                                                                                                                                                                                                                                                  stmt_rec.due_date_inv, --due_date           ,
                                                                                                                                                                                                                                                                                                                                         stmt_rec.amt_due_remaining_inv, --amt_due_remaining  ,
                                                                                                                                                                                                                                                                                                                                                                         stmt_rec.invnum, --trx_number         ,
                                                                                                                                                                                                                                                                                                                                                                                          stmt_rec.days_past_due, --days_past_due      ,
                                                                                                                                                                                                                                                                                                                                                                                                                  stmt_rec.amount_adjusted_inv, --amount_adjusted    ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                stmt_rec.amount_applied_inv, --amount_applied     ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             stmt_rec.amount_credited_inv, --amount_credited    ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           stmt_rec.gl_date_inv, --gl_date            ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 stmt_rec.b0_inv, stmt_rec.b1_inv, stmt_rec.b2_inv, stmt_rec.b3_inv, stmt_rec.b4_inv, stmt_rec.b5_inv, stmt_rec.b6_inv, stmt_rec.company_inv, --company            ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              stmt_rec.invoice_type_inv, --invoice_type       ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         stmt_rec.cons_billing_number, 'N', lv_remit_address1, --remit_address1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               lv_remit_address2, --remit_address2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  lv_remit_address3, --remit_address3,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     lv_remit_address4, --remit_address4,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        lv_remit_city, --remit_city,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       lv_remit_state, --remit_state,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       lv_remit_province, --remit_province,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          lv_remit_zip, --remit_zip,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        lv_remit_country, --remit_country,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          lv_remit_country_name, --remit_to_country_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 lv_bill_address1, --bill_to_address1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   lv_bill_address2, --bill_to_address2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     lv_bill_address3, --bill_to_address3,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       lv_bill_address4, --bill_to_address4,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         lv_bill_city, --bill_to_city,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       lv_bill_state, --bill_to_state,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      lv_bill_province, --bill_to_province,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        lv_bill_zip, --bill_to_zip,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     lv_bill_country, --bill_to_country,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      lv_bill_country_name, --bill_to_country_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            lv_bill_party, --bill_to_party,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           lv_remit_contact, --remit_contact_number,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             lv_remit_addressee, --remit_addressee,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 lv_collector_name, --collector_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    lv_collector_phone, --collector_phone,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        lv_collector_email, --collector_email,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            lv_parent_cust_no, --parent_customer_number,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               --NULL,                      --buying_group_number, --Commented by Madhav for CCR0007216
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               stmt_rec.buying_agent_group_num, --buying_group_number, --Added by Madhav for CCR0007216
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                lv_legal_entity, --sold_by_legal_entity,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 'N', --reprocess_flag,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      NULL, --consolidated_flag,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            NULL, --header_comments1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  'Option 2', --NULL,            --header_comments2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              NULL, --header_comments3,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    NULL, --header_comments4,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          NULL, --header_comments5,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                NULL, --header_comments6,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      NULL, --header_comments7,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            NULL, --header_comments8,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  NULL, --header_comments9,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        NULL, --header_comments10,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              NULL, --line_placeholder1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    NULL, --line_placeholder2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          NULL, --line_placeholder3,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                NULL, --line_placeholder4,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      NULL, --line_placeholder5,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            NULL, --line_placeholder6,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  NULL, --line_placeholder7,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        NULL, --line_placeholder8,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              NULL, --line_placeholder9,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    NULL, --line_placeholder10,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          lv_bucket_heading_0, --bucket0_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               lv_bucket_heading_1, --bucket1_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    lv_bucket_heading_2, --bucket2_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         lv_bucket_heading_3, --bucket3_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              lv_bucket_heading_4, --bucket4_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   lv_bucket_heading_5, --bucket5_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        lv_bucket_heading_6, --bucket6_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             NULL, --bucket0_value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   NULL, --bucket1_value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         NULL, --bucket2_value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               NULL, --bucket3_value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NULL, --bucket4_value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           NULL, --bucket5_value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 NULL, --bucket6_value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       NULL, --total_amount,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             lv_brand_phone, --NULL,       --brand_phone_number,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             lv_billing_phone, --NULL,        --billing_phone,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               NULL, --footer_notes1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NULL, --footer_notes2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           NULL, --footer_notes3,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 NULL, --footer_notes4,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       NULL, --footer_notes5,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             NULL, --footer_comments1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   NULL, --footer_comments2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         NULL, --footer_comments3,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               NULL, --footer_comments4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     --lv_lang_code,                     --doc_language, --Commented for CCR0007216
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     lv_lang_code1, --doc_language, --Added for CCR0007216
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    lv_email_to, --to_email_address,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 lv_email_from, --from_email_address,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                lv_print_flag, --print_flag,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               lv_email_flag, --email_flag
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              NULL, --statement_number,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    NULL, --statement_date
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          lv_currency_code
                             , lv_reference, ln_amt_due_original);
            EXCEPTION
                WHEN OTHERS
                THEN
                    print_log (
                           'Error inserting xxdoar_statements_stg. Payment_Sched_ID:'
                        || stmt_rec.payment_sched_id_inv
                        || ' '
                        || SQLERRM);
            END;
        END LOOP;

        -- Start changes for CCR0009748
        UPDATE xxdo.xxdoar_statements_stg xxd
           SET (bill_to_address1, bill_to_address2, bill_to_address3,
                bill_to_address4, bill_to_city, bill_to_state,
                bill_to_province, bill_to_zip, bill_to_country,
                bill_to_party, bill_to_country_name)   =
                   (SELECT loc.address1,
                           loc.address2,
                           loc.address3,
                           loc.address4,
                           loc.city,
                           loc.state,
                           loc.province,
                           loc.postal_code,
                           loc.country,
                           party.party_name,
                           (SELECT terr.territory_short_name
                              FROM apps.fnd_territories_vl terr
                             WHERE loc.country = terr.territory_code) territory_short_name
                      FROM apps.hz_party_sites psites, apps.hz_locations loc, apps.hz_cust_acct_sites_all sites,
                           apps.hz_cust_accounts cust_acct, apps.hz_parties party
                     WHERE     1 = 1
                           AND sites.party_site_id = psites.party_site_id
                           AND loc.location_id = psites.location_id
                           AND sites.cust_account_id =
                               cust_acct.cust_account_id
                           AND sites.cust_account_id = xxd.customer_id
                           AND sites.org_id = xxd.org_id
                           AND party.party_id = cust_acct.party_id
                           AND sites.bill_to_flag = 'P'
                           AND sites.status = 'A')
         WHERE     concurrent_request_id = gn_conc_request_id
               AND process_flag = 'N';

        COMMIT;

        FOR i
            IN (SELECT DISTINCT customer_id, org_id
                  FROM xxdo.xxdoar_statements_stg
                 WHERE     concurrent_request_id = gn_conc_request_id
                       AND process_flag = 'N')
        LOOP
            get_emea_stmt_lang (p_customer_id   => i.customer_id,
                                p_org_id        => i.org_id,
                                x_lang_code     => lv_lang_code1,
                                x_ret_code      => lv_ret_code,
                                x_ret_message   => lv_ret_message);

            UPDATE xxdo.xxdoar_statements_stg
               SET doc_language   = lv_lang_code1
             WHERE     customer_id = i.customer_id
                   AND org_id = i.org_id
                   AND concurrent_request_id = gn_conc_request_id
                   AND process_flag = 'N';
        END LOOP;

        COMMIT;

        FOR i
            IN (SELECT DISTINCT customer_id, contact_site_id
                  FROM xxdo.xxdoar_statements_stg
                 WHERE     concurrent_request_id = gn_conc_request_id
                       AND process_flag = 'N')
        LOOP
            get_collector_info (p_customer_id       => i.customer_id,
                                p_contact_id        => i.contact_site_id,
                                x_collector_name    => lv_collector_name,
                                x_collector_phone   => lv_collector_phone,
                                x_collector_email   => lv_collector_email);

            UPDATE xxdo.xxdoar_statements_stg
               SET collector_name = lv_collector_name, collector_phone = lv_collector_phone, collector_email = lv_collector_email
             WHERE     customer_id = i.customer_id
                   AND contact_site_id = i.contact_site_id
                   AND concurrent_request_id = gn_conc_request_id
                   AND process_flag = 'N';
        END LOOP;

        COMMIT;

        FOR i
            IN (SELECT DISTINCT customer_id, org_id, customer_name
                  FROM xxdo.xxdoar_statements_stg
                 WHERE     concurrent_request_id = gn_conc_request_id
                       AND process_flag = 'N')
        LOOP
            get_soa_hdr_details (p_org_id => i.org_id, p_customer_id => i.customer_id, p_customer_name => i.customer_name, x_ou_name => lv_ou_name, x_brand_name => lv_brand_name, x_lang_code => lv_lang_code, x_email_to => lv_email_to, x_email_from => lv_email_from, x_print_flag => lv_print_flag
                                 , x_email_flag => lv_email_flag);

            UPDATE xxdo.xxdoar_statements_stg
               SET operating_unit = lv_ou_name, brand_name = lv_brand_name, to_email_address = lv_email_to,
                   from_email_address = lv_email_from, print_flag = lv_print_flag, email_flag = lv_email_flag
             WHERE     customer_id = i.customer_id
                   AND customer_name = i.customer_name
                   AND org_id = i.org_id
                   AND concurrent_request_id = gn_conc_request_id
                   AND process_flag = 'N';
        END LOOP;

        COMMIT;

        FOR i
            IN (SELECT DISTINCT payment_sched_id
                  FROM xxdo.xxdoar_statements_stg
                 WHERE     concurrent_request_id = gn_conc_request_id
                       AND process_flag = 'N')
        LOOP
            get_stmt_line_det (p_payment_schedule_id => i.payment_sched_id, x_currency_code => lv_currency_code, x_amt_due_orig => ln_amt_due_original
                               , x_reference => lv_reference);

            UPDATE xxdo.xxdoar_statements_stg
               SET currency_code = lv_currency_code, amount_due_original = ln_amt_due_original, reference = lv_reference
             WHERE     payment_sched_id = i.payment_sched_id
                   AND concurrent_request_id = gn_conc_request_id
                   AND process_flag = 'N';
        END LOOP;

        COMMIT;

        IF lv_remit_contact IS NOT NULL
        THEN
            UPDATE xxdo.xxdoar_statements_stg
               SET billing_phone   = lv_remit_contact
             WHERE     concurrent_request_id = gn_conc_request_id
                   AND process_flag = 'N';
        ELSE
            FOR i
                IN (SELECT DISTINCT brand_name
                      FROM xxdo.xxdoar_statements_stg
                     WHERE     brand_name IS NOT NULL
                           AND concurrent_request_id = gn_conc_request_id
                           AND process_flag = 'N')
            LOOP
                lv_billing_phone   := get_billing_phone (i.brand_name);

                UPDATE xxdo.xxdoar_statements_stg xxd
                   SET billing_phone   = lv_billing_phone
                 WHERE     brand_name = i.brand_name
                       AND concurrent_request_id = gn_conc_request_id
                       AND process_flag = 'N';
            END LOOP;
        END IF;

        COMMIT;

        FOR i
            IN (SELECT DISTINCT brand_name
                  FROM xxdo.xxdoar_statements_stg
                 WHERE     brand_name IS NOT NULL
                       AND concurrent_request_id = gn_conc_request_id
                       AND process_flag = 'N')
        LOOP
            lv_brand_phone   := get_brand_num (i.brand_name);

            UPDATE xxdo.xxdoar_statements_stg xxd
               SET brand_phone_number   = lv_brand_phone
             WHERE     brand_name = i.brand_name
                   AND concurrent_request_id = gn_conc_request_id
                   AND process_flag = 'N';
        END LOOP;

        -- End changes for CCR0009748
        COMMIT;
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_err_msg      := 'Error in insert_stmt_staging:' || SQLERRM;
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
    --         raise_application_error(-20101, lv_err_msg);
    END insert_stmt_staging;

    ----
    ----
    PROCEDURE write_stmt_file (p_conc_request_id IN NUMBER, p_as_of_date IN DATE, p_file_path IN VARCHAR2
                               , p_file_name IN VARCHAR2, x_ret_code OUT VARCHAR2, x_ret_message OUT VARCHAR2)
    IS
        CURSOR c_hdr_ftr (p_conc_req_id IN NUMBER, p_date IN DATE)
        IS
              SELECT 'HDR' || '|' || TO_CHAR (p_date, 'DD-MON-YYYY') || '|' || operating_unit || '|' || customer_number || '|' || remove_junk (remit_address1) || '|' || remove_junk (remit_address2) || '|' || remove_junk (remit_address3) || '|' || remove_junk (remit_address4) || '|' || remove_junk (remit_city) || '|' || remove_junk (NVL (remit_state, remit_province)) || '|' || remove_junk (remit_zip) || '|' || remit_country || '|' || remit_to_country_name --Remit Country Name
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || remit_contact_number || '|' || remove_junk (remit_addressee) || '|' || remove_junk (bill_to_party) || '|' || customer_number || '|' || --bill to customer num
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            remove_junk (bill_to_address1) || '|' || remove_junk (bill_to_address2) || '|' || remove_junk (bill_to_address3) || '|' || remove_junk (bill_to_address4) || '|' || remove_junk (bill_to_city) || '|' || remove_junk (NVL (bill_to_state, bill_to_province)) || '|' || remove_junk (bill_to_zip) || '|' || remove_junk (bill_to_country) || '|' || bill_to_country_name --bill_to_country_name
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || collector_name || '|' || collector_phone || '|' || collector_email || '|' || parent_customer_number || '|' || buying_group_number || '|' || doc_language || '|' || remove_junk (to_email_address) || '|' || remove_junk (from_email_address) || '|' || brand_name --BRAND NAME
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                || '|' || email_flag || '|' || print_flag || '|' || get_consolidation_flag (customer_id) --(header_comments1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         || '|' || (header_comments2) || '|' || (header_comments3) || '|' || (header_comments4) || '|' || (header_comments5) || '|' || (header_comments6) || '|' || (header_comments7) || '|' || (header_comments8) || '|' || (header_comments9) || '|' || (header_comments10) || '|' || sold_by_legal_entity || '|' || reprocess_flag || '|' || statement_number || '|' || TO_CHAR (statement_date, 'DD-MON-YYYY') header, 'FTR' || '|' || bucket0_name || '|' || bucket1_name || '|' || bucket2_name || '|' || bucket3_name || '|' || bucket4_name || '|' || bucket5_name || '|' || bucket6_name || '|' || SUM (DECODE (b0_inv, 0, 0, NVL (amt_due_remaining, 0))) || '|' || SUM (DECODE (b1_inv, 0, 0, NVL (amt_due_remaining, 0))) || '|' || SUM (DECODE (b2_inv, 0, 0, NVL (amt_due_remaining, 0))) || '|' || SUM (DECODE (b3_inv, 0, 0, NVL (amt_due_remaining, 0))) || '|' || SUM (DECODE (b4_inv, 0, 0, NVL (amt_due_remaining, 0))) || '|' || SUM (DECODE (b5_inv, 0, 0, NVL (amt_due_remaining, 0))) || '|' || SUM (DECODE (b6_inv, 0, 0, NVL (amt_due_remaining, 0))) || '|' || SUM (NVL (amt_due_remaining, 0)) || '|' || brand_phone_number || '|' || billing_phone || '|' || (footer_notes1) || '|' || (footer_notes2) || '|' || (footer_notes3) || '|' || (footer_notes4) || '|' || (footer_notes5) || '|' || (footer_comments1) || '|' || (footer_comments2) || '|' || (footer_comments3) || '|' || (footer_comments4) footer, customer_number,
                     org_id, concurrent_request_id, SUM (NVL (amt_due_remaining, 0)) total_amount,
                     COUNT (1)
                FROM xxdo.xxdoar_statements_stg
               WHERE 1 = 1 AND concurrent_request_id = p_conc_req_id
            GROUP BY 'HDR', TO_CHAR (p_date, 'DD-MON-YYYY'), operating_unit,
                     customer_id, customer_number, (remit_address1),
                     (remit_address2), (remit_address3), (remit_address4),
                     remit_city, NVL (remit_state, remit_province), remit_zip,
                     remit_country, remit_to_country_name, remit_contact_number,
                     (remit_addressee), (bill_to_party), customer_number, --bill to customer num
                     (bill_to_address1), (bill_to_address2), (bill_to_address3),
                     (bill_to_address4), bill_to_city, NVL (bill_to_state, bill_to_province),
                     bill_to_zip, bill_to_country, bill_to_country_name,
                     collector_name, collector_phone, collector_email,
                     parent_customer_number, buying_group_number, doc_language,
                     to_email_address, from_email_address, brand_name,
                     email_flag, print_flag, (header_comments1),
                     (header_comments2), (header_comments3), (header_comments4),
                     (header_comments5), (header_comments6), (header_comments7),
                     (header_comments8), (header_comments9), (header_comments10),
                     sold_by_legal_entity, reprocess_flag, statement_number,
                     TO_CHAR (statement_date, 'DD-MON-YYYY'), 'FTR', bucket0_name,
                     bucket1_name, bucket2_name, bucket3_name,
                     bucket4_name, bucket5_name, bucket6_name,
                     brand_phone_number, billing_phone, (footer_notes1),
                     (footer_notes2), (footer_notes3), (footer_notes4),
                     (footer_notes5), (footer_comments1), (footer_comments2),
                     (footer_comments3), (footer_comments4), customer_number,
                     org_id, concurrent_request_id
            ORDER BY parent_customer_number, get_consolidation_flag (customer_id) DESC, customer_number;

        CURSOR c_line (p_request_id     IN NUMBER,
                       p_customer_num   IN VARCHAR2,
                       p_org_id         IN NUMBER)
        IS
            SELECT 'LIN' || '|' || trx_number || '|' || TO_CHAR (gl_date, 'DD-MON-YYYY') || '|' || class || '|' || TO_CHAR (due_date, 'DD-MON-YYYY') || '|' || brand_name || '|' || REFERENCE || '|' || CURRENCY_CODE || '|' || amount_due_original || '|' || amt_due_remaining || '|' || NULL || '|' || NULL || '|' || NULL || '|' || NULL || '|' || NULL || '|' || NULL || '|' || NULL || '|' || NULL || '|' || NULL || '|' || NULL line
              FROM xxdo.xxdoar_statements_stg
             WHERE     concurrent_request_id = p_request_id
                   AND customer_number = p_customer_num
                   AND org_id = p_org_id;

        --DEFINE VARIABLES
        lv_file_path       VARCHAR2 (360) := p_file_path;
        lv_output_file     UTL_FILE.file_type;
        --lv_outbound_file   VARCHAR2 (360) := 'STAT_' || p_file_name;
        lv_outbound_file   VARCHAR2 (360) := p_file_name;
        lv_err_msg         VARCHAR2 (2000) := NULL;
        ln_hdr_cnt         NUMBER := 0;
        ln_line_cnt        NUMBER := 0;
        ln_ftr_cnt         NUMBER := 0;
        lv_hdr             VARCHAR2 (32767) := NULL;
        lv_line            VARCHAR2 (32767) := NULL;
        lv_ftr             VARCHAR2 (32767) := NULL;
        lv_sum             VARCHAR2 (32767) := NULL;
        ln_sum_amount      NUMBER := 0;
        lv_ver             VARCHAR2 (32767) := NULL;
    BEGIN
        lv_output_file   :=
            UTL_FILE.fopen (lv_file_path, lv_outbound_file || '.tmp', 'W' --opening the file in write mode
                                                                         ,
                            32767);

        IF UTL_FILE.is_open (lv_output_file)
        THEN
            --Add Summary Record
            lv_ver   :=
                'VER' || '|' || gv_time_stamp || '|' || gn_conc_request_id;
            UTL_FILE.put_line (lv_output_file, lv_ver);

            FOR i IN c_hdr_ftr (p_conc_request_id, p_as_of_date)
            LOOP
                --Add Header Record
                ln_hdr_cnt      := ln_hdr_cnt + 1;
                lv_hdr          := i.header;
                UTL_FILE.put_line (lv_output_file, lv_hdr);


                FOR j
                    IN c_line (i.concurrent_request_id,
                               i.customer_number,
                               i.org_id)
                LOOP
                    --Add Line Record
                    lv_line       := j.line;
                    UTL_FILE.put_line (lv_output_file, lv_line);
                    ln_line_cnt   := ln_line_cnt + 1;
                END LOOP;

                --Add Footer Record
                lv_ftr          := i.footer;
                UTL_FILE.put_line (lv_output_file, lv_ftr);
                ln_ftr_cnt      := ln_ftr_cnt + 1;
                ln_sum_amount   := ln_sum_amount + i.total_amount;
            END LOOP;

            --Add Summary Record
            lv_sum   := 'SUM' || '|' || ln_hdr_cnt || '|' || ln_sum_amount;
            UTL_FILE.put_line (lv_output_file, lv_sum);
        ELSE
            lv_err_msg      :=
                SUBSTR (
                       'Error in Opening the Statement data file for writing. Error is : '
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            RETURN;
        END IF;

        UTL_FILE.fclose (lv_output_file);
    EXCEPTION
        WHEN UTL_FILE.invalid_path
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_PATH: File location or filename was invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20201, lv_err_msg);
        WHEN UTL_FILE.invalid_mode
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_MODE: The open_mode parameter in FOPEN was invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20202, lv_err_msg);
        WHEN UTL_FILE.invalid_filehandle
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_FILEHANDLE: The file handle was invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20203, lv_err_msg);
        WHEN UTL_FILE.invalid_operation
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_OPERATION: The file could not be opened or operated on as requested.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20204, lv_err_msg);
        WHEN UTL_FILE.read_error
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'READ_ERROR: An operating system error occurred during the read operation.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20205, lv_err_msg);
        WHEN UTL_FILE.write_error
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'WRITE_ERROR: An operating system error occurred during the write operation.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20206, lv_err_msg);
        WHEN UTL_FILE.internal_error
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      := 'INTERNAL_ERROR: An unspecified error in PL/SQL.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20207, lv_err_msg);
        WHEN UTL_FILE.invalid_filename
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_FILENAME: The filename parameter is invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20208, lv_err_msg);
        WHEN OTHERS
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                SUBSTR (
                       'Error while creating or writing the data into the file.'
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20209, lv_err_msg);
    END write_stmt_file;

    ----
    ----

    PROCEDURE write_completion_file (p_file_path IN VARCHAR2, p_file_name IN VARCHAR2, x_ret_code OUT NUMBER
                                     , x_ret_message OUT VARCHAR2)
    IS
        lv_file_path       VARCHAR2 (360) := p_file_path;
        lv_output_file     UTL_FILE.file_type;
        lv_outbound_file   VARCHAR2 (360) := 'READY_' || p_file_name;
        lv_err_msg         VARCHAR2 (2000);
        lv_line            VARCHAR2 (2000);
    BEGIN
        lv_output_file   :=
            UTL_FILE.fopen (lv_file_path, lv_outbound_file, 'W' --opening the file in write mode
                                                               );

        IF UTL_FILE.is_open (lv_output_file)
        THEN
            lv_line   := 'SUCCESS';
            UTL_FILE.put_line (lv_output_file, lv_line);
            NULL;
        ELSE
            lv_err_msg      :=
                SUBSTR (
                       'Error in Opening the Completion file for writing. Error is : '
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            RETURN;
        END IF;

        UTL_FILE.fclose (lv_output_file);
    EXCEPTION
        WHEN UTL_FILE.invalid_path
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_PATH: File location or filename was invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20101, lv_err_msg);
        WHEN UTL_FILE.invalid_mode
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_MODE: The open_mode parameter in FOPEN was invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20102, lv_err_msg);
        WHEN UTL_FILE.invalid_filehandle
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_FILEHANDLE: The file handle was invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20103, lv_err_msg);
        WHEN UTL_FILE.invalid_operation
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_OPERATION: The file could not be opened or operated on as requested.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20104, lv_err_msg);
        WHEN UTL_FILE.read_error
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'READ_ERROR: An operating system error occurred during the read operation.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20105, lv_err_msg);
        WHEN UTL_FILE.write_error
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'WRITE_ERROR: An operating system error occurred during the write operation.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20106, lv_err_msg);
        WHEN UTL_FILE.internal_error
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      := 'INTERNAL_ERROR: An unspecified error in PL/SQL.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20107, lv_err_msg);
        WHEN UTL_FILE.invalid_filename
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_FILENAME: The filename parameter is invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20108, lv_err_msg);
        WHEN OTHERS
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                SUBSTR (
                       'Error while creating or writing the data into the file.'
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20109, lv_err_msg);
    END write_completion_file;

    ----
    ----
    PROCEDURE insert_billing_staging (p_org_id IN NUMBER, p_trx_class IN VARCHAR2, p_batch_source_id IN NUMBER, p_cust_trx_type_id IN NUMBER, p_creation_date_from IN VARCHAR2, p_creation_date_to IN VARCHAR2, p_trx_date_from IN VARCHAR2, p_trx_date_to IN VARCHAR2, p_trx_num_from IN VARCHAR2, p_trx_num_to IN VARCHAR2, p_customer_id IN NUMBER, p_cc_email_id IN VARCHAR2, p_reprocess_flag IN VARCHAR2, p_file_path IN VARCHAR2, x_ret_code OUT VARCHAR2
                                      , x_ret_message OUT VARCHAR2)
    IS
        CURSOR c_hdr (p_org                IN NUMBER,
                      p_trx_dt_from        IN DATE,
                      p_trx_dt_to          IN DATE,
                      p_trx_no_from        IN VARCHAR2,
                      p_trx_no_to          IN VARCHAR2,
                      p_creation_dt_from   IN DATE,
                      p_creation_dt_to     IN DATE,
                      p_cust_id            IN NUMBER,
                      p_trx_class1         IN VARCHAR2,
                      p_batch_source_id    IN NUMBER,
                      p_cust_trx_type_id   IN NUMBER)
        IS
              SELECT rct.customer_trx_id
                         customer_trx_id,
                     rct.related_customer_trx_id
                         rel_customer_trx_id,
                     rct.set_of_books_id
                         set_of_books_id,
                     rct.trx_number
                         trx_number,
                     rct.org_id,
                     rct.trx_date
                         trx_date,
                     --TO_CHAR(rct.trx_date,'MM/DD/YYYY') trx_date ,
                     TO_CHAR (rct.trx_date, 'MM/DD/YYYY')
                         trx_date_dsp,
                     DECODE (tt.TYPE,
                             'CM', NVL (tt.description, tt.name),
                             tt.name)
                         trx_type_name,
                     tt.TYPE
                         trx_class_code,
                     arl.meaning
                         trx_class_desc,
                     NVL (abc.name, 'NO SOURCE')
                         trx_source_type,
                     NVL (abc.batch_source_id, -999)
                         trx_source_id,
                     rct.reason_code
                         reason_code,
                     xxdo_ar_invoice_print.factored_flag (rct.customer_trx_id)
                         factor_flag,
                     xxdo_ar_invoice_print.remit_to_address_id (
                         rct.customer_trx_id)
                         remit_to_address_id,
                     rct.bill_to_customer_id,
                     rct.bill_to_site_use_id,
                     rct.bill_to_contact_id,
                     rct.ship_to_customer_id,
                     rct.ship_to_site_use_id,
                     rct.ship_to_contact_id,
                     bill.customer_name
                         bill_customer_name,
                     bill.customer_number
                         bill_cust_num,
                     bill.address1
                         bill_address1,
                     bill.address2
                         bill_address2,
                     bill.address3
                         bill_address3,
                     bill.address4
                         bill_address4,
                     bill.city
                         bill_city,
                     bill.state
                         bill_state,
                     bill.postal_code
                         bill_postal_code,
                     bill.country
                         bill_country,
                     bill.country_name
                         bill_country_name,
                     bill.tax_reference
                         bill_tax_ref,
                     bill.brand
                         brand,
                     bill.buying_agent_group_num
                         bill_buy_agent_grp_no,         --Added for CCR0007216
                     bill.buying_mmb_num
                         bill_buying_mmb_no,            --Added for CCR0007216
                     bill.buying_membership_num
                         bill_membership_num,           --Added for CCR0007216
                     ship.customer_name
                         ship_customer_name,
                     ship.customer_number
                         ship_customer_num,
                     ship.address1
                         ship_address1,
                     ship.address2
                         ship_address2,
                     ship.address3
                         ship_address3,
                     ship.address4
                         ship_address4,
                     ship.city
                         ship_city,
                     ship.state
                         ship_state,
                     ship.postal_code
                         ship_postal_code,
                     ship.country
                         ship_country,
                     ship.country_name
                         ship_country_name,
                     ship.store_number
                         store_number,
                     ship.dc_number
                         dc_number,
                     apps.do_edi_utils_pub.parse_attributes (rct.attribute3,
                                                             'depart_number')
                         AS dept_number,
                     --NULL    dept_number,
                     ship.tax_reference
                         ship_tax_ref,
                     ship.buying_agent_group_num
                         ship_buy_agent_grp_no,         --Added for CCR0007216
                     ship.buying_mmb_num
                         ship_buying_mmb_no,            --Added for CCR0007216
                     ship.buying_membership_num
                         ship_membership_num,           --Added for CCR0007216
                     remit.address1
                         remit_address1,
                     remit.address2
                         remit_address2,
                     remit.address3
                         remit_address3,
                     remit.address4
                         remit_address4,
                     remit.city
                         remit_city,
                     remit.state
                         remit_state,
                     remit.postal_code
                         remit_postal_code,
                     remit.country
                         remit_country,
                     remit.country_name
                         remit_country_name,
                     remit.contact_number
                         remit_contact_number,
                     remit.addressee
                         remit_addressee,
                     DECODE (
                         remit.addressee,
                         'FACTOR',    'This invoice is assigned and payable to: '
                                   || remit.address1
                                   || ' to whom notice must be given of any returns or claims.'
                                   || CHR (13)
                                   || 'Payment to any other party does not constitute valid payment of this invoice.',
                         '')
                         remit_factor_disclaimer,
                     NVL (ship.tax_reference, bill.tax_reference)
                         tax_reference,
                     term.term_id,
                     term.name
                         term_name,
                     term.description
                         term_description,
                     REPLACE (
                         xxdo_ar_invoice_print.discount_amount_explanation (
                             ps.payment_schedule_id),
                         CHR (9),
                         ' ')
                         term_discount_amount_desc,
                     jrr.resource_name
                         salesrep_name,
                     rct.printing_pending
                         printing_pending,
                     rct.purchase_order
                         purchase_order,
                     /* --Start changes for EMEA Phase-2 CCR0007216
                     REPLACE (REPLACE (REPLACE ( NVL ( XXDO_AR_INVOICE_PRINT.discount_amount_explanation (ps.payment_schedule_id), rct.comments),
                             CHR (9), ' '), CHR (10), ' '), '|', ' ') comments,
                      */
                     --End changes for EMEA Phase-2 CCR0007216
                     REPLACE (
                         REPLACE (REPLACE (rct.comments, CHR (9), ' '),
                                  CHR (10),
                                  ' '),
                         '|',
                         ' ')
                         comments,                      --Added for CCR0007216
                     REPLACE (
                         REPLACE (REPLACE (rct.comments, CHR (9), ' '),
                                  CHR (10),
                                  ' '),
                         '|',
                         ' ')
                         invoice_comments,
                     REPLACE (
                         REPLACE (REPLACE (rct.internal_notes, CHR (9), ' '),
                                  CHR (10),
                                  ' '),
                         '|',
                         ' ')
                         internal_notes,
                     DECODE (rct.interface_header_context,
                             'CLAIM', rct.INTERFACE_HEADER_ATTRIBUTE5,
                             NULL)
                         dff_customer_reference,
                     DECODE (rct.interface_header_context,
                             'CLAIM', rct.INTERFACE_HEADER_ATTRIBUTE6,
                             NULL)
                         dff_customer_reason,
                     rct.invoice_currency_code
                         invoice_currency_code,
                     rct.attribute1
                         trx_attribute1,                        -- cancel_date
                     rct.attribute2
                         trx_attribute2,                        -- order class
                     rct.attribute3
                         trx_attribute3,
                     rct.attribute4
                         trx_attribute4,
                     rct.attribute5
                         trx_brand,
                     rct.attribute6
                         trx_attribute6,                         -- commments1
                     rct.attribute7
                         trx_attribute7,                          -- comments2
                     rct.attribute8
                         trx_attribute8,
                     rct.attribute9
                         trx_attribute9,
                     rct.attribute10
                         trx_attribute10,
                     rct.ship_via
                         ship_via,
                     ship_via.description
                         ship_via_desc,
                     DECODE (rct.waybill_number, '0', '', rct.waybill_number)
                         waybill_number,
                     rct.interface_header_context,
                     hou.name
                         operating_unit,
                     NVL (rct.interface_header_attribute1, rct.ct_reference)
                         order_reference,
                     rct.interface_header_attribute2
                         order_type,
                     DECODE (rct.interface_header_attribute3,
                             '0', '',
                             rct.interface_header_attribute3)
                         delivery_number,
                     ps.due_date
                         due_date,
                     TO_CHAR (ps.due_date, 'MM/DD/YYYY')
                         due_date_dsp,
                     ps.amount_due_original
                         invoice_amount,
                     ps.amount_due_original
                         inv_amt_dsp,
                     ps.amount_line_items_original,
                     ps.amount_line_items_original
                         invoice_line_amt_dsp,
                     ps.freight_original,
                     ps.freight_original
                         invoice_freight_amt_dsp,
                     ps.tax_original,
                     ps.tax_original
                         invoice_tax_amt_dsp,
                     /*ROUND(
                                 ps.freight_original
                               + ps.tax_original
                               + (ps.amount_line_items_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))),
                               2) disc_amt,*/
                     --Commented for CCR CCR0009132
                     /*Start of changes for CCR CCR0009132*/
                     DECODE (
                         term.calc_discount_on_lines_flag,
                         'L', (ROUND (ps.freight_original + ps.tax_original + (ps.amount_line_items_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))), 2)),
                         'I', (ROUND ((ps.amount_due_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))), 2)),
                         'T', (ROUND ((ps.freight_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))) + (ps.tax_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))) + (ps.amount_line_items_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))), 2)),
                         'F', (ROUND (
                                     ps.freight_original
                                   + (  (  ps.tax_original
                                         - (SELECT NVL (SUM (extended_amount), 0)
                                              FROM apps.ra_customer_trx_lines_all rctl
                                             WHERE     rctl.customer_trx_id =
                                                       rct.customer_trx_id
                                                   AND line_type = 'TAX'
                                                   AND link_to_cust_trx_line_id IN
                                                           (SELECT customer_trx_line_id
                                                              FROM apps.ra_customer_trx_lines_all rctl1
                                                             WHERE     1 = 1
                                                                   AND line_type =
                                                                       'FREIGHT'
                                                                   AND rctl1.customer_trx_id =
                                                                       rctl.customer_trx_id)))
                                      * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1)))
                                   + (ps.amount_line_items_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))),
                                   2)))
                         AS disc_amt,
                     /*End of changes for CCR CCR0009132*/
                     ROUND (
                           ps.freight_original
                         + ps.tax_original
                         + (ps.amount_line_items_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))),
                         2)
                         disc_amt_dsp,
                       ROUND (ps.amount_due_original, 2)
                     - ROUND (
                             ps.freight_original
                           + ps.tax_original
                           + (ps.amount_line_items_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))),
                           2)
                         AS discount,
                     /*ROUND (ps.amount_due_original, 2)
                   - ROUND (
                           ps.freight_original
                         + ps.tax_original
                         + (  ps.amount_line_items_original
                            * (NVL (
                                   (1 - NVL (rtld.discount_percent, 0) / 100),
                                   1))),
                         2)
                       AS discounted*/
                     --Commented for CCR CCR0009132
                     /*Start of changes for CCR CCR0009132*/
                     DECODE (
                         term.calc_discount_on_lines_flag,
                         'L', (ROUND (ps.amount_due_original, 2) - ROUND (ps.freight_original + ps.tax_original + (ps.amount_line_items_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))), 2)),
                         'I', (ROUND (ps.amount_due_original, 2) - ROUND ((ps.amount_due_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))), 2)),
                         'T', (ROUND (ps.amount_due_original, 2) - ROUND ((ps.freight_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))) + (ps.tax_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))) + (ps.amount_line_items_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))), 2)),
                         'F', (  ROUND (ps.amount_due_original, 2)
                               - ROUND (
                                       ps.freight_original
                                     + (  (  ps.tax_original
                                           - (SELECT NVL (SUM (extended_amount), 0)
                                                FROM apps.ra_customer_trx_lines_all rctl
                                               WHERE     rctl.customer_trx_id =
                                                         rct.customer_trx_id
                                                     AND line_type = 'TAX'
                                                     AND link_to_cust_trx_line_id IN
                                                             (SELECT customer_trx_line_id
                                                                FROM apps.ra_customer_trx_lines_all rctl1
                                                               WHERE     1 = 1
                                                                     AND line_type =
                                                                         'FREIGHT'
                                                                     AND rctl1.customer_trx_id =
                                                                         rctl.customer_trx_id)))
                                        * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1)))
                                     + (ps.amount_line_items_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))),
                                     2)))
                         AS discounted
                /*End of changes for CCR CCR0009132*/
                FROM apps.ra_customer_trx_all rct,
                     apps.ar_payment_schedules_all ps,
                     (SELECT c.cust_account_id customer_id, c.attribute1 brand, u.site_use_id site_use_id,
                             c.account_number customer_number, party.party_name customer_name, party.attribute16 buying_agent_group_num, --Added for CCR0007216
                             party.attribute17 buying_mmb_num, --Added for CCR0007216
                                                               loc.address1 address1, loc.address2 address2,
                             loc.address3 address3, loc.address4 address4, loc.city city,
                             NVL (loc.state, loc.province) state, loc.postal_code postal_code, loc.country country,
                             terr.territory_short_name country_name, u.tax_reference site_tax_reference, u.attribute11 buying_membership_num, --Added for CCR0007216
                             party.tax_reference cust_tax_reference, NVL (u.tax_reference, party.tax_reference) tax_reference, c.customer_class_code
                        FROM hz_cust_accounts c, hz_parties party, hz_cust_acct_sites_all a,
                             hz_party_sites party_site, hz_locations loc, hz_cust_site_uses_all u,
                             apps.fnd_territories_tl terr
                       WHERE     1 = 1
                             AND u.cust_acct_site_id = a.cust_acct_site_id -- address_id
                             AND c.cust_account_id = a.cust_account_id
                             AND a.party_site_id = party_site.party_site_id
                             AND loc.location_id = party_site.location_id
                             AND c.party_id = party.party_id
                             AND loc.country = terr.territory_code
                             AND terr.language = USERENV ('LANG')--AND (c.attribute9 IS NULL OR c.attribute9 NOT IN ('01', '11')) --Commented for CCR0007216
                                                                 ) bill,
                     (SELECT c.cust_account_id customer_id, u.site_use_id site_use_id, c.account_number customer_number,
                             NVL (a.attribute1, party.party_name) customer_name, party.attribute16 buying_agent_group_num, --Added for CCR0007216
                                                                                                                           party.attribute17 buying_mmb_num, --Added for CCR0007216
                             loc.address1 address1, loc.address2 address2, loc.address3 address3,
                             loc.address4 address4, loc.city city, NVL (loc.state, loc.province) state,
                             loc.postal_code postal_code, loc.country country, terr.territory_short_name country_name,
                             u.tax_reference site_tax_reference, party.tax_reference cust_tax_reference, NVL (u.tax_reference, party.tax_reference) tax_reference,
                             u.attribute11 buying_membership_num, --Added for CCR0007216
                                                                  a.attribute2 store_number, a.attribute5 dc_number
                        FROM hz_cust_accounts c, hz_parties party, hz_cust_acct_sites_all a,
                             hz_party_sites party_site, hz_locations loc, hz_cust_site_uses_all u,
                             apps.fnd_territories_tl terr
                       WHERE     1 = 1
                             AND u.cust_acct_site_id = a.cust_acct_site_id -- address_id
                             AND c.cust_account_id = a.cust_account_id
                             AND a.party_site_id = party_site.party_site_id
                             AND loc.location_id = party_site.location_id
                             AND c.party_id = party.party_id
                             AND loc.country = terr.territory_code
                             AND terr.language = USERENV ('LANG')) ship,
                     (SELECT acct_site.cust_acct_site_id address_id, loc.address1 address1, loc.address2 address2,
                             loc.address3 address3, loc.address4 address4, loc.city city,
                             NVL (loc.state, loc.province) state, loc.postal_code postal_code, loc.country country,
                             terr.territory_short_name country_name, party_site.addressee, acct_site.attribute2 contact_number
                        FROM hz_cust_acct_sites_all acct_site, hz_party_sites party_site, hz_locations loc,
                             apps.fnd_territories_tl terr
                       WHERE     1 = 1
                             AND acct_site.party_site_id =
                                 party_site.party_site_id
                             AND loc.location_id = party_site.location_id
                             AND loc.country = terr.territory_code
                             AND terr.language = USERENV ('LANG')) remit,
                     (SELECT f.freight_code, f.description, osp.org_id
                        FROM apps.org_freight f, apps.oe_system_parameters_all osp
                       WHERE f.organization_id = osp.master_organization_id --AND OSP.ORG_ID      =rct.org_id    --in (81,95,86,88,89,94,104,473)
                                                                           )
                     ship_via,
                     apps.ra_cust_trx_types_all tt,
                     apps.ra_batch_sources_all abc,
                     apps.ar_lookups arl,
                     apps.ra_terms term,
                     apps.ra_terms_lines_discounts rtld,
                     apps.jtf_rs_salesreps rep,
                     apps.jtf_rs_resource_extns_vl jrr,
                     apps.hr_operating_units hou
               WHERE     1 = 1
                     AND rct.org_id = hou.organization_id
                     AND rct.bill_to_customer_id = bill.customer_id
                     AND rct.bill_to_site_use_id = bill.site_use_id
                     AND rct.ship_to_customer_id = ship.customer_id(+)
                     AND rct.ship_to_site_use_id = ship.site_use_id(+)
                     AND rct.cust_trx_type_id = tt.cust_trx_type_id
                     AND rct.cust_trx_type_id =
                         NVL (p_cust_trx_type_id, rct.cust_trx_type_id)
                     AND rct.org_id = tt.org_id
                     AND tt.TYPE = arl.lookup_code
                     AND arl.lookup_type = 'INV/CM'
                     AND rct.batch_source_id = abc.batch_source_id(+)
                     AND rct.org_id = abc.org_id(+)
                     AND rct.batch_source_id =
                         NVL (p_batch_source_id, rct.batch_source_id)
                     AND rct.customer_trx_id = ps.customer_trx_id
                     AND rct.term_id = term.term_id(+)
                     AND rtld.term_id(+) = rct.term_id
                     AND rct.primary_salesrep_id = rep.salesrep_id(+)
                     AND rct.org_id = rep.org_id(+)
                     AND jrr.resource_id(+) = rep.resource_id
                     AND apps.xxdo_ar_invoice_print.remit_to_address_id (
                             rct.customer_trx_id) =
                         remit.address_id(+)
                     AND rct.ship_via = ship_via.freight_code(+)
                     AND rct.org_id = ship_via.org_id(+)
                     AND NVL (rct.printing_option, 'PRI') = 'PRI'
                     AND NVL (rct.printing_pending, 'Y') = 'Y'
                     AND ps.number_of_due_dates = 1 --Multiple pay schedule invoices will be printed using a different format
                     AND NOT EXISTS
                             (SELECT 1
                                FROM fnd_lookup_values flv
                               WHERE     1 = 1
                                     AND flv.language = USERENV ('LANG')
                                     AND flv.lookup_type =
                                         'XXDOAR035_EXCLUDED_TRX_TYPES'
                                     AND flv.meaning = tt.name
                                     AND flv.description = tt.TYPE
                                     AND DECODE (
                                             SIGN (
                                                   SYSDATE
                                                 - NVL (flv.start_date_active,
                                                        SYSDATE - 1)),
                                             -1, 'INACTIVE',
                                             DECODE (
                                                 SIGN (
                                                       NVL (
                                                           flv.end_date_active,
                                                           SYSDATE + 1)
                                                     - SYSDATE),
                                                 -1, 'INACTIVE',
                                                 DECODE (flv.enabled_flag,
                                                         'N', 'INACTIVE',
                                                         'ACTIVE'))) =
                                         'ACTIVE')
                     --AND rct.attribute5  = NVL(:P_BRAND,rct.attribute5)
                     AND rct.trx_number >= NVL (p_trx_no_from, rct.trx_number)
                     AND rct.trx_number <= NVL (p_trx_no_to, rct.trx_number)
                     AND rct.creation_date >=
                         NVL (p_creation_dt_from, rct.creation_date) --TO_DATE(p_creation_date_from,'YYYY/MM/DD HH24:MI:SS')
                     AND rct.creation_date <
                         NVL (p_creation_dt_to + 1, rct.creation_date + 1) --TRUNC(TO_DATE(p_creation_date_to,'YYYY/MM/DD HH24:MI:SS')+1)
                     AND rct.org_id = NVL (p_org, rct.org_id)
                     AND EXISTS
                             (SELECT 1
                                FROM apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values ffv
                               WHERE     1 = 1
                                     AND ffvs.flex_value_set_id =
                                         ffv.flex_value_set_id
                                     AND ffvs.flex_value_set_name =
                                         'XXDOAR_B2B_OPERATING_UNITS'
                                     AND ffv.enabled_flag = 'Y'
                                     AND NVL (ffv.start_date_active, SYSDATE) <=
                                         SYSDATE
                                     AND NVL (ffv.end_date_active, SYSDATE + 1) >
                                         SYSDATE
                                     AND TO_CHAR (rct.org_id) =
                                         RTRIM (LTRIM (ffv.flex_value)))
                     AND rct.trx_date >= NVL (p_trx_dt_from, rct.trx_date) --TRUNC(NVL(TO_DATE(p_trx_date_from,'YYYY/MM/DD HH24:MI:SS'),rct.trx_date))
                     AND rct.trx_date < NVL (p_trx_dt_to + 1, rct.trx_date + 1) --TRUNC(NVL(TO_DATE(p_trx_date_to,'YYYY/MM/DD HH24:MI:SS')+1,rct.trx_date+1))
                     AND rct.bill_to_customer_id =
                         NVL (p_cust_id, rct.bill_to_customer_id)
                     AND tt.TYPE = NVL (p_trx_class1, tt.TYPE)
                     AND validate_invoice (rct.org_id,
                                           rct.customer_trx_id,
                                           ps.class) =
                         1                          -- Added as per CCR0009859
            -- showkath
            --AND rct.customer_trx_id = 5732904
            /*AND rct.org_id IN (81, 95, 86, 88, 89, 94, 104, 473)*/
            ORDER BY hou.name, tt.TYPE, rct.trx_number;

        CURSOR c_lin (p_cust_trx_id IN NUMBER)
        IS
            SELECT rctl.customer_trx_id, rctl.customer_trx_line_id, rctl.interface_line_attribute6,
                   rctl.interface_line_attribute1,  -- Added as per CCR0009103
                                                   rctl.interface_line_context, -- Added as per CCR0009402
                                                                                rctl.description line_description,
                   msi.style_number item_style, msi.color_code item_color, DECODE (msi.item_number, 'FRT-NA-NA', msi.style_desc, msi.style_number) item_style1,
                   DECODE (msi.item_number, 'FRT-NA-NA', msi.color_desc, msi.color_code) item_color1, msi.style_desc, msi.color_desc,
                   msi.item_size, DECODE (NVL (rctl.interface_line_attribute11, 0), 0, NVL (rctl.quantity_invoiced, rctl.quantity_credited), 0) qty_total_dsp, NVL (DECODE (DECODE (NVL (rctl.interface_line_attribute11, 0), 0, NVL (rctl.quantity_invoiced, rctl.quantity_credited), 0), 0, 0, rctl.extended_amount / DECODE (NVL (rctl.interface_line_attribute11, 0), 0, NVL (rctl.quantity_invoiced, rctl.quantity_credited), 0)), rctl.unit_selling_price) --Added NVL of unit selling price on 23Jan2018 by Kranthi Bollam
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 avg_unit_price_dsp,
                   rctl.extended_amount ext_amt_dsp, rctl.inventory_item_id, rctl.unit_selling_price,
                   rctl.tax_recoverable, rctl.warehouse_id -- Added as per CCR0009103
              FROM apps.ra_customer_trx_lines_all rctl, apps.xxd_common_items_v msi
             WHERE     1 = 1
                   AND rctl.inventory_item_id = msi.inventory_item_id(+)
                   AND rctl.warehouse_id = msi.organization_id(+)
                   AND NVL (rctl.interface_line_attribute11, 0) = 0
                   AND rctl.line_type IN ('LINE', 'CB')
                   AND rctl.customer_trx_id = p_cust_trx_id;

        --Define Variables
        ld_trx_date_from                DATE;
        ld_trx_date_to                  DATE;
        ld_creation_date_from           DATE;
        ld_creation_date_to             DATE;
        lv_billing_phone                VARCHAR2 (50);
        lv_brand_phone                  VARCHAR2 (50);
        lv_to_email_address             VARCHAR2 (360);
        lv_print_or_email               VARCHAR2 (30);
        ld_disc_date                    DATE;
        ld_due_date                     DATE;
        lv_orig_trx_num                 VARCHAR2 (30);
        lv_from_email                   VARCHAR2 (100);
        lv_email_body                   VARCHAR2 (2000);
        lv_email_subject                VARCHAR2 (200);
        lv_language                     VARCHAR2 (100);
        ln_gst_amt                      NUMBER;
        ln_hst_amt                      NUMBER;
        ln_pst_amt                      NUMBER;
        ln_qst_amt                      NUMBER;
        ln_qty_sum                      NUMBER;
        ln_line_amt                     NUMBER;
        ln_unit_price                   NUMBER;
        ln_unit_price_list              NUMBER;
        ln_disc_percent                 NUMBER;
        lv_tax_yn                       VARCHAR2 (30);
        lv_item_code                    VARCHAR2 (30);
        lv_origin_country               VARCHAR2 (60);
        lv_legal_entity                 VARCHAR2 (150);
        lv_ou_country                   VARCHAR2 (10);
        ln_gst_rate                     NUMBER := 0;
        ln_hst_rate                     NUMBER := 0;
        ln_pst_rate                     NUMBER := 0;
        ln_qst_rate                     NUMBER := 0;
        lv_cpo_acc                      VARCHAR2 (120);
        lv_cpo_member                   VARCHAR2 (120);
        lv_tax_relate                   VARCHAR2 (60);
        lv_line_amt                     VARCHAR2 (50);
        lv_nt_tqty                      VARCHAR2 (50);
        lv_non_tax_amt                  VARCHAR2 (50);
        lv_non_tax_text                 VARCHAR2 (360);
        lv_c1                           VARCHAR2 (30);
        lv_t_tqty                       VARCHAR2 (50);
        lv_tax_amt                      VARCHAR2 (50);
        lv_tax_text                     VARCHAR2 (360);
        lv_c2                           VARCHAR2 (50);
        lv_other_amt                    VARCHAR2 (50);
        lv_tot_tax                      VARCHAR2 (50);
        lv_trate                        VARCHAR2 (50);
        lv_no_vat                       VARCHAR2 (50);

        lv_inco_term                    VARCHAR2 (100);
        lv_vat_rate_name                VARCHAR2 (50);
        lv_vat_rate                     VARCHAR2 (50);
        ln_total_qty                    NUMBER;
        lv_total_amt                    VARCHAR2 (20);
        lv_tax_on_taxable_amt           VARCHAR2 (20);
        lv_tax_on_non_taxable_amt       VARCHAR2 (20);
        lv_tax_on_goods_total           VARCHAR2 (20);
        ln_freight_amt                  NUMBER;
        lv_freight_amt                  VARCHAR2 (20);
        lv_freight_taxable              VARCHAR2 (20);
        lv_freight_non_taxable          VARCHAR2 (20);
        lv_grand_total1_non_tax         VARCHAR2 (20);
        lv_grand_total1_tax             VARCHAR2 (20);
        lv_grand_total1_total           VARCHAR2 (20);
        lv_tax_on_taxable_freight       VARCHAR2 (20);
        lv_tax_on_non_taxable_freight   VARCHAR2 (20);
        lv_tax_on_freight_total         VARCHAR2 (20);
        lv_grand_total2_non_tax         VARCHAR2 (20);
        lv_grand_total2_tax             VARCHAR2 (20);
        lv_grand_total2_total           VARCHAR2 (20);
        lv_eu_non_eu                    VARCHAR2 (10);
        lv_eu_non_eu_ship_from          VARCHAR2 (10);
        lv_stmt_english                 VARCHAR2 (150);
        lv_stmt_dutch                   VARCHAR2 (150);
        lv_stmt_french                  VARCHAR2 (150);
        lv_stmt_german                  VARCHAR2 (150);
        lv_lang_code                    VARCHAR2 (10);
        emea_triangulation_tax_stmt     VARCHAR2 (150);
        lv_country_name                 VARCHAR2 (80);
        lv_ship_from_location           VARCHAR2 (240) := NULL;
        lv_ship_from_address1           VARCHAR2 (240) := NULL;
        lv_ship_from_address2           VARCHAR2 (240) := NULL;
        lv_ship_from_address3           VARCHAR2 (240) := NULL;
        lv_ship_from_city               VARCHAR2 (240) := NULL;
        lv_ship_from_zip                VARCHAR2 (240) := NULL;
        lv_ship_from_territory          VARCHAR2 (240) := NULL;

        --lv_tax_code                     VARCHAR2 (10);
        lv_tax_code                     VARCHAR2 (100); -- Added as per CCR0009402
        lv_y                            VARCHAR2 (10);
        lv_n                            VARCHAR2 (10);


        --Subtotal Variables
        --Sub Total Goods
        ln_st_g_t0                      NUMBER;
        ln_st_g_t1                      NUMBER;
        ln_st_g_t2                      NUMBER;
        ln_st_g_tot                     NUMBER;
        --Sub Total Services
        ln_st_s_t0                      NUMBER;
        ln_st_s_t1                      NUMBER;
        ln_st_s_t2                      NUMBER;
        ln_st_s_tot                     NUMBER;
        --Total of goods and services
        ln_gt_st_t0                     NUMBER;
        ln_gt_st_t1                     NUMBER;
        ln_gt_st_t2                     NUMBER;
        ln_gt_st_tot                    NUMBER;
        --Vat Goods
        ln_vat_g_t0                     NUMBER;
        ln_vat_g_t1                     NUMBER;
        ln_vat_g_t2                     NUMBER;
        ln_vat_g_tot                    NUMBER;
        --Vat Services
        ln_vat_s_t0                     NUMBER;
        ln_vat_s_t1                     NUMBER;
        ln_vat_s_t2                     NUMBER;
        ln_vat_s_tot                    NUMBER;
        --Vat Totals
        ln_gt_vat_t0                    NUMBER;
        ln_gt_vat_t1                    NUMBER;
        ln_gt_vat_t2                    NUMBER;
        ln_gt_vat_tot                   NUMBER;
        --Grand Total
        ln_gt_tot                       NUMBER;
        --Tax Rates
        lv_tax_rate_t0                  VARCHAR2 (150);
        lv_tax_rate_t1                  VARCHAR2 (150);
        lv_tax_rate_t2                  VARCHAR2 (150);
        lv_ship_from_country            VARCHAR2 (50);
        lv_manual_tax_stmt              VARCHAR2 (2000);
        lv_ship_from_address            VARCHAR2 (2000);
        lv_tax_ref1                     VARCHAR2 (240);
        lv_ship_from_ctry_name          VARCHAR2 (240);
        lv_ship_from_region             VARCHAR2 (30);
        l_tax_boolean                   BOOLEAN;    -- Added as per Change 3.0
        lv_ship_to_region               VARCHAR2 (100); -- Added as per Change 3.0
        lb_is_manual_trx                BOOLEAN;
        ln_nt_goods_amt                 NUMBER;
        ln_line_tax_rate                NUMBER;
        lv_vs_cnt                       NUMBER;
        lv_vs_boolean                   BOOLEAN;
        lv_ou_region                    VARCHAR2 (30);  --Added for CCR0007216
        lv_reverse_charge               VARCHAR2 (30);  --Added for CCR0007216
        lv_is_manual_trx                VARCHAR2 (1);

        --Added as per CCR0009103

        lv_tax_rate_new_t0              VARCHAR2 (100);
        lv_tax_rate_new_t1              VARCHAR2 (100);
        lv_tax_rate_new_t2              VARCHAR2 (100);
        lv_tax_rate_val_new_t0          VARCHAR2 (100);
        lv_tax_rate_val_new_t1          VARCHAR2 (100);
        lv_tax_rate_val_new_t2          VARCHAR2 (100);
        lv_tax_desc_t0                  VARCHAR2 (100);
        lv_tax_desc_t1                  VARCHAR2 (100);
        lv_tax_desc_t2                  VARCHAR2 (100);
        ln_emea_count                   NUMBER := 0;
        lv_tax_rate_des                 VARCHAR2 (500) := NULL;
        lv_tax_rate_code                VARCHAR2 (100) := NULL;
        lv_item_description             VARCHAR2 (500) := NULL;
        ln_reference_id                 NUMBER := NULL;
        ln_sold_to_org_id               NUMBER;
        ln_item_id                      NUMBER;
    -- End of Change

    BEGIN
        ld_trx_date_from        := fnd_date.canonical_to_date (p_trx_date_from);
        ld_trx_date_to          := fnd_date.canonical_to_date (p_trx_date_to);
        ld_creation_date_from   :=
            fnd_date.canonical_to_date (p_creation_date_from);
        ld_creation_date_to     :=
            fnd_date.canonical_to_date (p_creation_date_to);

        print_log ('Inside insert_billing_staging');

        --        print_log ('p_org_id                         :' || p_org_id);
        --        print_log ('p_trx_class                      :' || p_trx_class);
        --        print_log ('p_creation_date_from             :' || p_creation_date_from);
        --        print_log ('p_creation_date_to               :' || p_creation_date_to);
        --        print_log ('p_trx_date_from                  :' || p_trx_date_from);
        --        print_log ('p_trx_date_to                    :' || p_trx_date_to);
        --        print_log ('p_trx_num_from                   :' || p_trx_num_from);
        --        print_log ('p_trx_num_to                     :' || p_trx_num_to);
        --        print_log ('p_customer_id                    :' || p_customer_id);
        --        print_log ('p_reprocess_flag                 :' || p_reprocess_flag);

        FOR i
            IN c_hdr (p_org                => p_org_id,
                      p_trx_dt_from        => ld_trx_date_from,
                      p_trx_dt_to          => ld_trx_date_to,
                      p_trx_no_from        => p_trx_num_from,
                      p_trx_no_to          => p_trx_num_to,
                      p_creation_dt_from   => ld_creation_date_from,
                      p_creation_dt_to     => ld_creation_date_to,
                      p_cust_id            => p_customer_id,
                      p_trx_class1         => p_trx_class,
                      p_batch_source_id    => p_batch_source_id,
                      p_cust_trx_type_id   => p_cust_trx_type_id)
        LOOP
            --Resetting values to NULL
            lv_billing_phone                := NULL;
            lv_brand_phone                  := NULL;
            lv_to_email_address             := NULL;
            lv_print_or_email               := NULL;
            ld_disc_date                    := NULL;
            ld_due_date                     := NULL;
            lv_orig_trx_num                 := NULL;
            lv_from_email                   := NULL;
            lv_email_body                   := NULL;
            lv_email_subject                := NULL;
            lv_language                     := NULL;
            lv_ou_country                   := NULL;
            lv_legal_entity                 := NULL;
            ln_gst_rate                     := 0;
            ln_hst_rate                     := 0;
            ln_pst_rate                     := 0;
            ln_qst_rate                     := 0;
            lv_cpo_acc                      := NULL;
            lv_cpo_member                   := NULL;
            lv_tax_relate                   := NULL;
            lv_line_amt                     := NULL;
            lv_nt_tqty                      := NULL;
            lv_non_tax_amt                  := NULL;
            lv_non_tax_text                 := NULL;
            lv_c1                           := NULL;
            lv_t_tqty                       := NULL;
            lv_tax_amt                      := NULL;
            lv_tax_text                     := NULL;
            lv_c2                           := NULL;
            lv_other_amt                    := NULL;
            lv_tot_tax                      := NULL;
            lv_trate                        := NULL;
            lv_no_vat                       := NULL;
            lv_ou_region                    := NULL;    --Added for CCR0007216
            lv_reverse_charge               := NULL;

            lv_inco_term                    := NULL;
            lv_vat_rate_name                := NULL;
            lv_vat_rate                     := NULL;
            ln_total_qty                    := NULL;
            lv_total_amt                    := NULL;
            lv_tax_on_taxable_amt           := NULL;
            lv_tax_on_non_taxable_amt       := NULL;
            lv_tax_on_goods_total           := NULL;
            ln_freight_amt                  := NULL;
            lv_freight_amt                  := NULL;
            lv_freight_taxable              := NULL;
            lv_freight_non_taxable          := NULL;
            lv_grand_total1_non_tax         := NULL;
            lv_grand_total1_tax             := NULL;
            lv_grand_total1_total           := NULL;
            lv_tax_on_taxable_freight       := NULL;
            lv_tax_on_non_taxable_freight   := NULL;
            lv_tax_on_freight_total         := NULL;
            lv_grand_total2_non_tax         := NULL;
            lv_grand_total2_tax             := NULL;
            lv_grand_total2_total           := NULL;
            lv_eu_non_eu                    := NULL;
            lv_eu_non_eu_ship_from          := NULL;
            lv_stmt_english                 := NULL;
            lv_stmt_dutch                   := NULL;
            lv_stmt_french                  := NULL;
            lv_stmt_german                  := NULL;
            lv_lang_code                    := NULL;
            emea_triangulation_tax_stmt     := NULL;
            lv_manual_tax_stmt              := NULL;
            lv_country_name                 := NULL;
            lv_ship_from_location           := NULL;
            lv_ship_from_address1           := NULL;
            lv_ship_from_address2           := NULL;
            lv_ship_from_address3           := NULL;
            lv_ship_from_city               := NULL;
            lv_ship_from_zip                := NULL;
            lv_ship_from_territory          := NULL;
            lv_tax_ref1                     := NULL;
            lv_ship_from_region             := NULL;
            lv_ship_to_region               := NULL; --- Added as per Change 3.0
            l_tax_boolean                   := NULL; --- Added as per Change 3.0
            lv_ship_from_ctry_name          := NULL;
            lb_is_manual_trx                := FALSE;
            lv_is_manual_trx                := 'N';
            --Subtotal Variables
            --Sub Total Goods
            ln_st_g_t0                      := 0;
            ln_st_g_t1                      := 0;
            ln_st_g_t2                      := 0;
            ln_st_g_tot                     := 0;
            --Sub Total Services
            ln_st_s_t0                      := 0;
            ln_st_s_t1                      := 0;
            ln_st_s_t2                      := 0;
            ln_st_s_tot                     := 0;
            ln_gt_st_t0                     := 0;
            ln_gt_st_t1                     := 0;
            ln_gt_st_t2                     := 0;
            ln_gt_st_tot                    := 0;
            ln_vat_g_t0                     := 0;
            ln_vat_g_t1                     := 0;
            ln_vat_g_t2                     := 0;
            ln_vat_g_tot                    := 0;
            ln_vat_s_t0                     := 0;
            ln_vat_s_t1                     := 0;
            ln_vat_s_t2                     := 0;
            ln_vat_s_tot                    := 0;
            ln_gt_vat_t0                    := 0;
            ln_gt_vat_t1                    := 0;
            ln_gt_vat_t2                    := 0;
            ln_gt_vat_tot                   := 0;
            ln_gt_tot                       := 0;

            lv_tax_rate_t0                  := NULL;
            lv_tax_rate_t1                  := NULL;
            lv_tax_rate_t2                  := NULL;

            -- Added as per CCR0009103

            lv_tax_desc_t0                  := NULL;
            lv_tax_desc_t1                  := NULL;
            lv_tax_desc_t2                  := NULL;
            lv_tax_rate_code                := NULL;
            lv_tax_rate_des                 := NULL;
            lv_tax_rate_val_new_t0          := NULL;
            lv_tax_rate_val_new_t1          := NULL;
            lv_tax_rate_val_new_t2          := NULL;

            -- End of Change CCR0009103

            print_log ('Header LOOP - ' || TO_CHAR (i.customer_trx_id));
            /*B2B Phase 2 EMEA Changes (CCR0007216 ) */
                                                                       --Start
            lv_ou_region                    :=
                get_ou_region (p_org_id => i.org_id);

            get_billing_ship_from (
                p_customer_trx_id       => i.customer_trx_id,
                p_trx_type              => i.trx_class_code,
                x_ship_from_country     => lv_ship_from_country,
                x_ship_from_ctry_name   => lv_ship_from_ctry_name,
                x_tax_statement         => lv_manual_tax_stmt);

            --Get Ship FROM Country Region
            get_eu_non_eu (p_country_code   => lv_ship_from_ctry_name,
                           x_eu_non_eu      => lv_ship_from_region);

            --- Added for Change 3.0

            get_eu_non_eu (p_country_code   => i.ship_country_name,
                           x_eu_non_eu      => lv_ship_to_region);

            --- End of Change 3.0

            --            print_log ('Ship From Country '       || lv_ship_from_country|| CHR(9)||
            --                       'Ship From Country Name ' || lv_ship_from_ctry_name|| CHR(9)||
            --                       'Ship to Country Name '   || i.ship_country_name|| CHR(9)||
            --                       'Ship to Country Region ' || lv_ship_to_region);


            lb_is_manual_trx                :=
                is_manual_trx (p_customer_trx_id => i.customer_trx_id);

            IF lb_is_manual_trx
            THEN
                lv_is_manual_trx   := 'Y';
            ELSE
                lv_is_manual_trx   := 'N';
            END IF;

            ----
            lv_tax_rate_t0                  := 0;
            lv_tax_rate_t1                  :=
                get_stdtax_rate (p_org_id     => i.org_id,
                                 p_trx_date   => i.trx_date);
            lv_tax_rate_t2                  := 0;


            ----
            /*B2B Phase 2 EMEA Changes (CCR0007216 ) */
                                                                         --End


            FOR j IN c_lin (i.customer_trx_id)
            LOOP
                --Resetting Variables
                ln_gst_amt            := 0;
                ln_hst_amt            := 0;
                ln_pst_amt            := 0;
                ln_qst_amt            := 0;

                ln_qty_sum            := NULL;
                ln_line_amt           := NULL;
                ln_unit_price         := NULL;
                ln_unit_price_list    := NULL;
                ln_disc_percent       := NULL;
                lv_tax_yn             := NULL;
                ln_nt_goods_amt       := 0;
                ln_line_tax_rate      := 0;
                --------------------------------------------------
                /*B2B Phase 2 EMEA Changes (CCR0007216 ) - start*/
                ---------------------------------------------------
                lv_tax_code           := NULL;
                lv_y                  := NULL;
                lv_n                  := NULL;
                lv_vs_cnt             := 0;
                lv_vs_boolean         := NULL;

                IF lb_is_manual_trx
                THEN
                    lv_ship_from_region   := NULL;
                --print_log('lv_ship_from_region:'||lv_ship_from_region);
                END IF;


                -- Start of Change 4.0

                IF lb_is_manual_trx
                THEN
                    lv_ship_from_region   := NULL;
                --print_log('lv_ship_from_region:'||lv_ship_from_region);
                END IF;

                IF lv_ship_from_region = 'Non-EU'
                THEN
                    ln_nt_goods_amt   :=
                        get_nontax_goods_amt (
                            p_customer_trx_line_id => j.customer_trx_line_id);
                --print_log('ln_nt_goods_amt:'||ln_nt_goods_amt);
                END IF;

                ln_line_tax_rate      :=
                    get_line_tax_rate (
                        p_org_id                 => i.org_id,
                        p_customer_trx_id        => i.customer_trx_id,
                        p_customer_trx_line_id   => j.customer_trx_line_id);

                IF NVL (ln_line_tax_rate, 0) = 0
                THEN
                    lv_tax_code   := 'T0';
                ELSE
                    lv_tax_code   := 'T1';
                END IF;

                IF ln_nt_goods_amt <> 0
                THEN
                    lv_tax_code   := 'T2';
                END IF;

                /*

                lv_vs_boolean := check_VS_active (pv_ff_name            => 'FND_FLEX_VALUES'
                                                 ,pv_flex_context_code  => 'XXD_B2B_TAX_CODES_VS'
                                                 ,x_count               => lv_vs_cnt);


                IF lv_vs_boolean = FALSE AND (lv_vs_cnt = 0 OR lv_vs_cnt > 1)
                THEN



                    IF lv_ship_from_region = 'Non-EU'
                    THEN
                        ln_nt_goods_amt := get_nontax_goods_amt (p_customer_trx_line_id => j.customer_trx_line_id);
                        --print_log('ln_nt_goods_amt:'||ln_nt_goods_amt);
                    END IF;

                    ln_line_tax_rate := get_line_tax_rate (p_org_id                => i.org_id
                                                          ,p_customer_trx_id       => i.customer_trx_id
                                                          ,p_customer_trx_line_id  => j.customer_trx_line_id);
                    IF NVL(ln_line_tax_rate,0) = 0
                    THEN
                        lv_tax_code := 'T0';
                    ELSE
                        lv_tax_code := 'T1';
                    END IF;

                    IF ln_nt_goods_amt <> 0
                    THEN
                        lv_tax_code := 'T2';
                    END IF;

                ELSIF lv_vs_boolean = TRUE AND lv_vs_cnt =1
                THEN

                --- Added for Change 3.0

                    ln_line_tax_rate := get_line_tax_rate (p_org_id                => i.org_id
                                                          ,p_customer_trx_id       => i.customer_trx_id
                                                          ,p_customer_trx_line_id  => j.customer_trx_line_id);

                    IF ln_line_tax_rate IS NULL
                    THEN
                        lv_tax_code := NULL;
                        --print_log ('Entered 1 ');
                    ELSIF ln_line_tax_rate IS NOT NULL AND (i.ship_country_name IS NOT NULL OR lv_ship_from_ctry_name IS NOT NULL)
                    THEN
                        l_tax_boolean := NULL;
                        l_tax_boolean := get_tax_codes  (pv_org_id      => i.org_id
                                                        ,pv_tax_rate    => ln_line_tax_rate
                                                        ,pv_ship_to     => i.ship_country_name
                                                        ,pv_ship_to_reg => lv_ship_to_region
                                                        ,pv_ship_from   => lv_ship_from_ctry_name
                                                        ,x_tax_code     => lv_tax_code);
                       -- print_log ('Entered 2 and Tax rate is : '||ln_line_tax_rate||CHR(9)|| 'and Tax Code is '||lv_tax_code);
                    ELSIF ln_line_tax_rate IS NOT NULL AND i.ship_country_name IS NULL AND lv_ship_from_ctry_name IS NULL
                    THEN
                        IF NVL(ln_line_tax_rate,0) = 0
                            THEN
                            lv_tax_code := 'T0';
                        ELSE
                            lv_tax_code := 'T1';
                        END IF;
                       -- print_log ('Entered 3 and Tax Code is '||lv_tax_code||CHR(9)||'Tax rate is : '||ln_line_tax_rate);
                    END IF;
                END IF;    */
                --- End of Change 3.0

                --- End of Change 4.0

                /*
                IF j.tax_recoverable IS NULL
                THEN
                    lv_y := 'T0';
                ELSE
                    lv_y := 'T1';
                END IF;

                print_log('lv_y:'||lv_y);

                --IF zero qty
                IF j.qty_total_dsp = 0 AND j.ext_amt_dsp = 0 AND j.avg_unit_price_dsp = 0 AND j.unit_selling_price = 0
                THEN
                    IF NVL(j.tax_recoverable,0) = 0
                    THEN
                        lv_y := NULL;
                    END IF;
                END IF;
                print_log('lv_y:'||lv_y);
                /*IF j.tax_recoverable = 0
                THEN
                    lv_n := 'T1';
                ELSE
                    lv_n := NULL;
                END IF;*/
                /*
                IF j.qty_total_dsp <> 0
                THEN
                    lv_n := 'T1';
                    lv_y := NULL;
                ELSE
                    lv_n := NULL;
                END IF;
                print_log('lv_n:'||lv_n);
                IF ln_nt_goods_amt <> 0
                THEN
                    lv_n := 'T2';
                    lv_y := NULL;
                ELSE
                    lv_n := NULL;
                END IF;
                print_log('lv_n:'||lv_n);

                --IF zero qty
                IF j.qty_total_dsp = 0 AND j.ext_amt_dsp = 0 AND j.avg_unit_price_dsp = 0 AND j.unit_selling_price = 0
                THEN
                    IF NVL(j.tax_recoverable,0) = 0
                    THEN
                        lv_n := 'T1';
                        lv_y := NULL;
                    ELSE
                        lv_n := NULL;
                    END IF;
                END IF;
                print_log('lv_n:'||lv_n);
                --IF non-zero qty
                IF j.qty_total_dsp <> 0 AND j.ext_amt_dsp = 0 AND j.avg_unit_price_dsp = 0 AND j.unit_selling_price = 0
                THEN
                    lv_n := 'T1';
                    lv_y := NULL;
                END IF;
                print_log('lv_n:'||lv_n);
                lv_tax_code := NVL(lv_y,lv_n);
                print_log('lv_tax_code:'||lv_tax_code);
                */
                IF UPPER (lv_ou_region) = 'NA'
                THEN
                    lv_tax_code   := NULL;
                END IF;

                ------------------------------------------------
                /*B2B Phase 2 EMEA Changes (CCR0007216 ) - end*/
                ------------------------------------------------

                lv_item_code          := NULL;
                lv_origin_country     := NULL;



                --print_log('LINE LOOP - ' || TO_CHAR(j.customer_trx_line_id));
                IF UPPER (lv_ou_region) = 'NA' --Added if condition for CCR0007216
                THEN
                    --If Canada Get Local GST tax
                    get_canada_tax (p_trx_id => j.customer_trx_id, p_inv_item_id => j.inventory_item_id, p_int_lin_att6 => j.interface_line_attribute6, p_tax_type => 'GST', p_desc => j.line_description, x_tax_amt => ln_gst_amt
                                    , x_tax_rate => ln_gst_rate);

                    --If Canada Get Local HST tax
                    get_canada_tax (p_trx_id => j.customer_trx_id, p_inv_item_id => j.inventory_item_id, p_int_lin_att6 => j.interface_line_attribute6, p_tax_type => 'HST', p_desc => j.line_description, x_tax_amt => ln_hst_amt
                                    , x_tax_rate => ln_hst_rate);

                    --If Canada Get Local PST tax
                    get_canada_tax (p_trx_id => j.customer_trx_id, p_inv_item_id => j.inventory_item_id, p_int_lin_att6 => j.interface_line_attribute6, p_tax_type => 'PST', p_desc => j.line_description, x_tax_amt => ln_pst_amt
                                    , x_tax_rate => ln_pst_rate);

                    --If Canada Get Local QST tax
                    get_canada_tax (p_trx_id => j.customer_trx_id, p_inv_item_id => j.inventory_item_id, p_int_lin_att6 => j.interface_line_attribute6, p_tax_type => 'QST', p_desc => j.line_description, x_tax_amt => ln_qst_amt
                                    , x_tax_rate => ln_qst_rate);
                END IF;


                -- Start of changes for CCR0009103

                ln_emea_count         := 0;
                lv_item_description   := NULL;
                ln_reference_id       := NULL;
                ln_sold_to_org_id     := NULL;
                ln_item_id            := NULL;

                BEGIN
                    SELECT COUNT (*)
                      INTO ln_emea_count
                      FROM fnd_flex_value_sets fls, fnd_flex_values_vl flv, hr_operating_units hou
                     WHERE     fls.flex_value_set_name = 'XXD_MTD_OU_VS'
                           AND fls.flex_value_set_id = flv.flex_value_set_id
                           AND flv.enabled_flag = 'Y'
                           AND TRUNC (SYSDATE) BETWEEN NVL (
                                                           flv.start_date_active,
                                                           TRUNC (SYSDATE))
                                                   AND NVL (
                                                           flv.end_date_active,
                                                           TRUNC (SYSDATE))
                           AND hou.NAME = flv.description
                           AND hou.organization_id = i.org_id;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        ln_emea_count   := 0;
                END;

                print_log ('Value of EMEA count is - ' || ln_emea_count);

                IF ln_emea_count > 0
                THEN
                    lv_tax_code        := NULL;
                    lv_tax_rate_des    := NULL;
                    lv_tax_rate_code   := NULL;

                    get_line_tax_rate_det (i.org_id,
                                           i.customer_trx_id,
                                           j.customer_trx_line_id,
                                           lv_tax_code,
                                           lv_tax_rate_des,
                                           lv_tax_rate_code);

                    --                   print_log(
                    --                         'Tax Code - '
                    --                      || lv_tax_code
                    --                      || ' and Desc - '
                    --                      || lv_tax_rate_des
                    --                      || ' and Tax Rate Code - '
                    --                      || lv_tax_rate_code);

                    BEGIN
                        SELECT description
                          INTO lv_item_description
                          FROM mtl_system_items_b
                         WHERE     segment1 LIKE
                                          j.item_style
                                       || '-'
                                       || j.item_color
                                       || '%'
                               AND ROWNUM = 1;
                    EXCEPTION
                        WHEN OTHERS
                        THEN
                            lv_item_description   := NULL;
                    END;

                    IF lv_item_description = 'FREIGHT AND ADMIN CHARGES'
                    THEN
                        lv_item_description   := lv_item_description;
                    ELSE
                        lv_item_description   := NULL;
                    END IF;

                    IF i.trx_class_code IN ('CM', 'DM')
                    THEN
                        ln_reference_id   := NULL;

                        -- Start of Change as per CCR0009859 starts
                        IF i.trx_attribute6 IS NOT NULL
                        THEN
                            ln_reference_id   := i.trx_attribute6;
                        ELSIF i.trx_attribute6 IS NULL
                        THEN
                            BEGIN
                                SELECT DISTINCT sl.user_element_attribute5
                                  INTO ln_reference_id
                                  FROM sabrix_line sl
                                 WHERE     sl.user_element_attribute5
                                               IS NOT NULL
                                       AND sl.batch_id =
                                           (SELECT MAX (si.batch_id)
                                              FROM sabrix_invoice si
                                             WHERE     si.user_element_attribute41 =
                                                       i.customer_trx_id
                                                   AND si.user_element_attribute45 =
                                                       i.org_id);
                            EXCEPTION
                                WHEN OTHERS
                                THEN
                                    ln_reference_id   := NULL;
                            END;
                        END IF;
                    END IF;

                    -- End of Change as per CCR0009859

                    --                      print_log(
                    --                         'p_trx_type'||' => '|| i.trx_class_code||'p_batch_name'||' => '||i.trx_source_type||'pn_ship_site_use_id'||' => '|| i.ship_to_site_use_id||
                    --                         'pn_bill_to_cust_id'||' => '||i.bill_to_customer_id||'pn_bill_site_use_id'||' => '||i.bill_to_site_use_id
                    --                         ||'pv_brand'||' => '||i.brand
                    --                         ||'pn_org_id'||' => '||i.org_id
                    --                         ||'pn_warehouse_id'||' => '||j.warehouse_id
                    --                         ||'pv_claim_number'||' => '||j.interface_line_attribute1
                    --                            ||'pv_line_context'||' => '||j.interface_line_context);

                    IF ln_reference_id IS NULL
                    THEN
                        ln_reference_id   :=
                            get_ref_num (
                                p_trx_type            => i.trx_class_code,
                                p_batch_name          => i.trx_source_type,
                                pn_ship_site_use_id   => i.ship_to_site_use_id,
                                pn_bill_to_cust_id    => i.bill_to_customer_id,
                                pn_bill_site_use_id   => i.bill_to_site_use_id,
                                pv_brand              => i.brand,
                                pn_org_id             => i.org_id,
                                pn_warehouse_id       => j.warehouse_id,
                                pv_claim_number       =>
                                    j.interface_line_attribute1,
                                pv_line_context       =>
                                    j.interface_line_context, -- Added for CCR0009402
                                pn_inv_item_id        => j.inventory_item_id -- Added as per CCR0009859
                                                                            );
                    END IF;

                    print_log (
                        'ln_reference_id fetched is - ' || ln_reference_id);
                END IF;

                -- End of Change CCR0009103

                --Get Line Data
                get_line_data (p_style => j.item_style1, p_color => j.item_color1, p_size => j.item_size, p_cust_trx_id => j.customer_trx_id, p_tax_rec => j.tax_recoverable, --p_cust_trx_line_id  => j.customer_trx_line_id,
                                                                                                                                                                              p_inventory_item_id => j.inventory_item_id, p_int_line_att6 => j.interface_line_attribute6, x_qty_sum => ln_qty_sum, x_line_amt => ln_line_amt, x_unit_price => ln_unit_price, x_unit_price_list => ln_unit_price_list, x_disc_percent => ln_disc_percent
                               , x_tax_yn => lv_tax_yn);

                --Get HTC Code, Country of Origin
                get_hcode (p_style => j.item_style, p_language => NULL, x_hcode => lv_item_code
                           , x_origin => lv_origin_country);

                --Insert into line stg
                BEGIN
                    INSERT INTO xxdo.xxdoar_b2b_billing_lin_stg (
                                    concurrent_request_id,
                                    customer_trx_id,
                                    customer_trx_line_id,
                                    line_description,
                                    item_style,
                                    item_color,
                                    style_description,
                                    color_description,
                                    item_code,
                                    country_of_origin,
                                    item_size,
                                    quantity,
                                    price,
                                    discount_percent,
                                    line_amount,
                                    selling_price,
                                    tax_amount,
                                    tax_code,
                                    --state_tax                 ,
                                    --parish_tax                ,
                                    --county_tax                ,
                                    --transit_district_tax      ,
                                    --district_tax              ,
                                    --city_tax                  ,
                                    --us_sales_tax_101          ,
                                    --special_purpose_dist_tax  ,
                                    --territory_tax             ,
                                    --country_tax               ,
                                    gst_amount,
                                    hst_amount,
                                    qst_amount,
                                    pst_amount,
                                    tax_exempt_line_amt,
                                    non_tax_ext_line_amt,
                                    line_placeholder1,
                                    line_placeholder2,
                                    line_placeholder3,
                                    line_placeholder4,
                                    line_placeholder5)
                         VALUES (gn_conc_request_id, --j.concurrent_request_id     ,
                                                     i.customer_trx_id, --j.customer_trx_id           ,
                                                                        j.customer_trx_line_id, --j.customer_trx_line_id      ,
                                                                                                remove_junk (j.line_description), --j.line_description      ,
                                                                                                                                  remove_junk (j.item_style), --j.item_style                ,
                                                                                                                                                              remove_junk (j.item_color), --j.item_color                ,
                                                                                                                                                                                          remove_junk (j.style_desc), --j.style_description         ,
                                                                                                                                                                                                                      remove_junk (j.color_desc), --j.color_description         ,
                                                                                                                                                                                                                                                  remove_junk (lv_item_code), --item_code                 ,
                                                                                                                                                                                                                                                                              remove_junk (lv_origin_country), --country_of_origin         ,
                                                                                                                                                                                                                                                                                                               j.item_size, --j.item_size                 ,
                                                                                                                                                                                                                                                                                                                            j.qty_total_dsp, --j.quantity                  ,
                                                                                                                                                                                                                                                                                                                                             j.avg_unit_price_dsp, --j.price                     ,
                                                                                                                                                                                                                                                                                                                                                                   ln_disc_percent, --j.discount_percent          ,
                                                                                                                                                                                                                                                                                                                                                                                    NVL (ln_line_amt, j.ext_amt_dsp), --j.line_amount               ,
                                                                                                                                                                                                                                                                                                                                                                                                                      NVL (ln_unit_price_list, j.unit_selling_price), --NULL, --selling_price             ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      NULL, --tax_amount                ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            --NULL,  --j.tax_code                  , --Commented for CCR0007216
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            lv_tax_code, --j.tax_code             , --Added for CCR0007216
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         --NULL, --j.state_tax                 ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         --NULL, --j.parish_tax                ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         --NULL, --j.county_tax                ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         --NULL, --j.transit_district_tax      ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         --NULL, --j.district_tax              ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         --NULL, --j.city_tax                  ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         --NULL, --j.us_sales_tax_101          ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         --NULL, --j.special_purpose_dist_tax  ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         --NULL, --j.territory_tax             ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         --NULL, --j.country_tax               ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ln_gst_amt, --j.gst_amount                ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ln_hst_amt, --j.hst_amount                ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ln_qst_amt, --j.qst_amount                ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ln_pst_amt, --j.pst_amount                ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         NULL, --j.tax_exempt_line_amt       ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               NULL, --j.non_tax_ext_line_amt      ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     lv_tax_rate_des, --NULL,  --j.line_placeholder1   -- Changed as per CCR0009103       ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ln_reference_id, --NULL,  --j.line_placeholder2   -- Changed as per CCR0009103       ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       lv_tax_rate_code
                                 , --NULL --j.line_placeholder3 -- Changed as per CCR0009103  ,
                                   NULL,       --j.line_placeholder4         ,
                                         NULL        --, --j.line_placeholder5
                                             );
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        print_log ('Inside LINE LOOP :exception:' || SQLERRM);
                END;
            END LOOP;                                              --Line Loop

            --Get Billing Phone
            IF lv_ou_region = 'NA'         --Added if condition for CCR0007216
            THEN
                lv_billing_phone   :=
                    NVL (i.remit_contact_number, get_billing_phone (i.brand));

                --print_log('Inside insert_billing_staging - HEADER LOOP 1');
                --Get Brand Phone
                lv_brand_phone   := get_brand_num (i.brand);
            END IF;

            --print_log('Inside insert_billing_staging - HEADER LOOP 2');
            --Get to email address
            lv_to_email_address             :=
                get_to_email_address (
                    p_customer_id    => i.bill_to_customer_id,
                    p_brand          => i.brand,
                    p_ship_country   => i.ship_country,
                    p_org_id         => i.org_id,
                    p_trx_class      => i.trx_class_code,
                    p_bill_site_id   => i.bill_to_site_use_id -- Added as per change 3.2
                                                             );
            --print_log('Inside insert_billing_staging - HEADER LOOP 3');

            --Get Print or Email
            lv_print_or_email               :=
                get_print_or_email (
                    p_trx_class_code        => i.trx_class_code,
                    p_trx_source_type       => i.trx_source_type,
                    p_bill_to_site_use_id   => i.bill_to_site_use_id);

            --print_log('Inside insert_billing_staging - HEADER LOOP 4');
            --Get Original Transaction Number
            IF i.rel_customer_trx_id IS NOT NULL
            THEN
                lv_orig_trx_num   :=
                    get_original_trx_num (i.rel_customer_trx_id);
            END IF;

            --print_log('Inside insert_billing_staging - HEADER LOOP 5');

            --Get discount date, due date
            get_disc_date (p_term_id     => i.term_id,
                           p_trx_date    => i.trx_date,
                           p_due_date    => i.due_date,
                           p_ou_region   => lv_ou_region,
                           x_disc_date   => ld_disc_date,
                           x_due_date    => ld_due_date);

            --print_log('Inside insert_billing_staging - HEADER LOOP 6');

            --Get Email Subject, From Email, Language, OU Name, Email Body
            get_lang_email_data (p_org_id => i.org_id, p_ship_country => i.ship_country, p_brand => i.brand, x_from_email => lv_from_email, x_email_body => lv_email_body, x_email_subject => lv_email_subject
                                 , x_language => lv_language);

            --print_log('Inside insert_billing_staging - HEADER LOOP 7');

            --Get Sold by Legal Entity, Ship from country
            get_country_le (p_org_id       => i.org_id,
                            x_le_name      => lv_legal_entity,
                            x_ou_country   => lv_ou_country);

            /*+Changes for CCR0007216 - HDR95 = NULL for EMEA - Start+*/

            IF lv_ou_region = 'EMEA'
            THEN
                lv_legal_entity     := i.dff_customer_reference;
                lv_reverse_charge   := i.dff_customer_reason;
            END IF;

            /*+Changes for CCR0007216 - HDR95 = NULL for EMEA - Start+*/

            --print_log('Inside insert_billing_staging - HEADER LOOP 8');
            /*Commented for CCR0007216 --Start
            --Get EMEA Header Data
            get_emea_hdr_data(
                              p_term_id               => i.term_id,
                              p_bill_to_customer_id   => i.bill_to_customer_id,
                              x_cpo_acc               => lv_cpo_acc,
                              x_cpo_member            => lv_cpo_member,
                              x_tax_relate            => lv_tax_relate
                             );
            Commented for CCR0007216*/
            --End
            get_emea_hdr_data (
                p_bill_to_customer_id   => i.bill_to_customer_id,
                p_bill_to_site_use_id   => i.bill_to_site_use_id,
                p_ship_to_customer_id   => i.ship_to_customer_id,
                p_ship_to_site_use_id   => i.ship_to_site_use_id,
                x_cpo_acc               => lv_cpo_acc,
                x_cpo_member            => lv_cpo_member,
                x_tax_relate            => lv_tax_relate,
                x_tax_ref               => lv_tax_ref1);

            --print_log('Inside insert_billing_staging - HEADER LOOP 9');

            --Get EMEA Footer Data
            emea_line_type_amt (
                p_customer_trx_id      => i.customer_trx_id,
                p_org_id               => i.org_id,
                p_invoice_currency     => i.invoice_currency_code,
                p_lang_code            => lv_language,
                x_line_amt             => lv_line_amt,
                x_nt_tqty              => lv_nt_tqty,
                x_non_tax_amt          => lv_non_tax_amt,
                x_non_tax_text         => lv_non_tax_text,
                x_c1                   => lv_c1,
                x_t_tqty               => lv_t_tqty,
                x_tax_amt              => lv_tax_amt,
                x_tax_text             => lv_tax_text,
                x_c2                   => lv_c2,
                x_other_amt            => lv_other_amt,
                x_tot_tax              => lv_tot_tax,
                x_trate                => lv_trate,
                x_no_vat               => lv_no_vat,
                x_tax_on_taxable_amt   => lv_tax_on_taxable_amt --Added by Kranthi
                                                               );

            --EMEA Triangulation - START

            /* --Commented for CCR0007216 --Start
            --Get Ship From Country Details
            get_ship_from_details(
                                  p_customer_trx_id     => i.customer_trx_id
                                 ,p_ship_from_country   => lv_ship_from_country
                                 ,p_ship_from_address   => lv_ship_from_address
                                 );
            */
            --Commented for CCR0007216 --End

            --Get Ship_to Country Region
            get_eu_non_eu (p_country_code   => i.ship_country_name,
                           x_eu_non_eu      => lv_eu_non_eu);



            lv_country_name                 :=
                get_country_name (lv_ou_country); -----lv_ou_country is ship_from_country
            --Get footer Notes(EMEA) - FTR --Added by Kranthi
            /*--B2B Phase 2 EMEA Changes (CCR0007216 ) --Start*/
            /*
            get_emea_footer
                            (
                             p_org_id               =>  i.org_id
                            ,p_ship_to_country_reg  =>  lv_eu_non_eu
                            ,p_ship_to_country      =>  i.ship_country_name
                            ,p_ship_from_country    =>  NVL(lv_ship_from_ctry_name, lv_country_name) --Modified for CCR0007216
                            ,x_stmt_english         =>  lv_stmt_english
                            ,x_stmt_dutch           =>  lv_stmt_dutch
                            ,x_stmt_french          =>  lv_stmt_french
                            ,x_stmt_german          =>  lv_stmt_german
--                            ,x_ret_code             =>  lv_ret_code
--                            ,x_ret_message          =>  lv_ret_message
                            );
            */

            get_emea_footer2 (p_org_id => i.org_id, p_customer_trx_id => i.customer_trx_id, p_ship_to_country_reg => lv_eu_non_eu, p_ship_to_country => i.ship_country_name, p_ship_from_country => NVL (lv_ship_from_ctry_name, lv_country_name) --Modified for CCR0007216
                                                                                                                                                                                                                                                 , p_is_manual_trx => lv_is_manual_trx
                              , x_stmt_english => lv_stmt_english);
            /*
            --Get EMEA Language Code
            emea_lang_code(
                           p_org_id                =>   i.org_id
                          ,p_bill_to_customer_id   =>   i.bill_to_customer_id
                          ,p_bill_to_site_use_id   =>   i.bill_to_site_use_id
                          ,p_language              =>   lv_language
                          ,x_lang_code             =>   lv_lang_code
                          );
            IF lv_lang_code = 'EN'
            THEN
                emea_triangulation_tax_stmt := lv_stmt_english;
            ELSIF lv_lang_code = 'DU'
            THEN
                emea_triangulation_tax_stmt := lv_stmt_dutch;
            ELSIF lv_lang_code = 'FR'
            THEN
                emea_triangulation_tax_stmt := lv_stmt_french;
            ELSIF lv_lang_code = 'DE'
            THEN
                emea_triangulation_tax_stmt := lv_stmt_german;
            END IF;*/
            ----
            ----
            emea_triangulation_tax_stmt     := lv_stmt_english;
            --Added for CCR0007216
            get_emea_billing_lang (p_customer_id => i.bill_to_customer_id, p_bill_to_site_use_id => i.bill_to_site_use_id, p_org_id => i.org_id
                                   , x_lang_code => lv_language);

            --B2B Phase 2 EMEA Changes (CCR0007216 ) --End

            --Get Inco Term(EMEA) - HDR --Added by Kranthi
            lv_inco_term                    :=
                get_inco_term (i.operating_unit);
            --
            --            --Get EMEA VAT Details - FTR --Added by Kranthi
            get_emea_vat_details (p_customer_trx_id   => i.customer_trx_id,
                                  p_org_id            => i.org_id,
                                  x_vat_rate_name     => lv_vat_rate_name--                                ,x_vat_rate             =>  lv_vat_rate
                                                                         );
            --            --total_quantity
            ln_total_qty                    :=
                  TO_NUMBER (NVL (lv_nt_tqty, 0))
                + TO_NUMBER (NVL (lv_t_tqty, 0));           --Added by Kranthi

            IF lv_ou_region = 'EMEA'
            THEN
                --print_log ('lv_ship_from_region='||lv_ship_from_region);
                --print_log ('lv_eu_non_eu='||lv_eu_non_eu);

                -- Start of Change for CCR0009103

                /*get_sub_totals(
                               p_customer_trx_id    =>  i.customer_trx_id
                              --,p_eu_non_eu          =>  lv_ship_from_region--lv_eu_non_eu Commented as per defect 513
                              ,p_eu_non_eu          =>  lv_ship_to_region
                              ,p_is_manual_trx      =>  lv_is_manual_trx
                              ,x_st_g_t0            =>  ln_st_g_t0
                              ,x_st_g_t1            =>  ln_st_g_t1
                              ,x_st_g_t2            =>  ln_st_g_t2
                              ,x_st_g_tot           =>  ln_st_g_tot
                              ,x_st_s_t0            =>  ln_st_s_t0
                              ,x_st_s_t1            =>  ln_st_s_t1
                              ,x_st_s_t2            =>  ln_st_s_t2
                              ,x_st_s_tot           =>  ln_st_s_tot
                              ,x_gt_st_t0           =>  ln_gt_st_t0
                              ,x_gt_st_t1           =>  ln_gt_st_t1
                              ,x_gt_st_t2           =>  ln_gt_st_t2
                              ,x_gt_st_tot          =>  ln_gt_st_tot
                              ,x_vat_g_t0           =>  ln_vat_g_t0
                              ,x_vat_g_t1           =>  ln_vat_g_t1
                              ,x_vat_g_t2           =>  ln_vat_g_t2
                              ,x_vat_g_tot          =>  ln_vat_g_tot
                              ,x_vat_s_t0           =>  ln_vat_s_t0
                              ,x_vat_s_t1           =>  ln_vat_s_t1
                              ,x_vat_s_t2           =>  ln_vat_s_t2
                              ,x_vat_s_tot          =>  ln_vat_s_tot
                              ,x_gt_vat_t0          =>  ln_gt_vat_t0
                              ,x_gt_vat_t1          =>  ln_gt_vat_t1
                              ,x_gt_vat_t2          =>  ln_gt_vat_t2
                              ,x_gt_vat_tot         =>  ln_gt_vat_tot
                              ,x_gt_tot             =>  ln_gt_tot
                              ); */

                get_sub_totals_prc (
                    p_customer_trx_id   => i.customer_trx_id, --,p_eu_non_eu          =>  lv_ship_from_region--lv_eu_non_eu Commented as per defect 513
                    p_eu_non_eu         => lv_ship_to_region,
                    p_is_manual_trx     => lv_is_manual_trx,
                    x_st_g_t0           => ln_st_g_t0,
                    x_st_g_t1           => ln_st_g_t1,
                    x_st_g_t2           => ln_st_g_t2,
                    x_st_g_tot          => ln_st_g_tot,
                    x_st_s_t0           => ln_st_s_t0,
                    x_st_s_t1           => ln_st_s_t1,
                    x_st_s_t2           => ln_st_s_t2,
                    x_st_s_tot          => ln_st_s_tot,
                    x_gt_st_t0          => ln_gt_st_t0,
                    x_gt_st_t1          => ln_gt_st_t1,
                    x_gt_st_t2          => ln_gt_st_t2,
                    x_gt_st_tot         => ln_gt_st_tot,
                    x_vat_g_t0          => ln_vat_g_t0,
                    x_vat_g_t1          => ln_vat_g_t1,
                    x_vat_g_t2          => ln_vat_g_t2,
                    x_vat_g_tot         => ln_vat_g_tot,
                    x_vat_s_t0          => ln_vat_s_t0,
                    x_vat_s_t1          => ln_vat_s_t1,
                    x_vat_s_t2          => ln_vat_s_t2,
                    x_vat_s_tot         => ln_vat_s_tot,
                    x_gt_vat_t0         => ln_gt_vat_t0,
                    x_gt_vat_t1         => ln_gt_vat_t1,
                    x_gt_vat_t2         => ln_gt_vat_t2,
                    x_gt_vat_tot        => ln_gt_vat_tot,
                    x_gt_tot            => ln_gt_tot,
                    x_tax_rate_t0       => lv_tax_rate_new_t0,
                    x_tax_rate_t1       => lv_tax_rate_new_t1,
                    x_tax_rate_t2       => lv_tax_rate_new_t2,
                    x_tax_desc_t0       => lv_tax_desc_t0,
                    x_tax_desc_t1       => lv_tax_desc_t1,
                    x_tax_desc_t2       => lv_tax_desc_t2,
                    x_tax_rate_val_t0   => lv_tax_rate_val_new_t0,
                    x_tax_rate_val_t1   => lv_tax_rate_val_new_t1,
                    x_tax_rate_val_t2   => lv_tax_rate_val_new_t2);
            -- End of Change for CCR0009103

            END IF;

            /*B2B Phase 2 EMEA Changes (CCR0007216 ) -- Start
            lv_tax_rate_t0 := '0%';
            lv_tax_rate_t1 := lv_trate||' for '||i.operating_unit;
            lv_tax_rate_t2 := 'Not applicable (0%)';
            --B2B Phase 2 EMEA Changes (CCR0007216 ) -- End */
            ----            ----subtotal_goods_total
            --            lv_total_amt := TO_NUMBER(NVL(lv_non_tax_amt, '0.00'), '999G999G990D00') + TO_NUMBER(NVL(lv_tax_amt, '0.00'), '999G999G990D00'); --Added by Kranthi
            --
            --            --Get EMEA Freight Amount --FTR --Added by Kranthi
            get_freight_amt (p_customer_trx_id => i.customer_trx_id, p_org_id => i.org_id, x_freight_amt => ln_freight_amt
                             , x_freight_amt_dsp => lv_freight_amt);

            --Subtotal_freight_total
            --            lv_freight_amt := TO_CHAR(ln_freight_amt, '999G999G990D00');--NVL(ln_freight_amt, 0);
            --            print_log('ln_freight_amt: '||ln_freight_amt);
            --            print_log('lv_freight_amt: '||lv_freight_amt);
            --subtotal_freight_exempt
            --            IF TO_NUMBER(NVL(lv_non_tax_amt, '0.00'), '999G999G990D00') <> 0
            --            THEN
            --                lv_freight_non_taxable := TO_NUMBER(NVL(lv_freight_amt, '0.00'), '999G999G990D00') * --NVL(ln_freight_amt, 0) *
            --                                      (
            --                                       TO_NUMBER(NVL(lv_non_tax_amt, '0.00'), '999G999G990D00')
            --                                       /
            --                                       (TO_NUMBER(NVL(lv_non_tax_amt, '0.00'), '999G999G990D00'))+(TO_NUMBER(NVL(lv_tax_amt, '0.00'), '999G999G990D00'))
            --                                      );
            --            END IF;
            ----            --subtotal_freight_taxable
            --            IF TO_NUMBER(NVL(lv_tax_amt, '0.00'), '999G999G990D00') <> 0
            --            THEN
            --                lv_freight_taxable := TO_NUMBER(NVL(lv_freight_amt, '0.00'), '999G999G990D00') * --NVL(ln_freight_amt, 0) *
            --                                   (TO_NUMBER(NVL(lv_tax_amt, '0.00'), '999G999G990D00')/(TO_NUMBER(NVL(lv_non_tax_amt, '0.00'), '999G999G990D00')+(TO_NUMBER(NVL(lv_tax_amt, '0.00'), '999G999G990D00'))));
            --            END IF;
            ----            --grand_total1_exempt
            --            lv_grand_total1_non_tax := TO_NUMBER(NVL(lv_non_tax_amt, '0.00'), '999G999G990D00') + TO_NUMBER(NVL(lv_freight_non_taxable, 0));
            ----            --grand_total1_taxable
            --            lv_grand_total1_tax := TO_NUMBER(NVL(lv_tax_amt, '0.00'), '999G999G990D00') + TO_NUMBER(NVL(lv_freight_taxable, 0));
            ----            --grand_total1_total
            --            lv_grand_total1_total := TO_NUMBER(NVL(lv_grand_total1_non_tax, 0)) + TO_NUMBER(NVL(lv_grand_total1_tax, 0));
            ----
            ----            --vat_goods_exempt
            --            lv_tax_on_non_taxable_amt := NULL;
            ----            --vat_goods_taxable
            --            lv_tax_on_taxable_amt := lv_tax_on_taxable_amt;
            ----            --vat_goods_total
            --            lv_tax_on_goods_total := TO_NUMBER(NVL(lv_tax_on_non_taxable_amt, 0)) + TO_NUMBER(NVL(lv_tax_on_taxable_amt, 0));
            ----
            ----            --vat_freight_exempt
            --            lv_tax_on_non_taxable_freight := TO_NUMBER(lv_freight_non_taxable) * (NVL(REPLACE(lv_trate, '%', ''), 0)/100);
            ----            --vat_freight_taxable
            --            lv_tax_on_taxable_freight := TO_NUMBER(lv_freight_taxable) * (NVL(REPLACE(lv_trate,'%',''), 0)/100);
            ----            --vat_freight_total
            --            lv_tax_on_freight_total := TO_NUMBER(NVL(lv_tax_on_taxable_freight, 0)) + TO_NUMBER(NVL(lv_tax_on_non_taxable_freight, 0));
            ----
            ----            --grand_total2_exempt
            --            lv_grand_total2_non_tax := TO_NUMBER(NVl(lv_tax_on_non_taxable_amt, 0)) + TO_NUMBER(NVL(lv_tax_on_non_taxable_freight, 0));
            ----            --grand_total2_taxable
            --            lv_grand_total2_tax := TO_NUMBER(NVL(lv_tax_on_taxable_amt, 0)) + TO_NUMBER(NVL(lv_tax_on_taxable_freight, 0));
            ----            --grand_total2_total
            --            lv_grand_total2_total := TO_NUMBER(NVL(lv_grand_total2_non_tax, 0)) + TO_NUMBER(NVL(lv_grand_total2_tax, 0));
            ----            --grand_total_qty
            --EMEA Triangulation - END
            --print_log('Inside insert_billing_staging - HEADER LOOP 10');


            BEGIN
                --Insert into hdr stg
                INSERT INTO xxdo.xxdoar_b2b_billing_hdr_stg (
                                file_date_time,
                                concurrent_request_id,
                                customer_trx_id,
                                operating_unit,
                                remit_to_address1,
                                remit_to_address2,
                                remit_to_address3,
                                remit_to_address4,
                                remit_city,
                                remit_state,
                                remit_postal_code,
                                remit_country,
                                remit_country_name,
                                remit_contact_number,
                                remit_addressee,
                                transaction_class,
                                transaction_number,
                                brand,
                                transaction_date,
                                discount_date,
                                discount_amount,
                                discounted_amount,
                                cf_due_date,
                                invoice_amount,
                                bill_to_customer,
                                bill_to_customer_num,
                                bill_to_address1,
                                bill_to_address2,
                                bill_to_address3,
                                bill_to_address4,
                                bill_to_city,
                                bill_to_state,
                                bill_to_postal_code,
                                bill_to_country,
                                bill_to_country_name,
                                bill_to_tax_reference,
                                ship_to_customer,
                                ship_to_customer_num,
                                ship_to_address1,
                                ship_to_address2,
                                ship_to_address3,
                                ship_to_address4,
                                ship_to_city,
                                ship_to_state,
                                ship_to_postal_code,
                                ship_to_country,
                                ship_to_country_name,
                                order_number,
                                po_number,
                                payment_terms,
                                payment_terms_desc,
                                account_number,
                                salesperson,
                                store_number,
                                dc_number,
                                dept_num,
                                vendor_number,
                                ship_via,
                                printing_pending,
                                delivery_number,
                                transaction_type_name,
                                factor_flag,
                                waybill_number,
                                order_type,
                                invoice_comments,
                                internal_notes,
                                comments,
                                doc_language,
                                print_or_email,
                                from_email,
                                to_email,
                                cc_email,
                                bcc_email,
                                email_subject,
                                buying_group,
                                member_number,
                                vat_number,
                                customer_reference,
                                gst_percent,
                                hst_percent,
                                qst_percent,
                                pst_percent,
                                original_transaction,
                                header_comments1,
                                header_comments2,
                                header_comments3,
                                header_comments4,
                                header_comments5,
                                header_comments6,
                                header_comments7,
                                header_comments8,
                                header_comments9,
                                header_comments10,
                                footer_notes1,
                                footer_notes2,
                                footer_notes3,
                                footer_notes4,
                                footer_notes5,
                                footer_comments1,
                                footer_comments2,
                                footer_comments3,
                                footer_comments4,
                                brand_phone_number,
                                billing_phone,
                                line_subtotal,
                                freight_subtotal,
                                tax_subtotal,
                                tax_ext_line_subtotal,
                                non_tax_ext_line_subtotal,
                                total_amount,
                                currency_code,
                                non_tax_text,
                                tax_text,
                                non_tax_total_qty,
                                tax_total_qty,
                                non_tax_amount_total,
                                tax_amount_total,
                                ship_to_tax_ref,
                                reprocess_flag,
                                sold_by_legal_entity,
                                ship_from_country,
                                inco_term,
                                reverse_charge,
                                total_quantity,
                                subtotal_goods_exempt,
                                subtotal_goods_taxable,
                                subtotal_goods_total,
                                subtotal_freight_exempt,
                                subtotal_freight_taxable,
                                subtotal_freight_total,
                                grand_total1_exempt,
                                grand_total1_taxable,
                                grand_total1_total,
                                vat_rate,
                                vat_rate_name,
                                vat_goods_exempt,
                                vat_goods_taxable,
                                vat_goods_total,
                                vat_freight_exempt,
                                vat_freight_taxable,
                                vat_freight_total,
                                grand_total2_exempt,
                                grand_total2_taxable,
                                grand_total2_total,
                                grand_total_qty,
                                process_flag,
                                error_message,
                                -- Start of Change for CCR0009103
                                tax_rate_name_T0,
                                tax_rate_name_T1,
                                tax_rate_name_T2,
                                tax_rate_desc_T0,
                                tax_rate_desc_T1,
                                tax_rate_desc_T2-- End of Change for CCR0009103
                                                )
                         VALUES (
                                    gv_time_stamp,
                                    gn_conc_request_id,
                                    i.customer_trx_id,
                                    remove_junk (i.operating_unit),
                                    remove_junk (i.remit_address1),
                                    remove_junk (i.remit_address2),
                                    remove_junk (i.remit_address3),
                                    remove_junk (i.remit_address4),
                                    remove_junk (i.remit_city),
                                    remove_junk (i.remit_state),
                                    i.remit_postal_code,
                                    remove_junk (i.remit_country),
                                    remove_junk (i.remit_country_name),
                                    i.remit_contact_number,
                                    remove_junk (i.remit_addressee),
                                    i.trx_class_code, --i.transaction_class        ,
                                    i.trx_number, --i.transaction_number       ,
                                    i.brand,
                                    i.trx_date, --i.transaction_date         ,
                                    ld_disc_date, --i.discount_date            ,
                                    i.disc_amt, --i.discount_amount          ,
                                    i.discounted, --i.discounted_amount        ,
                                    ld_due_date, --i.cf_due_date              ,
                                    i.invoice_amount, --i.invoice_amount           ,
                                    remove_junk (i.bill_customer_name), --i.bill_to_customer         ,
                                    remove_junk (i.bill_cust_num),
                                    remove_junk (i.bill_address1), --i.bill_to_address1         ,
                                    remove_junk (i.bill_address2), --i.bill_to_address2         ,
                                    remove_junk (i.bill_address3), --i.bill_to_address3         ,
                                    remove_junk (i.bill_address4), --i.bill_to_address4         ,
                                    remove_junk (i.bill_city), --i.bill_to_city             ,
                                    remove_junk (i.bill_state), --i.bill_to_state            ,
                                    i.bill_postal_code, --i.bill_to_postal_code      ,
                                    remove_junk (i.bill_country), --i.bill_to_country          ,
                                    remove_junk (i.bill_country_name), --i.bill_to_country_name     ,
                                    remove_junk (i.bill_tax_ref), --i.bill_to_tax_reference    ,
                                    remove_junk (i.ship_customer_name), --i.ship_to_customer         ,
                                    remove_junk (i.ship_customer_num),
                                    remove_junk (i.ship_address1), --i.ship_to_address1         ,
                                    remove_junk (i.ship_address2), --i.ship_to_address2         ,
                                    remove_junk (i.ship_address3), --i.ship_to_address3         ,
                                    remove_junk (i.ship_address4), -- i.ship_to_address4         ,
                                    remove_junk (i.ship_city), --i.ship_to_city             ,
                                    remove_junk (i.ship_state), --i.ship_to_state            ,
                                    i.ship_postal_code, --i.ship_to_postal_code      ,
                                    remove_junk (i.ship_country), -- i.ship_to_country          ,
                                    remove_junk (i.ship_country_name), --i.ship_to_country_name     ,
                                    remove_junk (i.order_reference), --i.order_number             ,
                                    remove_junk (i.purchase_order), --i.po_number                ,
                                    remove_junk (i.term_name), --i.payment_terms            ,
                                    remove_junk (i.term_description), --i.payment_terms_desc       ,
                                    remove_junk (i.bill_cust_num), --i.account_number           , --Commented for CCR0007216
                                    --NULL,   --i.account_number           , --Added for CCR0007216
                                    remove_junk (i.salesrep_name), --i.salesperson              ,
                                    remove_junk (i.store_number), --i.store_number             ,
                                    remove_junk (i.dc_number), --i.dc_number                ,
                                    remove_junk (i.dept_number), --i.dept_num                 ,
                                    NULL,       --i.vendor_number            ,
                                    remove_junk (i.ship_via_desc), --i.ship_via                 ,
                                    i.printing_pending, --i.printing_pending         ,
                                    i.delivery_number, --i.delivery_number          ,
                                    remove_junk (i.trx_type_name), --i.transaction_type_name    ,
                                    --i.factor_flag,     --i.factor_flag              ,--Commented for CCR0007216
                                    NULL, --i.factor_flag              ,--aDDed for CCR0007216
                                    remove_junk (i.waybill_number), --i.waybill_number           ,
                                    --remove_junk(i.order_type),      --i.order_type               ,--Commented for CCR0007216
                                    NULL, --i.order_type               ,--Added for CCR0007216
                                    remove_junk (i.invoice_comments), --i.invoice_comments         ,
                                    remove_junk (i.internal_notes), --i.internal_notes           ,
                                    remove_junk (i.comments), --i.comments                 ,
                                    remove_junk (lv_language), --i.doc_language             ,
                                    remove_junk (lv_print_or_email), --i.print_or_email ,
                                    remove_junk (lv_from_email), --i.from_email               ,
                                    remove_junk (lv_to_email_address), --i.to_email                 ,
                                    remove_junk (p_cc_email_id), --i.cc_email                 ,
                                    NULL,       --i.bcc_email                ,
                                    --remove_junk(lv_email_subject),  --i.email_subject            ,--Commented for CCR0007216
                                    NULL, --i.email_subject            ,--Added for CCR0007216
                                    --remove_junk(lv_cpo_acc),        --i.buying_group             ,--Commented for CCR0007216
                                    NULL, --i.buying_group             ,--Added for CCR0007216
                                    remove_junk (lv_cpo_member), --i.member_number            ,
                                    remove_junk (lv_tax_relate), --i.vat_number               ,
                                    remove_junk (i.order_reference), --i.customer_reference       ,
                                    ln_gst_rate, --i.gst_percent              ,
                                    ln_hst_rate, --i.hst_percent              ,
                                    ln_qst_rate, --i.qst_percent              ,
                                    ln_pst_rate, --i.pst_percent              ,
                                    remove_junk (lv_orig_trx_num), --i.original_transaction     ,
                                    --NULL,              --i.header_comments1         ,--Commented for CCR0007216
                                    remove_junk (lv_cpo_acc), --i.header_comments1         ,--Added for CCR0007216
                                    NULL,       --i.header_comments2         ,
                                    NULL,       --i.header_comments3         ,
                                    --NULL,              --i.header_comments4         , --Commented by Kranthi
                                    --remove_junk(emea_triangulation_tax_stmt), --i.header_comments4         , --Commented for CCR0007216
                                    remove_junk (
                                        NVL (emea_triangulation_tax_stmt,
                                             lv_manual_tax_stmt)), --i.header_comments4 , --Added for CCR0007216
                                    NULL,       --i.header_comments5         ,
                                    --NULL,              --i.header_comments6         , --Commented on 23Jan2018 by Kranthi Bollam
                                    'Option 2', --i.header_comments6         , --Added on 23Jan2018 by Kranthi Bollam
                                    NULL,       --i.header_comments7         ,
                                    NULL,       --i.header_comments8         ,
                                    NULL,       --i.header_comments9         ,
                                    NULL,       --i.header_comments10        ,
                                    --NULL,              --i.footer_notes1          , --Commented for CCR0007216
                                    lv_tax_rate_val_new_t0, -- Changed for CCR0009103  --lv_tax_rate_t0,  --i.footer_notes1            , --Tax Rate T0 Added for CCR0007216
                                    --NULL,              --i.footer_notes2            ,--Commented for CCR0007216
                                    lv_tax_rate_val_new_t1, -- Changed for CCR0009103 --lv_tax_rate_t1,              --i.footer_notes2,--Tax Rate T1 Added for CCR0007216
                                    --NULL,              --i.footer_notes3            , --Commented for CCR0007216
                                    lv_tax_rate_val_new_t2, -- Changed for CCR0009103 --lv_tax_rate_t2,              --i.footer_notes3,--Tax Rate T2 Added for CCR0007216
                                    --NULL,              --i.footer_notes4            ,--Added for CCR0007216
                                    ln_st_g_t2 + ln_st_s_t2, -- Changed for CCR0009103 --ln_st_g_t2,              --i.footer_notes4            , --Subtotal ?Goods T2--Commented for CCR0007216
                                    --NULL,              --i.footer_notes5            ,--Added for CCR0007216
                                    ln_st_s_t2, --i.footer_notes5            , --Subtotal ?Services T2--Commented for CCR0007216
                                    NULL, --i.footer_comments1         ,--Added for CCR0007216
                                    --ln_gt_st_t2,              --i.footer_comments1         , --Grand Total T2--Commented for CCR0007216
                                    --NULL,              --i.footer_comments2         ,--Added for CCR0007216
                                    ln_vat_g_t2 + ln_vat_s_t2, -- Changed for CCR0009103 --ln_vat_g_t2,              --i.footer_comments2         ,--VAT ?Goods T2--Commented for CCR0007216
                                    --NULL,              --i.footer_comments3         ,--Added for CCR0007216
                                    ln_vat_s_t2, --i.footer_comments3         ,--VAT ?Services T2--Commented for CCR0007216
                                    NULL, --i.footer_comments4         ,--Added for CCR0007216
                                    --ln_gt_vat_t2,              --i.footer_comments4         ,--VAT Grand Total T2--Commented for CCR0007216
                                    remove_junk (lv_brand_phone), --i.brand_phone_number       ,
                                    remove_junk (lv_billing_phone), --i.billing_phone            ,
                                    i.invoice_line_amt_dsp, --i.line_subtotal            ,
                                    i.invoice_freight_amt_dsp, --i.freight_subtotal         ,
                                    i.invoice_tax_amt_dsp, --i.tax_subtotal             ,
                                    --lv_tax_amt,        --i.tax_ext_line_subtotal    ,--Commented for CCR0007216
                                    NULL, --i.tax_ext_line_subtotal    ,--Added for CCR0007216
                                    --lv_non_tax_amt,    --i.non_tax_ext_line_subtotal, --Commented for CCR0007216
                                    NULL, --i.non_tax_ext_line_subtotal, --Added for CCR0007216
                                    i.inv_amt_dsp, --i.total_amount             ,
                                    i.invoice_currency_code, --i.currency_code            ,
                                    --remove_junk(lv_non_tax_text),   --i.non_tax_text             ,--Commented for CCR0007216
                                    NULL, --i.non_tax_text             ,--Added for CCR0007216
                                    --remove_junk(lv_tax_text),       --i.tax_text                 ,--Commented for CCR0007216
                                    NULL, --i.tax_text                 ,--Added for CCR0007216
                                    --lv_nt_tqty,        --i.non_tax_total_qty        ,--Commented for CCR0007216
                                    NULL, --i.non_tax_total_qty        ,--Added for CCR0007216
                                    --lv_t_tqty,         --i.tax_total_qty            ,--Commented for CCR0007216
                                    NULL, --i.tax_total_qty            ,--Added for CCR0007216
                                    --lv_other_amt,      --i.non_tax_amount_total     ,--Commented for CCR0007216
                                    NULL, --i.non_tax_amount_total     ,--Added for CCR0007216
                                    --lv_tot_tax,        --i.tax_amount_total         ,--Commented for CCR0007216
                                    NULL, --i.tax_amount_total         ,--Added for CCR0007216
                                    remove_junk (i.ship_tax_ref), --ship_to_tax_ref          ,
                                    NULL,         --reprocess_flag           ,
                                    remove_junk (lv_legal_entity), --sold_by_legal_entity     ,
                                    --remove_junk(lv_ou_country),       --ship_from_country      , --Commented for CCR0007216
                                    remove_junk (lv_ship_from_country), --ship_from_country      , --Added for CCR0007216
                                    --                 lv_ship_from_country, --ship_from_country       ,
                                    --NULL,              --inco_term                , --Commented by Kranthi
                                    remove_junk (lv_inco_term), --inco_term                , --Added by Kranthi
                                    remove_junk (lv_reverse_charge), --reverse_charge
                                    --NULL,                --reverse_charge           ,
                                    --NULL,               --total_quantity          , --Commented by Kranthi
                                    ln_total_qty, --total_quantity            , --Added by Kranthi
                                    --                 NULL,               --subtotal_goods_exempt   , --Commented by Kranthi
                                    ln_st_g_t0 + ln_st_s_t0, -- Added for CCR0009103 --ln_st_g_t0,--TO_NUMBER(NVL(lv_non_tax_amt, '0.00'), '999G999G990D00'),--lv_non_tax_amt,     --subtotal_goods_exempt--Commented for CCR0007216
                                    --NULL,--TO_NUMBER(NVL(lv_non_tax_amt, '0.00'), '999G999G990D00'),--lv_non_tax_amt,     --subtotal_goods_exempt--Added for CCR0007216
                                    ln_st_g_t1 + ln_st_s_t1, -- Added for CCR0009103 --ln_st_g_t1,--TO_NUMBER(NVL(lv_tax_amt, '0.00'), '999G999G990D00'),--lv_tax_amt,         --subtotal_goods_taxable--Commented for CCR0007216
                                    --NULL,--TO_NUMBER(NVL(lv_tax_amt, '0.00'), '999G999G990D00'),--lv_tax_amt,         --subtotal_goods_taxable--Added for CCR0007216
                                    --ln_st_g_tot,--lv_total_amt,       --subtotal_goods_total--Commented for CCR0007216
                                    NULL, --lv_total_amt,       --subtotal_goods_total--Added for CCR0007216
                                    ln_st_s_t0, --lv_freight_non_taxable, --subtotal_freight_exempt ,--Commented for CCR0007216
                                    --NULL,--lv_freight_non_taxable, --subtotal_freight_exempt ,--Added for CCR0007216
                                    ln_st_s_t1, --lv_freight_taxable,   --subtotal_freight_taxable  , --Commented for CCR0007216
                                    --NULL,--lv_freight_taxable,   --subtotal_freight_taxable  , --Added for CCR0007216
                                    --ln_st_s_tot,--lv_freight_amt,       --subtotal_freight_total ,--Commented for CCR0007216'
                                    NULL, --lv_freight_amt,       --subtotal_freight_total ,--Commented for CCR0007216
                                    --ln_gt_st_t0,--lv_grand_total1_non_tax, --grand_total1_exempt  , --Commented for CCR0007216
                                    NULL,               --Added for CCR0007216
                                    --ln_gt_st_t1,--lv_grand_total1_tax, --grand_total1_taxable     , --Commented for CCR0007216
                                    NULL,               --Added for CCR0007216
                                    --ln_gt_st_tot,--lv_grand_total1_total, --grand_total1_total     , --Commented for CCR0007216
                                    NULL,               --Added for CCR0007216
                                    lv_trate,    --vat_rate                  ,
                                    --lv_vat_rate_name,   --vat_rate_name             , --Added by Kranthi--Commented for CCR0007216
                                    NULL, --vat_rate_name             , --Added by Kranthi--Added for CCR0007216
                                    ln_vat_g_t0 + ln_vat_s_t0, -- Added for CCR0009103 --ln_vat_g_t0,--lv_tax_on_non_taxable_amt, --vat_goods_exempt   , --Added by Kranthi
                                    ln_vat_g_t1 + ln_vat_s_t1, -- Added for CCR0009103 --ln_vat_g_t1,--lv_tax_on_taxable_amt, --vat_goods_taxable      , --Added by Kranthi
                                    --ln_vat_g_tot,--lv_tax_on_goods_total, --vat_goods_total        , --Commented for CCR0007216
                                    NULL,               --Added for CCR0007216
                                    ln_vat_s_t0, --lv_tax_on_non_taxable_freight, --vat_freight_exempt , --Added by Kranthi
                                    ln_vat_s_t1, --lv_tax_on_taxable_freight, --vat_freight_taxable, --Added by Kranthi
                                    --ln_vat_s_tot,--lv_tax_on_freight_total, --vat_freight_total    , --Commented for CCR0007216
                                    NULL,               --Added for CCR0007216
                                    --ln_gt_vat_t0,--lv_grand_total2_non_tax, --grand_total2_exempt  , --Commented for CCR0007216
                                    NULL, --lv_grand_total2_non_tax, --grand_total2_exempt  , -Added for CCR0007216
                                    --ln_gt_vat_t1,--lv_grand_total2_tax, --grand_total2_taxable     ,--Commented for CCR0007216
                                    NULL, --lv_grand_total2_tax, --grand_total2_taxable     ,--Added for CCR0007216
                                    --ln_gt_vat_tot,--lv_grand_total2_total, --grand_total2_total     , --Commented for CCR0007216
                                    NULL, --lv_grand_total2_total, --grand_total2_total     , --Added for CCR0007216
                                    NULL,        --grand_total_qty           ,
                                    'N',        --i.process_flag             ,
                                    NULL,                    --i.error_message
                                    -- Start of Change for CCR0009103
                                    lv_tax_rate_new_t0,
                                    lv_tax_rate_new_t1,
                                    lv_tax_rate_new_t2,
                                    lv_tax_desc_t0,
                                    lv_tax_desc_t1,
                                    lv_tax_desc_t2-- End of Change for CCR0009103
                                                  );
            EXCEPTION
                WHEN OTHERS
                THEN
                    print_log ('Inside HEADER LOOP :exception:' || SQLERRM);
            END;
        END LOOP;                                                   --Hdr Loop

        x_ret_code              := gn_success;
        x_ret_message           := 'SUCCESS';
    EXCEPTION
        WHEN OTHERS
        THEN
            x_ret_code      := gn_error;
            x_ret_message   := 'Error in insert_billing_staging:' || SQLERRM;
            print_log (x_ret_message);
    END insert_billing_staging;

    ----
    ----
    PROCEDURE write_billing_file (p_conc_request_id   IN     NUMBER,
                                  p_file_path         IN     VARCHAR2,
                                  p_file_name         IN     VARCHAR2,
                                  x_ret_code             OUT VARCHAR2,
                                  x_ret_message          OUT VARCHAR2)
    IS
        --DEFINE CURSORS
        CURSOR c_hdr_ftr IS
            SELECT 'HDR'                                                   --1
                         || '|' || customer_trx_id                         --2
                                                   || '|' || operating_unit --3
                                                                            || '|' || (remit_to_address1) --4
                                                                                                          || '|' || (remit_to_address2) --5
                                                                                                                                        || '|' || (remit_to_address3) --6
                                                                                                                                                                      || '|' || (remit_to_address4) --7
                                                                                                                                                                                                    || '|' || remit_city --8
                                                                                                                                                                                                                         || '|' || remit_state --9
                                                                                                                                                                                                                                               || '|' || remit_postal_code --10
                                                                                                                                                                                                                                                                           || '|' || remit_country --11
                                                                                                                                                                                                                                                                                                   || '|' || remit_country_name --12
                                                                                                                                                                                                                                                                                                                                || '|' || remit_contact_number --13
                                                                                                                                                                                                                                                                                                                                                               || '|' || (remit_addressee) --14
                                                                                                                                                                                                                                                                                                                                                                                           || '|' || transaction_class --15
                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || transaction_number --16
                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || brand --17
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || TO_CHAR (transaction_date, 'MM/DD/YY') --18
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     || '|' || TO_CHAR (discount_date, 'MM/DD/YY') --19
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   || '|' || discount_amount --20
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             || '|' || discounted_amount --21
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         || '|' || TO_CHAR (cf_due_date, 'MM/DD/YY') --22
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     || '|' || invoice_amount --23
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || (bill_to_customer) --24
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || bill_to_customer_num --25
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || (bill_to_address1) --26
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || (bill_to_address2) --27
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || (bill_to_address3) --28
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 || '|' || (bill_to_address4) --29
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || bill_to_city --30
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     || '|' || bill_to_state --31
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             || '|' || bill_to_postal_code --32
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || bill_to_country --33
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     || '|' || bill_to_country_name --34
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || bill_to_tax_reference --35
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || (ship_to_customer) --36
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 || '|' || ship_to_customer_num --37
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                || '|' || (ship_to_address1) --38
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             || '|' || (ship_to_address2) --39
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || (ship_to_address3) --40
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || (ship_to_address4) --41
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || ship_to_city --42
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || ship_to_state --43
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   || '|' || ship_to_postal_code --44
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 || '|' || ship_to_country --45
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || ship_to_country_name --46
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || order_number --47
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 || '|' || po_number --48
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     || '|' || (payment_terms) --49
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               || '|' || (payment_terms_desc) --50
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || account_number --51
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || salesperson --52
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             || '|' || store_number --53
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || dc_number --54
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        || '|' || dept_num --55
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || vendor_number --56
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   || '|' || (ship_via) --57
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        || '|' || printing_pending --58
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   || '|' || delivery_number --59
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             || '|' || (transaction_type_name) --60
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               || '|' || factor_flag --61
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     || '|' || (waybill_number) --62
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                || '|' || (order_type) --63
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || (invoice_comments) --64
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || (internal_notes) --65
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               || '|' || (comments) --66
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || doc_language --67
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || print_or_email --68
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || from_email --69
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         || '|' || to_email --70
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            || '|' || cc_email --71
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               || '|' || bcc_email --72
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   || '|' || email_subject --73
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || buying_group --74
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  || '|' || member_number --75
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || vat_number --76
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               || '|' || customer_reference --77
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            || '|' || gst_percent --78
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  || '|' || hst_percent --79
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        || '|' || qst_percent --80
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || pst_percent --81
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || original_transaction --82
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   || '|' || (header_comments1) --83
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                || '|' || (header_comments2) --84
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             || '|' || (header_comments3) --85
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || (header_comments4) --86
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || (header_comments5) --87
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || (header_comments6) --88
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 || '|' || (header_comments7) --89 Ship From Location EMEA CCR0007216
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || (header_comments8) --90 Ship from Address1 EMEA CCR0007216
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || (header_comments9) --91 Ship from Address2 EMEA CCR0007216
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        || '|' || (header_comments10) --92 Ship from Address3 EMEA CCR0007216
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      || '|' || ship_to_tax_ref --93
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                || '|' || reprocess_flag --94
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         || '|' || sold_by_legal_entity --95 Ship from City EMEA CCR0007216
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        || '|' || ship_from_country --96
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || (inco_term) --97
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || (reverse_charge) header_record, --98
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'FTR' --1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || (footer_notes1) --2 Tax Rate T0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || (footer_notes2) --3 Tax Rate T1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || (footer_notes3) --4 Tax Rate T2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        || '|' || (footer_notes4) --5 Subtotal ?Goods T2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  || '|' || (footer_notes5) --6 Subtotal ?Services T2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            || '|' || brand_phone_number --7 brand_phone_number
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         || '|' || billing_phone --8
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 || '|' || line_subtotal --9
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         || '|' || freight_subtotal --10
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || tax_subtotal --11
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || tax_ext_line_subtotal --12 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || non_tax_ext_line_subtotal --13 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               || '|' || total_amount --14 total_amount (Grand Total)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      || '|' || currency_code --15
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || (non_tax_text) --16 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || (tax_text) --17 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            || '|' || non_tax_total_qty --18 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        || '|' || tax_total_qty --19 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                || '|' || non_tax_amount_total --20 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               || '|' || tax_amount_total --21 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || (footer_comments1) --22 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || (footer_comments2) --23 VAT ?Goods T2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || (footer_comments3) --24 VAT ?Services T2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 || '|' || (footer_comments4) --25 Subtotal T2 VAT Total
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || total_quantity --26 Subtotal T2 Total
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || subtotal_goods_exempt --27 subtotal_goods(T0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || subtotal_goods_taxable --28 subtotal_goods (T1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        || '|' || subtotal_goods_total --29 subtotal_goods_total  Invoice
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || subtotal_freight_exempt --30 subtotal_Services (T0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         || '|' || subtotal_freight_taxable --31 subtotal_Services(T1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            || '|' || subtotal_freight_total --32 subtotal_Services_total  Invoice
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             || '|' || grand_total1_exempt --33 Subtotal T0 Total
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || grand_total1_taxable --34 Subtotal T1 Total
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || grand_total1_total --35 Subtotal Total Invoice
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || vat_rate --36 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || vat_rate_name --37 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  || '|' || vat_goods_exempt --38 vat_goods  (T0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             || '|' || vat_goods_taxable --39 vat_goods  (T1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         || '|' || vat_goods_total --40 vat_goods_total  Invoice
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   || '|' || vat_freight_exempt --41 vat_Services(T0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                || '|' || vat_freight_taxable --42 vat_Services(T0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || vat_freight_total --43 vat_freight_total Invoice
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || grand_total2_exempt --44 Subtotal T0 VAT Total
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        || '|' || grand_total2_taxable --45 Subtotal T1 VAT Total
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || grand_total2_total --46 Subtotal Total Invoice VAT Total
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || grand_total_qty --47 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              -- Start of Change for CCR0009103
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || tax_rate_name_t0 || '|' || tax_rate_name_t1 || '|' || tax_rate_name_t2 || '|' || tax_rate_desc_t0 || '|' || tax_rate_desc_t1 || '|' || tax_rate_desc_t2 -- End of Change for CCR0009103
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                footer_record, concurrent_request_id,
                   customer_trx_id, total_amount
              FROM xxdo.xxdoar_b2b_billing_hdr_stg stg
             WHERE     1 = 1
                   AND stg.concurrent_request_id = p_conc_request_id
                   AND stg.process_flag = 'N'
            FOR UPDATE;

        CURSOR c_lines (p_conc_request_id IN NUMBER, p_cust_trx_id IN NUMBER)
        IS
              SELECT 'LIN'                                                 --1
                           || '|' || customer_trx_id                       --2
                                                     || '|' || customer_trx_line_id --3
                                                                                    || '|' || line_description --4
                                                                                                               || '|' || item_style --5
                                                                                                                                    || '|' || item_color --6
                                                                                                                                                         || '|' || style_description --7
                                                                                                                                                                                     || '|' || color_description --8
                                                                                                                                                                                                                 || '|' || item_code --9
                                                                                                                                                                                                                                     || '|' || country_of_origin --10
                                                                                                                                                                                                                                                                 || '|' || item_size --11
                                                                                                                                                                                                                                                                                     || '|' || quantity --12
                                                                                                                                                                                                                                                                                                        || '|' || price --13
                                                                                                                                                                                                                                                                                                                        || '|' || discount_percent --14
                                                                                                                                                                                                                                                                                                                                                   || '|' || line_amount --15
                                                                                                                                                                                                                                                                                                                                                                         || '|' || selling_price --16
                                                                                                                                                                                                                                                                                                                                                                                                 || '|' || tax_amount --17
                                                                                                                                                                                                                                                                                                                                                                                                                      || '|' || tax_code --18
                                                                                                                                                                                                                                                                                                                                                                                                                                         || '|' || gst_amount --19
                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || hst_amount --20
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   || '|' || qst_amount --21
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        || '|' || pst_amount --22
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             || '|' || tax_exempt_line_amt --23 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || non_tax_ext_line_amt --24 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || line_placeholder1 --25 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      || '|' || line_placeholder2 --26 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  || '|' || line_placeholder3 --27Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || line_placeholder4 --28 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          || '|' || line_placeholder5 line_record, --29 Future Use
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   item_style, item_color,
                     item_size, quantity
                FROM xxdo.xxdoar_b2b_billing_lin_stg stg
               WHERE     1 = 1
                     AND stg.concurrent_request_id = p_conc_request_id
                     AND stg.customer_trx_id = p_cust_trx_id
            ORDER BY item_style, item_color, item_size,
                     quantity;

        --DEFINE VARIABLES
        lv_output_file     UTL_FILE.file_type;
        lv_file_path       VARCHAR2 (360) := p_file_path;
        --lv_outbound_file    VARCHAR2(360)   := 'BILLING_' || p_file_name;
        lv_outbound_file   VARCHAR2 (360) := p_file_name;
        lv_err_msg         VARCHAR2 (2000) := NULL;
        ln_hdr_cnt         NUMBER := 0;
        ln_line_cnt        NUMBER := 0;
        ln_ftr_cnt         NUMBER := 0;
        lv_hdr             VARCHAR2 (32767) := NULL;
        lv_line            VARCHAR2 (32767) := NULL;
        lv_ftr             VARCHAR2 (32767) := NULL;
        lv_sum             VARCHAR2 (32767) := NULL;
        ln_sum_amount      NUMBER := 0;
        lv_ver             VARCHAR2 (32767) := NULL;
    BEGIN
        lv_output_file   :=
            UTL_FILE.fopen (lv_file_path, lv_outbound_file || '.tmp', 'W' --opening the file in write mode
                                                                         ,
                            32767);

        IF UTL_FILE.is_open (lv_output_file)
        THEN
            --Add Summary Record
            lv_ver   :=
                'VER' || '|' || gv_time_stamp || '|' || gn_conc_request_id;
            UTL_FILE.put_line (lv_output_file, lv_ver);

            FOR i IN c_hdr_ftr
            LOOP
                --Add Header Record
                ln_hdr_cnt      := ln_hdr_cnt + 1;
                lv_hdr          := i.header_record;
                UTL_FILE.put_line (lv_output_file, lv_hdr);

                FOR j IN c_lines (i.concurrent_request_id, i.customer_trx_id)
                LOOP
                    --Add Line Record
                    lv_line       := j.line_record;
                    UTL_FILE.put_line (lv_output_file, lv_line);
                    ln_line_cnt   := ln_line_cnt + 1;
                END LOOP;

                --Add Footer Record
                lv_ftr          := i.footer_record;
                UTL_FILE.put_line (lv_output_file, lv_ftr);
                ln_ftr_cnt      := ln_ftr_cnt + 1;
                ln_sum_amount   := ln_sum_amount + i.total_amount;

                BEGIN
                    UPDATE xxdo.xxdoar_b2b_billing_hdr_stg
                       SET process_flag   = 'Y'
                     WHERE     concurrent_request_id =
                               i.concurrent_request_id
                           AND process_flag = 'N'
                           AND customer_trx_id = i.customer_trx_id;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        NULL;
                END;
            END LOOP;

            COMMIT;

            --Add Summary Record
            lv_sum   := 'SUM' || '|' || ln_hdr_cnt || '|' || ln_sum_amount;
            UTL_FILE.put_line (lv_output_file, lv_sum);
        ELSE
            lv_err_msg      :=
                SUBSTR (
                       'Error in Opening the Billing data file for writing. Error is : '
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            RETURN;
        END IF;

        UTL_FILE.fclose (lv_output_file);
    EXCEPTION
        WHEN UTL_FILE.invalid_path
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_PATH: File location or filename was invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20201, lv_err_msg);
        WHEN UTL_FILE.invalid_mode
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_MODE: The open_mode parameter in FOPEN was invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20202, lv_err_msg);
        WHEN UTL_FILE.invalid_filehandle
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_FILEHANDLE: The file handle was invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20203, lv_err_msg);
        WHEN UTL_FILE.invalid_operation
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_OPERATION: The file could not be opened or operated on as requested.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20204, lv_err_msg);
        WHEN UTL_FILE.read_error
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'READ_ERROR: An operating system error occurred during the read operation.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20205, lv_err_msg);
        WHEN UTL_FILE.write_error
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'WRITE_ERROR: An operating system error occurred during the write operation.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20206, lv_err_msg);
        WHEN UTL_FILE.internal_error
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      := 'INTERNAL_ERROR: An unspecified error in PL/SQL.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20207, lv_err_msg);
        WHEN UTL_FILE.invalid_filename
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_FILENAME: The filename parameter is invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20208, lv_err_msg);
        WHEN OTHERS
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                SUBSTR (
                       'Error while creating or writing the data into the file.'
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20209, lv_err_msg);
    END write_billing_file;

    ----
    ----
    PROCEDURE write_open_ar_file (p_conc_request_id   IN     NUMBER,
                                  p_file_path         IN     VARCHAR2,
                                  p_file_name         IN     VARCHAR2,
                                  x_ret_code             OUT NUMBER,
                                  x_ret_message          OUT VARCHAR2)
    IS
        --DEFINE CURSORS
        --CURSOR OPEN AR
        CURSOR openar_file_cur IS
              SELECT invoice_number || '|' || LTRIM (TO_CHAR (NVL (invoice_amount, 0), '999999990D99')) || '|' || LTRIM (TO_CHAR (NVL (open_amount, 0), '999999990D99')) || '|' || LTRIM (TO_CHAR (NVL (discount_amount, 0), '999999990D99')) || '|' || LTRIM (TO_CHAR (NVL (freight_amount, 0), '999999990D99')) || '|' || LTRIM (TO_CHAR (NVL (tax_amount, 0), '999999990D99')) || '|' || TO_CHAR (invoice_date, 'MM/DD/YYYY') || '|' || po_number || '|' || consolidated_invoice_number --Cons Inv# is mapped to statement_number --StatementNumber
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || LTRIM (TO_CHAR (NVL (statement_amount, 0), '999999990D99')) --StatementAmount --Not Required to Send to Billtrust
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 || '|' || nonbrand_customer_number --Parent Customer Number
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    || '|' || bill_to_customer_number || '|' || SUBSTR (bill_to_customer_name, 1, 50) || '|' || SUBSTR (bill_to_address1, 1, 50) --CustomerAddress1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 || '|' || SUBSTR (bill_to_address2 || DECODE (bill_to_address3, NULL, NULL, ',' || bill_to_address3), 1, 50) --CustomerAddress2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || bill_to_city --CustomerCity
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     || '|' || bill_to_state_or_prov --CustomerState
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     || '|' || bill_to_zip_code --CustomerZip
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                || '|' || LTRIM (TO_CHAR (NVL (discounted_amount, 0), '999999990D99')) --CustomMoney1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || LTRIM (TO_CHAR (0, '999999990D99')) --CustomMoney2 --No Need to Send this to Billtrust  --Removed Comment on 08Nov2017
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     || '|' || bill_to_country --CustomField1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               || '|' || document_type --CustomField2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || SUBSTR (remove_junk (sales_order_number), 1, 50) --CustomField3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  || '|' || bill_of_lading --CustomField4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || SUBSTR (buying_agent_group_num, 1, 50) --CustomField5
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            || '|' || SUBSTR (buying_membership_num, 1, 50) --CustomField6
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            || '|' || SUBSTR (operating_unit, 1, 50) --CustomField7
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     || '|' || ship_to_customer_number --CustomField8
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || SUBSTR (ship_to_customer_name, 1, 50) --CustomField9
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       || '|' || SUBSTR (ship_to_address1, 1, 50) --CustomField10
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  || '|' || SUBSTR (ship_to_address2 || DECODE (ship_to_address3, NULL, NULL, ',' || ship_to_address3), 1, 50) --CustomField11
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               || '|' || ship_to_city --CustomField12
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      || '|' || ship_to_state_or_prov --CustomField13
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      || '|' || ship_to_zip_code --CustomField14
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 || '|' || ship_to_country --CustomField15
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || invoice_currency_code --CustomField16
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           || '|' || payment_term --CustomField17
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  || '|' || record_identifier --CustomField18
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              || '|' || NULL --CustomField19 --Not Required to Send to Billtrust  --Removed Comment on 08Nov2017
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             || '|' || NULL --CustomField20 --Not Required to Send to Billtrust  --Removed Comment on 08Nov2017
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            open_ar_record, request_id, ROWID row_id
                FROM xxdo.xxdoar_b2b_open_ar_stg stg
               WHERE     1 = 1
                     AND stg.request_id = p_conc_request_id
                     AND stg.process_flag = 'N'
            ORDER BY stg.document_type NULLS LAST --Check if this sorting is required or not.
                                                 ;

        --Define Variables
        lv_output_file     UTL_FILE.file_type;
        lv_file_path       VARCHAR2 (360) := p_file_path;
        --lv_outbound_file    VARCHAR2(360)       := 'OPENAR_' || p_file_name;
        lv_outbound_file   VARCHAR2 (360) := p_file_name;
        lv_err_msg         VARCHAR2 (2000) := NULL;
        ln_openar_cnt      NUMBER := 0;
        lv_openar          VARCHAR2 (32767) := NULL;
    BEGIN
        print_log ('Writing the Open AR File', 'Y');
        print_log ('Open AR File_Name: ' || lv_outbound_file);
        lv_output_file   :=
            UTL_FILE.fopen (lv_file_path, lv_outbound_file || '.tmp', 'W', --opening the file in write mode
                            32767);

        IF UTL_FILE.is_open (lv_output_file)
        THEN
            FOR openar_file_rec IN openar_file_cur
            LOOP
                ln_openar_cnt   := ln_openar_cnt + 1;
                lv_openar       := openar_file_rec.open_ar_record;
                UTL_FILE.put_line (lv_output_file, lv_openar);

                BEGIN
                    UPDATE xxdo.xxdoar_b2b_open_ar_stg stg
                       SET process_flag = 'S', file_date_time = TO_DATE (gv_time_stamp, 'YYYYMMDDHH24MISS')
                     WHERE     1 = 1
                           AND stg.request_id = p_conc_request_id
                           AND stg.process_flag = 'N'
                           AND stg.ROWID = openar_file_rec.row_id;
                EXCEPTION
                    WHEN OTHERS
                    THEN
                        lv_err_msg   :=
                            SUBSTR (
                                   'Error wile updating process flag to Success for ROWID: '
                                || openar_file_rec.row_id,
                                1,
                                2000);
                        print_log (lv_err_msg);
                END;
            END LOOP;

            COMMIT;
            print_log (
                'Number of records inserted into the file: ' || ln_openar_cnt);
        ELSE
            lv_err_msg      :=
                SUBSTR (
                       'Error in Opening the Billing data file for writing. Error is : '
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            RETURN;
        END IF;

        UTL_FILE.fclose (lv_output_file);
    EXCEPTION
        WHEN UTL_FILE.invalid_path
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_PATH: File location or filename was invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20201, lv_err_msg);
        WHEN UTL_FILE.invalid_mode
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_MODE: The open_mode parameter in FOPEN was invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20202, lv_err_msg);
        WHEN UTL_FILE.invalid_filehandle
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_FILEHANDLE: The file handle was invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20203, lv_err_msg);
        WHEN UTL_FILE.invalid_operation
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_OPERATION: The file could not be opened or operated on as requested.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20204, lv_err_msg);
        WHEN UTL_FILE.read_error
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'READ_ERROR: An operating system error occurred during the read operation.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20205, lv_err_msg);
        WHEN UTL_FILE.write_error
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'WRITE_ERROR: An operating system error occurred during the write operation.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20206, lv_err_msg);
        WHEN UTL_FILE.internal_error
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      := 'INTERNAL_ERROR: An unspecified error in PL/SQL.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20207, lv_err_msg);
        WHEN UTL_FILE.invalid_filename
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                'INVALID_FILENAME: The filename parameter is invalid.';
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20208, lv_err_msg);
        WHEN OTHERS
        THEN
            IF UTL_FILE.is_open (lv_output_file)
            THEN
                UTL_FILE.fclose (lv_output_file);
            END IF;

            lv_err_msg      :=
                SUBSTR (
                       'Error while creating or writing the data into the file.'
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            raise_application_error (-20209, lv_err_msg);
    END write_open_ar_file;

    ----
    ----
    PROCEDURE upd_so_num_prc (p_conc_request_id IN NUMBER)
    IS
        lv_proc_name   VARCHAR2 (30) := 'UPD_SO_NUM_PRC';
        lv_err_msg     VARCHAR2 (2000) := NULL;
    BEGIN
        UPDATE xxdo.xxdoar_b2b_open_ar_stg xoar
           SET sales_order_number = get_sales_order_num (xoar.customer_trx_id)
         WHERE     xoar.customer_trx_id IS NOT NULL
               AND xoar.request_id = p_conc_request_id
               AND xoar.process_flag = 'N';

        COMMIT;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK; --In case of any issue in updating the sales order number
            lv_err_msg   :=
                SUBSTR (
                       'Error while updating sales order number in '
                    || lv_proc_name
                    || ' procedure. Error is: '
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
    END upd_so_num_prc;

    ----
    ----
    PROCEDURE upd_buying_grp_details (p_conc_request_id IN NUMBER)
    IS
        lv_proc_name        VARCHAR2 (30) := 'UPD_BUYING_GRP_DETAILS';
        lv_err_msg          VARCHAR2 (2000) := NULL;
        lv_buying_group     VARCHAR2 (120) := NULL;
        lv_membership_num   VARCHAR2 (120) := NULL;
        lv_tax_relate       VARCHAR2 (120) := NULL;
        lv_tax_ref1         VARCHAR2 (240) := NULL;

        CURSOR buy_grp_cur IS
            SELECT ROWID row_id, xoar.payment_term_id, xoar.bill_to_customer_id,
                   xoar.bill_to_site_use_id, xoar.ship_to_site_use_id
              FROM xxdo.xxdoar_b2b_open_ar_stg xoar
             WHERE     xoar.payment_term_id IS NOT NULL
                   AND xoar.request_id = p_conc_request_id
                   AND xoar.process_flag = 'N';
    BEGIN
        FOR buy_grp_rec IN buy_grp_cur
        LOOP
            /* --Commented for CCR0007216 --Start
            get_emea_hdr_data(
                              p_term_id              =>  buy_grp_rec.payment_term_id
                             ,p_bill_to_customer_id  =>  buy_grp_rec.bill_to_customer_id
                             ,x_cpo_acc              =>  lv_buying_group
                             ,x_cpo_member           =>  lv_membership_num
                             ,x_tax_relate           =>  lv_tax_relate
                             );
            */
            --Commented for CCR0007216 --End
            --Added for CCR0007216 --Start
            get_emea_hdr_data (
                p_bill_to_customer_id   => buy_grp_rec.bill_to_customer_id,
                p_bill_to_site_use_id   => buy_grp_rec.bill_to_site_use_id,
                p_ship_to_customer_id   => buy_grp_rec.bill_to_customer_id,
                p_ship_to_site_use_id   => buy_grp_rec.ship_to_site_use_id,
                x_cpo_acc               => lv_buying_group,
                x_cpo_member            => lv_membership_num,
                x_tax_relate            => lv_tax_relate,
                x_tax_ref               => lv_tax_ref1);

            --Added for CCR0007216 --End

            UPDATE xxdo.xxdoar_b2b_open_ar_stg xoar
               SET buying_agent_group_num = remove_junk (SUBSTR (lv_buying_group, 1, 120)), buying_membership_num = remove_junk (SUBSTR (lv_membership_num, 1, 120))
             WHERE     1 = 1 --xoar.payment_term_id IS NOT NULL --Commented for CCR0007216
                   AND xoar.request_id = p_conc_request_id
                   AND xoar.process_flag = 'N'
                   AND ROWID = buy_grp_rec.row_id;
        END LOOP;

        COMMIT;
    EXCEPTION
        WHEN OTHERS
        THEN
            ROLLBACK; --In case of any issue in updating the sales order number
            lv_err_msg   :=
                SUBSTR (
                       'Error while updating Buying agent group details in '
                    || lv_proc_name
                    || ' procedure. Error is: '
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
    END upd_buying_grp_details;

    ----
    ----
    PROCEDURE open_ar_dummy_records (p_conc_request_id IN NUMBER, x_ret_code OUT VARCHAR2, x_ret_message OUT VARCHAR2)
    IS
        lv_proc_name   VARCHAR2 (30) := 'OPEN_AR_DUMMY_RECORDS';
        lv_err_msg     VARCHAR2 (2000) := NULL;
    BEGIN
        INSERT INTO xxdo.xxdoar_b2b_open_ar_stg (invoice_number,
                                                 open_amount,
                                                 invoice_date,
                                                 nonbrand_customer_number,
                                                 bill_to_customer_number,
                                                 bill_to_customer_name,
                                                 record_identifier,
                                                 process_flag,
                                                 request_id,
                                                 bill_to_customer_id,
                                                 creation_date,
                                                 created_by,
                                                 last_update_date,
                                                 last_updated_by)
            SELECT remove_junk (invoice_number) invoice_number, open_amount, invoice_date,
                   remove_junk (nonbrand_customer_number) nonbrand_customer_number, remove_junk (bill_to_customer_number) bill_to_customer_number, remove_junk (bill_to_customer_name) bill_to_customer_name,
                   record_identifier, process_flag, request_id,
                   bill_to_customer_id, SYSDATE creation_date, gn_user_id created_by,
                   SYSDATE last_update_date, gn_user_id last_updated_by
              FROM (SELECT 'OA' || hca.account_number invoice_number,
                           0   open_amount,
                           TRUNC (SYSDATE) invoice_date,
                           CASE
                               WHEN REGEXP_COUNT (hca.account_number, '-', 1,
                                                  'i') > 0
                               THEN
                                   SUBSTR (
                                       hca.account_number,
                                       1,
                                       INSTR (hca.account_number, '-', 1) - 1)
                               ELSE
                                   hca.account_number
                           END nonbrand_customer_number,
                           hca.account_number bill_to_customer_number,
                           hp.party_name bill_to_customer_name,
                           'O' record_identifier            --O for On Account
                                                ,
                           'N' process_flag,
                           p_conc_request_id request_id,
                           hca.cust_account_id bill_to_customer_id
                      FROM apps.hz_cust_accounts hca, hz_parties hp
                     WHERE     1 = 1
                           AND hca.status = 'A'
                           AND hca.party_id = hp.party_id
                           AND hp.status = 'A'
                           --AND hp.party_type = 'ORGANIZATION'
                           AND EXISTS
                                   (SELECT '1'
                                      FROM apps.hz_cust_acct_sites_all hcasa, apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values ffv
                                     WHERE     1 = 1
                                           AND hcasa.status = 'A'
                                           AND hcasa.cust_account_id =
                                               hca.cust_account_id
                                           AND ffvs.flex_value_set_name =
                                               'XXDOAR_B2B_OPERATING_UNITS'
                                           AND ffvs.flex_value_set_id =
                                               ffv.flex_value_set_id
                                           AND ffv.enabled_flag = 'Y'
                                           AND NVL (ffv.start_date_active,
                                                    SYSDATE) <=
                                               SYSDATE
                                           AND NVL (ffv.end_date_active,
                                                    SYSDATE + 1) >
                                               SYSDATE
                                           AND TO_CHAR (hcasa.org_id) =
                                               RTRIM (LTRIM (ffv.flex_value)))
                    UNION ALL
                    SELECT 'CC' || hca.account_number invoice_number,
                           0   open_amount,
                           TRUNC (SYSDATE) invoice_date,
                           CASE
                               WHEN REGEXP_COUNT (hca.account_number, '-', 1,
                                                  'i') > 0
                               THEN
                                   SUBSTR (
                                       hca.account_number,
                                       1,
                                       INSTR (hca.account_number, '-', 1) - 1)
                               ELSE
                                   hca.account_number
                           END nonbrand_customer_number,
                           hca.account_number bill_to_customer_number,
                           hp.party_name bill_to_customer_name,
                           'C' record_identifier           --C for Cash Claims
                                                ,
                           'N' process_flag,
                           p_conc_request_id request_id,
                           hca.cust_account_id bill_to_customer_id
                      FROM apps.hz_cust_accounts hca, hz_parties hp
                     WHERE     1 = 1
                           AND hca.status = 'A'
                           AND hca.party_id = hp.party_id
                           AND hp.status = 'A'
                           --AND hp.party_type = 'ORGANIZATION'
                           AND EXISTS
                                   (SELECT '1'
                                      FROM apps.hz_cust_acct_sites_all hcasa, apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values ffv
                                     WHERE     1 = 1
                                           AND hcasa.status = 'A'
                                           AND hcasa.cust_account_id =
                                               hca.cust_account_id
                                           AND ffvs.flex_value_set_name =
                                               'XXDOAR_B2B_OPERATING_UNITS'
                                           AND ffvs.flex_value_set_id =
                                               ffv.flex_value_set_id
                                           AND ffv.enabled_flag = 'Y'
                                           AND NVL (ffv.start_date_active,
                                                    SYSDATE) <=
                                               SYSDATE
                                           AND NVL (ffv.end_date_active,
                                                    SYSDATE + 1) >
                                               SYSDATE
                                           AND TO_CHAR (hcasa.org_id) =
                                               RTRIM (LTRIM (ffv.flex_value)))
                    UNION ALL
                    SELECT 'SC' || hca.account_number invoice_number,
                           0   open_amount,
                           TRUNC (SYSDATE) invoice_date,
                           CASE
                               WHEN REGEXP_COUNT (hca.account_number, '-', 1,
                                                  'i') > 0
                               THEN
                                   SUBSTR (
                                       hca.account_number,
                                       1,
                                       INSTR (hca.account_number, '-', 1) - 1)
                               ELSE
                                   hca.account_number
                           END nonbrand_customer_number,
                           hca.account_number bill_to_customer_number,
                           hp.party_name bill_to_customer_name,
                           'S' record_identifier            --S for Surcharges
                                                ,
                           'N' process_flag,
                           p_conc_request_id request_id,
                           hca.cust_account_id bill_to_customer_id
                      FROM apps.hz_cust_accounts hca, hz_parties hp
                     WHERE     1 = 1
                           AND hca.status = 'A'
                           AND hca.party_id = hp.party_id
                           AND hp.status = 'A'
                           --AND hp.party_type = 'ORGANIZATION'
                           AND EXISTS
                                   (SELECT '1'
                                      FROM apps.hz_cust_acct_sites_all hcasa, apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values ffv
                                     WHERE     1 = 1
                                           AND hcasa.status = 'A'
                                           AND hcasa.cust_account_id =
                                               hca.cust_account_id
                                           AND ffvs.flex_value_set_name =
                                               'XXDOAR_B2B_OPERATING_UNITS'
                                           AND ffvs.flex_value_set_id =
                                               ffv.flex_value_set_id
                                           AND ffv.enabled_flag = 'Y'
                                           AND NVL (ffv.start_date_active,
                                                    SYSDATE) <=
                                               SYSDATE
                                           AND NVL (ffv.end_date_active,
                                                    SYSDATE + 1) >
                                               SYSDATE
                                           AND TO_CHAR (hcasa.org_id) =
                                               RTRIM (LTRIM (ffv.flex_value)))
                           AND CASE
                                   WHEN REGEXP_COUNT (hca.account_number, '-', 1
                                                      , 'i') > 0
                                   THEN
                                       SUBSTR (
                                           hca.account_number,
                                           1,
                                             INSTR (hca.account_number,
                                                    '-',
                                                    1)
                                           - 1)
                                   ELSE
                                       hca.account_number
                               END =
                               hca.account_number) xx;

        COMMIT;
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_err_msg      :=
                SUBSTR (
                       'Error in OPEN_AR_DUMMY_RECORDS procedure. Error is: '
                    || SQLERRM,
                    1,
                    2000);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            print_log (lv_err_msg);
    END open_ar_dummy_records;

    ----
    ----
    PROCEDURE insert_open_ar_staging (p_org_id IN NUMBER, p_customer_id IN NUMBER, p_include_receipts IN VARCHAR2
                                      , p_file_path IN VARCHAR2, x_ret_code OUT VARCHAR2, x_ret_message OUT VARCHAR2)
    IS
        CURSOR open_ar_cur (p_org IN NUMBER)
        IS
            --Open Invoices Query - END
            SELECT rct.trx_number
                       invoice_number                          --InvoiceNumber
                                     ,
                   ps.amount_due_original
                       invoice_amount                          --InvoiceAmount
                                     ,
                   ps.amount_due_remaining
                       open_amount                                --OpenAmount
                                  ,
                     ROUND (ps.amount_due_original, 2)
                   - ROUND (
                           ps.freight_original
                         + ps.tax_original
                         + (ps.amount_line_items_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))),
                         2)
                       discount_amount                        --DiscountAmount
                                      ,
                   ps.freight_remaining
                       freight_amount                          --FreightAmount
                                     ,
                   ps.tax_remaining
                       tax_amount                                  --TaxAmount
                                 ,
                   rct.trx_date
                       invoice_date --InvoiceDate --format data while creating file(TO_CHAR(date, 'MM/DD/YYYY'))
                                   ,
                   rct.purchase_order
                       po_number                                    --PONumber
                                ,
                   NULL
                       statement_number --StatementNumber --Do not send this field --Need clarification
                                       ,
                   0.00
                       statement_amount --StatementAmount --Do not send this field(If Yes, Send '0.00') --Need clarification
                                       ,
                   CASE
                       WHEN REGEXP_COUNT (hca.account_number, '-', 1,
                                          'i') > 0
                       THEN
                           SUBSTR (hca.account_number,
                                   1,
                                   INSTR (hca.account_number, '-', 1) - 1)
                       ELSE
                           hca.account_number
                   END
                       nonbrand_customer_number --ParentCustomerNumber --Non-Brand Customer Number
                                               --      ,(
                                               --       SELECT hca_nb.account_number
                                               --          FROM apps.hz_cust_accounts hca_nb
                                               --         WHERE 1=1
                                               --           AND hca_nb.attribute1 = 'ALL BRAND'
                                               --           AND hca_nb.attribute13 = 'NON-BRAND'
                                               --           AND hca_nb.status = 'A'
                                               --           AND hca_nb.party_id = hp.party_id
                                               --           AND ROWNUM=1
                                               --       ) nonbrand_customer_number --ParentCustomerNumber --Comment this column
                                               ,
                   hca.account_number
                       bill_to_customer_number                --CustomerNumber
                                              ,
                   hp.party_name
                       bill_to_customer_name                    --CustomerName
                                            ,
                   hl.address1
                       bill_to_address1  --CustomerAddress1 --Bill TO Address1
                                       ,
                   hl.address2
                       bill_to_address2 --CustomerAddress2 --Bill To Address 2 and 3
                                       ,
                   hl.address3
                       bill_to_address3 --CustomerAddress2 --Bill To Address 2 and 3
                                       ,
                   hl.address4
                       bill_to_address4        --bill_to_address4 --No Mapping
                                       ,
                   hl.city
                       bill_to_city              --CustomerCity --Bill To City
                                   ,
                   NVL (hl.state, hl.province)
                       bill_to_state_or_prov --CustomerState --Bill To State or Province
                                            ,
                   hl.postal_code
                       bill_to_zip_code      --CustomerZip  --Bill To Zip Code
                                       ,
                   ROUND (
                         ps.freight_original
                       + ps.tax_original
                       + (ps.amount_line_items_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1))),
                       2)
                       discounted_amount --CustomMoney1 --Discounted Amount: Inv line amount less available discount
                                        --,0.00 custom_money2 --CustomMoney2 --No Mapping (Send 0.00 for this field)
                                        ,
                   hl.country
                       bill_to_country       --CustomField1  --Bill To Country
                                      ,
                   arl.meaning
                       document_type            --CustomField2 --Document Type
                                    --                   rct.interface_header_attribute1
                                    ,
                   NULL
                       sales_order_number --CustomField3 --SO Number (Write a function to concatenate SO# from RCT lines table)
                                         ,
                   DECODE (rct.waybill_number, '0', NULL, rct.waybill_number)
                       bill_of_lading --CustomField4 --Bill Of Lading --Need clarification
                                     --B2B Phase 2 EMEA Changes (CCR0007216 ) --Start
                                     /*
                                     ,NULL buying_agent_group_num --CustomField5 --Buying Agent/Group Number --x_cpo_acc --Need Clarification --
                                     ,NULL buying_membership_num --CustomField6 --Buying Membership Number --Logic to derive  - TBD
                                     */
                                     ,
                   hp.attribute16
                       buying_agent_group_num --CustomField5 --Buying Agent/Group Number --x_cpo_acc --Need Clarification --
                                             ,
                   NVL (NVL (hcsua_ship.attribute11, hcsua.attribute11),
                        hp.attribute17)
                       buying_membership_num --CustomField6 --Buying Membership Number --Logic to derive  - TBD
                                            --B2B Phase 2 EMEA Changes (CCR0007216 ) --End
                                            ,
                   hou.name
                       operating_unit     --CustomField7 --Operating Unit Name
                                     ,
                   hca_ship.account_number
                       ship_to_customer_number --Customfield8 --Ship To Customer Number
                                              ,
                   hp_ship.party_name
                       ship_to_customer_name --Customfield9 --Ship To Customer Name
                                            ,
                   hl_ship.address1
                       ship_to_address1     --CustomField10 --Ship To address1
                                       ,
                   hl_ship.address2
                       ship_to_address2 --CustomField11 --Ship To address 2 and 3
                                       ,
                   hl_ship.address3
                       ship_to_address3 --CustomField11 --Ship To address 2 and 3
                                       ,
                   hl_ship.address4
                       ship_to_address4                           --No Mapping
                                       ,
                   hl_ship.city
                       ship_to_city             --CustomField12 --Ship To City
                                   ,
                   NVL (hl_ship.state, hl_ship.province)
                       ship_to_state_or_prov --CustomField13 --Ship To State/Province
                                            ,
                   hl_ship.postal_code
                       ship_to_zip_code     --CustomField14 --Ship To Zip Code
                                       ,
                   hl_ship.country
                       ship_to_country       --CustomField15 --Ship To Country
                                      ,
                   rct.invoice_currency_code
                       invoice_currency_code   --CustomField16 --Currency Code
                                            ,
                   rt.name
                       payment_term             --CustomField17 --Payment Term
                                   ,
                   NULL
                       consolidated_invoice_number --CustomField18 --Consolidated Inv # This is now mapped to Statement Number Field
                                                  ,
                   NULL
                       record_identifier --CustomField18 --Dummy Record Identifier to be sent in CustomField18
                                        --      ,NULL customfield19 --No Mapping
                                        --      ,NULL customfield20 --No Mapping
                                        --      ,tt.type trx_class_code
                                        --      ,ps.org_id
                                        --      ,ps.class
                                        --      ,ps.status
                                        --      ,TO_CHAR(ps.due_date, 'MM/DD/YYYY') due_date
                                        --      ,ps.due_date - ps.trx_date due_days
                                        --      ,ps.days_past_due
                                        --      ,DECODE(ps.amount_due_remaining,
                                        --                   0, to_number (null),
                                        --                   trunc (sysdate) - ps.due_date) past_due_days
                                        --      ,ps.gl_date
                                        --,ROUND(ps.freight_original + ps.tax_original + (ps.amount_line_items_original * (NVL ((1 - NVL (rtld.discount_percent, 0) / 100), 1) ) ), 2 ) disc_amt
                                        --      ,ps.tax_original
                                        --      ,ps.freight_original
                                        --      ,ps.amount_adjusted
                                        --      ,ps.amount_adjusted_pending
                                        --      ,ps.receivables_charges_charged
                                        --      ,ps.receivables_charges_remaining
                                        --      ,ps.customer_id
                                        --      ,ps.customer_site_use_id
                                        ,
                   rct.org_id,
                   rct.customer_trx_id,
                   rct.cust_trx_type_id,
                   ps.cash_receipt_id,
                   rct.bill_to_customer_id,
                   rct.bill_to_site_use_id,
                   rct.ship_to_site_use_id,
                   rct.term_id
                       payment_term_id
              FROM apps.ar_payment_schedules_all ps, apps.fnd_flex_value_sets ffvs, apps.fnd_flex_values ffv,
                   apps.hr_operating_units hou, apps.hz_cust_site_uses_all hcsua, apps.hz_cust_acct_sites_all hcasa,
                   apps.hz_party_sites hps, apps.hz_locations hl, apps.hz_cust_accounts hca,
                   apps.hz_parties hp, apps.ra_customer_trx_all rct, apps.ra_terms_lines_discounts rtld,
                   apps.ra_cust_trx_types_all tt, apps.ar_lookups arl, apps.hz_cust_site_uses_all hcsua_ship,
                   apps.hz_cust_acct_sites_all hcasa_ship, apps.hz_party_sites hps_ship, apps.hz_locations hl_ship,
                   apps.hz_cust_accounts hca_ship, apps.hz_parties hp_ship, apps.ra_terms rt
             --      ,(SELECT hca_nb.account_number
             --          FROM apps.hz_cust_accounts hca_nb
             --         WHERE 1=1
             --           AND hca_nb.attribute1 = 'ALL BRAND'
             --           AND hca_nb.attribute13 = 'NON-BRAND'
             --           AND hca_nb.status = 'A'
             --           AND hca_nb.party_id = hp.party_id
             --           AND ROWNUM=1
             --       ) nbc
             WHERE     1 = 1
                   AND ps.org_id = NVL (p_org, ps.org_id) --Operating Unit Parameter
                   AND NVL (ps.amount_due_remaining, 0) <> 0         --OPEN AR
                   AND ps.status = 'OP'                    --Open Transactions
                   AND ps.customer_id IS NOT NULL
                   AND ps.class <> 'PMT'
                   AND ffvs.flex_value_set_id = ffv.flex_value_set_id
                   AND ffvs.flex_value_set_name =
                       'XXDOAR_B2B_OPERATING_UNITS'
                   AND ffv.enabled_flag = 'Y'
                   AND NVL (ffv.start_date_active, SYSDATE) <= SYSDATE
                   AND NVL (ffv.end_date_active, SYSDATE + 1) > SYSDATE
                   AND TO_CHAR (ps.org_id) = RTRIM (LTRIM (ffv.flex_value))
                   AND ps.org_id = hou.organization_id
                   AND ps.customer_trx_id = rct.customer_trx_id
                   --AND NVL(rct.printing_option, 'PRI') = 'PRI' --Commented by Kranthi on 17Jan2018
                   AND NVL (rct.printing_option, 'PRI') = 'PRI' --Added for CCR0007216
                   --AND NVL(rct.printing_pending, 'Y') = 'Y' --Commented by Kranthi on 17Jan2018
                   AND rct.bill_to_site_use_id = hcsua.site_use_id
                   AND hcsua.cust_acct_site_id = hcasa.cust_acct_site_id
                   AND hcasa.party_site_id = hps.party_site_id
                   AND hps.location_id = hl.location_id
                   AND rct.bill_to_customer_id = hca.cust_account_id
                   AND hca.party_id = hp.party_id
                   AND rct.ship_to_site_use_id = hcsua_ship.site_use_id(+)
                   AND hcsua_ship.cust_acct_site_id =
                       hcasa_ship.cust_acct_site_id(+)
                   AND hcasa_ship.party_site_id = hps_ship.party_site_id(+)
                   AND hps_ship.location_id = hl_ship.location_id(+)
                   --AND hcasa_ship.cust_account_id = hca_ship.cust_account_id(+)
                   AND rct.ship_to_customer_id = hca_ship.cust_account_id(+)
                   AND hca_ship.party_id = hp_ship.party_id(+)
                   AND rct.term_id = rtld.term_id(+)
                   AND rct.cust_trx_type_id = tt.cust_trx_type_id
                   AND rct.org_id = tt.org_id
                   AND tt.TYPE = arl.lookup_code
                   AND arl.lookup_type = 'INV/CM'
                   AND rct.term_id = rt.term_id(+)
                   AND DECODE (p_customer_id, NULL, 1, hca.cust_account_id) IN
                           (SELECT c1.cust_account_id    --, c1.account_number
                              FROM hz_cust_accounts c1
                             WHERE SUBSTR (
                                       c1.account_number,
                                       1,
                                       INSTR (c1.account_number, '-', 1) - 1) =
                                   (SELECT c2.account_number
                                      FROM hz_cust_accounts c2
                                     WHERE c2.cust_account_id = p_customer_id)
                            UNION
                            SELECT hca.cust_account_id  --, hca.account_number
                              FROM hz_cust_accounts hca, hz_cust_acct_sites_all hcasa
                             WHERE     hca.cust_account_id = p_customer_id
                                   AND hca.cust_account_id =
                                       hcasa.cust_account_id
                                   AND hcasa.org_id =
                                       NVL (p_org_id, hcasa.org_id)
                                   AND hca.status = 'A'
                                   AND hcasa.status = 'A'
                            UNION
                            SELECT 1
                              FROM DUAL
                             WHERE p_customer_id IS NULL)
                   AND validate_invoice (rct.org_id,
                                         rct.customer_trx_id,
                                         ps.class) =
                       1                            -- Added as per CCR0009859
            --   AND rct.trx_number = '9114063'
            --   AND hp.party_id = nbc.party_id
            --Open Invoices Query - END
            UNION ALL
              --On Account Query - START
              SELECT cr.receipt_number invoice_number          --InvoiceNumber
                                                     ,
                     -1 * cr.amount invoice_amount             --InvoiceAmount
                                                  ,
                     -1 * SUM (app.amount_applied) open_amount    --OpenAmount
                                                              ,
                     0.00 discount_amount                     --DiscountAmount
                                         ,
                     0.00 freight_amount                       --FreightAmount
                                        ,
                     0.00 tax_amount                               --TaxAmount
                                    ,
                     cr.receipt_date invoice_date --InvoiceDate --format data while creating file(TO_CHAR(date, 'MM/DD/YYYY'))
                                                 ,
                     NULL po_number                                 --PONumber
                                   ,
                     NULL statement_number                   --StatementNumber
                                          ,
                     0.00 statement_amount                   --StatementAmount
                                          ,
                     CASE
                         WHEN REGEXP_COUNT (hca.account_number, '-', 1,
                                            'i') > 0
                         THEN
                             SUBSTR (hca.account_number,
                                     1,
                                     INSTR (hca.account_number, '-', 1) - 1)
                         ELSE
                             hca.account_number
                     END nonbrand_customer_number --ParentCustomerNumber --Non-Brand Customer Number
                                                 --      ,(
                                                 --       SELECT hca_nb.account_number
                                                 --          FROM apps.hz_cust_accounts hca_nb
                                                 --         WHERE 1=1
                                                 --           AND hca_nb.attribute1 = 'ALL BRAND'
                                                 --           AND hca_nb.attribute13 = 'NON-BRAND'
                                                 --           AND hca_nb.status = 'A'
                                                 --           AND hca_nb.party_id = hp.party_id
                                                 --           AND ROWNUM=1
                                                 --       ) nonbrand_customer_number --ParentCustomerNumber --Comment this column
                                                 ,
                     hca.account_number bill_to_customer_number --CustomerNumber
                                                               ,
                     hp.party_name bill_to_customer_name        --CustomerName
                                                        ,
                     hl.address1 bill_to_address1 --CustomerAddress1 --Bill TO Address1
                                                 ,
                     hl.address2 bill_to_address2 --CustomerAddress2 --Bill To Address 2 and 3
                                                 ,
                     hl.address3 bill_to_address3 --CustomerAddress2 --Bill To Address 2 and 3
                                                 ,
                     hl.address4 bill_to_address4 --bill_to_address4 --No Mapping
                                                 ,
                     hl.city bill_to_city        --CustomerCity --Bill To City
                                         ,
                     NVL (hl.state, hl.province) bill_to_state_or_prov --CustomerState --Bill To State or Province
                                                                      ,
                     hl.postal_code bill_to_zip_code --CustomerZip  --Bill To Zip Code
                                                    ,
                     0.00 discounted_amount --CustomMoney1 --Discounted Amount: Inv line amount less available discount --To be calculated
                                           --,0.00 custom_money2 --CustomMoney2 --No Mapping (Send 0.00 for this field)
                                           ,
                     hl.country bill_to_country --CustomField1  --Bill To Country
                                               ,
                     'ONACCOUNT' document_type  --CustomField2 --Document Type
                                              ,
                     NULL sales_order_number --CustomField3 --SO Number (Write a function to concatenate SO# from RCT lines table)
                                            ,
                     NULL bill_of_lading --CustomField4 --Bill Of Lading --Need clarification
                                        ,
                     NULL buying_agent_group_num --CustomField5 --Buying Agent/Group Number --x_cpo_acc --Need Clarification --
                                                ,
                     NULL buying_membership_num --CustomField6 --Buying Membership Number --Logic to derive  - TBD
                                               ,
                     hou.name operating_unit --CustomField7 --Operating Unit Name
                                            ,
                     NULL ship_to_customer_number --CustomField8 --Ship To Customer Number
                                                 ,
                     NULL ship_to_customer_name --CustomField9 --Ship To Customer Name
                                               ,
                     NULL ship_to_address1  --CustomField10 --Ship To address1
                                          ,
                     NULL ship_to_address2 --CustomField11 --Ship To address 2 and 3
                                          ,
                     NULL ship_to_address3 --CustomField11 --Ship To address 2 and 3
                                          ,
                     NULL ship_to_address4                        --No Mapping
                                          ,
                     NULL ship_to_city          --CustomField12 --Ship To City
                                      ,
                     NULL ship_to_state_or_prov --CustomField13 --Ship To State/Province
                                               ,
                     NULL ship_to_zip_code  --CustomField14 --Ship To Zip Code
                                          ,
                     NULL ship_to_country    --CustomField15 --Ship To Country
                                         ,
                     cr.currency_code invoice_currency_code --CustomField16 --Currency Code
                                                           ,
                     NULL payment_term          --CustomField17 --Payment Term
                                      ,
                     NULL consolidated_invoice_number --CustomField18 --Consolidated Inv #
                                                     ,
                     NULL record_identifier --CustomField18 --Dummy Record Identifier to be sent in CustomField18
                                           --,NULL customfield19 --No Mapping
                                           --,NULL customfield20 --No Mapping
                                           ,
                     cr.org_id,
                     app.customer_trx_id,
                     NULL cust_trx_type_id,
                     cr.cash_receipt_id,
                     cr.pay_from_customer bill_to_customer_id,
                     cr.customer_site_use_id bill_to_site_use_id,
                     NULL ship_to_site_use_id,
                     NULL payment_term_id
                FROM apps.ar_receivable_applications_all app, apps.ar_cash_receipts_all cr, apps.fnd_flex_value_sets ffvs,
                     apps.fnd_flex_values ffv, apps.ar_payment_schedules_all ps_inv, hz_cust_accounts hca,
                     hz_parties hp, apps.hz_cust_site_uses_all hcsua, apps.hz_cust_acct_sites_all hcasa,
                     apps.hz_party_sites hps, apps.hz_locations hl, apps.hr_operating_units hou
               WHERE     1 = 1
                     AND 'Y' = NVL (p_include_receipts, 'Y') --Get OnAccount details only if this parameter is 'Yes'
                     AND app.display = 'Y'
                     AND app.cash_receipt_id = cr.cash_receipt_id
                     AND app.org_id = cr.org_id
                     AND app.org_id = NVL (p_org, app.org_id)
                     AND app.applied_payment_schedule_id =
                         ps_inv.payment_schedule_id
                     AND ffvs.flex_value_set_id = ffv.flex_value_set_id
                     AND ffvs.flex_value_set_name =
                         'XXDOAR_B2B_OPERATING_UNITS'
                     AND ffv.enabled_flag = 'Y'
                     AND NVL (ffv.start_date_active, SYSDATE) <= SYSDATE
                     AND NVL (ffv.end_date_active, SYSDATE + 1) > SYSDATE
                     AND cr.org_id = TO_NUMBER (ffv.flex_value)
                     AND ps_inv.status = 'OP'
                     AND ps_inv.payment_schedule_id = -1 --On Account (ON_ACC)---4 --Claims (CLAIM_INV)
                     AND NVL (app.amount_applied, 0) <> 0
                     AND app.application_type = 'CASH'
                     AND app.status = 'ACC'                       --On Account
                     AND cr.pay_from_customer = hca.cust_account_id
                     AND hca.party_id = hp.party_id
                     AND cr.customer_site_use_id = hcsua.site_use_id
                     AND cr.org_id = hcsua.org_id
                     AND hcsua.cust_acct_site_id = hcasa.cust_acct_site_id
                     AND hcasa.party_site_id = hps.party_site_id
                     AND hps.location_id = hl.location_id
                     AND cr.org_id = hou.organization_id
                     AND DECODE (p_customer_id, NULL, 1, hca.cust_account_id) IN
                             (SELECT c1.cust_account_id  --, c1.account_number
                                FROM hz_cust_accounts c1
                               WHERE SUBSTR (
                                         c1.account_number,
                                         1,
                                         INSTR (c1.account_number, '-', 1) - 1) =
                                     (SELECT c2.account_number
                                        FROM hz_cust_accounts c2
                                       WHERE c2.cust_account_id = p_customer_id)
                              UNION
                              SELECT hca.cust_account_id --, hca.account_number
                                FROM hz_cust_accounts hca, hz_cust_acct_sites_all hcasa
                               WHERE     hca.cust_account_id = p_customer_id
                                     AND hca.cust_account_id =
                                         hcasa.cust_account_id
                                     AND hcasa.org_id =
                                         NVL (p_org_id, hcasa.org_id)
                                     AND hca.status = 'A'
                                     AND hcasa.status = 'A'
                              UNION
                              SELECT 1
                                FROM DUAL
                               WHERE p_customer_id IS NULL)
            --   AND cr.receipt_number in ('WT 3100021287','007663')
            --   AND cr.cash_receipt_id = 3534577
            GROUP BY cr.receipt_number,
                     cr.amount,
                     cr.receipt_date,
                     CASE
                         WHEN REGEXP_COUNT (hca.account_number, '-', 1,
                                            'i') > 0
                         THEN
                             SUBSTR (hca.account_number,
                                     1,
                                     INSTR (hca.account_number, '-', 1) - 1)
                         ELSE
                             hca.account_number
                     END,
                     hca.account_number,
                     hp.party_name,
                     hl.address1,
                     hl.address2,
                     hl.address3,
                     hl.address4,
                     hl.city,
                     NVL (hl.state, hl.province),
                     hl.postal_code,
                     hl.country,
                     hou.name,
                     cr.currency_code,
                     cr.org_id,
                     app.customer_trx_id,
                     cr.cash_receipt_id,
                     cr.pay_from_customer,
                     cr.customer_site_use_id
              HAVING SUM (app.amount_applied) <> 0      --Added for CCR0007216
            --On Account Query - END
            UNION ALL
              --Cash Claims Query - START
              SELECT cr.receipt_number invoice_number          --InvoiceNumber
                                                     ,
                     -1 * cr.amount invoice_amount             --InvoiceAmount
                                                  ,
                     -1 * SUM (app.amount_applied) open_amount    --OpenAmount
                                                              ,
                     0.00 discount_amount                     --DiscountAmount
                                         ,
                     0.00 freight_amount                       --FreightAmount
                                        ,
                     0.00 tax_amount                               --TaxAmount
                                    ,
                     cr.receipt_date invoice_date --InvoiceDate --format data while creating file(TO_CHAR(date, 'MM/DD/YYYY'))
                                                 ,
                     NULL po_number                                 --PONumber
                                   ,
                     NULL statement_number --StatementNumber --Do not send this field --Need clarification
                                          ,
                     0.00 statement_amount --StatementAmount --Do not send this field(If Yes, Send '0.00') --Need clarification
                                          ,
                     CASE
                         WHEN REGEXP_COUNT (hca.account_number, '-', 1,
                                            'i') > 0
                         THEN
                             SUBSTR (hca.account_number,
                                     1,
                                     INSTR (hca.account_number, '-', 1) - 1)
                         ELSE
                             hca.account_number
                     END nonbrand_customer_number --ParentCustomerNumber --Non-Brand Customer Number
                                                                    --      ,(
                                         --       SELECT hca_nb.account_number
                                 --          FROM apps.hz_cust_accounts hca_nb
                                                          --         WHERE 1=1
                              --           AND hca_nb.attribute1 = 'ALL BRAND'
                             --           AND hca_nb.attribute13 = 'NON-BRAND'
                                          --           AND hca_nb.status = 'A'
                                --           AND hca_nb.party_id = hp.party_id
                                                     --           AND ROWNUM=1
 --       ) nonbrand_customer_number --ParentCustomerNumber --Comment this column
                     ,
                     hca.account_number bill_to_customer_number --CustomerNumber
                                                               ,
                     hp.party_name bill_to_customer_name        --CustomerName
                                                        ,
                     hl.address1 bill_to_address1 --CustomerAddress1 --Bill TO Address1
                                                 ,
                     hl.address2 bill_to_address2 --CustomerAddress2 --Bill To Address 2 and 3
                                                 ,
                     hl.address3 bill_to_address3 --CustomerAddress2 --Bill To Address 2 and 3
                                                 ,
                     hl.address4 bill_to_address4 --bill_to_address4 --No Mapping
                                                 ,
                     hl.city bill_to_city        --CustomerCity --Bill To City
                                         ,
                     NVL (hl.state, hl.province) bill_to_state_or_prov --CustomerState --Bill To State or Province
                                                                      ,
                     hl.postal_code bill_to_zip_code --CustomerZip  --Bill To Zip Code
                                                    ,
                     0.00 discounted_amount --CustomMoney1 --Discounted Amount: Inv line amount less available discount --To be calculated
                                           --,0.00 custom_money2 --CustomMoney2 --No Mapping (Send 0.00 for this field)
                                           ,
                     hl.country bill_to_country --CustomField1  --Bill To Country
                                               ,
                     'CASHCLAIM' document_type  --CustomField2 --Document Type
                                              ,
                     NULL sales_order_number --CustomField3 --SO Number (Write a function to concatenate SO# from RCT lines table)
                                            ,
                     NULL bill_of_lading --CustomField4 --Bill Of Lading --Need clarification
                                        ,
                     NULL buying_agent_group_num --CustomField5 --Buying Agent/Group Number --x_cpo_acc --Need Clarification --
                                                ,
                     NULL buying_membership_num --CustomField6 --Buying Membership Number --Logic to derive  - TBD
                                               ,
                     hou.name operating_unit --CustomField7 --Operating Unit Name
                                            ,
                     NULL ship_to_customer_number --Customfield8 --Ship To Customer Number
                                                 ,
                     NULL ship_to_customer_name --Customfield9 --Ship To Customer Name--      ,NULL customfield17 --No Mapping
                                               ,
                     NULL ship_to_address1  --CustomField10 --Ship To address1
                                          ,
                     NULL ship_to_address2 --CustomField11 --Ship To address 2 and 3
                                          ,
                     NULL ship_to_address3 --CustomField11 --Ship To address 2 and 3
                                          ,
                     NULL ship_to_address4                        --No Mapping
                                          ,
                     NULL ship_to_city          --CustomField12 --Ship To City
                                      ,
                     NULL ship_to_state_or_prov --CustomField13 --Ship To State/Province
                                               ,
                     NULL ship_to_zip_code  --CustomField14 --Ship To Zip Code
                                          ,
                     NULL ship_to_country    --CustomField15 --Ship To Country
                                         ,
                     cr.currency_code invoice_currency_code --CustomField16 --Currency Code
                                                           ,
                     NULL payment_term          --CustomField17 --Payment Term
                                      ,
                     NULL consolidated_invoice_number --CustomField18 --Consolidated Inv #
                                                     ,
                     NULL record_identifier --CustomField18 --Dummy Record Identifier to be sent in CustomField18
                                      --      ,NULL customfield19 --No Mapping
                                      --      ,NULL customfield20 --No Mapping
                     ,
                     cr.org_id,
                     app.customer_trx_id,
                     NULL cust_trx_type_id,
                     cr.cash_receipt_id,
                     cr.pay_from_customer bill_to_customer_id,
                     cr.customer_site_use_id bill_to_site_use_id,
                     NULL ship_to_site_use_id,
                     NULL payment_term_id
                FROM apps.ar_receivable_applications_all app, apps.ar_cash_receipts_all cr, apps.fnd_flex_value_sets ffvs,
                     apps.fnd_flex_values ffv, apps.ar_payment_schedules_all ps_inv, hz_cust_accounts hca,
                     hz_parties hp, apps.hz_cust_site_uses_all hcsua, apps.hz_cust_acct_sites_all hcasa,
                     apps.hz_party_sites hps, apps.hz_locations hl, apps.hr_operating_units hou
               WHERE     1 = 1
                     AND 'Y' = NVL (p_include_receipts, 'Y') --Get CashClaim details only if this parameter is 'Yes'
                     AND app.org_id = NVL (p_org, app.org_id) --Operating Unit Parameter
                     AND app.display = 'Y'
                     AND app.cash_receipt_id = cr.cash_receipt_id
                     AND app.org_id = cr.org_id
                     AND app.applied_payment_schedule_id =
                         ps_inv.payment_schedule_id
                     AND ffvs.flex_value_set_id = ffv.flex_value_set_id
                     AND ffvs.flex_value_set_name =
                         'XXDOAR_B2B_OPERATING_UNITS'
                     AND ffv.enabled_flag = 'Y'
                     AND NVL (ffv.start_date_active, SYSDATE) <= SYSDATE
                     AND NVL (ffv.end_date_active, SYSDATE + 1) > SYSDATE
                     AND cr.org_id = TO_NUMBER (ffv.flex_value)
                     AND ps_inv.payment_schedule_id = -4 --Claims (CLAIM_INV)--     -1 --On Account (ON_ACC)
                     AND app.application_type = 'CASH'
                     AND app.status = 'OTHER ACC'                --Cash Claims
                     AND app.amount_applied <> 0
                     AND ps_inv.status = 'OP'
                     AND cr.pay_from_customer = hca.cust_account_id
                     AND hca.party_id = hp.party_id
                     AND cr.customer_site_use_id = hcsua.site_use_id
                     AND cr.org_id = hcsua.org_id
                     AND hcsua.cust_acct_site_id = hcasa.cust_acct_site_id
                     AND hcasa.party_site_id = hps.party_site_id
                     AND hps.location_id = hl.location_id
                     AND cr.org_id = hou.organization_id
                     AND DECODE (p_customer_id, NULL, 1, hca.cust_account_id) IN
                             (SELECT c1.cust_account_id  --, c1.account_number
                                FROM hz_cust_accounts c1
                               WHERE SUBSTR (
                                         c1.account_number,
                                         1,
                                         INSTR (c1.account_number, '-', 1) - 1) =
                                     (SELECT c2.account_number
                                        FROM hz_cust_accounts c2
                                       WHERE c2.cust_account_id = p_customer_id)
                              UNION
                              SELECT hca.cust_account_id --, hca.account_number
                                FROM hz_cust_accounts hca, hz_cust_acct_sites_all hcasa
                               WHERE     hca.cust_account_id = p_customer_id
                                     AND hca.cust_account_id =
                                         hcasa.cust_account_id
                                     AND hcasa.org_id =
                                         NVL (p_org_id, hcasa.org_id)
                                     AND hca.status = 'A'
                                     AND hcasa.status = 'A'
                              UNION
                              SELECT 1
                                FROM DUAL
                               WHERE p_customer_id IS NULL)
            --   AND cr.cash_receipt_id = 66005
            --   AND cr.receipt_number = '007663'--'007663'
            GROUP BY cr.receipt_number,
                     cr.amount,
                     cr.receipt_date,
                     CASE
                         WHEN REGEXP_COUNT (hca.account_number, '-', 1,
                                            'i') > 0
                         THEN
                             SUBSTR (hca.account_number,
                                     1,
                                     INSTR (hca.account_number, '-', 1) - 1)
                         ELSE
                             hca.account_number
                     END,
                     hca.account_number,
                     hp.party_name,
                     hl.address1,
                     hl.address2,
                     hl.address3,
                     hl.address4,
                     hl.city,
                     NVL (hl.state, hl.province),
                     hl.postal_code,
                     hl.country,
                     hou.name,
                     cr.currency_code,
                     cr.org_id,
                     app.customer_trx_id,
                     cr.cash_receipt_id,
                     cr.pay_from_customer,
                     cr.customer_site_use_id         --Cash Claims Query - END
              HAVING SUM (app.amount_applied) <> 0      --Added for CCR0007216
                                                  ;

        --        CURSOR cust_cur
        --            IS
        --        SELECT c1.cust_account_id, c1.account_number
        --          FROM hz_cust_accounts c1
        --         WHERE SUBSTR(c1.account_number, 1, INSTR(c1.account_number, '-', 1)-1) = (SELECT c2.account_number
        --                                                                                     FROM hz_cust_accounts c2
        --                                                                                    WHERE c2.cust_Account_id = p_customer_id)
        --        UNION
        --        SELECT hca.cust_account_id, hca.account_number
        --          FROM hz_cust_accounts hca,
        --               hz_cust_acct_sites_all hcasa
        --         WHERE hca.cust_account_id = p_customer_id
        --           AND hca.cust_account_id = hcasa.cust_account_id
        --           AND hcasa.org_id = NVL(p_org_id, hcasa.org_id)
        --           AND hca.status = 'A'
        --           AND hcasa.status = 'A';

        --Define Variables
        lv_proc_name   VARCHAR2 (30) := 'INSERT_OPEN_AR_STAGING';
        lv_err_msg     VARCHAR2 (2000) := NULL;
        l_ret_code     NUMBER := 0;
        l_ret_msg      VARCHAR2 (2000) := NULL;
    BEGIN
        print_log (
            'Entered into procedure to Insert Open AR data into Staging table',
            'Y');
        --        print_log ('Printing Input Parameters');
        --        print_log('p_org_id                    :'||p_org_id);
        --        print_log('p_customer_id               :'||p_customer_id);
        --        print_log('p_include_receipts          :'||p_include_receipts);
        print_log (' ');
        print_log (
            'Opening the cursor and Inserting into Open AR Staging table - START',
            'Y');

        FOR open_ar_rec IN open_ar_cur (p_org_id)
        LOOP
            INSERT INTO xxdo.xxdoar_b2b_open_ar_stg (invoice_number, invoice_amount, open_amount, discount_amount, freight_amount, tax_amount, invoice_date, po_number, statement_number, statement_amount, nonbrand_customer_number, bill_to_customer_number, bill_to_customer_name, bill_to_address1, bill_to_address2, bill_to_address3, bill_to_address4, bill_to_city, bill_to_state_or_prov, bill_to_zip_code, bill_to_country, discounted_amount, document_type, sales_order_number, bill_of_lading, buying_agent_group_num, buying_membership_num, operating_unit, ship_to_customer_number, ship_to_customer_name, ship_to_address1, ship_to_address2, ship_to_address3, ship_to_address4, ship_to_city, ship_to_state_or_prov, ship_to_zip_code, ship_to_country, invoice_currency_code, payment_term, consolidated_invoice_number, record_identifier, process_flag, error_message, file_date_time, creation_date, created_by, last_update_date, last_updated_by, request_id, org_id, customer_trx_id, cust_trx_type_id, cash_receipt_id, bill_to_customer_id, bill_to_site_use_id, ship_to_site_use_id
                                                     , payment_term_id--            ,reprocess_flag
                                                                      )
                 VALUES (open_ar_rec.invoice_number           --invoice_number
                                                   , open_ar_rec.invoice_amount --invoice_amount
                                                                               , open_ar_rec.open_amount --open_amount
                                                                                                        , open_ar_rec.discount_amount --discount_amount
                                                                                                                                     , open_ar_rec.freight_amount --freight_amount
                                                                                                                                                                 , open_ar_rec.tax_amount --tax_amount
                                                                                                                                                                                         , open_ar_rec.invoice_date --invoice_date
                                                                                                                                                                                                                   , remove_junk (open_ar_rec.po_number) --po_number
                                                                                                                                                                                                                                                        , open_ar_rec.statement_number --statement_number
                                                                                                                                                                                                                                                                                      , open_ar_rec.statement_amount --statement_amount
                                                                                                                                                                                                                                                                                                                    , open_ar_rec.nonbrand_customer_number --nonbrand_customer_number
                                                                                                                                                                                                                                                                                                                                                          , open_ar_rec.bill_to_customer_number --bill_to_customer_number
                                                                                                                                                                                                                                                                                                                                                                                               , remove_junk (open_ar_rec.bill_to_customer_name) --bill_to_customer_name
                                                                                                                                                                                                                                                                                                                                                                                                                                                , remove_junk (open_ar_rec.bill_to_address1) --bill_to_address1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            , remove_junk (open_ar_rec.bill_to_address2) --bill_to_address2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        , remove_junk (open_ar_rec.bill_to_address3) --bill_to_address3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    , remove_junk (open_ar_rec.bill_to_address4) --bill_to_address4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                , remove_junk (open_ar_rec.bill_to_city) --bill_to_city
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        , remove_junk (open_ar_rec.bill_to_state_or_prov) --bill_to_state_or_prov
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         , remove_junk (open_ar_rec.bill_to_zip_code) --bill_to_zip_code
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     , remove_junk (open_ar_rec.bill_to_country) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                , open_ar_rec.discounted_amount --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               , open_ar_rec.document_type --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          , remove_junk (open_ar_rec.sales_order_number) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        , remove_junk (open_ar_rec.bill_of_lading) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  , remove_junk (open_ar_rec.buying_agent_group_num) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    , remove_junk (open_ar_rec.buying_membership_num) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     , remove_junk (open_ar_rec.operating_unit) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               , remove_junk (open_ar_rec.ship_to_customer_number) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  , remove_junk (open_ar_rec.ship_to_customer_name) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   , remove_junk (open_ar_rec.ship_to_address1) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               , remove_junk (open_ar_rec.ship_to_address2) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           , remove_junk (open_ar_rec.ship_to_address3) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       , remove_junk (open_ar_rec.ship_to_address4) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   , remove_junk (open_ar_rec.ship_to_city) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           , remove_junk (open_ar_rec.ship_to_state_or_prov) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            , remove_junk (open_ar_rec.ship_to_zip_code) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        , remove_junk (open_ar_rec.ship_to_country) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   , open_ar_rec.invoice_currency_code --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      , remove_junk (open_ar_rec.payment_term) --
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              , remove_junk (open_ar_rec.consolidated_invoice_number) --consolidated_invoice_number
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     , open_ar_rec.record_identifier, 'N' --process_flag
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         , NULL --error_message
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               , NULL --file_date_time
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     , SYSDATE --creation_date
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              , gn_user_id --created_by
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          , SYSDATE --last_update_date
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   , gn_user_id --last_updated_by
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               , gn_conc_request_id --request_id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   , open_ar_rec.org_id, open_ar_rec.customer_trx_id, open_ar_rec.cust_trx_type_id, open_ar_rec.cash_receipt_id, open_ar_rec.bill_to_customer_id, open_ar_rec.bill_to_site_use_id, open_ar_rec.ship_to_site_use_id
                         , open_ar_rec.payment_term_id--            ,p_reprocess_flag
                                                      );
        END LOOP;

        --Commiting the records
        COMMIT;
        print_log (
            'Opening the cursor and Inserting into Open AR Staging table - END',
            'Y');
        print_log (' ');
        print_log ('Calling OPEN_AR_DUMMY_RECORDS Procedure - START', 'Y');
        open_ar_dummy_records (gn_conc_request_id, l_ret_code, l_ret_msg);

        IF NVL (l_ret_code, 0) <> 0
        THEN
            x_ret_code      := l_ret_code;
            x_ret_message   := l_ret_msg;
        END IF;

        print_log ('OPEN_AR_DUMMY_RECORDS Procedure - END', 'Y');
        print_log (' ');
        print_log ('Calling UPD_SO_NUM_PRC Procedure - START', 'Y');
        --Calling the procedure to update the sales order number
        upd_so_num_prc (gn_conc_request_id);
        print_log ('UPD_SO_NUM_PRC Procedure - END', 'Y');
        print_log (' ');
        print_log ('Calling UPD_BUYING_GRP_DETAILS Procedure - START', 'Y');
        --Calling the procedure to update the Buying Group Details like Buying Group and Buying Membership
        upd_buying_grp_details (gn_conc_request_id);
        print_log ('UPD_BUYING_GRP_DETAILS Procedure - END', 'Y');
        print_log (' ');
        print_log (
            'Inserting the data into the Open AR Staging table completed successfully',
            'Y');
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_err_msg      :=
                SUBSTR (
                       'Error in '
                    || lv_proc_name
                    || ' procedure - Others:'
                    || SQLERRM,
                    1,
                    2000);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
            print_log (lv_err_msg);
    END insert_open_ar_staging;

    ----
    ----
    PROCEDURE statement_main (errbuf OUT VARCHAR2, retcode OUT VARCHAR2, p_org_id IN NUMBER, p_customer_id IN NUMBER, p_as_of_date IN VARCHAR2, p_bucket_name IN VARCHAR2
                              , p_file_path IN VARCHAR2)
    IS
        CURSOR c_orgs IS
            SELECT TO_NUMBER (RTRIM (LTRIM (ffv.flex_value))) org
              FROM fnd_flex_value_sets ffvs, fnd_flex_values ffv
             WHERE     1 = 1
                   AND ffvs.flex_value_set_id = ffv.flex_value_set_id
                   AND ffvs.flex_value_set_name =
                       'XXDOAR_B2B_OPERATING_UNITS'
                   AND TO_NUMBER (RTRIM (LTRIM (ffv.flex_value))) =
                       NVL (p_org_id,
                            TO_NUMBER (RTRIM (LTRIM (ffv.flex_value))))
                   AND ffv.enabled_flag = 'Y'
                   AND NVL (ffv.start_date_active, SYSDATE) <= SYSDATE
                   AND NVL (ffv.end_date_active, SYSDATE + 1) > SYSDATE;

        lv_ret_code        VARCHAR2 (30) := NULL;
        lv_ret_message     VARCHAR2 (2000) := NULL;
        --lv_file_name        VARCHAR2(100)   := TO_CHAR (gn_conc_request_id) || '_' || gv_time_stamp || '.txt';
        --lv_file_name        VARCHAR2(100)   := TO_CHAR (gn_conc_request_id) || '_' || gv_time_stamp;
        lv_file_name       VARCHAR2 (100) := gv_file_time_stamp;
        lv_func_currency   VARCHAR2 (30);
        ld_as_of_date      DATE;
        lb_file_exists     BOOLEAN;
        ln_file_length     NUMBER := NULL;
        ln_block_size      NUMBER := NULL;
        --        lv_file_prefix      VARCHAR2(30)    := 'STAT_';
        lv_file_prefix     VARCHAR2 (30) := 'DECKERS_STATEMENT_';
        lv_program_name    VARCHAR2 (30) := 'STATEMENTS_FILE';
    BEGIN
        --Print Input Parameters
        print_log ('Printing Input Parameters');
        print_log (' ');
        print_log ('p_org_id                         :' || p_org_id);
        print_log ('p_customer_id                    :' || p_customer_id);
        print_log ('p_as_of_date                     :' || p_as_of_date);
        print_log ('p_bucket_name                    :' || p_bucket_name);
        print_log ('p_file_path                      :' || p_file_path);
        print_log (' ');

        ld_as_of_date    := fnd_date.canonical_to_date (p_as_of_date);

        --Insert data into Staging tables
        lv_ret_code      := NULL;
        lv_ret_message   := NULL;

        FOR i IN c_orgs
        LOOP
            insert_stmt_staging (p_org_id => i.org, p_customer_id => p_customer_id, p_as_of_date => ld_as_of_date, p_bucket_name => p_bucket_name, p_fuctional_currency => lv_func_currency, x_ret_code => lv_ret_code
                                 , x_ret_message => lv_ret_message);

            print_log ('x_ret_code                      :' || lv_ret_code);
            print_log ('x_ret_message                   :' || lv_ret_message);

            IF lv_ret_code = gn_error
            THEN
                retcode   := gn_error;
                errbuf    := 'After insert_stmt_staging - ' || lv_ret_message;
                print_log (errbuf);
                raise_application_error (-20301, errbuf);
            END IF;
        END LOOP;

        --Write Data into Billing file
        lv_ret_code      := NULL;
        lv_ret_message   := NULL;

        write_stmt_file (
            p_conc_request_id   => gn_conc_request_id,
            p_as_of_date        => ld_as_of_date,
            p_file_path         => p_file_path,
            --p_file_name         => lv_file_name,
            p_file_name         => lv_file_prefix || lv_file_name,
            x_ret_code          => lv_ret_code,
            x_ret_message       => lv_ret_message);

        IF lv_ret_code = gn_error
        THEN
            retcode   := gn_error;
            errbuf    := 'After write_stmt_file - ' || lv_ret_message;
            print_log (errbuf);
            raise_application_error (-20002, errbuf);
        END IF;

        print_log ('CHECK_FILE_EXISTS procedure - START', 'Y');
        --Check file is created in the directory or not.
        check_file_exists (
            p_file_path     => p_file_path,
            p_file_name     => lv_file_prefix || lv_file_name || '.tmp',
            x_file_exists   => lb_file_exists,
            x_file_length   => ln_file_length,
            x_block_size    => ln_block_size);

        print_log ('CHECK_FILE_EXISTS procedure - END', 'Y');
        print_log (' ');

        IF lb_file_exists
        THEN
            print_log (
                'Statements File is successfully created in the directory.');
            --Call Write Completion File Procedure only if lb_file_exists is TRUE
            lv_ret_code      := NULL;
            lv_ret_message   := NULL;

            --print_log('Calling WRITE_COMPLETION_FILE procedure - START', 'Y');
            print_log (' ');
            print_log (
                'Calling UTL_FILE.frename procedure to rename file extension from .tmp to .txt - START',
                'Y');
            /*--Write Completion file for Automize to Pickup
            write_completion_file(
                                  p_file_path     => p_file_path,
                                  p_file_name     => lv_file_name,
                                  x_ret_code      => lv_ret_code,
                                  x_ret_message   => lv_ret_message
                                 );*/

            --Renaming the File Name from TMP to TXT
            ----New addition
            UTL_FILE.frename (
                src_location    => p_file_path,
                src_filename    => lv_file_prefix || lv_file_name || '.tmp',
                dest_location   => p_file_path,
                dest_filename   => lv_file_prefix || lv_file_name || '.txt',
                overwrite       => TRUE);
            ----

            --print_log('WRITE_COMPLETION_FILE procedure - END', 'Y');
            print_log (
                'Calling UTL_FILE.frename procedure to rename file extension from .tmp to .txt - END',
                'Y');
            print_log (' ');
            print_log ('Program Return Code and Return Message ');
            print_log ('x_ret_code                      :' || lv_ret_code);
            print_log ('x_ret_message                   :' || lv_ret_message);
            print_log (' ');

            IF lv_ret_code = gn_error
            THEN
                retcode          := gn_error;
                errbuf           :=
                       'Error in WRITE_COMPLETION_FILE procedure - '
                    || lv_ret_message;
                print_log (errbuf);

                --Reset the return variables
                lv_ret_code      := NULL;
                lv_ret_message   := NULL;
                raise_application_error (-20003, errbuf);
            END IF;
        ELSE
            --If lb_file_exists is FALSE then do the below
            lv_ret_message   :=
                SUBSTR (
                    'Statements file creation is not successful, Please check the issue.',
                    1,
                    2000);
            print_log (lv_ret_message);
            --Complete the program in error
            retcode   := gn_error;
            errbuf    := lv_ret_message;
        END IF;                                        --End of lb_file_exists

        --Resetting variables
        lv_ret_code      := NULL;
        lv_ret_message   := NULL;

        print_log ('Writing the Statements Program output into output file',
                   'Y');
        program_output (p_program_name => lv_program_name, p_conc_request_id => gn_conc_request_id, x_ret_code => lv_ret_code
                        , x_ret_message => lv_ret_message);
        print_log ('Return Code and Message from PROGRAM_OUTPUT procedure');
        print_log ('x_ret_code                      :' || lv_ret_code);
        print_log ('x_ret_message                   :' || lv_ret_message);

        IF lv_ret_code = gn_error
        THEN
            retcode   := gn_error;
            errbuf    :=
                'After writing output into out file - ' || lv_ret_message;
            print_log (errbuf);
            raise_application_error (-20304, errbuf);
        END IF;

        print_log (
            'Writing the Statements Program output into output file completed',
            'Y');
    EXCEPTION
        WHEN OTHERS
        THEN
            retcode   := gn_error;
            errbuf    := 'Error in statement_main - Others:' || SQLERRM;
            print_log (errbuf);
    END statement_main;

    ----
    ----
    PROCEDURE billing_main (errbuf OUT VARCHAR2, retcode OUT VARCHAR2, p_org_id IN NUMBER, p_trx_class IN VARCHAR2, p_cust_trx_type_id IN NUMBER, p_batch_source_id IN NUMBER, p_creation_date_from IN VARCHAR2, p_creation_date_to IN VARCHAR2, p_trx_date_from IN VARCHAR2, p_trx_date_to IN VARCHAR2, p_trx_num_from IN VARCHAR2, p_trx_num_to IN VARCHAR2, p_customer_id IN NUMBER, p_cc_email_id IN VARCHAR2, p_reprocess_flag IN VARCHAR2
                            , p_file_path IN VARCHAR2)
    IS
        --Define Variables
        lv_ret_code       VARCHAR2 (30) := NULL;
        lv_ret_message    VARCHAR2 (2000) := NULL;
        --lv_file_name        VARCHAR2(100)   := TO_CHAR(gn_conc_request_id) || '_' || gv_time_stamp || '.txt';
        lv_file_name      VARCHAR2 (100) := gv_file_time_stamp;
        lb_file_exists    BOOLEAN;
        ln_file_length    NUMBER := NULL;
        ln_block_size     NUMBER := NULL;
        --lv_file_prefix      VARCHAR2(30)    := 'BILLING_'; --Commented by Kranthi on 20Dec2017
        lv_file_prefix    VARCHAR2 (30) := 'DECKERS_BILLING_'; --Added by Kranthi on 20Dec2017
        lv_program_name   VARCHAR2 (30) := 'BILLING_FILE';
    BEGIN
        --Print Input Parameters
        print_log ('Printing Input Parameters');
        print_log (' ');
        print_log ('p_org_id                         :' || p_org_id);
        print_log ('p_trx_class                      :' || p_trx_class);
        print_log (
            'p_cust_trx_type_id               :' || p_cust_trx_type_id);
        print_log ('p_trx_source_id                  :' || p_batch_source_id);
        print_log (
            'p_creation_date_from             :' || p_creation_date_from);
        print_log (
            'p_creation_date_to               :' || p_creation_date_to);
        print_log ('p_trx_date_from                  :' || p_trx_date_from);
        print_log ('p_trx_date_to                    :' || p_trx_date_to);
        print_log ('p_trx_num_from                   :' || p_trx_num_from);
        print_log ('p_trx_num_to                     :' || p_trx_num_to);
        print_log ('p_customer_id                    :' || p_customer_id);
        print_log ('p_reprocess_flag                 :' || p_reprocess_flag);
        print_log ('p_file_path                      :' || p_file_path);
        print_log (' ');

        --Insert data into Staging tables
        insert_billing_staging (p_org_id => p_org_id, p_trx_class => p_trx_class, p_batch_source_id => p_batch_source_id, p_cust_trx_type_id => p_cust_trx_type_id, p_creation_date_from => p_creation_date_from, p_creation_date_to => p_creation_date_to, p_trx_date_from => p_trx_date_from, p_trx_date_to => p_trx_date_to, p_trx_num_from => p_trx_num_from, p_trx_num_to => p_trx_num_to, p_customer_id => p_customer_id, p_cc_email_id => p_cc_email_id, p_reprocess_flag => p_reprocess_flag, p_file_path => p_file_path, x_ret_code => lv_ret_code
                                , x_ret_message => lv_ret_message);

        IF lv_ret_code = gn_error
        THEN
            retcode   := gn_error;
            errbuf    := 'After insert_billing_staging - ' || lv_ret_message;
            print_log (errbuf);
            raise_application_error (-20001, errbuf);
        END IF;

        lv_ret_code      := NULL;
        lv_ret_message   := NULL;

        --Write Data into Billing file
        write_billing_file (
            p_conc_request_id   => gn_conc_request_id,
            p_file_path         => p_file_path,
            p_file_name         => lv_file_prefix || lv_file_name,
            x_ret_code          => lv_ret_code,
            x_ret_message       => lv_ret_message);

        IF lv_ret_code = gn_error
        THEN
            retcode   := gn_error;
            errbuf    := 'After write_billing_file - ' || lv_ret_message;
            print_log (errbuf);
            raise_application_error (-20002, errbuf);
        END IF;

        print_log ('CHECK_FILE_EXISTS procedure - START', 'Y');
        --Check file is created in the directory or not.
        check_file_exists (
            p_file_path     => p_file_path,
            p_file_name     => lv_file_prefix || lv_file_name || '.tmp',
            x_file_exists   => lb_file_exists,
            x_file_length   => ln_file_length,
            x_block_size    => ln_block_size);

        print_log ('CHECK_FILE_EXISTS procedure - END', 'Y');
        print_log (' ');

        IF lb_file_exists
        THEN
            print_log (
                'Billing File is successfully created in the directory.');
            --Call Write Completion File Procedure only if lb_file_exists is TRUE
            lv_ret_code      := NULL;
            lv_ret_message   := NULL;

            /*print_log('Calling WRITE_COMPLETION_FILE procedure - START', 'Y');
            --Write Completion file for Automize to Pickup
            write_completion_file(
                                  p_file_path     => p_file_path,
                                  p_file_name     => lv_file_name,
                                  x_ret_code      => lv_ret_code,
                                  x_ret_message   => lv_ret_message
                                 );
            print_log('WRITE_COMPLETION_FILE procedure - END', 'Y');*/
            print_log (' ');
            print_log (
                'Calling UTL_FILE.frename procedure to rename file extension from .tmp to .txt - START',
                'Y');
            --Renaming the File Name from TMP to TXT
            ----New addition
            UTL_FILE.frename (
                src_location    => p_file_path,
                src_filename    => lv_file_prefix || lv_file_name || '.tmp',
                dest_location   => p_file_path,
                dest_filename   => lv_file_prefix || lv_file_name || '.txt',
                overwrite       => TRUE);
            ----

            print_log (
                'Calling UTL_FILE.frename to rename file extension from .tmp to .txt procedure - END',
                'Y');

            print_log (' ');
            print_log ('Program Return Code and Return Message ');
            print_log ('x_ret_code                      :' || lv_ret_code);
            print_log ('x_ret_message                   :' || lv_ret_message);
            print_log (' ');

            IF lv_ret_code = gn_error
            THEN
                retcode          := gn_error;
                errbuf           :=
                       'Error in WRITE_COMPLETION_FILE procedure - '
                    || lv_ret_message;
                print_log (errbuf);

                --Reset the return variables
                lv_ret_code      := NULL;
                lv_ret_message   := NULL;
                raise_application_error (-20003, errbuf);
            END IF;
        ELSE
            --If lb_file_exists is FALSE then do the below
            lv_ret_message   :=
                SUBSTR (
                    'Billing file creation is not successful, Please check the issue.',
                    1,
                    2000);
            print_log (lv_ret_message);
            --Complete the program in error
            retcode   := gn_error;
            errbuf    := lv_ret_message;
        END IF;                                        --End of lb_file_exists

        --Resetting variables
        lv_ret_code      := NULL;
        lv_ret_message   := NULL;

        print_log ('Writing the Billing Program output into output file',
                   'Y');
        program_output (p_program_name => lv_program_name, p_conc_request_id => gn_conc_request_id, x_ret_code => lv_ret_code
                        , x_ret_message => lv_ret_message);
        print_log ('Return Code and Message from PROGRAM_OUTPUT procedure');

        lv_ret_code      := NULL;
        lv_ret_message   := NULL;

        --        --Write Completion file for Automize to Pickup
        --        write_completion_file (p_file_path     => p_file_path,
        --                               p_file_name     => lv_file_name,
        --                               x_ret_code      => lv_ret_code,
        --                               x_ret_message   => lv_ret_message);

        print_log ('x_ret_code                      :' || lv_ret_code);
        print_log ('x_ret_message                   :' || lv_ret_message);

        IF lv_ret_code = gn_error
        THEN
            retcode   := gn_error;
            errbuf    :=
                'After writing output into out file - ' || lv_ret_message;
            print_log (errbuf);
            raise_application_error (-20003, errbuf);
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            retcode   := gn_error;
            errbuf    := 'Error in Billing_main - Others:' || SQLERRM;
            print_log (errbuf);
    END billing_main;

    ----
    ----
    PROCEDURE open_ar_main (errbuf OUT VARCHAR2, retcode OUT VARCHAR2, p_org_id IN NUMBER, p_customer_id IN NUMBER, p_include_receipts IN VARCHAR2, p_debug_mode IN VARCHAR2
                            , p_file_path IN VARCHAR2)
    IS
        --Local Variables
        lv_proc_name      VARCHAR2 (30) := 'OPEN_AR_MAIN';
        lv_program_name   VARCHAR2 (30) := 'OPEN_AR_FILE';
        lb_file_exists    BOOLEAN;
        ln_file_length    NUMBER := NULL;
        ln_block_size     NUMBER := NULL;
        ln_ret_code       NUMBER := NULL;
        lv_ret_message    VARCHAR2 (2000) := NULL;
        lv_err_msg        VARCHAR2 (2000) := NULL;
        --lv_file_name     VARCHAR2 (100)  := TO_CHAR (gn_conc_request_id) || '_' || gv_time_stamp || '.txt';
        --lv_file_name        VARCHAR2(100)   := TO_CHAR (gn_conc_request_id) || '_' || gv_time_stamp;
        lv_file_name      VARCHAR2 (100) := gv_file_time_stamp;
        lv_truc_stmt      VARCHAR2 (500) := NULL;
        lv_file_prefix    VARCHAR2 (30) := 'DECKERS_OPENAR_';
        lv_ret_code       VARCHAR2 (1) := NULL;
    BEGIN
        print_log ('Open AR Program Started', 'Y');
        print_log ('Printing Input Parameters');
        print_log (' ');
        print_log ('p_org_id                    :' || p_org_id);
        print_log ('p_customer_id               :' || p_customer_id);
        print_log ('p_include_receipts          :' || p_include_receipts);
        print_log ('p_debug_mode                :' || p_debug_mode);
        print_log ('p_file_path                 :' || p_file_path);
        print_log (' ');
        print_log ('Calling INSERT_OPEN_AR_STAGING procedure - START - ',
                   'Y');
        --Insert data into Open AR Staging table
        insert_open_ar_staging (p_org_id             => p_org_id,
                                p_customer_id        => p_customer_id,
                                p_include_receipts   => p_include_receipts,
                                p_file_path          => p_file_path,
                                x_ret_code           => ln_ret_code,
                                x_ret_message        => lv_ret_message);

        print_log ('INSERT_OPEN_AR_STAGING procedure - END', 'Y');
        print_log (' ');

        IF ln_ret_code = gn_error
        THEN
            retcode   := ln_ret_code;
            errbuf    :=
                SUBSTR (
                       'Error in INSERT_OPEN_AR_STAGING Procedure - '
                    || lv_ret_message,
                    1,
                    2000);
            print_log (errbuf);
            raise_application_error (-20001, errbuf);
        END IF;

        ln_ret_code      := NULL;
        lv_ret_message   := NULL;

        print_log (' ');
        print_log ('Calling WRITE_OPEN_AR_FILE procedure - START', 'Y');
        --Write Data into Open AR file
        write_open_ar_file (
            p_conc_request_id   => gn_conc_request_id,
            p_file_path         => p_file_path,
            p_file_name         => lv_file_prefix || lv_file_name,
            x_ret_code          => ln_ret_code,
            x_ret_message       => lv_ret_message);
        print_log ('WRITE_OPEN_AR_FILE procedure - END', 'Y');
        print_log (' ');

        IF ln_ret_code = gn_error
        THEN
            retcode   := gn_error;
            errbuf    := 'After write_open_ar_file - ' || lv_ret_message;
            print_log (errbuf);
            raise_application_error (-20002, errbuf);
        END IF;

        print_log ('CHECK_FILE_EXISTS procedure - START', 'Y');
        --Check file is created in the directory or not.
        check_file_exists (
            p_file_path     => p_file_path,
            p_file_name     => lv_file_prefix || lv_file_name || '.tmp',
            x_file_exists   => lb_file_exists,
            x_file_length   => ln_file_length,
            x_block_size    => ln_block_size);
        print_log ('CHECK_FILE_EXISTS procedure - END', 'Y');
        print_log (' ');

        IF lb_file_exists
        THEN
            print_log (
                'Open AR File is successfully created in the directory.');
            --Call Write Completion File Procedure only if lb_file_exists is TRUE
            ln_ret_code      := NULL;
            lv_ret_message   := NULL;

            /*print_log('Calling WRITE_COMPLETION_FILE procedure - START', 'Y');
            --Write Completion file for Automize to Pickup
            write_completion_file(
                                  p_file_path     => p_file_path,
                                  p_file_name     => lv_file_name,
                                  x_ret_code      => ln_ret_code,
                                  x_ret_message   => lv_ret_message
                                 );
            print_log('WRITE_COMPLETION_FILE procedure - END', 'Y');*/
            print_log (' ');
            print_log (
                'Calling UTL_FILE.frename procedure to rename file extension from .tmp to .txt - START',
                'Y');
            --Renaming the File Name from TMP to TXT
            ----New addition
            UTL_FILE.frename (
                src_location    => p_file_path,
                src_filename    => lv_file_prefix || lv_file_name || '.tmp',
                dest_location   => p_file_path,
                dest_filename   => lv_file_prefix || lv_file_name || '.txt',
                overwrite       => TRUE);
            ----
            print_log (
                'UTL_FILE.frename procedure to rename file extension from .tmp to .txt - END',
                'Y');

            print_log (' ');
            print_log ('Program Return Code and Return Message ');
            print_log ('x_ret_code                      :' || ln_ret_code);
            print_log ('x_ret_message                   :' || lv_ret_message);
            print_log (' ');

            IF ln_ret_code = gn_error
            THEN
                retcode   := gn_error;
                errbuf    :=
                       'Error in WRITE_COMPLETION_FILE procedure - '
                    || lv_ret_message;
                print_log (errbuf);
                raise_application_error (-20003, errbuf);
            END IF;
        ELSE
            --If lb_file_exists is FALSE then do the below
            lv_err_msg   :=
                SUBSTR (
                    'Open AR file creation is not successful, Please check the issue.',
                    1,
                    2000);
            print_log (lv_err_msg);
            --Complete the program in error
            retcode   := gn_error;
            errbuf    := lv_err_msg;
        END IF;                                        --End of lb_file_exists

        --Reset the return variables
        ln_ret_code      := NULL;
        lv_ret_message   := NULL;

        print_log ('Writing the Open AR Program output into output file',
                   'Y');
        program_output (p_program_name => lv_program_name, p_conc_request_id => gn_conc_request_id, x_ret_code => lv_ret_code
                        , x_ret_message => lv_ret_message);
        print_log (
            'Program Return Code and Return Message from PROGRAM_OUTPUT Procedure ');
        print_log ('x_ret_code                      :' || lv_ret_code);
        print_log ('x_ret_message                   :' || lv_ret_message);
        print_log (' ');

        IF lv_ret_code = gn_error
        THEN
            retcode   := gn_error;
            errbuf    :=
                'Error in PROGRAM_OUTPUT procedure - ' || lv_ret_message;
            print_log (errbuf);
            raise_application_error (-20004, errbuf);
        END IF;

        print_log (
            'Writing the Open AR Program output into output file completed',
            'Y');
        print_log ('Open AR Program Completed Successfully', 'Y');
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_err_msg   :=
                SUBSTR (
                       'Error in '
                    || lv_proc_name
                    || ' procedure - Others: '
                    || SQLERRM,
                    1,
                    2000);
            retcode   := gn_error;
            errbuf    := lv_err_msg;
            print_log (lv_err_msg);
    END open_ar_main;

    ----
    ----
    --This procedure checks if given file exists or not in the directory
    --Parameters
    --p_file_dir    --Directory to look for file --IN Parameter --Mandatory
    --p_file_name   --File to be checked in the directory --IN Parameter --Mandatory
    --x_file_exists --If file exists in directory, TRUE is returned else FALSE --OUT Parameter
    --x_file_lenght --If file exists return the length of the file in bytes else NULL --OUT Parameter
    --x_block_size  --If file exists return the filesystem block size in bytes else NULL --OUT Parameter
    PROCEDURE check_file_exists (p_file_path     IN     VARCHAR2,
                                 p_file_name     IN     VARCHAR2,
                                 x_file_exists      OUT BOOLEAN,
                                 x_file_length      OUT NUMBER,
                                 x_block_size       OUT BINARY_INTEGER)
    IS
        lv_proc_name     VARCHAR2 (30) := 'CHECK_FILE_EXISTS';
        lb_file_exists   BOOLEAN := FALSE;
        ln_file_length   NUMBER := NULL;
        ln_block_size    BINARY_INTEGER := NULL;
        lv_err_msg       VARCHAR2 (2000) := NULL;
    BEGIN
        --Checking if p_file_name file exists in p_file_dir directory
        --If exists, x_file_exists is true else false
        UTL_FILE.FGETATTR (location      => p_file_path,
                           filename      => p_file_name,
                           fexists       => lb_file_exists,
                           file_length   => ln_file_length,
                           block_size    => ln_block_size);
        x_file_exists   := lb_file_exists;
        x_file_length   := ln_file_length;
        x_block_size    := ln_block_size;
    EXCEPTION
        WHEN OTHERS
        THEN
            x_file_exists   := lb_file_exists;
            x_file_length   := ln_file_length;
            x_block_size    := ln_block_size;
            lv_err_msg      :=
                SUBSTR (
                       'When Others expection while checking file is created or not in '
                    || lv_proc_name
                    || ' procedure. Error is: '
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
    END check_file_exists;

    ----
    ----
    FUNCTION get_email_ids (p_email_lkp_name IN VARCHAR2--                          ,p_notif_type         IN  VARCHAR2
                                                        )
        RETURN VARCHAR2
    IS
        CURSOR recipients_cur IS
            SELECT ffvs.flex_value_set_name, ffv.description email_id
              FROM fnd_flex_value_sets ffvs, fnd_flex_values_vl ffv
             WHERE     1 = 1
                   AND ffvs.flex_value_set_name = p_email_lkp_name --'XXDO_B2B_OPEN_AR_EMAIL'
                   AND ffvs.flex_value_set_id = ffv.flex_value_set_id
                   AND ffv.enabled_flag = 'Y'
                   AND NVL (ffv.start_date_active, SYSDATE) <= SYSDATE
                   AND NVL (ffv.end_date_active, SYSDATE + 1) > SYSDATE;

        lv_email   VARCHAR2 (500) := NULL;
    BEGIN
        FOR recipients_rec IN recipients_cur
        LOOP
            lv_email   := lv_email || ',' || recipients_rec.email_id;
        END LOOP;

        IF (lv_email IS NOT NULL AND LENGTH (lv_email) > 1)
        THEN
            lv_email   := SUBSTR (lv_email, 2);
        ELSE
            lv_email   := gv_default_email;
        END IF;

        RETURN lv_email;
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_email   := gv_default_email;
            RETURN lv_email;
    END get_email_ids;

    ----
    ----
    --    FUNCTION get_default_email_id(
    --                                   p_def_email_value_set    IN  VARCHAR2
    --                                 ) RETURN VARCHAR2
    --    IS
    --        CURSOR recipients_cur
    --            IS
    --        SELECT ffvs.flex_value_set_name
    --              ,ffv.description email_id
    --          FROM fnd_flex_value_sets ffvs
    --              ,fnd_flex_values_vl ffv
    --         WHERE 1 = 1
    --           AND ffvs.flex_value_set_name = p_def_email_value_set--'XXDO_B2B_DEFAULT_EMAIL'
    --           AND ffvs.flex_value_set_id = ffv.flex_value_set_id
    --           AND ffv.enabled_flag = 'Y'
    --           AND ffv.enabled_flag = 'Y'
    --           AND NVL(ffv.start_date_active,SYSDATE) <= SYSDATE
    --           AND NVL(ffv.end_date_active,SYSDATE+1) > SYSDATE
    --           ;
    --
    --        lv_email        VARCHAR2(500)   :=  NULL;
    --
    --    BEGIN
    --        FOR recipients_rec IN recipients_cur
    --        LOOP
    --            lv_email := lv_email||','||recipients_rec.email_id;
    --        END LOOP;
    --        IF (
    --            lv_email IS NOT NULL AND
    --            LENGTH(lv_email) > 1
    --           )
    --        THEN
    --            lv_email := SUBSTR(lv_email, 2);
    --        ELSE
    --            lv_email := gv_default_email;
    --        END IF;
    --        RETURN lv_email;
    --
    --   EXCEPTION
    --      WHEN OTHERS THEN
    --         lv_email := gv_default_email;
    --         RETURN lv_email;
    --
    --    END get_default_email_id;

    ----
    ----
    PROCEDURE send_notification (p_program_name IN VARCHAR2, p_file_path IN VARCHAR2, p_conc_request_id IN NUMBER
                                 , p_email_lkp_name IN VARCHAR2, x_ret_code OUT NUMBER, x_ret_message OUT VARCHAR2)
    IS
        lv_proc_name          VARCHAR2 (30) := 'SEND_NOTIFICATION';
        lv_err_msg            VARCHAR2 (2000) := NULL;
        lv_logfile_name       VARCHAR2 (30) := NULL;
        lv_logfile_path       VARCHAR2 (255) := NULL;
        lv_outfile_name       VARCHAR2 (30) := NULL;
        lv_outfile_path       VARCHAR2 (255) := NULL;
        lv_status_code        VARCHAR2 (1) := NULL;
        lv_phase_code         VARCHAR2 (1) := NULL;
        lv_status_meaning     VARCHAR2 (80) := NULL;
        lv_phase_meaning      VARCHAR2 (80) := NULL;
        lv_notif_type         VARCHAR2 (30) := NULL;
        lv_file_path          VARCHAR2 (255) := NULL;
        lv_file_name          VARCHAR2 (30) := NULL;
        lv_email_ids          VARCHAR2 (500) := NULL;
        lv_email_sub          VARCHAR2 (2000) := NULL;
        lv_email_body         VARCHAR2 (2000) := NULL;
        ln_email_req_id       NUMBER := 0;
        l_req_return_status   BOOLEAN;
        lc_phase              VARCHAR2 (30) := NULL;
        lc_status             VARCHAR2 (30) := NULL;
        lc_dev_phase          VARCHAR2 (30) := NULL;
        lc_dev_status         VARCHAR2 (30) := NULL;
        lc_message            VARCHAR2 (30) := NULL;
    BEGIN
        print_log ('Parameters passed to Send Notifications Procedure');
        print_log (' ');
        print_log ('Program Name: ' || p_program_name);
        print_log ('Request ID: ' || p_conc_request_id);
        print_log ('Email Lookup Name: ' || p_email_lkp_name);
        print_log (' ');

        IF p_conc_request_id <> 0 OR p_conc_request_id IS NOT NULL
        THEN
            BEGIN
                SELECT SUBSTR (fcr.logfile_name, 1, INSTR (fcr.logfile_name, '/', -1) - 1) logfile_path, SUBSTR (fcr.logfile_name, INSTR (fcr.logfile_name, '/', -1) + 1) logfile_name, SUBSTR (fcr.outfile_name, 1, INSTR (fcr.outfile_name, '/', -1) - 1) outfile_path,
                       SUBSTR (fcr.outfile_name, INSTR (fcr.outfile_name, '/', -1) + 1) outfile_name, flv_s.lookup_code status_code, flv_s.meaning status_meaning,
                       flv_p.lookup_code phase_code, flv_p.meaning phase_meaning
                  INTO lv_logfile_path, lv_logfile_name, lv_outfile_path, lv_outfile_name,
                                      lv_status_code, lv_status_meaning, lv_phase_code,
                                      lv_phase_meaning
                  FROM fnd_concurrent_requests fcr, fnd_lookup_values flv_s, fnd_lookup_values flv_p
                 WHERE     1 = 1
                       AND fcr.status_code = flv_s.lookup_code
                       AND flv_s.lookup_type = 'CP_STATUS_CODE'
                       AND flv_s.enabled_flag = 'Y'
                       AND flv_s.view_application_id = 0
                       AND flv_s.language = 'US'
                       AND fcr.phase_code = flv_p.lookup_code
                       AND flv_p.lookup_type = 'CP_PHASE_CODE'
                       AND flv_p.enabled_flag = 'Y'
                       AND flv_p.view_application_id = 0
                       AND flv_p.language = 'US'
                       AND fcr.request_id = p_conc_request_id;
            EXCEPTION
                WHEN NO_DATA_FOUND
                THEN
                    NULL;
                WHEN OTHERS
                THEN
                    NULL;
            END;
        ELSE
            print_log ('Concurrent request id passed is null or zero');
            RETURN;
        END IF;

        --Based on the program status send success or failure email
        --Assigning the values variables which are passed as parameters to the email program
        IF lv_status_meaning = 'Normal'
        THEN
            lv_notif_type   := 'SUCCESS';
            lv_file_path    := lv_outfile_path;
            lv_file_name    := lv_outfile_name;
            lv_email_ids    := get_email_ids (p_email_lkp_name); --, lv_notif_type);
            lv_email_body   :=
                'Please see attached Output file for program Output';
        ELSE
            lv_notif_type   := 'ERROR';
            lv_file_path    := lv_logfile_path;
            lv_file_name    := lv_logfile_name;
            lv_email_ids    := get_email_ids (p_email_lkp_name); --, lv_notif_type);
            lv_email_body   :=
                'Please check the attached LOG file for program Errors/Warnings';
        END IF;

        IF p_program_name = 'OPEN_AR_FILE'
        THEN
            lv_email_sub   :=
                   lv_notif_type
                || ' - B2B - Open AR File Program Notification on '
                || gv_time_stamp;
        ELSIF p_program_name = 'STATEMENT_FILE'
        THEN
            lv_email_sub   :=
                   lv_notif_type
                || ' - B2B - Statements File Program Notification on '
                || gv_time_stamp;
        ELSIF p_program_name = 'BILLING_FILE'
        THEN
            lv_email_sub   :=
                   lv_notif_type
                || ' - B2B - Billing File Program Notification on '
                || gv_time_stamp;
        END IF;

        print_log ('lv_file_path: ' || lv_file_path);
        print_log ('lv_file_name: ' || lv_file_name);
        print_log ('lv_email_body: ' || lv_email_body);
        print_log ('lv_email_ids: ' || lv_email_ids);
        print_log ('lv_email_sub: ' || lv_email_sub);

        --Submit concurrent program to send an email
        ln_email_req_id   :=
            fnd_request.submit_request (application => 'XXDO', program => 'XXDOAR_B2B_SEND_NOTIFICATIONS', description => 'Send Email Notification', start_time => SYSDATE, sub_request => FALSE, argument1 => lv_file_path, argument2 => lv_file_name, argument3 => lv_email_body, argument4 => lv_email_ids
                                        , argument5 => lv_email_sub);
        COMMIT;

        IF ln_email_req_id = 0
        THEN
            --print_log('Send Email Notification concurrent request failed to submit', 'Y');
            lv_err_msg      :=
                SUBSTR (
                       'Send Email Notification concurrent request failed to submit. Please check SEND_NOTIFICATION procedure.'
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
        ELSE
            print_log (
                   'Successfully Submitted the Send Email Notification Concurrent Request with request ID: '
                || ln_email_req_id);
        END IF;

        IF ln_email_req_id > 0
        THEN
            LOOP
                --To make process execution to wait for 1st program to complete
                l_req_return_status   :=
                    fnd_concurrent.wait_for_request (
                        request_id   => ln_email_req_id,
                        INTERVAL     => 5 --Interval Number of seconds to wait between checks
                                         ,
                        max_wait     => 600 --Maximum number of seconds to wait for the request completion
                                           -- out arguments
                                           ,
                        phase        => lc_phase,
                        status       => lc_status,
                        dev_phase    => lc_dev_phase,
                        dev_status   => lc_dev_status,
                        MESSAGE      => lc_message);
                EXIT WHEN    UPPER (lc_phase) = 'COMPLETED'
                          OR UPPER (lc_status) IN
                                 ('CANCELLED', 'ERROR', 'TERMINATED');
            END LOOP;
        END IF;
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_err_msg      :=
                SUBSTR (
                       'When Others exception while sending notification in '
                    || lv_proc_name
                    || ' procedure. Error is: '
                    || SQLERRM,
                    1,
                    2000);
            print_log (lv_err_msg);
            x_ret_code      := gn_error;
            x_ret_message   := lv_err_msg;
    END send_notification;

    ----
    ----
    --This procedure is called from the SRS window
    --This is the wrapper program which submits the actual open ar program as a child request.
    PROCEDURE open_ar_wrapper (errbuf OUT VARCHAR2, retcode OUT VARCHAR2, p_org_id IN NUMBER, p_customer_id IN NUMBER, p_include_receipts IN VARCHAR2, p_debug_mode IN VARCHAR2
                               , p_file_path IN VARCHAR2)
    IS
        lv_proc_name            VARCHAR2 (30) := 'OPEN_AR_WRAPPER';
        lv_program_name         VARCHAR2 (30) := 'OPEN_AR_FILE';
        lv_req_data             VARCHAR2 (20) := NULL;
        ln_child_req_id         NUMBER := 0;
        ln_ret_code             NUMBER := NULL;
        lv_ret_message          VARCHAR2 (2000) := NULL;
        lv_err_msg              VARCHAR2 (2000) := NULL;
        lv_email_lkp_name       VARCHAR2 (30) := 'XXDO_B2B_OPEN_AR_EMAIL';
        ln_input_notif_req_id   NUMBER := 0;
        l_child_req_ret_sts     BOOLEAN;
        lc_phase                VARCHAR2 (30) := NULL;
        lc_status               VARCHAR2 (30) := NULL;
        lc_dev_phase            VARCHAR2 (30) := NULL;
        lc_dev_status           VARCHAR2 (30) := NULL;
        lc_message              VARCHAR2 (30) := NULL;
    BEGIN
        --        lv_req_data := apps.fnd_conc_global.request_data;
        --        --lv_req_data will be null for first time when parent is scanned by concurrent manager
        --        IF (lv_req_data IS NULL)
        --        THEN
        print_log ('Calling Open AR Program from Wrapper Program', 'Y');
        --Submit the concurrent program to Create Open AR File
        ln_child_req_id   :=
            fnd_request.submit_request (application => 'XXDO', program => 'XXDOAR_B2B_OPEN_AR_FILE', description => 'Create Open AR File', start_time => SYSDATE, sub_request => FALSE, argument1 => p_org_id, argument2 => p_customer_id, argument3 => p_include_receipts, argument4 => p_debug_mode
                                        , argument5 => p_file_path);
        COMMIT;

        IF ln_child_req_id = 0
        THEN
            print_log (
                'Create Open AR File concurrent request failed to submit',
                'Y');
            errbuf    :=
                'Create Open AR File concurrent request failed to submit. Please check the concurrent request submission of child open AR Program';
            retcode   := gn_error;
            RETURN;                                         --Exit the program
        ELSE
            print_log (
                   'Successfully Submitted the Create Open AR File Concurrent Request with request ID: '
                || ln_child_req_id);
        END IF;

        --If there are any requests to be submitted then PAUSE the parent request until child requests are completed.
        --Until unless the parent request is 'PAUSED', child requests will not run
        --            IF ln_child_req_id > 0
        --            THEN
        --                apps.fnd_conc_global.set_req_globals(
        --                                                     conc_status       => 'PAUSED'   --Parent request will be paused until all the child requests are completed
        --                                                    ,request_data      => TO_CHAR (ln_child_req_id)
        --                                                    );
        --            END IF;

        --        END IF;  --lv_req_data IF condition END

        IF ln_child_req_id > 0
        THEN
            LOOP
                --To make process execution to wait for 1st program to complete
                l_child_req_ret_sts   :=
                    fnd_concurrent.wait_for_request (
                        request_id   => ln_child_req_id,
                        INTERVAL     => 10 --Interval Number of seconds to wait between checks
                                          ,
                        max_wait     => 0 --3600 --Maximum number of seconds to wait for the request completion
                                         -- out arguments
                                         ,
                        phase        => lc_phase,
                        status       => lc_status,
                        dev_phase    => lc_dev_phase,
                        dev_status   => lc_dev_status,
                        MESSAGE      => lc_message);
                EXIT WHEN    UPPER (lc_phase) = 'COMPLETED'
                          OR UPPER (lc_status) IN
                                 ('CANCELLED', 'ERROR', 'TERMINATED');
            END LOOP;
        END IF;

        --Resuming the parent request after the child requests are completed and continuing with the next steps
        --        IF lv_req_data IS NOT NULL
        --        THEN
        print_log ('ln_child_req_id:' || ln_child_req_id);
        print_log (
            'Resuming the Open AR Wrapper Program after the actual Open AR program is completed',
            'Y');
        print_log (' ');
        print_log ('Calling the send notification procedure', 'Y');
        --Call the send notification procedure
        send_notification (p_program_name      => lv_program_name,
                           p_file_path         => p_file_path,
                           p_conc_request_id   => ln_child_req_id,
                           p_email_lkp_name    => lv_email_lkp_name,
                           x_ret_code          => ln_ret_code,
                           x_ret_message       => lv_ret_message);

        IF ln_ret_code = gn_error
        THEN
            retcode   := gn_error;
            errbuf    :=
                'Error in Send Notification Procedure - ' || lv_ret_message;
            print_log (errbuf);
            raise_application_error (-20003, errbuf);
        END IF;

        print_log ('Send notification procedure completed', 'Y');
        print_log (' ');
        --        END IF;
        print_log ('Open AR Wrapper Program completed successfully', 'Y');
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_err_msg   :=
                SUBSTR (
                       'Error in '
                    || lv_proc_name
                    || ' procedure - Others: '
                    || SQLERRM,
                    1,
                    2000);
            retcode   := gn_error;
            errbuf    := lv_err_msg;
            print_log (lv_err_msg);
    END open_ar_wrapper;

    ----
    ----
    --This procedure is called from the SRS window
    --This is the wrapper program which submits the actual Statements program as a child request.
    PROCEDURE statement_wrapper (errbuf OUT VARCHAR2, retcode OUT VARCHAR2, p_org_id IN NUMBER, p_customer_id IN NUMBER, p_as_of_date IN VARCHAR2, p_bucket_name IN VARCHAR2
                                 , p_file_path IN VARCHAR2)
    IS
        lv_proc_name            VARCHAR2 (30) := 'STATEMENT_WRAPPER';
        lv_program_name         VARCHAR2 (30) := 'STATEMENT_FILE';
        lv_req_data             VARCHAR2 (20) := NULL;
        ln_child_req_id         NUMBER := 0;
        ln_ret_code             NUMBER := NULL;
        lv_ret_message          VARCHAR2 (2000) := NULL;
        lv_err_msg              VARCHAR2 (2000) := NULL;
        lv_email_lkp_name       VARCHAR2 (30) := 'XXDO_B2B_STATEMENT_EMAIL';
        ln_input_notif_req_id   NUMBER := 0;
        l_child_req_ret_sts     BOOLEAN;
        lc_phase                VARCHAR2 (30) := NULL;
        lc_status               VARCHAR2 (30) := NULL;
        lc_dev_phase            VARCHAR2 (30) := NULL;
        lc_dev_status           VARCHAR2 (30) := NULL;
        lc_message              VARCHAR2 (30) := NULL;
    BEGIN
        --        lv_req_data := apps.fnd_conc_global.request_data;
        --        --lv_req_data will be null for first time when parent is scanned by concurrent manager
        --        IF (lv_req_data IS NULL)
        --        THEN
        print_log ('Calling Statements Program from Wrapper Program', 'Y');
        --Submit the concurrent program to Create Statements File
        ln_child_req_id   :=
            fnd_request.submit_request (application => 'XXDO', program => 'XXDOAR_B2B_STMT_FILE', description => 'Create Statements File', start_time => SYSDATE, sub_request => FALSE, argument1 => p_org_id, argument2 => p_customer_id, argument3 => p_as_of_date, argument4 => p_bucket_name
                                        , argument5 => p_file_path);
        COMMIT;

        IF ln_child_req_id = 0
        THEN
            print_log (
                'Create Statements File concurrent request failed to submit',
                'Y');
            errbuf    :=
                'Create Statements File concurrent request failed to submit. Please check the concurrent request submission of child Statements Program';
            retcode   := gn_error;
            RETURN;                                         --Exit the program
        ELSE
            print_log (
                   'Successfully Submitted the Create Statements File Concurrent Request with request ID: '
                || ln_child_req_id);
        END IF;

        --If there are any requests to be submitted then PAUSE the parent request until child requests are completed.
        --Until unless the parent request is 'PAUSED', child requests will not run
        --            IF ln_child_req_id > 0
        --            THEN
        --                apps.fnd_conc_global.set_req_globals(
        --                                                     conc_status       => 'PAUSED'   --Parent request will be paused until all the child requests are completed
        --                                                    ,request_data      => TO_CHAR (ln_child_req_id)
        --                                                    );
        --            END IF;

        --        END IF;  --lv_req_data IF condition END

        IF ln_child_req_id > 0
        THEN
            LOOP
                --To make process execution to wait for 1st program to complete
                l_child_req_ret_sts   :=
                    fnd_concurrent.wait_for_request (
                        request_id   => ln_child_req_id,
                        INTERVAL     => 10 --Interval Number of seconds to wait between checks
                                          ,
                        max_wait     => 0 --3600 --Maximum number of seconds to wait for the request completion
                                         -- out arguments
                                         ,
                        phase        => lc_phase,
                        status       => lc_status,
                        dev_phase    => lc_dev_phase,
                        dev_status   => lc_dev_status,
                        MESSAGE      => lc_message);
                EXIT WHEN    UPPER (lc_phase) = 'COMPLETED'
                          OR UPPER (lc_status) IN
                                 ('CANCELLED', 'ERROR', 'TERMINATED');
            END LOOP;
        END IF;

        --Resuming the parent request after the child requests are completed and continuing with the next steps
        --        IF lv_req_data IS NOT NULL
        --        THEN
        print_log ('ln_child_req_id:' || ln_child_req_id);
        print_log (
            'Resuming the Statements Wrapper Program after the actual Statements program is completed',
            'Y');
        print_log ('Calling the send notification procedure', 'Y');
        --Call the send notification procedure
        send_notification (p_program_name      => lv_program_name,
                           p_file_path         => p_file_path,
                           p_conc_request_id   => ln_child_req_id,
                           p_email_lkp_name    => lv_email_lkp_name,
                           x_ret_code          => ln_ret_code,
                           x_ret_message       => lv_ret_message);

        IF ln_ret_code = gn_error
        THEN
            retcode   := gn_error;
            errbuf    :=
                'Error in Send Notification Procedure - ' || lv_ret_message;
            print_log (errbuf);
            raise_application_error (-20003, errbuf);
        END IF;

        print_log ('Send notification procedure completed', 'Y');
        --        END IF;
        print_log ('Statements Wrapper Program completed successfully', 'Y');
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_err_msg   :=
                SUBSTR (
                       'Error in '
                    || lv_proc_name
                    || ' procedure - Others: '
                    || SQLERRM,
                    1,
                    2000);
            retcode   := gn_error;
            errbuf    := lv_err_msg;
            print_log (lv_err_msg);
    END statement_wrapper;

    ----
    ----
    --This procedure is called from the SRS window
    --This is the wrapper program which submits the actual Billing program as a child request.
    PROCEDURE billing_wrapper (errbuf OUT VARCHAR2, retcode OUT VARCHAR2, p_org_id IN NUMBER, p_trx_class IN VARCHAR2, p_cust_trx_type_id IN NUMBER, p_batch_source_id IN NUMBER, p_creation_date_from IN VARCHAR2, p_creation_date_to IN VARCHAR2, p_trx_date_from IN VARCHAR2, p_trx_date_to IN VARCHAR2, p_trx_num_from IN VARCHAR2, p_trx_num_to IN VARCHAR2, p_customer_id IN NUMBER, p_cc_email_id IN VARCHAR2, p_reprocess_flag IN VARCHAR2
                               , p_file_path IN VARCHAR2)
    IS
        lv_proc_name            VARCHAR2 (30) := 'BILLING_WRAPPER';
        lv_program_name         VARCHAR2 (30) := 'BILLING_FILE';
        lv_req_data             VARCHAR2 (20) := NULL;
        ln_child_req_id         NUMBER := 0;
        ln_ret_code             NUMBER := NULL;
        lv_ret_message          VARCHAR2 (2000) := NULL;
        lv_err_msg              VARCHAR2 (2000) := NULL;
        lv_email_lkp_name       VARCHAR2 (30) := 'XXDO_B2B_BILLING_EMAIL';
        ln_input_notif_req_id   NUMBER := 0;
        l_child_req_ret_sts     BOOLEAN;
        lc_phase                VARCHAR2 (30) := NULL;
        lc_status               VARCHAR2 (30) := NULL;
        lc_dev_phase            VARCHAR2 (30) := NULL;
        lc_dev_status           VARCHAR2 (30) := NULL;
        lc_message              VARCHAR2 (30) := NULL;
    BEGIN
        --        lv_req_data := apps.fnd_conc_global.request_data;
        --        --lv_req_data will be null for first time when parent is scanned by concurrent manager
        --        IF (lv_req_data IS NULL)
        --        THEN
        print_log ('Calling Billing Program from Wrapper Program', 'Y');
        --Submit the concurrent program to Create Open AR File
        ln_child_req_id   :=
            fnd_request.submit_request (application => 'XXDO', program => 'XXDOAR_B2B_BILLING_FILE', description => 'Create Billing File', start_time => SYSDATE, sub_request => FALSE, argument1 => p_org_id, argument2 => p_trx_class, argument3 => p_cust_trx_type_id, argument4 => p_batch_source_id, argument5 => p_creation_date_from, argument6 => p_creation_date_to, argument7 => p_trx_date_from, argument8 => p_trx_date_to, argument9 => p_trx_num_from, argument10 => p_trx_num_to, argument11 => p_customer_id, argument12 => p_cc_email_id, argument13 => p_reprocess_flag
                                        , argument14 => p_file_path);
        COMMIT;

        IF ln_child_req_id = 0
        THEN
            print_log (
                'Create Billing File concurrent request failed to submit',
                'Y');
            errbuf    :=
                'Create Billing File concurrent request failed to submit. Please check the concurrent request submission of child Billing Program';
            retcode   := gn_error;
            RETURN;                                         --Exit the program
        ELSE
            print_log (
                   'Successfully Submitted the Create Billing File Concurrent Request with request ID: '
                || ln_child_req_id);
        END IF;

        --If there are any requests to be submitted then PAUSE the parent request until child requests are completed.
        --Until unless the parent request is 'PAUSED', child requests will not run
        --            IF ln_child_req_id > 0
        --            THEN
        --                apps.fnd_conc_global.set_req_globals(
        --                                                     conc_status       => 'PAUSED'   --Parent request will be paused until all the child requests are completed
        --                                                    ,request_data      => TO_CHAR (ln_child_req_id)
        --                                                    );
        --            END IF;

        --        END IF;  --lv_req_data IF condition END

        IF ln_child_req_id > 0
        THEN
            LOOP
                --To make process execution to wait for 1st program to complete
                l_child_req_ret_sts   :=
                    fnd_concurrent.wait_for_request (
                        request_id   => ln_child_req_id,
                        INTERVAL     => 10 --Interval Number of seconds to wait between checks
                                          ,
                        max_wait     => 0 --3600 --Maximum number of seconds to wait for the request completion
                                         -- out arguments
                                         ,
                        phase        => lc_phase,
                        status       => lc_status,
                        dev_phase    => lc_dev_phase,
                        dev_status   => lc_dev_status,
                        MESSAGE      => lc_message);
                EXIT WHEN    UPPER (lc_phase) = 'COMPLETED'
                          OR UPPER (lc_status) IN
                                 ('CANCELLED', 'ERROR', 'TERMINATED');
            END LOOP;
        END IF;

        --Resuming the parent request after the child requests are completed and continuing with the next steps
        --        IF lv_req_data IS NOT NULL
        --        THEN
        print_log ('ln_child_req_id:' || ln_child_req_id);
        print_log (
            'Resuming the Billing Wrapper Program after the actual Open AR program is completed',
            'Y');

        print_log (' ');
        print_log ('Updating Print Options - START', 'Y');
        update_print_options (p_conc_request_id   => ln_child_req_id,
                              x_ret_code          => ln_ret_code,
                              x_ret_message       => lv_ret_message);
        print_log ('Updating Print Options - END', 'Y');
        print_log (' ');

        IF ln_ret_code = gn_error
        THEN
            retcode   := gn_error;
            errbuf    :=
                   'Error in Update_print_options Procedure - '
                || lv_ret_message;
            print_log (errbuf);
        --raise_application_error (-20003, errbuf);
        END IF;

        print_log ('Calling the send notification procedure', 'Y');
        --Call the send notification procedure
        send_notification (p_program_name      => lv_program_name,
                           p_file_path         => p_file_path,
                           p_conc_request_id   => ln_child_req_id,
                           p_email_lkp_name    => lv_email_lkp_name,
                           x_ret_code          => ln_ret_code,
                           x_ret_message       => lv_ret_message);

        IF ln_ret_code = gn_error
        THEN
            retcode   := gn_error;
            errbuf    :=
                'Error in Send Notification Procedure - ' || lv_ret_message;
            print_log (errbuf);
            raise_application_error (-20003, errbuf);
        END IF;

        print_log ('Send notification procedure completed', 'Y');
        --        END IF;
        print_log ('Billing Wrapper Program completed successfully', 'Y');
    EXCEPTION
        WHEN OTHERS
        THEN
            lv_err_msg   :=
                SUBSTR (
                       'Error in '
                    || lv_proc_name
                    || ' procedure - Others: '
                    || SQLERRM,
                    1,
                    2000);
            retcode   := gn_error;
            errbuf    := lv_err_msg;
            print_log (lv_err_msg);
    END billing_wrapper;
END XXDO_AR_B2B_OUTBOUND_PKG;
/
